
/// <summary>
/// Static factory for creating and initializing GameWorld instances.
/// Uses the new package-based loading system.
/// This is static to ensure clean initialization during startup without DI dependencies.
/// </summary>
public static class GameWorldInitializer
{
    /// <summary>
    /// Creates a new GameWorld instance using the specified content directory.
    /// This method must be static to avoid circular dependencies during startup.
    /// Object references are resolved during parsing (HIGHLANDER Pattern A).
    /// </summary>
    public static GameWorld CreateGameWorld(string contentDirectory = "Content/Core")
    {
        // Create new GameWorld instance
        GameWorld gameWorld = new GameWorld();

        // CRITICAL: Clear Content/Dynamic folder at game start for clean state
        // Dependent resources from previous sessions (scene-generated locations/items) must not persist
        // Must happen BEFORE any package loading to prevent stale JSON files from interfering
        ClearDynamicContentFolder();

        // Create SceneGenerationFacade for parse-time scene generation
        SceneGenerationFacade sceneGenerationFacade = new SceneGenerationFacade(gameWorld);

        // Create validation and synchronization services required by PackageLoader
        LocationPlayabilityValidator locationValidator = new LocationPlayabilityValidator();
        HexSynchronizationService hexSync = new HexSynchronizationService();

        // Load content from the specified directory
        // Parsers resolve object references during parsing
        // AI-generated content will go in Content/Generated
        // Test packages are in Content/Test
        PackageLoader packageLoader = new PackageLoader(gameWorld, sceneGenerationFacade, locationValidator, hexSync);
        packageLoader.LoadPackagesFromDirectory(contentDirectory);

        // NOTE: Procedural routes are generated by PackageLoader (NOT here - avoid duplication)
        // PackageLoader.GenerateProceduralRoutes() is called after hex grid + locations loaded

        // Spawn initial starter Scenes to populate tutorial content
        SpawnInitialScenes(gameWorld);

        return gameWorld;
    }

    /// <summary>
    /// Log all SceneTemplates marked as starter content for verification
    /// Actual spawning happens in GameFacade.StartGameAsync() after initialization completes
    /// Called during game initialization after content loading
    /// </summary>
    private static void SpawnInitialScenes(GameWorld gameWorld)
    {
        SpawnConditionsEvaluator spawnConditionsEvaluator = new SpawnConditionsEvaluator(gameWorld);
        SceneNarrativeService narrativeService = new SceneNarrativeService(gameWorld);
        MarkerResolutionService markerResolutionService = new MarkerResolutionService();
        SceneGenerationFacade sceneGenerationFacade = new SceneGenerationFacade(gameWorld);
        LocationPlayabilityValidator locationValidator = new LocationPlayabilityValidator();
        HexSynchronizationService hexSync = new HexSynchronizationService();
        PackageLoader packageLoader = new PackageLoader(gameWorld, sceneGenerationFacade, locationValidator, hexSync);
        HexRouteGenerator hexRouteGenerator = new HexRouteGenerator(gameWorld);
        VenueGeneratorService venueGenerator = new VenueGeneratorService(hexSync);

        SceneInstantiator instantiator = new SceneInstantiator(gameWorld, spawnConditionsEvaluator, narrativeService, markerResolutionService, venueGenerator);
        ContentGenerationFacade contentGenerationFacade = new ContentGenerationFacade();
        PackageLoaderFacade packageLoaderFacade = new PackageLoaderFacade(packageLoader);
        MessageSystem messageSystem = new MessageSystem(gameWorld);
        TimeModel timeModel = new TimeModel(gameWorld.CurrentDay);
        timeModel.SetInitialState(gameWorld.CurrentDay, gameWorld.CurrentTimeBlock, 1);
        TimeManager timeManager = new TimeManager(timeModel, messageSystem);
        SpawnedScenePlayabilityValidator playabilityValidator = new SpawnedScenePlayabilityValidator(gameWorld);

        SceneInstanceFacade sceneInstanceFacade =
            new SceneInstanceFacade(instantiator, contentGenerationFacade, packageLoaderFacade, hexRouteGenerator, timeManager, gameWorld, playabilityValidator);

        // Find all starter templates (for verification logging)
        List<SceneTemplate> starterTemplates = gameWorld.SceneTemplates.Where(t => t.IsStarter).ToList();

        Console.WriteLine($"[Init] Found {starterTemplates.Count} starter templates (will be spawned by GameFacade.StartGameAsync)");
        foreach (SceneTemplate t in starterTemplates)
        {
            Console.WriteLine($"  - {t.Id} (PlacementFilter: {t.PlacementFilter?.PlacementType})");
        }
    }

    /// <summary>
    /// Clear Content/Dynamic folder at game initialization for clean state
    /// Removes stale scene-generated JSON files from previous sessions
    /// Called before any package loading to prevent interference
    /// </summary>
    private static void ClearDynamicContentFolder()
    {
        string dynamicPath = Path.Combine("Content", "Dynamic");

        if (!Directory.Exists(dynamicPath))
        {
            Console.WriteLine($"[Init] Dynamic folder does not exist, skipping cleanup");
            return;
        }

        string[] jsonFiles = Directory.GetFiles(dynamicPath, "*.json");

        if (jsonFiles.Length == 0)
        {
            Console.WriteLine($"[Init] Dynamic folder is already empty");
            return;
        }

        Console.WriteLine($"[Init] Clearing {jsonFiles.Length} stale files from Content/Dynamic");

        foreach (string file in jsonFiles)
        {
            File.Delete(file);
            Console.WriteLine($"[Init]   âœ… Deleted {Path.GetFileName(file)}");
        }

        Console.WriteLine($"[Init] Content/Dynamic cleared - clean state achieved");
    }
}