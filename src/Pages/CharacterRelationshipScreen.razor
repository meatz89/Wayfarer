@page "/relationships"
@using Wayfarer.Pages.Components

@inherits MainGameplayViewBase

@inject ConnectionTokenManager TokenManager

<div class="character-relationship-container">
    <h2>Character Relationships</h2>
    
    <div class="relationship-summary">
        <p>Total Relationships: @knownNPCs.Count</p>
        <p>Relationships in Debt: @GetDebtRelationshipCount()</p>
        <p>Letter-Ready NPCs: @GetLetterReadyCount()</p>
    </div>
    
    @* Relationship Transparency Guide *@
    <RelationshipTransparency />
    
    <div class="npc-relationship-grid">
        @foreach (var npc in knownNPCs)
        {
            <NPCRelationshipCard NPC="npc" GameWorld="GameWorld" />
        }
    </div>
    
    @* Back Button *@
    <div class="navigation-buttons">
        <button class="btn btn-secondary" @onclick="() => NavigationService.NavigateTo(CurrentViews.LocationScreen)">Back to Main</button>
    </div>
</div>

@code {

@namespace Wayfarer.Pages
    private List<NPC> knownNPCs = new List<NPC>();
    
    protected override void OnInitialized()
    {
        // Get all NPCs that the player has interacted with
        // For now, get all NPCs in the game (in full implementation, would track "known" NPCs)
        knownNPCs = NPCRepository.GetAllNPCs()
            .Where(npc => !string.IsNullOrEmpty(npc.ID))
            .OrderBy(npc => npc.Name)
            .ToList();
    }
    
    private int GetDebtRelationshipCount()
    {
        return knownNPCs.Count(npc => 
        {
            var tokens = TokenManager.GetTokensWithNPC(npc.ID);
            return tokens.Any(kvp => kvp.Value < 0);
        });
    }
    
    private int GetLetterReadyCount()
    {
        return knownNPCs.Count(npc => TokenManager.HasEnoughTokensForDirectOffer(npc.ID));
    }
}