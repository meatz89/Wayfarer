@inherits NarrativeViewBase

<div class="narrative-container">
    <div class="narrative-text">
        @if (ShowResult)
        {
            <h3>
                @(ConversationResult.Success ? "Conversation Success!" : "Conversation Failed")
            </h3>

            @if (!string.IsNullOrEmpty(ConversationResult.AIResponse?.BeatNarration))
            {
                <div class="narrative-message">
                    @((MarkupString)ConversationResult.AIResponse?.BeatNarration)
                </div>
            }

            <div class="tooltip-section">
                <h5>
                    Conversation Consequences
                </h5>
                <div class="tooltip-list">
                    @if (ConversationResult.Success)
                    {
                    }
                </div>
                <div class="tooltip-list">
                    @if (!ConversationResult.Success)
                    {
                    }
                </div>
            </div>

            @if (HasPostConversationEvolution())
            {
                <div class="tooltip-section">
                    <h5>World Changes</h5>

                    @if (GetLocationChangesWithDepth().Any())
                    {
                        <h6>Discovered Places</h6>
                        <div class="tooltip-list">
                            @foreach (var location in GetLocationChangesWithDepth())
                            {
                                <div class="encounter-result-item wide">
                                    <div class="tooltip-item-header">
                                        <div class="tooltip-item-title">
                                            @GetEvolutionIcon(location.Type)
                                            <span class="tooltip-item-name">@location.Name</span>
                                        </div>
                                        <span class="tooltip-item-value info-change">
                                            @location.TypeDisplay (@location.DepthDisplay)
                                        </span>
                                    </div>
                                    <div class="tooltip-item-detail">
                                        @if (location.AvailableServices != null && location.AvailableServices.Any())
                                        {
                                            <span class="service-icons">
                                                @foreach (var service in location.AvailableServices)
                                                {
                                                    <span class="service-icon" title="@service">@GetServiceIcon(service)</span>
                                                }
                                            </span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    @if (GetActionChangesWithStamina().Any())
                    {
                        <h6>New Actions</h6>
                        <div class="tooltip-list">
                            @foreach (var action in GetActionChangesWithStamina())
                            {
                                <div class="encounter-result-item wide">
                                    <div class="tooltip-item-header">
                                        <div class="tooltip-item-title">
                                            @GetEvolutionIcon("Action")
                                            <span class="tooltip-item-name">@action.Name</span>
                                            @if (action.IsRepeatable)
                                            {
                                                <span class="repeatable-icon" title="Repeatable">🔄</span>
                                            }
                                        </div>
                                        <span class="tooltip-item-value @(action.StaminaCost > 0 ? "negative-change" : "info-change")">
                                            @(action.StaminaCost > 0 ? $"-{action.StaminaCost} Stamina" : "No Stamina Cost")
                                        </span>
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    @* Display new characters *@
                    @if (GetCharacterChanges().Any())
                    {
                        <h6>New Characters</h6>
                        <div class="tooltip-list">
                            @foreach (var character in GetCharacterChanges())
                            {
                                <div class="encounter-result-item wide">
                                    <div class="tooltip-item-header">
                                        <div class="tooltip-item-title">
                                            @GetEvolutionIcon("Character")
                                            <span class="tooltip-item-name">@character.Name</span>
                                        </div>
                                        <span class="tooltip-item-value info-change">
                                            @character.Description at @character.Location
                                        </span>
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    @* Display relationship changes *@
                    @if (GetRelationshipChanges().Any())
                    {
                        <h6>Relationship Changes</h6>
                        <div class="tooltip-list">
                            @foreach (var relationship in GetRelationshipChanges())
                            {
                                <div class="encounter-result-item wide">
                                    <div class="tooltip-item-header">
                                        <div class="tooltip-item-title">
                                            @GetEvolutionIcon("Relationship")
                                            <span class="tooltip-item-name">@relationship.CharacterName</span>
                                        </div>
                                        <span class="tooltip-item-value @(relationship.Change > 0 ? "positive-change" : "negative-change")">
                                            @(relationship.Change > 0 ? "+" : "")@relationship.Change Reputation
                                        </span>
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    @* Display coin changes *@
                    @if (GetCoinsChange() != null)
                    {
                        <h6>Coin Changes</h6>
                        <div class="tooltip-list">
                            <div class="encounter-result-item wide">
                                <div class="tooltip-item-header">
                                    <div class="tooltip-item-title">
                                        <i class='value-icon coins-icon'>💰</i>
                                        <span class="tooltip-item-name">Coins @(GetCoinsChange().Amount > 0 ? "Gained" : "Lost")</span>
                                    </div>
                                    <span class="tooltip-item-value @(GetCoinsChange().Amount > 0 ? "positive-change" : "negative-change")">
                                        (@GetCoinsChange().Current -> @GetCoinsChange().New)
                                    </span>
                                </div>
                            </div>
                        </div>
                    }

                    @* Display resource changes *@
                    @if (GetResourceChanges().Any())
                    {
                        <h6>Item Changes</h6>
                        <div class="tooltip-list">
                            @foreach (var resource in GetResourceChanges())
                            {
                                <div class="encounter-result-item wide">
                                    <div class="tooltip-item-header">
                                        <div class="tooltip-item-title">
                                            @GetEvolutionIcon(resource.ChangeType)
                                            <span class="tooltip-item-name">@resource.Name</span>
                                        </div>
                                        <span class="tooltip-item-value @(resource.ChangeType == "Added" ? "positive-change" : "negative-change")">
                                            @resource.ChangeType
                                        </span>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        }
    </div>

    <button class="narrative-button" @onclick="OnNarrativeCompleted">
        Continue
    </button>
</div>