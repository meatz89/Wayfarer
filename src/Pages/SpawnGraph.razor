@page "/spawngraph"

@namespace Wayfarer.Pages

@using Blazor.Diagrams.Core.Models
@using Wayfarer.Pages.Components.SpawnGraph

@implements IDisposable

@inject GameWorld GameWorld
@inject NavigationManager NavigationManager
@inject SpawnGraphBuilder GraphBuilder

<div class="spawn-graph-container">
    <div class="spawn-graph-toolbar">
        <button class="back-button" @onclick="NavigateBack">Back to Game</button>
        <h1>Procedural Content Graph</h1>
        <button @onclick="RefreshGraph">Refresh</button>
        <button @onclick="FitToView">Fit to View</button>
        <div class="filter-toggles">
            <label class="filter-toggle @(ShowScenes ? "active" : "")">
                <input type="checkbox" @bind="ShowScenes" @bind:after="ApplyFilters" />
                Scenes
            </label>
            <label class="filter-toggle @(ShowSituations ? "active" : "")">
                <input type="checkbox" @bind="ShowSituations" @bind:after="ApplyFilters" />
                Situations
            </label>
            <label class="filter-toggle @(ShowChoices ? "active" : "")">
                <input type="checkbox" @bind="ShowChoices" @bind:after="ApplyFilters" />
                Choices
            </label>
            <label class="filter-toggle @(ShowEntities ? "active" : "")">
                <input type="checkbox" @bind="ShowEntities" @bind:after="ApplyFilters" />
                Entities
            </label>
        </div>
        <span class="stats">
            Scenes: @SceneCount | Situations: @SituationCount | Choices: @ChoiceCount
        </span>
    </div>

    <div class="spawn-graph-canvas">
        @if (IsLoading)
        {
            <div class="spawn-graph-loading">
                <p>Computing layout...</p>
            </div>
        }
        else if (Diagram != null && Diagram.Nodes.Count > 0)
        {
            <CascadingValue Value="Diagram">
                <DiagramCanvas></DiagramCanvas>
            </CascadingValue>
        }
        else
        {
            <div class="spawn-graph-empty">
                <h2>No Graph Data</h2>
                <p>Start the game and make some choices to generate content.</p>
            </div>
        }
    </div>

    @if (!string.IsNullOrEmpty(BuildMessage))
    {
        <div class="spawn-graph-status">
            @BuildMessage
        </div>
    }

    <DetailPanel SelectedNode="SelectedNode" OnCloseClicked="ClearSelection" />
</div>

@code {
    private BlazorDiagram Diagram { get; set; }
    private bool IsLoading { get; set; }
    private string BuildMessage { get; set; }
    private NodeModel SelectedNode { get; set; }

    private bool ShowScenes { get; set; } = true;
    private bool ShowSituations { get; set; } = true;
    private bool ShowChoices { get; set; } = true;
    private bool ShowEntities { get; set; } = true;

    private int SceneCount => GameWorld?.ProceduralTracer?.AllSceneNodes?.Count ?? 0;
    private int SituationCount => GameWorld?.ProceduralTracer?.AllSituationNodes?.Count ?? 0;
    private int ChoiceCount => GameWorld?.ProceduralTracer?.AllChoiceNodes?.Count ?? 0;

    protected override async Task OnInitializedAsync()
    {
        InitializeDiagram();
        RegisterCustomWidgets();
        SubscribeToEvents();
        await BuildGraphAsync();
    }

    private void InitializeDiagram()
    {
        BlazorDiagramOptions options = new BlazorDiagramOptions
        {
            AllowMultiSelection = false
        };

        options.Zoom.Enabled = true;
        options.Zoom.Minimum = 0.1;
        options.Zoom.Maximum = 4.0;
        options.Links.DefaultColor = "#888888";
        options.Links.DefaultSelectedColor = "#ffffff";

        Diagram = new BlazorDiagram(options);
    }

    private void SubscribeToEvents()
    {
        Diagram.SelectionChanged += OnSelectionChanged;
    }

    private void OnSelectionChanged(Blazor.Diagrams.Core.Models.Base.SelectableModel model)
    {
        if (model is NodeModel node && node.Selected)
        {
            SelectedNode = node;
        }
        else if (model is NodeModel deselectedNode && !deselectedNode.Selected && SelectedNode == deselectedNode)
        {
            SelectedNode = null;
        }
        StateHasChanged();
    }

    private void RegisterCustomWidgets()
    {
        Diagram.RegisterComponent<SceneNodeModel, SceneNodeWidget>();
        Diagram.RegisterComponent<SituationNodeModel, SituationNodeWidget>();
        Diagram.RegisterComponent<ChoiceNodeModel, ChoiceNodeWidget>();
        Diagram.RegisterComponent<EntityNodeModel, EntityNodeWidget>();
    }

    private async Task BuildGraphAsync()
    {
        if (GameWorld?.ProceduralTracer == null) return;

        IsLoading = true;
        StateHasChanged();

        SpawnGraphBuildResult result = await GraphBuilder.BuildGraphAsync(GameWorld.ProceduralTracer, Diagram);

        BuildMessage = result.Success
            ? $"Layout: {result.NodeCount} nodes, {result.LinkCount} links ({result.GraphWidth:F0}x{result.GraphHeight:F0})"
            : result.Message;

        IsLoading = false;
        StateHasChanged();
    }

    private async Task RefreshGraph()
    {
        await BuildGraphAsync();
    }

    private void FitToView()
    {
        Diagram?.ZoomToFit();
    }

    private void ApplyFilters()
    {
        if (Diagram == null) return;

        foreach (NodeModel node in Diagram.Nodes)
        {
            bool shouldShow = node switch
            {
                SceneNodeModel _ => ShowScenes,
                SituationNodeModel _ => ShowSituations,
                ChoiceNodeModel _ => ShowChoices,
                EntityNodeModel _ => ShowEntities,
                _ => true
            };
            node.Visible = shouldShow;
        }
        StateHasChanged();
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo("/");
    }

    private void ClearSelection()
    {
        if (SelectedNode != null)
        {
            Diagram?.UnselectAll();
            SelectedNode = null;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        if (Diagram != null)
        {
            Diagram.SelectionChanged -= OnSelectionChanged;
        }
    }
}
