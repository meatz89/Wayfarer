@* RestUI.razor *@
@inject GameWorld GameWorld
@inject GameWorldManager GameManager
@inject RestManager RestManager
@inject GameWorldManager GameWorldManager
@inject LocationActionManager LocationActionManager

<div class="rest-options">
    @* Show contextual rest options from RestManager *@
    @{
        var restOptions = RestManager.GetAvailableRestOptions()
            .Where(o => o.StaminaRecovery > 0 && o.RestTimeHours >= 1)
            .ToList();
    }
    
    @foreach (var option in restOptions)
    {
        <div class="rest-option">
            <div class="option-header">
                <span class="option-name">@option.Name</span>
                <span class="option-cost">@(option.CoinCost > 0 ? $"{option.CoinCost} coins" : "Free")</span>
            </div>
            <div class="option-benefits">
                <div class="benefit">
                    <span class="benefit-label">Stamina Recovery:</span>
                    <span class="benefit-value">+@option.StaminaRecovery</span>
                </div>
                @if (option.EnablesDawnDeparture)
                {
                    <div class="benefit special-benefit">
                        <span class="benefit-label">Special:</span>
                        <span class="benefit-value">Enables dawn departure</span>
                    </div>
                }
                @if (option.ProvidesMarketRumors)
                {
                    <div class="benefit special-benefit">
                        <span class="benefit-label">Special:</span>
                        <span class="benefit-value">Provides market rumors</span>
                    </div>
                }
                @if (option.CleansesContraband)
                {
                    <div class="benefit special-benefit">
                        <span class="benefit-label">Special:</span>
                        <span class="benefit-value">Cleanses contraband</span>
                    </div>
                }
            </div>
            <button class="rest-button"
                    disabled="@(GameWorld.GetPlayer().Coins < option.CoinCost || (option.RequiredItem != null && !HasItem(option.RequiredItem)))"
                    @onclick='() => Rest(option.Id)'>
                Rest Here
            </button>
        </div>
    }
    
    @* Show location-specific rest actions (like tavern drinking while resting) *@
    @{
        var locationActions = LocationActionManager.GetAvailableActions()
            .Where(a => a.Action == LocationAction.Rest)
            .ToList();
    }
    
    @if (locationActions.Any())
    {
        <div class="location-rest-actions">
            <h4>Location Activities</h4>
            @foreach (var action in locationActions)
            {
                <div class="rest-option">
                    <div class="option-header">
                        <span class="option-name">@action.Name</span>
                        <span class="option-cost">
                            @if (action.CoinCost > 0)
                            {
                                @:@action.CoinCost coins
                            }
                            else
                            {
                                @:Free
                            }
                        </span>
                    </div>
                    <div class="option-benefits">
                        <div class="benefit">
                            <span class="benefit-label">Time:</span>
                            <span class="benefit-value">@action.HourCost hour@(action.HourCost > 1 ? "s" : "")</span>
                        </div>
                        <div class="benefit">
                            <span class="benefit-label">Effect:</span>
                            <span class="benefit-value">@action.Effect</span>
                        </div>
                    </div>
                    <button class="rest-button"
                            disabled="@(!CanAffordAction(action))"
                            @onclick="() => ExecuteLocationAction(action)">
                        @action.Name
                    </button>
                </div>
            }
        </div>
    }
    
    <div class="wait-section">
        <h4>Wait</h4>
        <p>Current Time: @GameWorld.TimeManager.CurrentTimeHours:00 (@GameWorld.TimeManager.GetCurrentTimeBlock())</p>
        <p>Remaining Hours Today: @(24 - GameWorld.TimeManager.CurrentTimeHours)</p>
        
        <div class="wait-options">
            <button class="wait-button" 
                    disabled="@(GameWorld.TimeManager.CurrentTimeHours >= 23)"
                    @onclick="() => WaitHours(1)">
                Wait 1 Hour
            </button>
            <button class="wait-button" 
                    disabled="@(GameWorld.TimeManager.CurrentTimeHours >= 22)"
                    @onclick="() => WaitHours(2)">
                Wait 2 Hours  
            </button>
            <button class="wait-button" 
                    disabled="@(GameWorld.TimeManager.CurrentTimeHours >= 21)"
                    @onclick="() => WaitHours(3)">
                Wait 3 Hours
            </button>
        </div>
    </div>
</div>

@code {

@namespace Wayfarer.Pages
    [Parameter] public Location Location { get; set; }
    [Parameter] public EventCallback OnRestComplete { get; set; }

    private async Task Rest(string option)
    {
        // Use RestManager for proper architecture
        var availableOptions = RestManager.GetAvailableRestOptions();
        var selectedOption = availableOptions.FirstOrDefault(o => o.Id == option);
        
        if (selectedOption != null)
        {
            RestManager.Rest(selectedOption);
        }

        await OnRestComplete.InvokeAsync();
    }
    
    private async Task WaitHours(int hours)
    {
        RestManager.Wait(hours);
        await OnRestComplete.InvokeAsync();
    }
    
    private bool HasItem(string itemName)
    {
        var player = GameWorld.GetPlayer();
        return Array.IndexOf(player.Inventory.ItemSlots, itemName) != -1;
    }
    
    private bool CanAffordAction(ActionOption action)
    {
        var player = GameWorld.GetPlayer();
        return player.Coins >= action.CoinCost && 
               player.Stamina >= action.StaminaCost &&
               GameWorld.TimeManager.HoursRemaining >= action.HourCost;
    }
    
    private async Task ExecuteLocationAction(ActionOption action)
    {
        // UI actions must go through GameWorldManager, not LocationActionManager directly
        await GameWorldManager.ExecuteAction(action);
        await OnRestComplete.InvokeAsync();
    }
}