@* RestUI.razor *@
@inject GameWorld GameWorld
@inject GameWorldManager GameManager
@inject RestManager RestManager
@inject CommandDiscoveryService CommandDiscovery
@inject CommandExecutor CommandExecutor

<div class="rest-options">
    @* Show contextual rest options from RestManager *@
    @{
        var restOptions = RestManager.GetAvailableRestOptions()
            .Where(o => o.StaminaRecovery > 0 && o.RestTimeHours >= 1)
            .ToList();
    }
    
    @foreach (var option in restOptions)
    {
        <div class="rest-option">
            <div class="option-header">
                <span class="option-name">@option.Name</span>
                <span class="option-cost">@(option.CoinCost > 0 ? $"{option.CoinCost} coins" : "Free")</span>
            </div>
            <div class="option-benefits">
                <div class="benefit">
                    <span class="benefit-label">Stamina Recovery:</span>
                    <span class="benefit-value">+@option.StaminaRecovery</span>
                </div>
                @if (option.EnablesDawnDeparture)
                {
                    <div class="benefit special-benefit">
                        <span class="benefit-label">Special:</span>
                        <span class="benefit-value">Enables dawn departure</span>
                    </div>
                }
                @if (option.ProvidesMarketRumors)
                {
                    <div class="benefit special-benefit">
                        <span class="benefit-label">Special:</span>
                        <span class="benefit-value">Provides market rumors</span>
                    </div>
                }
                @if (option.CleansesContraband)
                {
                    <div class="benefit special-benefit">
                        <span class="benefit-label">Special:</span>
                        <span class="benefit-value">Cleanses contraband</span>
                    </div>
                }
            </div>
            <button class="rest-button"
                    disabled="@(GameWorld.GetPlayer().Coins < option.CoinCost || (option.RequiredItem != null && !HasItem(option.RequiredItem)))"
                    @onclick='() => Rest(option.Id)'>
                Rest Here
            </button>
        </div>
    }
    
    @* Show location-specific rest actions from command discovery *@
    @{
        var discovery = CommandDiscovery.DiscoverCommands(GameWorld);
        var restCommands = discovery.CommandsByCategory
            .Where(kvp => kvp.Key == CommandCategory.Rest)
            .SelectMany(kvp => kvp.Value)
            .ToList();
    }
    
    @if (restCommands.Any())
    {
        <div class="location-rest-actions">
            <h4>Location Activities</h4>
            @foreach (var cmd in restCommands)
            {
                <div class="rest-option">
                    <div class="option-header">
                        <span class="option-name">@cmd.DisplayName</span>
                        <span class="option-cost">
                            @if (cmd.CoinCost > 0)
                            {
                                @:@cmd.CoinCost coins
                            }
                            else
                            {
                                @:Free
                            }
                        </span>
                    </div>
                    <div class="option-benefits">
                        <div class="benefit">
                            <span class="benefit-label">Time:</span>
                            <span class="benefit-value">@cmd.TimeCost hour@(cmd.TimeCost > 1 ? "s" : "")</span>
                        </div>
                        <div class="benefit">
                            <span class="benefit-label">Effect:</span>
                            <span class="benefit-value">@cmd.PotentialReward</span>
                        </div>
                    </div>
                    <button class="rest-button"
                            disabled="@(!cmd.IsAvailable)"
                            @onclick="() => ExecuteCommand(cmd.UniqueId)">
                        @cmd.DisplayName
                    </button>
                </div>
            }
        </div>
    }
    
    <div class="wait-section">
        <h4>Wait</h4>
        <p>Current Time: @GameWorld.TimeManager.GetCurrentTimeHours():00 (@GameWorld.TimeManager.GetCurrentTimeBlock())</p>
        <p>Remaining Hours Today: @(24 - GameWorld.TimeManager.GetCurrentTimeHours())</p>
        
        <div class="wait-options">
            <button class="wait-button" 
                    disabled="@(GameWorld.TimeManager.GetCurrentTimeHours() >= 23)"
                    @onclick="() => WaitHours(1)">
                Wait 1 Hour
            </button>
            <button class="wait-button" 
                    disabled="@(GameWorld.TimeManager.GetCurrentTimeHours() >= 22)"
                    @onclick="() => WaitHours(2)">
                Wait 2 Hours  
            </button>
            <button class="wait-button" 
                    disabled="@(GameWorld.TimeManager.GetCurrentTimeHours() >= 21)"
                    @onclick="() => WaitHours(3)">
                Wait 3 Hours
            </button>
        </div>
    </div>
</div>

@code {

@namespace Wayfarer.Pages
    [Parameter] public Location Location { get; set; }
    [Parameter] public EventCallback OnRestComplete { get; set; }

    private async Task Rest(string option)
    {
        // Use RestManager for proper architecture
        var availableOptions = RestManager.GetAvailableRestOptions();
        var selectedOption = availableOptions.FirstOrDefault(o => o.Id == option);
        
        if (selectedOption != null)
        {
            RestManager.Rest(selectedOption);
        }

        await OnRestComplete.InvokeAsync();
    }
    
    private async Task WaitHours(int hours)
    {
        RestManager.Wait(hours);
        await OnRestComplete.InvokeAsync();
    }
    
    private bool HasItem(string itemName)
    {
        var player = GameWorld.GetPlayer();
        return Array.IndexOf(player.Inventory.ItemSlots, itemName) != -1;
    }
    
    private async Task ExecuteCommand(string commandId)
    {
        await GameManager.ExecuteCommandAsync(commandId);
        await OnRestComplete.InvokeAsync();
    }
    
}