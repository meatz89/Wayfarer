@using System.Linq
@inject DialogueGenerationService DialogueGenerator
@inject NarrativeRenderer NarrativeRenderer
@inject ObligationQueueManager QueueManager

@code {
    [Parameter] public EmotionalState State { get; set; }
    [Parameter] public NPC NPC { get; set; }
    [Parameter] public MeetingObligation MeetingObligation { get; set; }
    [Parameter] public int TurnNumber { get; set; }

    private string GetDialogueText()
    {
        // Get obligations for context
        var obligations = QueueManager?.GetActiveObligations()?.ToList() ?? new List<DeliveryObligation>();
        var npcObligation = obligations.FirstOrDefault(o => o.SenderId == NPC.ID || o.SenderName == NPC.Name);
        
        // Generate categorical template from game state
        var template = DialogueGenerator.GenerateNPCDialogue(
            State, 
            NPC.PersonalityType,
            npcObligation,
            MeetingObligation,
            TurnNumber
        );
        
        // Render template to human-readable text
        return NarrativeRenderer.RenderTemplate(template);
    }
}

<div class="npc-dialogue @State.ToString().ToLower()">
    "@GetDialogueText()"
</div>