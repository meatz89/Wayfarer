@namespace Wayfarer.Pages.Components.SpawnGraph

@using Blazor.Diagrams
@using Blazor.Diagrams.Components.Renderers
@using Blazor.Diagrams.Core.Models
@using Blazor.Diagrams.Core.Models.Base
@using Blazor.Diagrams.Core.Geometry

<g class="entity-link-group @GetResolutionClass()">
    @* Render the link path using Blazor.Diagrams' built-in renderer *@
    <LinkRenderer Link="@Link" />

    @* Add resolution label overlay at the midpoint *@
    @if (Link.Resolution != null)
    {
        Point midPoint = CalculateMidpoint();
        @if (midPoint != null)
        {
            <g class="link-resolution-label" transform="translate(@FormatCoord(midPoint.X), @FormatCoord(midPoint.Y))">
                <rect class="link-label-bg @GetBgClass()"
                      x="-30" y="-11"
                      width="60" height="22"
                      rx="4" ry="4" />
                <text class="link-label-text"
                      x="0" y="4"
                      text-anchor="middle"
                      dominant-baseline="middle"
                      fill="white">
                    @GetResolutionText()
                </text>
            </g>
        }
    }
</g>

@code {
    [Parameter] public SpawnGraphLinkModel Link { get; set; }

    private Point CalculateMidpoint()
    {
        if (Link?.Source?.Model is not NodeModel sourceNode || Link?.Target?.Model is not NodeModel targetNode)
            return null;

        if (sourceNode.Position == null || targetNode.Position == null)
            return null;

        double sourceX = sourceNode.Position.X + 90;
        double sourceY = sourceNode.Position.Y + 40;
        double targetX = targetNode.Position.X + 75;
        double targetY = targetNode.Position.Y + 30;

        return new Point((sourceX + targetX) / 2, (sourceY + targetY) / 2);
    }

    private string FormatCoord(double value)
    {
        return value.ToString(System.Globalization.CultureInfo.InvariantCulture);
    }

    private string GetResolutionClass()
    {
        if (Link?.Resolution == null) return "";

        return Link.Resolution.Outcome switch
        {
            EntityResolutionOutcome.Discovered => "link-discovered",
            EntityResolutionOutcome.Created => "link-created",
            EntityResolutionOutcome.RouteDestination => "link-route-dest",
            _ => ""
        };
    }

    private string GetBgClass()
    {
        if (Link?.Resolution == null) return "";

        return Link.Resolution.Outcome switch
        {
            EntityResolutionOutcome.Discovered => "bg-discovered",
            EntityResolutionOutcome.Created => "bg-created",
            EntityResolutionOutcome.RouteDestination => "bg-route-dest",
            _ => ""
        };
    }

    private string GetResolutionText()
    {
        if (Link?.Resolution == null) return "";

        return Link.Resolution.Outcome switch
        {
            EntityResolutionOutcome.Discovered => "Found",
            EntityResolutionOutcome.Created => "Created",
            EntityResolutionOutcome.RouteDestination => "Via Route",
            _ => ""
        };
    }
}
