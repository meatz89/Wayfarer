@namespace Wayfarer.Pages.Components
@inject HttpClient Http

@if (!string.IsNullOrEmpty(_svgContent))
{
    @((MarkupString)_svgContent)
}

@code {
    [Parameter]
    public string Name { get; set; }

    [Parameter]
    public string Size { get; set; } = "16px";

    [Parameter]
    public string Color { get; set; } = "currentColor";

    [Parameter]
    public string CssClass { get; set; } = "";

    private string _svgContent = "";
    private static System.Collections.Concurrent.ConcurrentDictionary<string, string> _iconCache = new System.Collections.Concurrent.ConcurrentDictionary<string, string>();

    protected override async Task OnParametersSetAsync()
    {
        if (string.IsNullOrEmpty(Name))
        {
            return;
        }

        if (_iconCache.TryGetValue(Name, out string cachedSvg))
        {
            _svgContent = ApplyStyling(cachedSvg);
            return;
        }

        try
        {
            string svgPath = $"game-icons/{Name}.svg";
            string rawSvg = await Http.GetStringAsync(svgPath);
            _iconCache.TryAdd(Name, rawSvg);
            _svgContent = ApplyStyling(rawSvg);
        }
        catch
        {
            _svgContent = "";
        }
    }

    private string ApplyStyling(string rawSvg)
    {
        string styledSvg = rawSvg;

        styledSvg = System.Text.RegularExpressions.Regex.Replace(
            styledSvg,
            @"<svg([^>]*)>",
            $"<svg$1 width=\"{Size}\" height=\"{Size}\" style=\"fill: {Color};\" class=\"game-icon {CssClass}\">"
        );

        return styledSvg;
    }
}
