@using Wayfarer.Models
@using Wayfarer.GameState
@using Wayfarer

@* 
   Emotional State Display Component
   Shows the transparent formula: State = Stakes + Time
*@

<div class="emotional-state-display @GetStateClass()">
    <div class="state-header">
        <span class="npc-name">@NpcName</span>
        <span class="state-badge @GetStateClass()">[@CurrentState.ToString().ToUpper()]</span>
    </div>
    
    @if (ShowFormula)
    {
        <div class="state-formula">
            <span class="formula-label"><span class="icon icon-arrow"></span></span>
            <span class="formula-components">
                @if (!string.IsNullOrEmpty(StakesDescription))
                {
                    <span class="stakes-component">@StakesDescription</span>
                }
                @if (TimeRemaining.HasValue)
                {
                    <span class="time-component">+ @GetTimeDescription()</span>
                }
            </span>
        </div>
    }
    
    @if (ShowMechanicalEffects)
    {
        <div class="state-effects">
            @foreach (var effect in GetStateEffects())
            {
                var parts = effect.Split('|');
                var effectType = parts[0];
                var effectText = parts[1];
                <div class="effect-item @GetEffectClass(effectType)">
                    <span class="effect-icon @GetEffectIconClass(effectType)"></span>
                    <span class="effect-text">@effectText</span>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public string NpcName { get; set; }
    [Parameter] public NPCEmotionalState CurrentState { get; set; }
    [Parameter] public StakeType? Stakes { get; set; }
    [Parameter] public string StakesDescription { get; set; }
    [Parameter] public TimeSpan? TimeRemaining { get; set; }
    [Parameter] public bool ShowFormula { get; set; } = true;
    [Parameter] public bool ShowMechanicalEffects { get; set; } = true;
    
    private string GetStateClass()
    {
        return CurrentState switch
        {
            NPCEmotionalState.DESPERATE => "state-desperate",
            NPCEmotionalState.ANXIOUS => "state-anxious",
            NPCEmotionalState.CALCULATING => "state-calculating",
            NPCEmotionalState.HOSTILE => "state-hostile",
            NPCEmotionalState.WITHDRAWN => "state-withdrawn",
            _ => "state-neutral"
        };
    }
    
    private string GetTimeDescription()
    {
        if (!TimeRemaining.HasValue)
            return "";
            
        var hours = (int)TimeRemaining.Value.TotalHours;
        var minutes = TimeRemaining.Value.Minutes;
        
        if (hours > 0)
            return $"{hours}h {minutes}m remaining";
        else
            return $"{minutes}m remaining";
    }
    
    private List<string> GetStateEffects()
    {
        var effects = new List<string>();
        
        switch (CurrentState)
        {                
            case NPCEmotionalState.DESPERATE:
                effects.Add("WARNING|Will accept any help");
                effects.Add("NEUTRAL|0 attention cost choices");
                effects.Add("WARNING|Extreme time pressure");
                break;
                
            case NPCEmotionalState.ANXIOUS:
                effects.Add("WARNING|Worried about deadlines");
                effects.Add("NEUTRAL|Standard token costs");
                effects.Add("POSITIVE|Open to negotiation");
                break;
                
            case NPCEmotionalState.CALCULATING:
                effects.Add("POSITIVE|Strategic thinking");
                effects.Add("NEUTRAL|Balanced exchanges");
                effects.Add("POSITIVE|Evaluating options");
                break;
                
            case NPCEmotionalState.HOSTILE:
                effects.Add("WARNING|Letter overdue");
                effects.Add("WARNING|Trust building blocked");
                effects.Add("WARNING|Permanent consequences");
                break;
                
            case NPCEmotionalState.WITHDRAWN:
                effects.Add("POSITIVE|No active letters");
                effects.Add("NEUTRAL|Minimal interaction");
                effects.Add("POSITIVE|No pressure");
                break;
        }
        
        return effects;
    }
    
    private string GetEffectIconClass(string effectType)
    {
        return effectType switch
        {
            "POSITIVE" => "icon icon-positive",
            "WARNING" => "icon icon-warning", 
            "NEUTRAL" => "icon icon-arrow",
            _ => "icon icon-neutral"
        };
    }
    
    private string GetEffectClass(string effectType)
    {
        return effectType switch
        {
            "POSITIVE" => "effect-positive",
            "WARNING" => "effect-negative",
            "NEUTRAL" => "effect-neutral",
            _ => "effect-info"
        };
    }
}