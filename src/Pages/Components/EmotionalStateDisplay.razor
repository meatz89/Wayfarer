@using Wayfarer.Models
@using Wayfarer.GameState
@using Wayfarer

@* 
   Emotional State Display Component
   Shows the transparent formula: State = Stakes + Time
*@

<div class="emotional-state-display @GetStateClass()">
    <div class="state-header">
        <span class="npc-name">@NpcName</span>
        <span class="state-badge @GetStateClass()">[@CurrentState.ToString().ToUpper()]</span>
    </div>
    
    @if (ShowFormula)
    {
        <div class="state-formula">
            <span class="formula-label">↳</span>
            <span class="formula-components">
                @if (!string.IsNullOrEmpty(StakesDescription))
                {
                    <span class="stakes-component">@StakesDescription</span>
                }
                @if (TimeRemaining.HasValue)
                {
                    <span class="time-component">+ @GetTimeDescription()</span>
                }
            </span>
        </div>
    }
    
    @if (ShowMechanicalEffects)
    {
        <div class="state-effects">
            @foreach (var effect in GetStateEffects())
            {
                <div class="effect-item @GetEffectClass(effect)">
                    <span class="effect-icon">@GetEffectIcon(effect)</span>
                    <span class="effect-text">@effect</span>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public string NpcName { get; set; }
    [Parameter] public NPCEmotionalState CurrentState { get; set; }
    [Parameter] public StakeType? Stakes { get; set; }
    [Parameter] public string StakesDescription { get; set; }
    [Parameter] public TimeSpan? TimeRemaining { get; set; }
    [Parameter] public bool ShowFormula { get; set; } = true;
    [Parameter] public bool ShowMechanicalEffects { get; set; } = true;
    
    private string GetStateClass()
    {
        return CurrentState switch
        {
            NPCEmotionalState.DESPERATE => "state-desperate",
            NPCEmotionalState.ANXIOUS => "state-anxious",
            NPCEmotionalState.CALCULATING => "state-calculating",
            NPCEmotionalState.HOSTILE => "state-hostile",
            NPCEmotionalState.WITHDRAWN => "state-withdrawn",
            _ => "state-neutral"
        };
    }
    
    private string GetTimeDescription()
    {
        if (!TimeRemaining.HasValue)
            return "";
            
        var hours = (int)TimeRemaining.Value.TotalHours;
        var minutes = TimeRemaining.Value.Minutes;
        
        if (hours > 0)
            return $"{hours}h {minutes}m remaining";
        else
            return $"{minutes}m remaining";
    }
    
    private List<string> GetStateEffects()
    {
        var effects = new List<string>();
        
        switch (CurrentState)
        {                
            case NPCEmotionalState.DESPERATE:
                effects.Add("⚠ Will accept any help");
                effects.Add("→ 0 attention cost choices");
                effects.Add("⚠ Extreme time pressure");
                break;
                
            case NPCEmotionalState.ANXIOUS:
                effects.Add("⚠ Worried about deadlines");
                effects.Add("→ Standard token costs");
                effects.Add("ℹ Open to negotiation");
                break;
                
            case NPCEmotionalState.CALCULATING:
                effects.Add("✓ Strategic thinking");
                effects.Add("→ Balanced exchanges");
                effects.Add("ℹ Evaluating options");
                break;
                
            case NPCEmotionalState.HOSTILE:
                effects.Add("⚠ Letter overdue");
                effects.Add("⚠ Trust building blocked");
                effects.Add("⚠ Permanent consequences");
                break;
                
            case NPCEmotionalState.WITHDRAWN:
                effects.Add("ℹ No active letters");
                effects.Add("→ Minimal interaction");
                effects.Add("✓ No pressure");
                break;
        }
        
        return effects;
    }
    
    private string GetEffectIcon(string effect)
    {
        if (effect.StartsWith("✓")) return "✓";
        if (effect.StartsWith("⚠")) return "⚠";
        if (effect.StartsWith("ℹ")) return "ℹ";
        if (effect.StartsWith("→")) return "→";
        return "•";
    }
    
    private string GetEffectClass(string effect)
    {
        if (effect.Contains("✓")) return "effect-positive";
        if (effect.Contains("⚠")) return "effect-negative";
        return "effect-neutral";
    }
}