@* Maps emotional states and contexts to narrative text *@

@using System.Collections.Generic

@code {
    [Parameter] public EmotionalState State { get; set; }
    [Parameter] public PersonalityType? Personality { get; set; }
    [Parameter] public int? MinutesUntilDeadline { get; set; }
    [Parameter] public string NPCName { get; set; }

    private string GetNarrativeText()
    {
        // Generate contextual narrative based on state and deadline
        if (State == EmotionalState.DESPERATE && MinutesUntilDeadline.HasValue)
        {
            int hours = MinutesUntilDeadline.Value / 60;
            if (hours <= 2)
            {
                return $"Time is running short. {NPCName}'s desperation fills the space between you, making every word carry weight.";
            }
            return $"Urgency hangs in the air. {NPCName} needs your help, and time is not on their side.";
        }

        return State switch
        {
            EmotionalState.DESPERATE => "The air crackles with desperation. Every moment counts.",
            EmotionalState.TENSE => "Tension coils through the conversation like a tightening spring.",
            EmotionalState.GUARDED => "Walls are up. Trust must be earned word by careful word.",
            EmotionalState.NEUTRAL => "The conversation flows at its natural pace.",
            EmotionalState.OPEN => "Openness creates space for genuine connection.",
            EmotionalState.CONNECTED => "A profound connection hums between you, each word perfectly placed.",
            EmotionalState.EAGER => "Enthusiasm bubbles through every exchange.",
            EmotionalState.OVERWHELMED => "Too much, too fast. The conversation needs breathing room.",
            EmotionalState.HOSTILE => "Hostility poisons the air. Words become weapons.",
            _ => "The moment unfolds."
        };
    }

    private string GetStateDescription()
    {
        // Use actual values from ConversationRules.States
        if (ConversationRules.States.TryGetValue(State, out var rules))
        {
            var parts = new List<string>();
            
            // Draw count
            parts.Add($"Draw {rules.CardsOnListen}");
            
            // Weight limit
            parts.Add($"Weight limit {rules.MaxWeight}");
            
            // Special mechanics
            if (State == EmotionalState.DESPERATE)
            {
                parts.Add("Burden free");
            }
            else if (State == EmotionalState.CONNECTED && rules.AutoAdvanceDepth > 0)
            {
                parts.Add("Auto-depth progress");
            }
            else if (State == EmotionalState.EAGER)
            {
                parts.Add("+3 bonus for 2+ same type");
            }
            else if (State == EmotionalState.HOSTILE)
            {
                return "Cannot converse until resolved";
            }
            
            // Listen transition (only show if different from current state)
            if (rules.ListenTransition != State)
            {
                parts.Add($"Listen → {rules.ListenTransition}");
            }
            else if (rules.ListenEndsConversation)
            {
                parts.Add("Listen ends conversation");
            }
            
            return string.Join(" • ", parts);
        }
        
        return "";
    }
}

<div class="narrative-text">
    @GetNarrativeText()
</div>

@if (!string.IsNullOrEmpty(GetStateDescription()))
{
    <div class="state-description">
        @GetStateDescription()
    </div>
}