@namespace Wayfarer.Pages.Components
@using Wayfarer.Pages.Components.Shared
@using Wayfarer.GameState.Enums
@*
Equipment Applicability - Shows which equipment matches obstacle contexts
Displays context matching and intensity reduction preview
*@

<div class="equipment-applicability">
    <h4 class="applicability-header">Equipment Analysis:</h4>

    @if (!ApplicableEquipment.Any())
    {
        <div class="no-applicable-equipment">
            <span class="no-match-icon">✗</span>
            <span class="no-match-text">No equipment matches this obstacle's contexts</span>
        </div>
    }
    else
    {
        <div class="applicable-equipment-list">
            @foreach (EquipmentMatch match in ApplicableEquipment)
            {
                <div class="equipment-match">
                    <div class="match-header">
                        <span class="equipment-name">@match.Equipment.Name</span>
                        <span class="match-indicator">✓ Matches</span>
                    </div>

                    <div class="match-contexts">
                        <span class="matches-label">Matches:</span>
                        @foreach (ObstacleContext context in match.MatchedContexts)
                        {
                            <ContextTag ContextName="@context.ToString()" IsMatch="true" />
                        }
                    </div>

                    <div class="match-effect">
                        <span class="effect-label">Reduction:</span>
                        <span class="effect-value">-@match.Equipment.IntensityReduction intensity</span>
                    </div>
                </div>
            }
        </div>
    }

    @if (NonApplicableEquipment.Any())
    {
        <details class="non-applicable-equipment">
            <summary class="non-applicable-header">
                Non-Applicable Equipment (@NonApplicableEquipment.Count)
            </summary>
            <div class="non-applicable-list">
                @foreach (Equipment equipment in NonApplicableEquipment)
                {
                    <div class="equipment-no-match">
                        <span class="equipment-name">@equipment.Name</span>
                        <span class="no-match-reason">No matching contexts</span>
                    </div>
                }
            </div>
        </details>
    }
</div>

@code {
    [Parameter] public Obstacle Obstacle { get; set; }
    [Parameter] public List<Equipment> AvailableEquipment { get; set; }

    private List<EquipmentMatch> ApplicableEquipment
    {
        get
        {
            if (AvailableEquipment == null || !AvailableEquipment.Any())
                return new List<EquipmentMatch>();

            return AvailableEquipment
                .Where(e => e.ApplicableContexts.Any(c => Obstacle.Contexts.Contains(c)))
                .Select(e => new EquipmentMatch
                {
                    Equipment = e,
                    MatchedContexts = e.ApplicableContexts.Intersect(Obstacle.Contexts).ToList()
                })
                .ToList();
        }
    }

    private List<Equipment> NonApplicableEquipment => AvailableEquipment?
        .Where(e => !e.ApplicableContexts.Any(c => Obstacle.Contexts.Contains(c)))
        .ToList() ?? new List<Equipment>();

    private class EquipmentMatch
    {
        public Equipment Equipment { get; set; }
        public List<ObstacleContext> MatchedContexts { get; set; }
    }
}
