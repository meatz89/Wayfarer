@using Wayfarer.ViewModels
@inject GameFacade GameFacade
@inject ITimeManager TimeManager

<div class="bottom-status-bar">
    <div class="status-section">
        <span class="status-icon">üìç</span>
        <span class="status-text">@GetCurrentLocation()</span>
    </div>
    
    <div class="status-section">
        <span class="status-icon">üìú</span>
        <span class="status-text">Queue: @GetQueueStatus()</span>
    </div>
    
    <div class="status-section">
        <span class="status-icon">üí∞</span>
        <span class="status-text">@GetCoinDisplay()</span>
    </div>
    
    <div class="status-section">
        <span class="status-icon">‚è∞</span>
        <span class="status-text">@GetCurrentTime()</span>
    </div>
    
    @{
        var deadline = GetMostUrgentDeadline();
        if (deadline != null)
        {
            <div class="status-section deadline-warning">
                <span class="status-icon">@deadline.Icon</span>
                <span class="status-text">@deadline.Text</span>
            </div>
        }
    }
</div>

@code {
    private string GetCurrentLocation()
    {
        try
        {
            var (location, spot) = GameFacade.GetCurrentLocation();
            if (spot != null && !string.IsNullOrEmpty(spot.Name))
            {
                return spot.Name;
            }
            else if (location != null && !string.IsNullOrEmpty(location.Name))
            {
                return location.Name;
            }
            return "Market Square";
        }
        catch
        {
            return "Market Square";
        }
    }
    
    private string GetQueueStatus()
    {
        try
        {
            var queueVM = GameFacade.GetLetterQueue();
            if (queueVM?.Status != null)
            {
                // Show both count and weight: "3/8 [7/12w]"
                return $"{queueVM.Status.LetterCount}/8 [{queueVM.Status.TotalWeight}/{queueVM.Status.MaxWeight}w]";
            }
            
            // Fallback to simple count
            int count = GameFacade.GetLetterQueueCount();
            return $"{count}/8";
        }
        catch
        {
            return "0/8";
        }
    }
    
    private string GetCoinDisplay()
    {
        try
        {
            var inventory = GameFacade.GetInventory();
            if (inventory != null)
            {
                var coins = inventory.Coins;
                if (coins >= 100)
                {
                    return $"{coins / 100}g {coins % 100}s";
                }
                return $"{coins}s";
            }
            return "0s";
        }
        catch
        {
            return "0s";
        }
    }
    
    private string GetCurrentTime()
    {
        try
        {
            var day = TimeManager.GetCurrentDay();
            var dayName = new[] { "MON", "TUE", "WED", "THU", "FRI", "SAT", "SUN" }[day % 7];
            
            var currentHour = TimeManager.GetCurrentTimeHours();
            var currentMinute = TimeManager.GetCurrentMinutes();
            var period = currentHour >= 12 ? "PM" : "AM";
            var displayHour = currentHour > 12 ? currentHour - 12 : (currentHour == 0 ? 12 : currentHour);
            
            return $"{dayName} {displayHour}:{currentMinute:D2} {period}";
        }
        catch
        {
            return "MON 6:00 AM";
        }
    }
    
    private class DeadlineInfo
    {
        public string Icon { get; set; }
        public string Text { get; set; }
    }
    
    private DeadlineInfo GetMostUrgentDeadline()
    {
        try
        {
            var queueVM = GameFacade.GetLetterQueue();
            if (queueVM?.QueueSlots == null) return null;
            
            // Find the most urgent letter
            LetterViewModel mostUrgent = null;
            foreach (var slot in queueVM.QueueSlots)
            {
                if (slot.IsOccupied && slot.Letter != null)
                {
                    if (mostUrgent == null || slot.Letter.DeadlineInHours < mostUrgent.DeadlineInHours)
                    {
                        mostUrgent = slot.Letter;
                    }
                }
            }
            
            if (mostUrgent == null) return null;
            
            // Format deadline display
            if (mostUrgent.DeadlineInHours <= 0)
            {
                return new DeadlineInfo { Icon = "üíÄ", Text = "EXPIRED!" };
            }
            else if (mostUrgent.DeadlineInHours <= 2)
            {
                return new DeadlineInfo { Icon = "üî•", Text = $"{mostUrgent.DeadlineInHours}h CRITICAL" };
            }
            else if (mostUrgent.DeadlineInHours <= 6)
            {
                return new DeadlineInfo { Icon = "‚ö†Ô∏è", Text = $"{mostUrgent.DeadlineInHours}h urgent" };
            }
            else if (mostUrgent.DeadlineInHours <= 24)
            {
                return new DeadlineInfo { Icon = "üìÖ", Text = $"{mostUrgent.DeadlineInHours}h" };
            }
            
            return null; // Don't show deadline if > 24 hours
        }
        catch
        {
            return null;
        }
    }
}