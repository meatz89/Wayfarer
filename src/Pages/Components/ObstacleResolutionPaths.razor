@namespace Wayfarer.Pages.Components
@using Wayfarer.Pages.Components.Shared
@using Wayfarer.GameState.Enums
@*
Obstacle Resolution Paths - Shows all resolution options for an obstacle
Challenge, Equipment, Cost bypass, Accept damage
*@

<div class="obstacle-resolution">
    <div class="obstacle-info">
        <h3 class="obstacle-name">@Obstacle.Name</h3>
        <p class="obstacle-description">@Obstacle.Description</p>

        <div class="obstacle-properties">
            <div class="obstacle-intensity">
                <span class="property-label">Intensity:</span>
                <span class="property-value intensity-@EffectiveIntensity">@EffectiveIntensity/3</span>
            </div>
        </div>

        <div class="obstacle-contexts">
            <span class="contexts-label">Contexts:</span>
            <div class="context-tags-list">
                @foreach (var context in Obstacle.Contexts)
                {
                    <ContextTag ContextName="@context.ToString()" IsMatch="@IsContextMatched(context)" />
                }
            </div>
        </div>
    </div>

    <EquipmentApplicability
        Obstacle="@Obstacle"
        AvailableEquipment="@AvailableEquipment" />

    <div class="resolution-options">
        <h4 class="options-header">Resolution Options:</h4>

        <!-- Option 1: Challenge -->
        <div class="resolution-option challenge-option">
            <h5 class="option-title">1. Challenge</h5>
            <p class="option-description">Launch tactical challenge</p>
            <div class="option-cost">Risk: @EffectiveIntensity Intensity</div>
            <button class="btn-challenge" @onclick="() => HandleChallenge()">
                Begin Challenge
            </button>
        </div>

        <!-- Option 2: Pay Coins (if available) -->
        @if (BypassCost > 0)
        {
            <div class="resolution-option bypass-option">
                <h5 class="option-title">2. Pay to Bypass</h5>
                <p class="option-description">Hire assistance, auto-success</p>
                <div class="option-cost">Cost: @BypassCost coins</div>
                <button class="btn-bypass"
                        @onclick="() => HandleBypass()"
                        disabled="@(!CanAffordBypass)">
                    @(CanAffordBypass ? "Pay to Bypass" : "Insufficient Coins")
                </button>
            </div>
        }

        <!-- Option 3: Accept Damage -->
        <div class="resolution-option accept-option">
            <h5 class="option-title">3. Accept Consequences</h5>
            <p class="option-description">Take damage, proceed immediately</p>
            <div class="option-cost">Damage: @EffectiveIntensity Intensity</div>
            <button class="btn-accept" @onclick="() => HandleAccept()">
                Accept Damage & Continue
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter] public Obstacle Obstacle { get; set; }
    [Parameter] public List<Equipment> AvailableEquipment { get; set; }
    [Parameter] public int PlayerCoins { get; set; }
    [Parameter] public EventCallback OnChallenge { get; set; }
    [Parameter] public EventCallback OnBypass { get; set; }
    [Parameter] public EventCallback OnAccept { get; set; }

    [Inject] private ObstacleFacade ObstacleFacade { get; set; }

    private int EffectiveIntensity
    {
        get
        {
            ObstacleIntensity intensity = ObstacleFacade?.CalculateEffectiveIntensity(Obstacle?.Id);
            return intensity?.EffectiveIntensity ?? Obstacle?.Intensity ?? 0;
        }
    }

    private int BypassCost => EffectiveIntensity * 5; // 5 coins per effective intensity point

    private bool CanAffordBypass => PlayerCoins >= BypassCost;

    private bool IsContextMatched(ObstacleContext context)
    {
        return AvailableEquipment?.Any(e => e.ApplicableContexts.Contains(context)) ?? false;
    }

    private async Task HandleChallenge()
    {
        await OnChallenge.InvokeAsync();
    }

    private async Task HandleBypass()
    {
        if (CanAffordBypass)
        {
            await OnBypass.InvokeAsync();
        }
    }

    private async Task HandleAccept()
    {
        await OnAccept.InvokeAsync();
    }
}
