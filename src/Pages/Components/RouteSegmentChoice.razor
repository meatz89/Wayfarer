@namespace Wayfarer.Pages.Components
@using Wayfarer.Pages.Components.Shared
@inject ObstacleFacade ObstacleFacade
@*
Route Segment Choice - Core Loop path selection UI
Displays available paths with time/stamina trade-offs
Filters by exploration cubes (reveals hidden paths)
*@

<div class="route-segment-choice">
    @if (!string.IsNullOrEmpty(NarrativeDescription))
    {
        <div class="segment-narrative">
            @NarrativeDescription
        </div>
    }

    <div class="segment-paths-header">
        <h4>Choose Your Path</h4>
        @if (AvailablePaths != null && AvailablePaths.Count > 1)
        {
            <span class="paths-count">@AvailablePaths.Count options available</span>
        }
    </div>

    @if (AvailablePaths == null || !AvailablePaths.Any())
    {
        <div class="no-paths-message">
            No paths available. Increase exploration cubes to reveal hidden routes.
        </div>
    }
    else
    {
        <div class="paths-grid">
            @foreach (RoutePath path in AvailablePaths)
            {
                <div class="path-choice-card @(IsSelected(path.Id) ? "selected" : "")"
                     @onclick="() => SelectPath(path)">

                    <div class="path-choice-header">
                        <h5 class="path-choice-name">@path.Description</h5>
                    </div>

                    <div class="path-choice-costs">
                        @if (path.TimeSegments > 0)
                        {
                            <div class="path-cost-item time-cost">
                                <span class="cost-icon">‚è±</span>
                                <span class="cost-value">@path.TimeSegments</span>
                                <span class="cost-label">segment@(path.TimeSegments > 1 ? "s" : "")</span>
                            </div>
                        }

                        @if (path.StaminaCost > 0)
                        {
                            <div class="path-cost-item stamina-cost">
                                <span class="cost-icon">üí™</span>
                                <span class="cost-value">@path.StaminaCost</span>
                                <span class="cost-label">stamina</span>
                            </div>
                        }

                        @if (path.TimeSegments == 0 && path.StaminaCost == 0)
                        {
                            <div class="path-cost-item no-cost">
                                <span class="cost-icon">‚úì</span>
                                <span class="cost-label">No cost</span>
                            </div>
                        }
                    </div>

                    @if (!string.IsNullOrEmpty(path.OptionalObstacleId))
                    {
                        <div class="path-obstacle-warning">
                            <span class="obstacle-icon">‚ö†</span>
                            <span class="obstacle-text">Potential challenge ahead</span>
                        </div>

                        @if (ShowObstacleDetails)
                        {
                            var obstacle = GetObstacle(path.OptionalObstacleId);
                            if (obstacle != null)
                            {
                                <div class="obstacle-preview">
                                    <div class="obstacle-name">@obstacle.Name</div>
                                    <div class="obstacle-contexts">
                                        @foreach (var context in obstacle.Contexts)
                                        {
                                            <ContextTag ContextName="@context.ToString()" />
                                        }
                                    </div>
                                    <div class="obstacle-intensity">
                                        Intensity: @obstacle.Intensity
                                    </div>

                                    @if (ShowEquipmentHelp)
                                    {
                                        var applicableEquipment = ObstacleFacade.GetApplicableEquipment(path.OptionalObstacleId);
                                        if (applicableEquipment != null && applicableEquipment.Any())
                                        {
                                            <div class="equipment-help">
                                                <span class="help-icon">‚öô</span>
                                                <span class="help-text">
                                                    Equipment can help: @string.Join(", ", applicableEquipment.Select(e => e.Name))
                                                </span>
                                            </div>
                                        }
                                    }
                                </div>
                            }
                        }
                    }

                    @if (path.HiddenUntilExploration > 0)
                    {
                        <div class="path-hidden-indicator">
                            <span class="hidden-icon">üó∫</span>
                            <span class="hidden-text">Revealed at @path.HiddenUntilExploration cubes</span>
                        </div>
                    }

                    @if (IsSelected(path.Id))
                    {
                        <div class="path-selected-indicator">
                            <span class="selected-icon">‚úì</span>
                            <span class="selected-text">Selected</span>
                        </div>
                    }
                </div>
            }
        </div>
    }

    @if (ShowConfirmButton && SelectedPath != null)
    {
        <div class="path-confirm-section">
            <button class="btn-confirm-path" @onclick="ConfirmSelection">
                Confirm Path: @SelectedPath.Description
            </button>
        </div>
    }
</div>

@code {
    [Parameter] public string NarrativeDescription { get; set; }
    [Parameter] public List<RoutePath> AvailablePaths { get; set; }
    [Parameter] public bool ShowObstacleDetails { get; set; } = true;
    [Parameter] public bool ShowEquipmentHelp { get; set; } = true;
    [Parameter] public bool ShowConfirmButton { get; set; } = false;
    [Parameter] public EventCallback<RoutePath> OnPathSelected { get; set; }
    [Parameter] public EventCallback<RoutePath> OnPathConfirmed { get; set; }
    [Parameter] public GameWorld GameWorld { get; set; }

    private RoutePath SelectedPath { get; set; }

    private bool IsSelected(string pathId)
    {
        return SelectedPath != null && SelectedPath.Id == pathId;
    }

    private void SelectPath(RoutePath path)
    {
        SelectedPath = path;
        OnPathSelected.InvokeAsync(path);
    }

    private void ConfirmSelection()
    {
        if (SelectedPath != null)
        {
            OnPathConfirmed.InvokeAsync(SelectedPath);
        }
    }

    private Obstacle GetObstacle(string obstacleId)
    {
        return GameWorld?.Obstacles?.FirstOrDefault(o => o.Id == obstacleId);
    }
}
