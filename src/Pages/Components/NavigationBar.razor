@inject NavigationService NavigationService
@inject ITimeManager TimeManager
@inject GameWorld GameWorld
@inject StandingObligationManager ObligationManager

@namespace Wayfarer.Pages.Components

<div class="navigation-bar">
    @if (ShouldShowLetterManagement())
    {
        <div class="nav-section nav-primary">
            <h4>Letter Management</h4>
            <div class="nav-buttons">
                @if (ShouldShowQueue())
                {
                    <button class="nav-button @(IsActive(CurrentViews.LetterQueueScreen) ? "active" : "")" 
                            @onclick="() => NavigateTo(CurrentViews.LetterQueueScreen)">
                        Queue
                    </button>
                }
                @if (ShouldShowLetterBoard())
                {
                    <button class="nav-button @(IsActive(CurrentViews.LetterBoardScreen) ? "active" : "")" 
                            @onclick="() => NavigateTo(CurrentViews.LetterBoardScreen)"
                            disabled="@(!CanNavigateToLetterBoard())">
                        Board
                    </button>
                }
                @if (ShouldShowRelations())
                {
                    <button class="nav-button @(IsActive(CurrentViews.RelationshipScreen) ? "active" : "")" 
                            @onclick="() => NavigateTo(CurrentViews.RelationshipScreen)">
                        Relations
                    </button>
                }
                @if (ShouldShowObligations())
                {
                    <button class="nav-button @(IsActive(CurrentViews.ObligationsScreen) ? "active" : "")" 
                            @onclick="() => NavigateTo(CurrentViews.ObligationsScreen)">
                        Obligations
                    </button>
                }
            </div>
        </div>
    }
    
    <div class="nav-section nav-secondary">
        <h4>World</h4>
        <div class="nav-buttons">
            <button class="nav-button @(IsActive(CurrentViews.LocationScreen) ? "active" : "")" 
                    @onclick="() => NavigateTo(CurrentViews.LocationScreen)">
                Location
            </button>
            <button class="nav-button @(IsActive(CurrentViews.MapScreen) ? "active" : "")" 
                    @onclick="() => NavigateTo(CurrentViews.MapScreen)">
                Map
            </button>
            <button class="nav-button @(IsActive(CurrentViews.TravelScreen) ? "active" : "")" 
                    @onclick="() => NavigateTo(CurrentViews.TravelScreen)">
                Travel
            </button>
            <button class="nav-button @(IsActive(CurrentViews.MarketScreen) ? "active" : "")" 
                    @onclick="() => NavigateTo(CurrentViews.MarketScreen)">
                Market
            </button>
            <button class="nav-button @(IsActive(CurrentViews.RestScreen) ? "active" : "")" 
                    @onclick="() => NavigateTo(CurrentViews.RestScreen)">
                Rest
            </button>
        </div>
    </div>
    
    <div class="nav-section nav-tertiary">
        <h4>Character</h4>
        <div class="nav-buttons">
            <button class="nav-button @(IsActive(CurrentViews.PlayerStatusScreen) ? "active" : "")" 
                    @onclick="() => NavigateTo(CurrentViews.PlayerStatusScreen)">
                Status
            </button>
            <button class="nav-button @(IsActive(CurrentViews.EventLogScreen) ? "active" : "")" 
                    @onclick="() => NavigateTo(CurrentViews.EventLogScreen)">
                Event Log
            </button>
        </div>
    </div>
    
    @if (NavigationService.CanNavigateBack())
    {
        <div class="nav-section nav-back">
            <button class="nav-button nav-back-button" @onclick="NavigateBack">
                ‚Üê Back
            </button>
        </div>
    }
</div>

@code {
    protected override void OnInitialized()
    {
        // NavigationBar will re-render when parent state changes
        // No need to subscribe to events - Blazor handles this
    }
    
    private void NavigateTo(CurrentViews view)
    {
        NavigationService.NavigateTo(view);
    }
    
    private void NavigateBack()
    {
        NavigationService.NavigateBack();
    }
    
    private bool IsActive(CurrentViews view)
    {
        return NavigationService.CurrentScreen == view;
    }
    
    private bool CanNavigateToLetterBoard()
    {
        return TimeManager.GetCurrentTimeBlock() == TimeBlocks.Dawn;
    }
    
    // Tutorial visibility methods based on player achievements
    private bool ShouldShowLetterManagement()
    {
        // Show letter management section once player has learned about letters
        return !GameWorld.NarrativeManager.IsNarrativeActive("wayfarer_tutorial") || 
               GameWorld.FlagService.GetFlag("first_letter_accepted");
    }
    
    private bool ShouldShowQueue()
    {
        // Show queue after player accepts their first letter
        return !GameWorld.NarrativeManager.IsNarrativeActive("wayfarer_tutorial") || 
               GameWorld.FlagService.GetFlag("first_letter_accepted");
    }
    
    private bool ShouldShowLetterBoard()
    {
        // Show letter board after player delivers their first letter
        return !GameWorld.NarrativeManager.IsNarrativeActive("wayfarer_tutorial") || 
               GameWorld.FlagService.GetFlag("first_letter_delivered");
    }
    
    private bool ShouldShowRelations()
    {
        // Show relations after player earns their first token
        return !GameWorld.NarrativeManager.IsNarrativeActive("wayfarer_tutorial") || 
               GameWorld.FlagService.GetFlag("first_token_earned");
    }
    
    private bool ShouldShowObligations()
    {
        // Show obligations after player meets patron or has any obligation
        return !GameWorld.NarrativeManager.IsNarrativeActive("wayfarer_tutorial") || 
               GameWorld.FlagService.GetFlag("tutorial_patron_met") ||
               ObligationManager.GetActiveObligations().Any();
    }
    
}