@using Wayfarer.GameState

<div class="information-hierarchy">
    <!-- Critical Layer - Always Visible -->
    <div class="info-layer critical-layer">
        <div class="layer-header">
            <span class="layer-icon">‚ö†Ô∏è</span>
            <span class="layer-title">Critical</span>
            <span class="layer-count">@GetCriticalCount()</span>
        </div>
        <div class="layer-content">
            @if (HasCriticalDeadline)
            {
                <div class="info-item critical deadline">
                    <span class="info-icon">‚è∞</span>
                    <span class="info-text">Deadline: @FormatDeadline()</span>
                    <span class="info-impact">Failure imminent</span>
                </div>
            }
            @if (HasCriticalDebt)
            {
                <div class="info-item critical debt">
                    <span class="info-icon">üíî</span>
                    <span class="info-text">Critical Debt</span>
                    <span class="info-impact">-@MaxDebt tokens</span>
                </div>
            }
            @if (IsExhausted)
            {
                <div class="info-item critical stamina">
                    <span class="info-icon">üò∞</span>
                    <span class="info-text">Exhausted</span>
                    <span class="info-impact">Cannot act</span>
                </div>
            }
        </div>
    </div>
    
    <!-- Strategic Layer - Expandable -->
    <div class="info-layer strategic-layer @(ExpandedLayers.Contains("strategic") ? "expanded" : "")">
        <div class="layer-header" @onclick="() => ToggleLayer("strategic")">
            <span class="layer-icon">üéØ</span>
            <span class="layer-title">Strategic</span>
            <span class="layer-count">@GetStrategicCount()</span>
            <span class="layer-toggle">@(ExpandedLayers.Contains("strategic") ? "‚ñº" : "‚ñ∂")</span>
        </div>
        @if (ExpandedLayers.Contains("strategic"))
        {
            <div class="layer-content">
                <div class="info-grid strategic">
                    <!-- Queue Management -->
                    <div class="info-group">
                        <h5>Queue</h5>
                        <div class="info-item">
                            <span class="info-label">Letters:</span>
                            <span class="info-value">@QueueSize/8</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Next Due:</span>
                            <span class="info-value">@GetNextDeadline()</span>
                        </div>
                    </div>
                    
                    <!-- Token Economy -->
                    <div class="info-group">
                        <h5>Tokens</h5>
                        @foreach (var token in GetTokenSummary())
                        {
                            <div class="info-item">
                                <span class="info-label">@token.Type:</span>
                                <span class="info-value @(token.Count < 0 ? "negative" : "")">@token.Count</span>
                            </div>
                        }
                    </div>
                    
                    <!-- Obligations -->
                    <div class="info-group">
                        <h5>Obligations</h5>
                        <div class="info-item">
                            <span class="info-label">Active:</span>
                            <span class="info-value">@ObligationCount</span>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
    
    <!-- Tactical Layer - Expandable -->
    <div class="info-layer tactical-layer @(ExpandedLayers.Contains("tactical") ? "expanded" : "")">
        <div class="layer-header" @onclick="() => ToggleLayer("tactical")">
            <span class="layer-icon">‚öîÔ∏è</span>
            <span class="layer-title">Tactical</span>
            <span class="layer-count">@GetTacticalCount()</span>
            <span class="layer-toggle">@(ExpandedLayers.Contains("tactical") ? "‚ñº" : "‚ñ∂")</span>
        </div>
        @if (ExpandedLayers.Contains("tactical"))
        {
            <div class="layer-content">
                <div class="info-grid tactical">
                    <!-- Current Resources -->
                    <div class="info-group">
                        <h5>Resources</h5>
                        <div class="info-item">
                            <span class="info-label">Coins:</span>
                            <span class="info-value">@PlayerCoins</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Stamina:</span>
                            <span class="info-value">@PlayerStamina/@MaxStamina</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Attention:</span>
                            <span class="info-value">@CurrentAttention/3</span>
                        </div>
                    </div>
                    
                    <!-- Available Actions -->
                    <div class="info-group">
                        <h5>Actions</h5>
                        @foreach (var action in GetAvailableActions())
                        {
                            <div class="info-item action">
                                <span class="action-name">@action.Name</span>
                                <span class="action-cost">@action.Cost</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
    
    <!-- Environmental Layer - Expandable -->
    <div class="info-layer environmental-layer @(ExpandedLayers.Contains("environmental") ? "expanded" : "")">
        <div class="layer-header" @onclick="() => ToggleLayer("environmental")">
            <span class="layer-icon">üå§Ô∏è</span>
            <span class="layer-title">Environmental</span>
            <span class="layer-count">@GetEnvironmentalCount()</span>
            <span class="layer-toggle">@(ExpandedLayers.Contains("environmental") ? "‚ñº" : "‚ñ∂")</span>
        </div>
        @if (ExpandedLayers.Contains("environmental"))
        {
            <div class="layer-content">
                <div class="info-tags">
                    @foreach (var tag in GetEnvironmentalTags())
                    {
                        <span class="env-tag @tag.Category">@tag.Name</span>
                    }
                </div>
            </div>
        }
    </div>
    
    <!-- Discovery Layer - Expandable -->
    <div class="info-layer discovery-layer @(ExpandedLayers.Contains("discovery") ? "expanded" : "")">
        <div class="layer-header" @onclick="() => ToggleLayer("discovery")">
            <span class="layer-icon">üîç</span>
            <span class="layer-title">Discovery</span>
            <span class="layer-count">@GetDiscoveryCount()</span>
            <span class="layer-toggle">@(ExpandedLayers.Contains("discovery") ? "‚ñº" : "‚ñ∂")</span>
        </div>
        @if (ExpandedLayers.Contains("discovery"))
        {
            <div class="layer-content">
                <div class="discovery-hints">
                    @foreach (var hint in GetDiscoveryHints())
                    {
                        <div class="discovery-hint">
                            <span class="hint-icon">@hint.Icon</span>
                            <span class="hint-text">@hint.Text</span>
                            <span class="hint-requirement">@hint.Requirement</span>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
    
    <!-- Quick Actions Bar -->
    <div class="quick-actions">
        <button class="quick-action" @onclick="ExpandAll" title="Expand All">
            <span class="action-icon">üìñ</span>
        </button>
        <button class="quick-action" @onclick="CollapseAll" title="Collapse All">
            <span class="action-icon">üìï</span>
        </button>
        <button class="quick-action @(ShowOnlyCritical ? "active" : "")" 
                @onclick="ToggleCriticalOnly" title="Critical Only">
            <span class="action-icon">‚ö†Ô∏è</span>
        </button>
    </div>
</div>

@code {
    [Parameter] public SceneContext? Scene { get; set; }
    [Parameter] public int CurrentAttention { get; set; }
    [Parameter] public int PlayerCoins { get; set; }
    [Parameter] public int PlayerStamina { get; set; }
    [Parameter] public int MaxStamina { get; set; }
    [Parameter] public int QueueSize { get; set; }
    [Parameter] public int ObligationCount { get; set; }
    
    private HashSet<string> ExpandedLayers = new HashSet<string> { "strategic" };
    private bool ShowOnlyCritical = false;
    
    private bool HasCriticalDeadline => GetMinutesUntilDeadline() < 60;
    private bool HasCriticalDebt => MaxDebt >= 3;
    private bool IsExhausted => PlayerStamina < MaxStamina * 0.3;
    private int MaxDebt => 0; // TODO: Calculate from token manager
    
    private class TokenSummary
    {
        public string Type { get; set; }
        public int Count { get; set; }
    }
    
    private class ActionInfo
    {
        public string Name { get; set; }
        public string Cost { get; set; }
    }
    
    private class TagInfo
    {
        public string Name { get; set; }
        public string Category { get; set; }
    }
    
    private class DiscoveryHint
    {
        public string Icon { get; set; }
        public string Text { get; set; }
        public string Requirement { get; set; }
    }
    
    private void ToggleLayer(string layer)
    {
        if (ExpandedLayers.Contains(layer))
            ExpandedLayers.Remove(layer);
        else
            ExpandedLayers.Add(layer);
    }
    
    private void ExpandAll()
    {
        ExpandedLayers = new HashSet<string> { "strategic", "tactical", "environmental", "discovery" };
    }
    
    private void CollapseAll()
    {
        ExpandedLayers.Clear();
    }
    
    private void ToggleCriticalOnly()
    {
        ShowOnlyCritical = !ShowOnlyCritical;
        if (ShowOnlyCritical)
        {
            ExpandedLayers.Clear();
        }
        else
        {
            ExpandedLayers.Add("strategic");
        }
    }
    
    private int GetCriticalCount()
    {
        int count = 0;
        if (HasCriticalDeadline) count++;
        if (HasCriticalDebt) count++;
        if (IsExhausted) count++;
        return count;
    }
    
    private int GetStrategicCount()
    {
        return 3; // Queue, Tokens, Obligations
    }
    
    private int GetTacticalCount()
    {
        return GetAvailableActions().Count + 3; // Actions + Resources
    }
    
    private int GetEnvironmentalCount()
    {
        return GetEnvironmentalTags().Count;
    }
    
    private int GetDiscoveryCount()
    {
        return GetDiscoveryHints().Count;
    }
    
    private string FormatDeadline()
    {
        var minutes = GetMinutesUntilDeadline();
        if (minutes > 999) return "None";
        return $"{minutes / 60}h {minutes % 60}m";
    }
    
    private int GetMinutesUntilDeadline()
    {
        // TODO: Get from actual game state
        return 45;
    }
    
    private string GetNextDeadline()
    {
        // TODO: Get from queue manager
        return "2h 30m";
    }
    
    private List<TokenSummary> GetTokenSummary()
    {
        // TODO: Get from token manager
        return new List<TokenSummary>
        {
            new TokenSummary { Type = "Trust", Count = 2 },
            new TokenSummary { Type = "Commerce", Count = -1 },
            new TokenSummary { Type = "Status", Count = 0 },
            new TokenSummary { Type = "Shadow", Count = 0 }
        };
    }
    
    private List<ActionInfo> GetAvailableActions()
    {
        // TODO: Get from scene context
        return new List<ActionInfo>
        {
            new ActionInfo { Name = "Inquire", Cost = "1‚óã" },
            new ActionInfo { Name = "Trade Rumor", Cost = "2‚óã" },
            new ActionInfo { Name = "Leave", Cost = "Free" }
        };
    }
    
    private List<TagInfo> GetEnvironmentalTags()
    {
        var tags = new List<TagInfo>();
        
        if (Scene?.FeelingTags != null)
        {
            foreach (var tag in Scene.FeelingTags)
            {
                tags.Add(new TagInfo { Name = tag.ToString(), Category = "feeling" });
            }
        }
        
        return tags;
    }
    
    private List<DiscoveryHint> GetDiscoveryHints()
    {
        var hints = new List<DiscoveryHint>();
        
        if (Scene?.DiscoveryTags?.Contains(DiscoveryTag.RUMOR_AVAILABLE) == true)
        {
            hints.Add(new DiscoveryHint
            {
                Icon = "üí¨",
                Text = "Rumors available",
                Requirement = "Build trust"
            });
        }
        
        if (Scene?.DiscoveryTags?.Contains(DiscoveryTag.SECRET_PRESENT) == true)
        {
            hints.Add(new DiscoveryHint
            {
                Icon = "üóùÔ∏è",
                Text = "Secret knowledge",
                Requirement = "Deep inquiry"
            });
        }
        
        return hints;
    }
}