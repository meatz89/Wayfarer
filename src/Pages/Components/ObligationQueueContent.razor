@inherits ObligationQueueContentBase

@namespace Wayfarer.Pages.Components

<div class="obligation-queue-content">
    <div class="queue-header">
        <h2>Obligation Queue</h2>
        <div class="queue-stats">
            <span>@ActiveObligations.Count active obligations</span>
            <span>@ExpiredObligations.Count expired</span>
        </div>
    </div>

    @if (ActiveObligations.Any())
    {
        <div class="active-obligations">
            <h3>Active Obligations</h3>
            <div class="letter-list">
                @foreach (var letter in ActiveObligations)
                {
                    <div class="letter-card @GetLetterUrgencyClass(letter)">
                        <div class="letter-header">
                            <h4>Letter from @letter.SenderName</h4>
                            <div class="letter-type">@letter.TokenType Token</div>
                        </div>
                        
                        <div class="letter-details">
                            <div class="letter-route">
                                <span class="from">From: @letter.SenderName</span>
                                <span class="to">To: @letter.RecipientName</span>
                            </div>
                            
                            <div class="letter-deadline">
                                <span class="deadline-label">Deadline:</span>
                                <span class="deadline-time @GetDeadlineClass(letter)">
                                    @GetTimeRemaining(letter)
                                </span>
                            </div>
                            
                            <div class="letter-reward">
                                <span class="reward-label">Reward:</span>
                                <span class="reward-amount">@letter.Payment coins</span>
                            </div>
                        </div>
                        
                        <div class="letter-actions">
                            <button class="view-button" 
                                    @onclick="@(async () => await ViewLetterDetails(letter))">
                                View Details
                            </button>
                            
                            @if (CanDeliver(letter))
                            {
                                <button class="deliver-button" 
                                        @onclick="@(async () => await DeliverLetter(letter))">
                                    Deliver Now
                                </button>
                            }
                            
                            @if (CanDisplace(letter))
                            {
                                <div class="displacement-options">
                                    <div class="displacement-menu">
                                        <div class="displacement-header">Displacement Options</div>
                                        <div class="displacement-content">
                                            @for (int targetPos = 1; targetPos <= 8; targetPos++)
                                            {
                                                var preview = GetDisplacementPreview(letter, targetPos);
                                                if (preview != null && preview.CanExecute && targetPos < GetLetterPosition(letter))
                                                {
                                                    <div class="displacement-option">
                                                        <button class="displace-to-button @GetDisplacementButtonClass(preview)" 
                                                                @onclick="@(async () => await DisplaceLetterToPosition(letter, targetPos))">
                                                            Move to Position @targetPos
                                                        </button>
                                                        <div class="token-cost">
                                                            Cost: @preview.TotalTokenCost tokens
                                                        </div>
                                                        @if (preview.DisplacementDetails.Any())
                                                        {
                                                            <div class="displacement-details">
                                                                @foreach (var detail in preview.DisplacementDetails)
                                                                {
                                                                    <div class="displacement-detail">
                                                                        -@detail.TokenCost @detail.TokenType with @detail.NPCName
                                                                    </div>
                                                                }
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="empty-queue">
            <p>No active letters in your queue.</p>
            <p>Have conversations with NPCs to generate letters!</p>
        </div>
    }

    @if (ExpiredObligations.Any())
    {
        <div class="expired-obligations">
            <h3>Expired Obligations</h3>
            <div class="letter-list expired">
                @foreach (var letter in ExpiredObligations)
                {
                    <div class="letter-card expired">
                        <div class="letter-header">
                            <h4>@letter.SenderName <span class="icon-arrow-right"></span> @letter.RecipientName</h4>
                            <span class="expired-tag">EXPIRED</span>
                        </div>
                        <div class="letter-consequences">
                            <p>Failed to deliver on time. Relationship damaged.</p>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <div class="queue-footer">
        <button class="back-button" @onclick="ReturnToPreviousView">
            Back to @PreviousViewName
        </button>
    </div>
</div>