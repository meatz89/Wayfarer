@inject GameWorld GameWorld
@inject NarrativeManager NarrativeManager
@inject FlagService FlagService
@inject LocationRepository LocationRepository
@inject LocationSpotRepository LocationSpotRepository
@inject IJSRuntime JSRuntime

@namespace Wayfarer.Pages.Components

<div class="save-load-panel">
    <h4>Game Management</h4>
    <div class="save-load-buttons">
        @if (CanSaveLoad())
        {
            <button class="save-button" @onclick="SaveGame">
                Save Game
            </button>
            <button class="load-button" @onclick="LoadGame">
                Load Game
            </button>
        }
        else
        {
            <div class="tutorial-message">
                Cannot save during tutorial
            </div>
        }
    </div>
    
    @if (!string.IsNullOrEmpty(StatusMessage))
    {
        <div class="status-message @(IsError ? "error" : "success")">
            @StatusMessage
        </div>
    }
</div>

@code {
    private string StatusMessage = "";
    private bool IsError = false;
    
    private bool CanSaveLoad()
    {
        // Cannot save/load during tutorial
        return !NarrativeManager.IsNarrativeActive("wayfarer_tutorial");
    }
    
    private async Task SaveGame()
    {
        try
        {
            // Serialize the game state including narrative state
            string serializedState = GameWorldSerializer.SerializeGameWorld(GameWorld, FlagService, NarrativeManager);
            
            // Save to browser local storage
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "wayfarer-save", serializedState);
            
            StatusMessage = "Game saved successfully!";
            IsError = false;
            
            // Clear message after 3 seconds
            _ = Task.Delay(3000).ContinueWith(_ => 
            {
                StatusMessage = "";
                InvokeAsync(StateHasChanged);
            });
        }
        catch (Exception ex)
        {
            StatusMessage = $"Failed to save game: {ex.Message}";
            IsError = true;
        }
    }
    
    private async Task LoadGame()
    {
        try
        {
            // Load from browser local storage
            string serializedState = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "wayfarer-save");
            
            if (string.IsNullOrEmpty(serializedState))
            {
                StatusMessage = "No saved game found";
                IsError = true;
                return;
            }
            
            // Get the current locations and spots
            List<Location> locations = LocationRepository.GetAllLocations();
            List<LocationSpot> spots = LocationSpotRepository.GetAllLocationSpots();
            
            // Deserialize and restore the game world
            GameWorld restoredWorld = GameWorldSerializer.DeserializeGameWorld(
                serializedState, 
                locations, 
                spots, 
                FlagService, 
                NarrativeManager
            );
            
            // Apply the restored state to the current GameWorld
            // Note: This is a bit tricky since GameWorld is a singleton
            // We need to copy the state from the restored world to the current one
            CopyGameWorldState(restoredWorld, GameWorld);
            
            StatusMessage = "Game loaded successfully!";
            IsError = false;
            
            // Clear message after 3 seconds
            _ = Task.Delay(3000).ContinueWith(_ => 
            {
                StatusMessage = "";
                InvokeAsync(StateHasChanged);
            });
        }
        catch (Exception ex)
        {
            StatusMessage = $"Failed to load game: {ex.Message}";
            IsError = true;
        }
    }
    
    private void CopyGameWorldState(GameWorld source, GameWorld target)
    {
        // Copy basic world state
        target.CurrentDay = source.CurrentDay;
        target.CurrentTimeBlock = source.CurrentTimeBlock;
        
        // Copy world state content
        target.WorldState.locations.Clear();
        target.WorldState.locations.AddRange(source.WorldState.locations);
        
        target.WorldState.locationSpots.Clear();
        target.WorldState.locationSpots.AddRange(source.WorldState.locationSpots);
        
        // Copy player state
        Player sourcePlayer = source.GetPlayer();
        Player targetPlayer = target.GetPlayer();
        
        // Initialize player if needed
        if (sourcePlayer.IsInitialized && !targetPlayer.IsInitialized)
        {
            targetPlayer.Initialize(sourcePlayer.Name, sourcePlayer.Archetype, sourcePlayer.Gender);
        }
        
        // Copy player resources
        targetPlayer.Coins = sourcePlayer.Coins;
        targetPlayer.MaxStamina = sourcePlayer.MaxStamina;
        targetPlayer.Stamina = sourcePlayer.Stamina;
        targetPlayer.MaxHealth = sourcePlayer.MaxHealth;
        targetPlayer.Health = sourcePlayer.Health;
        targetPlayer.Level = sourcePlayer.Level;
        targetPlayer.CurrentXP = sourcePlayer.CurrentXP;
        
        // Copy location
        targetPlayer.CurrentLocation = sourcePlayer.CurrentLocation;
        targetPlayer.CurrentLocationSpot = sourcePlayer.CurrentLocationSpot;
        
        // Copy inventory
        targetPlayer.Inventory.Clear();
        foreach (var item in sourcePlayer.Inventory.GetAllItems())
        {
            targetPlayer.Inventory.AddItem(item);
        }
        
        // Copy letter queue
        for (int i = 0; i < sourcePlayer.LetterQueue.Length; i++)
        {
            targetPlayer.LetterQueue[i] = sourcePlayer.LetterQueue[i];
        }
        
        // Copy tokens
        targetPlayer.ConnectionTokens.Clear();
        foreach (var kvp in sourcePlayer.ConnectionTokens)
        {
            targetPlayer.ConnectionTokens[kvp.Key] = kvp.Value;
        }
        
        targetPlayer.NPCTokens.Clear();
        foreach (var npc in sourcePlayer.NPCTokens)
        {
            targetPlayer.NPCTokens[npc.Key] = new Dictionary<ConnectionType, int>(npc.Value);
        }
        
        // Copy carried letters
        targetPlayer.CarriedLetters.Clear();
        targetPlayer.CarriedLetters.AddRange(sourcePlayer.CarriedLetters);
        
        // Copy queue manipulation tracking
        targetPlayer.LastMorningSwapDay = sourcePlayer.LastMorningSwapDay;
        targetPlayer.LastLetterBoardDay = sourcePlayer.LastLetterBoardDay;
        targetPlayer.DailyBoardLetters.Clear();
        targetPlayer.DailyBoardLetters.AddRange(sourcePlayer.DailyBoardLetters);
        
        // Copy letter history
        targetPlayer.NPCLetterHistory.Clear();
        foreach (var kvp in sourcePlayer.NPCLetterHistory)
        {
            targetPlayer.NPCLetterHistory[kvp.Key] = kvp.Value;
        }
        
        // Copy standing obligations
        targetPlayer.StandingObligations.Clear();
        targetPlayer.StandingObligations.AddRange(sourcePlayer.StandingObligations);
        
        // Copy token favor system
        targetPlayer.PurchasedFavors = new List<string>(sourcePlayer.PurchasedFavors);
        targetPlayer.UnlockedLocationIds = new List<string>(sourcePlayer.UnlockedLocationIds);
        targetPlayer.UnlockedServices = new List<string>(sourcePlayer.UnlockedServices);
        
        // Copy delivered letters
        targetPlayer.DeliveredLetters.Clear();
        targetPlayer.DeliveredLetters.AddRange(sourcePlayer.DeliveredLetters);
        targetPlayer.TotalLettersDelivered = sourcePlayer.TotalLettersDelivered;
        targetPlayer.TotalLettersExpired = sourcePlayer.TotalLettersExpired;
        targetPlayer.TotalTokensSpent = sourcePlayer.TotalTokensSpent;
        
        // Copy patron tracking
        targetPlayer.PatronLeverage = sourcePlayer.PatronLeverage;
        
        // Force UI refresh
        StateHasChanged();
    }
}

<style>
    .save-load-panel {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
        margin: 16px 0;
    }
    
    .save-load-panel h4 {
        margin: 0 0 12px 0;
        color: var(--text-primary);
    }
    
    .save-load-buttons {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
    }
    
    .save-button, .load-button {
        padding: 8px 16px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: var(--button-bg);
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .save-button:hover, .load-button:hover {
        background: var(--button-hover-bg);
        border-color: var(--primary-color);
    }
    
    .tutorial-message {
        color: var(--text-muted);
        font-style: italic;
        padding: 8px;
    }
    
    .status-message {
        padding: 8px 12px;
        border-radius: 4px;
        margin-top: 8px;
        font-size: 0.9em;
    }
    
    .status-message.success {
        background: rgba(34, 197, 94, 0.1);
        color: rgb(34, 197, 94);
        border: 1px solid rgba(34, 197, 94, 0.3);
    }
    
    .status-message.error {
        background: rgba(239, 68, 68, 0.1);
        color: rgb(239, 68, 68);
        border: 1px solid rgba(239, 68, 68, 0.3);
    }
</style>