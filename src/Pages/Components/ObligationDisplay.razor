
@inject GameFacade GameFacade
@inject StandingObligationManager ObligationManager

@if (ActiveObligations.Any())
{
    <div class="obligations-panel">
        <div class="obligations-header">
            <span class="icon icon-obligation"></span>
            <span class="header-text">Active Obligations (@ActiveObligations.Count)</span>
        </div>
        
        <div class="obligations-list">
            @foreach (var obligation in ActiveObligations)
            {
                <div class="obligation-card @GetObligationSeverityClass(obligation)">
                    <div class="obligation-name">@obligation.Name</div>
                    <div class="obligation-source">from @obligation.Source</div>
                    
                    <div class="obligation-effects">
                        @foreach (var benefit in GetBenefitDescriptions(obligation))
                        {
                            <div class="effect benefit">
                                <span class="effect-icon">✓</span>
                                <span class="effect-text">@benefit</span>
                            </div>
                        }
                        
                        @foreach (var constraint in GetConstraintDescriptions(obligation))
                        {
                            <div class="effect constraint">
                                <span class="effect-icon">!</span>
                                <span class="effect-text">@constraint</span>
                            </div>
                        }
                    </div>
                    
                    @if (obligation.IsThresholdBased)
                    {
                        <div class="obligation-threshold">
                            @if (obligation.ActivatesAboveThreshold)
                            {
                                <span>Active while tokens ≥ @obligation.ActivationThreshold</span>
                            }
                            else
                            {
                                <span>Active while tokens ≤ @obligation.ActivationThreshold</span>
                            }
                        </div>
                    }
                    
                    <div class="obligation-duration">
                        Active for @obligation.DaysSinceAccepted days
                    </div>
                    
                    <div class="obligation-actions">
                        <button class="break-obligation-btn" 
                                @onclick="() => ShowBreakConfirmation(obligation)"
                                title="Break this obligation (severe consequences)">
                            ⚠️ Break Obligation
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>
}

@if (ShowingConfirmation && ObligationToBreak != null)
{
    <div class="obligation-confirmation-overlay">
        <div class="obligation-confirmation-dialog">
            <div class="confirmation-header">
                <h3>⚠️ Break Obligation: @ObligationToBreak.Name</h3>
            </div>
            
            <div class="confirmation-consequences">
                <h4>Consequences:</h4>
                <ul>
                    <li>Lose @GameRules.OBLIGATION_BREAKING_PENALTY @ObligationToBreak.RelatedTokenType tokens</li>
                    <li>@GetNPCName(ObligationToBreak.RelatedNPCId) becomes HOSTILE</li>
                    <li>Must deliver overdue letters to restore communication</li>
                    <li>Relationship will be permanently scarred</li>
                </ul>
            </div>
            
            <div class="confirmation-actions">
                <button class="btn-danger" @onclick="ConfirmBreakObligation">
                    Yes, Break Obligation
                </button>
                <button class="btn-secondary" @onclick="CancelBreakObligation">
                    Cancel
                </button>
            </div>
        </div>
    </div>
}

@code {
    private List<StandingObligation> ActiveObligations = new List<StandingObligation>();
    private bool ShowingConfirmation = false;
    private StandingObligation? ObligationToBreak = null;
    
    protected override void OnInitialized()
    {
        LoadObligations();
    }
    
    private void LoadObligations()
    {
        ActiveObligations = ObligationManager.GetActiveObligations();
        StateHasChanged();
    }
    
    private string GetObligationSeverityClass(StandingObligation obligation)
    {
        // High tier obligations are more serious
        if (obligation.Tier >= 4) return "obligation-critical";
        if (obligation.Tier >= 3) return "obligation-serious";
        if (obligation.Tier >= 2) return "obligation-moderate";
        return "obligation-minor";
    }
    
    private List<string> GetBenefitDescriptions(StandingObligation obligation)
    {
        var descriptions = new List<string>();
        
        foreach (var effect in obligation.BenefitEffects)
        {
            string desc = GetEffectDescription(effect, obligation);
            if (!string.IsNullOrEmpty(desc))
                descriptions.Add(desc);
        }
        
        return descriptions;
    }
    
    private List<string> GetConstraintDescriptions(StandingObligation obligation)
    {
        var descriptions = new List<string>();
        
        foreach (var effect in obligation.ConstraintEffects)
        {
            string desc = GetEffectDescription(effect, obligation);
            if (!string.IsNullOrEmpty(desc))
                descriptions.Add(desc);
        }
        
        return descriptions;
    }
    
    private string GetEffectDescription(ObligationEffect effect, StandingObligation obligation)
    {
        // Convert categorical effects to human-readable descriptions
        return effect switch
        {
            // Position effects
            ObligationEffect.StatusPriority => "Status letters enter at position 3",
            ObligationEffect.CommercePriority => "Commerce letters enter at position 5",
            ObligationEffect.TrustPriority => "Trust letters enter at position 7",
            ObligationEffect.PatronLettersPosition1 => "Patron letters always position 1",
            ObligationEffect.PatronLettersPosition3 => "Patron letters enter at position 3",
            
            // Payment bonuses
            ObligationEffect.CommerceBonus => "Commerce letters +10 coins",
            ObligationEffect.CommerceBonusPlus3 => "Commerce letters +3 coins",
            ObligationEffect.ShadowTriplePay => "Shadow letters pay triple",
            
            // Deadline effects
            ObligationEffect.TrustFreeExtend => "Can extend Trust letter deadlines freely",
            ObligationEffect.DeadlinePlus2Days => "All letters +2 days deadline",
            
            // Restrictions
            ObligationEffect.NoStatusRefusal => "Cannot refuse Status letters",
            ObligationEffect.NoCommercePurge => "Cannot purge Commerce letters",
            ObligationEffect.TrustSkipDoubleCost => "Skipping Trust letters costs double",
            ObligationEffect.CannotRefuseLetters => "Cannot refuse any letters",
            
            // Forced generation
            ObligationEffect.ShadowForced => "Forced Shadow letter every 3 days",
            ObligationEffect.PatronMonthly => "Monthly patron resource package",
            
            // Leverage modifiers
            ObligationEffect.ShadowEqualsStatus => "Shadow letters use Status priority",
            ObligationEffect.MerchantRespect => "Commerce letters with 5+ tokens get +1 position",
            ObligationEffect.PatronAbsolute => "Patron letters push everything down",
            ObligationEffect.DebtSpiral => "Negative tokens get additional -1 position",
            
            _ => ""
        };
    }
    
    private void ShowBreakConfirmation(StandingObligation obligation)
    {
        ObligationToBreak = obligation;
        ShowingConfirmation = true;
        StateHasChanged();
    }
    
    private void CancelBreakObligation()
    {
        ObligationToBreak = null;
        ShowingConfirmation = false;
        StateHasChanged();
    }
    
    private void ConfirmBreakObligation()
    {
        if (ObligationToBreak == null) return;
        
        // Call the obligation manager to break the obligation
        bool success = ObligationManager.RemoveObligation(ObligationToBreak.ID, isVoluntary: true);
        
        if (success)
        {
            // Refresh the obligations list
            LoadObligations();
        }
        
        // Close the confirmation dialog
        ObligationToBreak = null;
        ShowingConfirmation = false;
        StateHasChanged();
    }
    
    private string GetNPCName(string? npcId)
    {
        if (string.IsNullOrEmpty(npcId)) return "Unknown NPC";
        
        var npc = GameFacade.GetNPCById(npcId);
        return npc?.Name ?? "Unknown NPC";
    }
    
    public void RefreshObligations()
    {
        LoadObligations();
    }
}