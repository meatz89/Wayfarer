@namespace Wayfarer.Pages.Components
@using Microsoft.AspNetCore.Components
@inject GameFacade GameFacade

<div class="readable-letter-display @(IsVisible ? "visible" : "hidden")">
    @if (CurrentLetter != null)
    {
        <div class="readable-letter-container" data-letter-id="@CurrentLetter.Id">
            <div class="readable-letter-header">
                <h3>@CurrentLetter.Name</h3>
                <button class="readable-letter-close" @onclick="CloseLetter">Ã—</button>
            </div>
            
            <div class="readable-letter-content">
                @if (IsReading)
                {
                    <div class="reading-animation">
                        <span class="reading-text">Breaking the seal...</span>
                    </div>
                }
                else if (!string.IsNullOrEmpty(LetterContent))
                {
                    <div class="readable-letter-text">
                        @((MarkupString)LetterContent)
                    </div>
                }
            </div>
            
            @if (ShowEffect)
            {
                <div class="readable-letter-effect">
                    @EffectMessage
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public string ItemId { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private Item CurrentLetter { get; set; }
    private string LetterContent { get; set; }
    private string EffectMessage { get; set; }
    private bool IsVisible { get; set; }
    private bool IsReading { get; set; }
    private bool ShowEffect { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(ItemId))
        {
            await ShowLetter(ItemId);
        }
    }

    private async Task ShowLetter(string itemId)
    {
        CurrentLetter = GameFacade.GetItemById(itemId);
        
        if (CurrentLetter != null && CurrentLetter.IsReadable())
        {
            IsVisible = true;
            IsReading = true;
            StateHasChanged();

            // Simulate breaking the seal
            await Task.Delay(1500);
            
            IsReading = false;
            LetterContent = FormatLetterContent(CurrentLetter.ReadableContent);
            
            // Execute the read command to set flags
            await GameFacade.ReadLetterAsync(itemId);
            
            // Show special effect message if applicable
            if (!string.IsNullOrEmpty(CurrentLetter.ReadFlagToSet))
            {
                await Task.Delay(1000);
                ShowEffect = true;
                EffectMessage = "This letter reveals new possibilities...";
            }
            
            StateHasChanged();
        }
    }

    private string FormatLetterContent(string content)
    {
        if (string.IsNullOrEmpty(content))
            return "<em>The letter contains no readable text.</em>";
            
        // Convert newlines to HTML breaks and wrap paragraphs
        var paragraphs = content.Split(new[] { "\n\n" }, StringSplitOptions.RemoveEmptyEntries);
        var formatted = string.Join("", paragraphs.Select(p => 
            $"<p>{p.Replace("\n", "<br/>")}</p>"
        ));
        
        return formatted;
    }

    private async Task CloseLetter()
    {
        IsVisible = false;
        CurrentLetter = null;
        LetterContent = null;
        ShowEffect = false;
        StateHasChanged();
        
        await OnClose.InvokeAsync();
    }

}