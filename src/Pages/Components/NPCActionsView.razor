@inherits ComponentBase

<div class="npc-actions-view">
    @if (SelectedNPC == null)
    {
        <div class="no-content">
            <p>Select an NPC to see available actions.</p>
        </div>
    }
    else
    {
        var actions = GetActionsForNPC();
        
        <div class="npc-header">
            <div class="npc-info">
                <span class="npc-name">@SelectedNPC.Name</span>
                <span class="npc-role">@SelectedNPC.Profession.ToString().Replace("_", " ")</span>
            </div>
            @if (SelectedNPC.IsAvailable(CurrentTime))
            {
                <span class="availability-indicator available">‚óè</span>
            }
            else
            {
                <span class="availability-indicator unavailable">‚óè</span>
            }
        </div>
        
        @if (actions.Any())
        {
            <div class="npc-actions">
                @foreach (var action in actions)
                {
                    <div class="action-with-preview">
                        <button class="npc-action-button @(CanAffordAction(action) ? "" : "disabled")" 
                                disabled="@(!CanAffordAction(action))"
                                @onclick="@(() => ExecuteAction(action.Id))">
                            <span class="action-text">@GetActionVerb(action)</span>
                            @if (action.TimeCost > 0 || action.StaminaCost > 0 || action.CoinCost > 0)
                            {
                                <span class="action-costs-inline">
                                    @if (action.TimeCost > 0)
                                    {
                                        <span class="cost-inline @(action.HasEnoughTime ? "" : "insufficient")">@action.TimeCost‚è∞</span>
                                    }
                                    @if (action.StaminaCost > 0)
                                    {
                                        <span class="cost-inline @(action.HasEnoughStamina ? "" : "insufficient")">@action.StaminaCostüí™</span>
                                    }
                                    @if (action.CoinCost > 0)
                                    {
                                        <span class="cost-inline @(action.HasEnoughCoins ? "" : "insufficient")">@action.CoinCostü™ô</span>
                                    }
                                </span>
                            }
                        </button>
                        
                        
                        @{
                            var tokenChanges = GetTokenChangesForAction(action, SelectedNPC.ID);
                        }
                        @if (tokenChanges != null && tokenChanges.Any())
                        {
                            <TokenTransactionPreview TokenChanges="@tokenChanges" ShowEffects="false" ShowNetEffect="false" />
                        }
                        
                        @if (action.TimeCost > 0)
                        {
                            var timeImpact = TimeCalculator.CalculateTimeImpact(action.TimeCost);
                            <ActionTimePreview Hours="@timeImpact.Hours"
                                               CurrentTimeBlock="@timeImpact.CurrentTimeBlock"
                                               ResultTimeBlock="@timeImpact.ResultTimeBlock"
                                               WouldAdvanceDay="@timeImpact.WouldAdvanceDay"
                                               LettersExpiring="@timeImpact.LettersExpiring"
                                               ShowDeadlineWarning="true"
                                               ShowTimeProgression="true" />
                        }
                    </div>
                }
                
                @* Special Letter Options *@
                @{
                    var specialOptions = SpecialLetterService.GetAvailableSpecialLetters(SelectedNPC.ID);
                }
                @if (specialOptions.Any() && SelectedNPC.IsAvailable(CurrentTime))
                {
                    <div class="location-actions-section">
                            <h3>Special Letters</h3>
                            @foreach (var option in specialOptions)
                            {
                                <div class="action-with-preview">
                                    <button class="npc-action-button @(option.CanAfford ? "" : "disabled")"
                                            disabled="@(!option.CanAfford)"
                                            @onclick="@(() => RequestSpecialLetter(SelectedNPC.ID, option.TokenType))">
                                        <span class="action-text">
                                            @GetSpecialLetterIcon(option.SpecialType.ToString()) Request @option.SpecialType
                                        </span>
                                        <span class="action-costs-inline">
                                            <span class="cost-inline">1‚è∞</span>
                                            <span class="cost-inline @(option.CanAfford ? "" : "insufficient")">
                                                @option.Cost @GetTokenIcon(option.TokenType)
                                            </span>
                                        </span>
                                    </button>
                                    <TokenTransactionPreview TokenChanges="@GetSpecialLetterTokenCost(SelectedNPC.ID, option)" ShowEffects="true" ShowNetEffect="false" />
                                    @{
                                        var timeImpact = TimeCalculator.CalculateTimeImpact(1);
                                    }
                                    <ActionTimePreview Hours="1"
                                                       CurrentTimeBlock="@timeImpact.CurrentTimeBlock"
                                                       ResultTimeBlock="@timeImpact.ResultTimeBlock"
                                                       WouldAdvanceDay="@timeImpact.WouldAdvanceDay"
                                                       LettersExpiring="@timeImpact.LettersExpiring"
                                                       ShowDeadlineWarning="true"
                                                       ShowTimeProgression="false" />
                                </div>
                            }
                        </div>
                }
            </div>
        }
        else if (SelectedNPC.IsAvailable(CurrentTime))
        {
            <div class="no-actions-message">
                <p>No actions available with @SelectedNPC.Name right now.</p>
            </div>
        }
        else
        {
            <div class="unavailable-message">
                <p>@SelectedNPC.Name is not available at this time.</p>
            </div>
        }
    }
</div>