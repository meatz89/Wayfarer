@inject ItemRepository ItemRepository

<div class="transport-selector">
    <h4>Select Transport Method</h4>
    
    <div class="transport-options">
        @foreach (var option in GetAvailableTransportOptions())
        {
            <div class="transport-option @(option.IsSelected ? "selected" : "") @(!option.IsAvailable ? "disabled" : "")"
                 @onclick="() => SelectTransport(option)">
                <div class="transport-header">
                    <span class="transport-icon">@GetTransportIcon(option.Method)</span>
                    <span class="transport-name">@option.Method</span>
                </div>
                
                <div class="transport-details">
                    <div class="transport-stats">
                        <span class="stat">‚è±Ô∏è @GetTimeMultiplier(option.Method)x time</span>
                        <span class="stat">‚ö° @GetStaminaMultiplier(option.Method)x stamina</span>
                        @if (GetCoinCost(option.Method) > 0)
                        {
                            <span class="stat">ü™ô +@GetCoinCost(option.Method) coins</span>
                        }
                    </div>
                    
                    @if (!option.IsAvailable)
                    {
                        <div class="unavailable-reason">
                            @option.UnavailableReason
                        </div>
                    }
                    else if (option.Warnings.Any())
                    {
                        <div class="transport-warnings">
                            @foreach (var warning in option.Warnings)
                            {
                                <div class="warning">‚ö†Ô∏è @warning</div>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public RouteOption Route { get; set; }
    [Parameter] public Player Player { get; set; }
    [Parameter] public TravelMethods SelectedTransport { get; set; } = TravelMethods.Walking;
    [Parameter] public EventCallback<TravelMethods> OnTransportSelected { get; set; }
    
    private TransportCompatibilityValidator _validator;
    
    protected override void OnInitialized()
    {
        _validator = new TransportCompatibilityValidator(ItemRepository);
    }
    
    private List<TransportOption> GetAvailableTransportOptions()
    {
        var options = new List<TransportOption>();
        
        foreach (TravelMethods method in Enum.GetValues<TravelMethods>())
        {
            var compatibility = _validator.CheckFullCompatibility(method, Route, Player);
            
            options.Add(new TransportOption
            {
                Method = method,
                IsAvailable = compatibility.IsCompatible && HasRequiredEquipment(method),
                IsSelected = method == SelectedTransport,
                UnavailableReason = GetUnavailableReason(method, compatibility),
                Warnings = compatibility.Warnings ?? new List<string>()
            });
        }
        
        return options;
    }
    
    private bool HasRequiredEquipment(TravelMethods method)
    {
        var playerItems = GetPlayerItems();
        
        return method switch
        {
            TravelMethods.Walking => true,
            TravelMethods.Horseback => playerItems.Any(i => i.Name.Contains("Horse", StringComparison.OrdinalIgnoreCase)),
            TravelMethods.Cart => playerItems.Any(i => i.Name.Contains("Cart", StringComparison.OrdinalIgnoreCase)),
            TravelMethods.Carriage => playerItems.Any(i => i.Name.Contains("Carriage", StringComparison.OrdinalIgnoreCase)),
            TravelMethods.Boat => playerItems.Any(i => i.Categories.Contains(ItemCategory.Water_Transport)),
            _ => false
        };
    }
    
    private string GetUnavailableReason(TravelMethods method, TransportCompatibilityResult compatibility)
    {
        if (!compatibility.IsCompatible)
            return compatibility.BlockingReason;
            
        if (!HasRequiredEquipment(method))
        {
            return method switch
            {
                TravelMethods.Horseback => "Requires a horse",
                TravelMethods.Cart => "Requires a cart",
                TravelMethods.Carriage => "Requires a carriage",
                TravelMethods.Boat => "Requires water transport equipment",
                _ => "Not available"
            };
        }
        
        return "";
    }
    
    private List<Item> GetPlayerItems()
    {
        var items = new List<Item>();
        
        foreach (string itemId in Player.Inventory.ItemSlots)
        {
            if (!string.IsNullOrEmpty(itemId))
            {
                var item = ItemRepository.GetItemById(itemId);
                if (item != null)
                {
                    items.Add(item);
                }
            }
        }
        
        return items;
    }
    
    private void SelectTransport(TransportOption option)
    {
        if (option.IsAvailable)
        {
            SelectedTransport = option.Method;
            OnTransportSelected.InvokeAsync(option.Method);
        }
    }
    
    private string GetTransportIcon(TravelMethods method)
    {
        return method switch
        {
            TravelMethods.Walking => "üö∂",
            TravelMethods.Horseback => "üêé",
            TravelMethods.Cart => "üõí",
            TravelMethods.Carriage => "üöå",
            TravelMethods.Boat => "‚õµ",
            _ => "‚ùì"
        };
    }
    
    private double GetTimeMultiplier(TravelMethods method)
    {
        return method switch
        {
            TravelMethods.Walking => 1.0,
            TravelMethods.Horseback => 0.5,
            TravelMethods.Cart => 0.8,
            TravelMethods.Carriage => 0.4,
            TravelMethods.Boat => 0.6,
            _ => 1.0
        };
    }
    
    private double GetStaminaMultiplier(TravelMethods method)
    {
        return method switch
        {
            TravelMethods.Walking => 1.0,
            TravelMethods.Horseback => 0.7,
            TravelMethods.Cart => 1.2,
            TravelMethods.Carriage => 0.3,
            TravelMethods.Boat => 0.5,
            _ => 1.0
        };
    }
    
    private int GetCoinCost(TravelMethods method)
    {
        return method switch
        {
            TravelMethods.Walking => 0,
            TravelMethods.Horseback => 0,
            TravelMethods.Cart => 0,
            TravelMethods.Carriage => 5,
            TravelMethods.Boat => 3,
            _ => 0
        };
    }
    
    private class TransportOption
    {
        public TravelMethods Method { get; set; }
        public bool IsAvailable { get; set; }
        public bool IsSelected { get; set; }
        public string UnavailableReason { get; set; }
        public List<string> Warnings { get; set; } = new();
    }
}

