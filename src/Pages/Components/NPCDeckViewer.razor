@using System.Collections.Generic
@using System.Linq

@namespace Wayfarer.Pages.Components

<HeadContent>
    <link href="css/debug.css" rel="stylesheet" />
</HeadContent>

<div class="deck-viewer">
    <div class="deck-viewer-header">
        <button class="back-button" @onclick="GoBack"><span class="icon-arrow-left"></span> Back to Location</button>
        <h2>NPC Deck Viewer - Development Mode</h2>
        @if (CurrentNPC != null)
        {
            <div class="npc-info">
                <span class="npc-name">@CurrentNPC.Name</span>
                <span class="npc-id">ID: @CurrentNPC.ID</span>
                <span class="npc-personality">@CurrentNPC.PersonalityType</span>
            </div>
        }
    </div>
    
    @if (CurrentNPC == null)
    {
        <div class="error-message">NPC not found!</div>
    }
    else
    {
        <!-- Available Conversation Types Panel -->
        <div class="conversation-availability-panel">
            <h3>Available Conversation Types</h3>
            <div class="conversation-types-grid">
                @* Quick Exchange - enabled by Exchange Deck *@
                <div class="conversation-type-card @(HasExchangeCards ? "enabled" : "disabled")">
                    <div class="conversation-type-header">
                        <span class="type-name">Quick Exchange</span>
                        <span class="attention-cost">0 attention</span>
                    </div>
                    <div class="enabling-condition">
                        @if (HasExchangeCards)
                        {
                            <span class="enabled-by"><span class="icon-check"></span> Exchange Deck (@(CurrentNPC.ExchangeDeck?.Count ?? 0) cards)</span>
                        }
                        else
                        {
                            <span class="disabled-reason"><span class="icon-close"></span> No exchange cards</span>
                        }
                    </div>
                    <div class="type-description">
                        Instant resource trades. No doubt accumulated.
                    </div>
                </div>

                @* Standard Talk - always available *@
                <div class="conversation-type-card enabled">
                    <div class="conversation-type-header">
                        <span class="type-name">Talk</span>
                        <span class="attention-cost">2 attention</span>
                    </div>
                    <div class="enabling-condition">
                        <span class="enabled-by"><span class="icon-check"></span> Always available</span>
                    </div>
                    <div class="type-description">
                        Standard conversation with full mechanics.
                    </div>
                </div>

                @* Future: Make Amends - enabled by 2+ burden cards *@
                <div class="conversation-type-card disabled future">
                    <div class="conversation-type-header">
                        <span class="type-name">Make Amends</span>
                        <span class="attention-cost">2 attention</span>
                    </div>
                    <div class="enabling-condition">
                        <span class="disabled-reason"><span class="icon-close"></span> Requires 2+ burden cards (not implemented)</span>
                    </div>
                    <div class="type-description">
                        Address past wrongs and repair relationships.
                    </div>
                </div>

                @* Future: Deep Conversation - enabled by relationship level 3+ *@
                <div class="conversation-type-card disabled future">
                    <div class="conversation-type-header">
                        <span class="type-name">Deep Conversation</span>
                        <span class="attention-cost">3 attention</span>
                    </div>
                    <div class="enabling-condition">
                        <span class="disabled-reason"><span class="icon-close"></span> Requires relationship level 3+ (not implemented)</span>
                    </div>
                    <div class="type-description">
                        Extended intimate conversation with trusted friends.
                    </div>
                </div>
            </div>
        </div>

        <div class="decks-container">
            <!-- One-Time Requests -->
            <div class="deck-section request-deck-section @(HasRequestCards ? "has-requests" : "")">
                <h3>One-Time Requests (@(TotalRequestCards) requests)</h3>
                <div class="deck-purpose">
                    NPCs can have multiple thematic requests. Each request contains request cards (at different momentum thresholds) and promise cards.
                    <span class="urgency-rule"><span class="icon-warning"></span> Promise Cards: Force queue position 1 and burn tokens for instant momentum!</span>
                </div>
                
                @if (CurrentNPC.Requests != null && CurrentNPC.Requests.Any())
                {
                    @foreach (var request in CurrentNPC.Requests)
                    {
                        <div class="request-group">
                            <h4 class="request-header">@request.Name (@request.Status)</h4>
                            <div class="request-description">@request.Description</div>
                            
                            @{
                                var requestCards = NPCRepository.GetRequestCards(request);
                            }
                            @if (requestCards.Any())
                            {
                                <h5>Request Cards (@requestCards.Count):</h5>
                                <div class="card-list">
                                    @foreach (var card in requestCards)
                                    {
                                        <div class="debug-card letter-card request-card">
                                            <div class="card-header">
                                                <span class="card-id">@card.Id</span>
                                                <span class="card-name">@(card.Description ?? card.Id)</span>
                                                <span class="request-type-badge">REQUEST</span>
                                            </div>
                                            <div class="card-properties">
                                                <span>Momentum Required: @card.MomentumThreshold</span>
                                                <span>Focus: @card.Focus</span>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            
                            @{
                                var promiseCards = NPCRepository.GetPromiseCards(request);
                            }
                            @if (promiseCards.Any())
                            {
                                <h5>Promise Cards (@promiseCards.Count):</h5>
                                <div class="card-list">
                                    @foreach (var card in promiseCards)
                                    {
                                        <div class="debug-card promise-card">
                                            <div class="card-header">
                                                <span class="card-id">@card.Id</span>
                                                <span class="card-name">@(card.Description ?? card.Id)</span>
                                                <span class="request-type-badge">PROMISE</span>
                                            </div>
                                            <div class="card-properties">
                                                <span>Queue Position: @card.QueuePosition</span>
                                                <span>Instant Momentum: @card.InstantMomentum per token</span>
                                                <span>Focus: @card.Focus</span>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                }
                
                @if (!HasRequestCards)
                {
                    <div class="empty-deck">No one-time requests configured</div>
                }
            </div>

            <!-- Exchange Deck -->
            <div class="deck-section exchange-deck-section @(HasExchangeCards ? "has-exchanges" : "")">
                <h3>Exchange Deck (@(CurrentNPC.ExchangeDeck?.Count ?? 0) cards)</h3>
                <div class="deck-purpose">Simple instant trades for Quick Exchange conversations (0 attention)</div>
                @if (CurrentNPC.ExchangeDeck != null && CurrentNPC.ExchangeDeck.Any())
                {
                    <div class="card-list">
                        @foreach (var card in CurrentNPC.ExchangeDeck)
                        {
                            <div class="debug-card exchange-card">
                                <div class="card-header">
                                    <span class="card-id">@card.Id</span>
                                    <span class="card-name">@card.Id</span>
                                </div>
                                <div class="exchange-details">
                                    <div class="costs">
                                        <h4>Costs:</h4>
                                        <div>Exchange costs defined in effects</div>
                                    </div>
                                    <div class="exchange-info">
                                        <h4>Exchange Properties:</h4>
                                        <div>ExchangeType: @card.ExchangeType</div>
                                        <div>Success Rate: @card.SuccessRate%</div>
                                        <div>Single Use: @card.SingleUse</div>
                                    </div>
                                </div>
                                @* TodaysExchangeCard property was removed - exchanges are selected dynamically *@
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="empty-deck">No exchange cards (only Mercantile NPCs have exchanges)</div>
                }
            </div>
        </div>
    }
</div>

@code {
    [CascadingParameter] public GameScreenBase GameScreen { get; set; }
    [Inject] private NPCRepository NPCRepository { get; set; }
    [Inject] private GameFacade GameFacade { get; set; }

    private NPC CurrentNPC { get; set; }

    // Computed properties for conversation availability
    private bool HasExchangeCards => CurrentNPC?.ExchangeDeck?.Any() == true;
    private bool HasRequestCards => CurrentNPC?.Requests?.Any() == true;
    private int TotalRequestCards => CurrentNPC?.Requests?.Count ?? 0;
    
    protected override void OnInitialized()
    {
        LoadNPCData();
    }
    
    private void LoadNPCData()
    {
        if (string.IsNullOrEmpty(GameScreen?.CurrentDeckViewerNpcId))
        {
            Console.WriteLine("[NPCDeckViewer] No NPC ID provided");
            return;
        }

        CurrentNPC = NPCRepository.GetById(GameScreen.CurrentDeckViewerNpcId);
        if (CurrentNPC == null)
        {
            Console.WriteLine($"[NPCDeckViewer] NPC not found: {GameScreen.CurrentDeckViewerNpcId}");
            return;
        }

    }

    private void GoBack()
    {
        _ = GameScreen?.NavigateToScreen(ScreenMode.Location);
    }
    
    private string GetCategoryClass(CardInstance card)
    {
        // Determine category based on card type
        if (card.CardType == CardType.Observation)
            return "observation";
        if (card.CardType == CardType.Letter || card.CardType == CardType.Promise || card.CardType == CardType.Letter)
            return "promise";
        if (card.CardType == CardType.Letter)
            return "burden";
        
        return "flow"; // Default
    }
    
    private string GetPersistenceText(CardInstance card)
    {
        if (card.Persistence == PersistenceType.Standard) return "Standard";
        if (card.Persistence == PersistenceType.Banish) return "Banish";
        return "";
    }
    
    private string GetCategoryText(CardInstance card)
    {
        // Determine category display text based on card type
        if (card.CardType == CardType.Observation)
            return "OBSERVATION";
        if (card.CardType == CardType.Letter || card.CardType == CardType.Promise || card.CardType == CardType.Letter)
            return "PROMISE";
        if (card.CardType == CardType.Letter)
            return "BURDEN";

        return "FLOW"; // Default
    }
}