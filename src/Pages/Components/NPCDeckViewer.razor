@using System.Collections.Generic
@using System.Linq

@namespace Wayfarer.Pages.Components

<div class="deck-viewer">
    <div class="deck-viewer-header">
        <button class="back-button" @onclick="GoBack">← Back to Location</button>
        <h2>NPC Deck Viewer - Development Mode</h2>
        @if (CurrentNPC != null)
        {
            <div class="npc-info">
                <span class="npc-name">@CurrentNPC.Name</span>
                <span class="npc-id">ID: @CurrentNPC.ID</span>
                <span class="npc-personality">@CurrentNPC.PersonalityType</span>
            </div>
        }
    </div>
    
    @if (CurrentNPC == null)
    {
        <div class="error-message">NPC not found!</div>
    }
    else
    {
        <!-- Available Conversation Types Panel -->
        <div class="conversation-availability-panel">
            <h3>Available Conversation Types</h3>
            <div class="conversation-types-grid">
                @* Quick Exchange - enabled by Exchange Deck *@
                <div class="conversation-type-card @(HasExchangeCards ? "enabled" : "disabled")">
                    <div class="conversation-type-header">
                        <span class="type-name">Quick Exchange</span>
                        <span class="attention-cost">0 attention</span>
                    </div>
                    <div class="enabling-condition">
                        @if (HasExchangeCards)
                        {
                            <span class="enabled-by">✓ Exchange Deck (@(CurrentNPC.ExchangeDeck?.Count ?? 0) cards)</span>
                        }
                        else
                        {
                            <span class="disabled-reason">✗ No exchange cards</span>
                        }
                    </div>
                    <div class="type-description">
                        Instant resource trades. No patience required.
                    </div>
                </div>

                @* Standard Talk - always available *@
                <div class="conversation-type-card enabled">
                    <div class="conversation-type-header">
                        <span class="type-name">Talk</span>
                        <span class="attention-cost">2 attention</span>
                    </div>
                    <div class="enabling-condition">
                        <span class="enabled-by">✓ Always available</span>
                    </div>
                    <div class="type-description">
                        Standard conversation with full mechanics.
                    </div>
                </div>

                @* Future: Make Amends - enabled by 2+ burden cards *@
                <div class="conversation-type-card disabled future">
                    <div class="conversation-type-header">
                        <span class="type-name">Make Amends</span>
                        <span class="attention-cost">2 attention</span>
                    </div>
                    <div class="enabling-condition">
                        <span class="disabled-reason">✗ Requires 2+ burden cards (not implemented)</span>
                    </div>
                    <div class="type-description">
                        Address past wrongs and repair relationships.
                    </div>
                </div>

                @* Future: Deep Conversation - enabled by relationship level 3+ *@
                <div class="conversation-type-card disabled future">
                    <div class="conversation-type-header">
                        <span class="type-name">Deep Conversation</span>
                        <span class="attention-cost">3 attention</span>
                    </div>
                    <div class="enabling-condition">
                        <span class="disabled-reason">✗ Requires relationship level 3+ (not implemented)</span>
                    </div>
                    <div class="type-description">
                        Extended intimate conversation with trusted friends.
                    </div>
                </div>
            </div>
        </div>

        <div class="decks-container">
            <!-- Conversation Deck -->
            <div class="deck-section conversation-deck-section">
                <h3>Conversation Deck (@(ConversationCards?.Count ?? 0) cards)</h3>
                <div class="deck-purpose">Contains flow, state, and token cards for standard conversations</div>
                @if (ConversationCards != null && ConversationCards.Any())
                {
                    <div class="card-list">
                        @foreach (var card in ConversationCards.OrderBy(c => c.Focus))
                        {
                            <div class="debug-card conversation-card">
                                <div class="card-header">
                                    <span class="card-id">@card.Id</span>
                                    <span class="card-name">@(card.Description ?? card.Id)</span>
                                    <span class="card-category @GetCategoryClass(card)">@GetCategoryName(card)</span>
                                </div>
                                <div class="card-properties">
                                    <span>Token: @card.TokenType</span>
                                    <span>Focus: @card.Focus</span>
                                    <span>Persistence: @GetPersistenceText(card)</span>
                                </div>
                                <div class="card-text">@(card.Description ?? "Template: " + card.Id)</div>
                                <div class="card-outcomes">
                                    <div class="outcome success">
                                        <span>Success Effect</span>
                                        @if (card.SuccessEffect != null && !card.SuccessEffect.IsEmpty)
                                        {
                                            <span>@card.SuccessEffect.ToString()</span>
                                        }
                                    </div>
                                    <div class="outcome failure">
                                        <span>Failure Effect</span>
                                        @if (card.FailureEffect != null && !card.FailureEffect.IsEmpty)
                                        {
                                            <span>@card.FailureEffect.ToString()</span>
                                        }
                                        else
                                        {
                                            <span>No effect</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="empty-deck">No conversation cards</div>
                }
            </div>

            <!-- Request Deck (Letters + Crisis) -->
            <div class="deck-section request-deck-section @(HasRequestCards ? "has-requests" : "")">
                <h3>Request Deck (@(TotalRequestCards) cards total)</h3>
                <div class="deck-purpose">
                    Contains letter and crisis requests. Only ONE request card can be drawn per conversation.
                    <span class="urgency-rule">⚠ Request Urgency Rule: Once drawn, must be played within 1 turn or conversation fails!</span>
                </div>
                
                @if (CurrentNPC.RequestDeck != null && CurrentNPC.RequestDeck.Any())
                {
                    <h4 class="sub-deck-header">Letter Requests (@(CurrentNPC.RequestDeck.Count) cards)</h4>
                    <div class="card-list">
                        @foreach (var card in CurrentNPC.RequestDeck.GetAllCards())
                        {
                            <div class="debug-card letter-card request-card">
                                <div class="card-header">
                                    <span class="card-id">@card.Id</span>
                                    <span class="card-name">@(card.Description ?? card.Id)</span>
                                    <span class="request-type-badge">LETTER REQUEST</span>
                                </div>
                                <div class="card-properties">
                                    <span>Template: @card.Id</span>
                                    <span>Focus: @card.Focus</span>
                                </div>
                                <div class="eligibility">
                                    <h4>Eligibility Requirements:</h4>
                                    @if (card.Context?.ValidStates?.Any() == true)
                                    {
                                        <div>Valid States: @string.Join(", ", card.Context.ValidStates)</div>
                                    }
                                </div>
                                <div class="negotiation">
                                    <h4>Request Card Properties:</h4>
                                    <div>Type: @card.RequestCardType</div>
                                    <div>Category: @card.Category</div>
                                    <div>Focus: @card.Focus</div>
                                </div>
                            </div>
                        }
                    </div>
                }
                
                @if (!HasRequestCards)
                {
                    <div class="empty-deck">No request cards (letters or crisis)</div>
                }
            </div>

            <!-- Exchange Deck -->
            <div class="deck-section exchange-deck-section @(HasExchangeCards ? "has-exchanges" : "")">
                <h3>Exchange Deck (@(CurrentNPC.ExchangeDeck?.Count ?? 0) cards)</h3>
                <div class="deck-purpose">Simple instant trades for Quick Exchange conversations (0 attention)</div>
                @if (CurrentNPC.ExchangeDeck != null && CurrentNPC.ExchangeDeck.Any())
                {
                    <div class="card-list">
                        @foreach (var card in CurrentNPC.ExchangeDeck.GetAllCards())
                        {
                            <div class="debug-card exchange-card">
                                <div class="card-header">
                                    <span class="card-id">@card.Id</span>
                                    <span class="card-name">@card.Id</span>
                                </div>
                                <div class="exchange-details">
                                    <div class="costs">
                                        <h4>Costs:</h4>
                                        <div>Exchange costs defined in effects</div>
                                    </div>
                                    <div class="exchange-info">
                                        <h4>Exchange Properties:</h4>
                                        <div>Category: @card.Category</div>
                                        <div>Type: @card.Type</div>
                                        <div>Focus: @card.Focus</div>
                                    </div>
                                </div>
                                @* TodaysExchangeCard property was removed - exchanges are selected dynamically *@
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="empty-deck">No exchange cards (only Mercantile NPCs have exchanges)</div>
                }
            </div>
        </div>
    }
</div>

@code {
    [CascadingParameter] public GameScreenBase GameScreen { get; set; }
    [Inject] private NPCRepository NPCRepository { get; set; }
    
    private NPC CurrentNPC { get; set; }
    private List<ConversationCard> ConversationCards { get; set; }
    
    // Computed properties for conversation availability
    private bool HasExchangeCards => CurrentNPC?.ExchangeDeck?.Any() == true;
    private bool HasRequestCards => (CurrentNPC?.RequestDeck?.Any() == true);
    private int TotalRequestCards => (CurrentNPC?.RequestDeck?.Count ?? 0);
    
    protected override void OnInitialized()
    {
        LoadNPCData();
    }
    
    private void LoadNPCData()
    {
        if (string.IsNullOrEmpty(GameScreen?.CurrentDeckViewerNpcId))
        {
            Console.WriteLine("[NPCDeckViewer] No NPC ID provided");
            return;
        }
        
        CurrentNPC = NPCRepository.GetById(GameScreen.CurrentDeckViewerNpcId);
        if (CurrentNPC == null)
        {
            Console.WriteLine($"[NPCDeckViewer] NPC not found: {GameScreen.CurrentDeckViewerNpcId}");
            return;
        }
        
        // Get conversation cards
        if (CurrentNPC.ConversationDeck != null)
        {
            ConversationCards = CurrentNPC.ConversationDeck.GetAllCards().Cast<ConversationCard>().ToList();
        }
    }
    
    private void GoBack()
    {
        _ = GameScreen?.NavigateToScreen(ScreenMode.Location);
    }
    
    private string GetCategoryClass(ConversationCard card)
    {
        // Determine category based on card properties since Category enum is removed
        if (card.Properties.Contains(CardProperty.Exchange))
            return "exchange";
        if (card.IsObservable)
            return "observation";
        if (card.Properties.Contains(CardProperty.DeliveryEligible))
            return "promise";
        if (card.IsBurden)
            return "burden";
        
        return "flow"; // Default
    }
    
    private string GetPersistenceText(ConversationCard card)
    {
        if (card.IsImpulse && card.IsOpening) return "Request";  // Both properties = Request
        if (card.IsImpulse) return "Impulse";
        if (card.IsOpening) return "Opening";
        if (card.IsPersistent) return "Persistent";
        return "";
    }
    
    private string GetCategoryName(ConversationCard card)
    {
        // Determine category name based on card properties since Category enum is removed
        if (card.Properties.Contains(CardProperty.Exchange))
            return "EXCHANGE";
        if (card.IsObservable)
            return "OBSERVATION";
        if (card.Properties.Contains(CardProperty.DeliveryEligible))
            return "PROMISE";
        if (card.IsBurden)
            return "BURDEN";
        
        return "FLOW"; // Default
    }
}