@inherits ConversationContentBase

@namespace Wayfarer.Pages.Components

@* ARCHITECTURAL PRINCIPLE: Screen components (LocationContent, ConversationContent, etc.) are rendered INSIDE GameScreen's game-container.
   They must NEVER define their own game-container, header, or resource bars - those are managed by the parent GameScreen.
   Screen components should only contain their specific content wrapped in a semantic class like 'conversation-content'. *@

@if (Session != null)
{
    <div class="conversation-content">
        <!-- Location context bar -->
        <div class="location-context">
            <span>@GetLocationContext()</span>
        </div>

        @if ((Context?.Type ?? ConversationType.FriendlyChat) != ConversationType.Commerce)
        {
            <!-- NPC Bar -->
            <div class="npc-bar">
                <div class="npc-info">
                    <div class="npc-name">@NpcName</div>
                    <div class="npc-status">@GetNpcStatusLine()</div>
                </div>
                <div class="patience-display">
                    <div class="patience-label">Patience</div>
                    <div class="patience-value">@Session.CurrentPatience/@Session.MaxPatience</div>
                </div>
            </div>

            <!-- State and Flow Section (Grouped) -->
            <div class="state-flow-section">
                <div class="emotional-state">
                    <span class="state-label">Emotional State:</span>
                    <span class="state-name">@GetEmotionalStateDisplay()</span>
                    <span class="state-effects">(@GetEmotionalStateInfo())</span>
                </div>
                
                <div class="flow-display">
                    <span class="flow-label">Flow:</span>
                    <div class="flow-bar">
                        <span class="flow-segment @(Session.FlowBattery <= -3 ? "negative" : "") @(Session.FlowBattery == -3 ? "current" : "")"></span>
                        <span class="flow-segment @(Session.FlowBattery <= -2 ? "negative" : "") @(Session.FlowBattery == -2 ? "current" : "")"></span>
                        <span class="flow-segment @(Session.FlowBattery <= -1 ? "negative" : "") @(Session.FlowBattery == -1 ? "current" : "")"></span>
                        <span class="flow-segment @(Session.FlowBattery == 0 ? "current" : "")"></span>
                        <span class="flow-segment @(Session.FlowBattery >= 1 ? "positive" : "") @(Session.FlowBattery == 1 ? "current" : "")"></span>
                        <span class="flow-segment @(Session.FlowBattery >= 2 ? "positive" : "") @(Session.FlowBattery == 2 ? "current" : "")"></span>
                        <span class="flow-segment @(Session.FlowBattery >= 3 ? "positive" : "") @(Session.FlowBattery == 3 ? "current" : "")"></span>
                    </div>
                    <span class="flow-value">@Session.FlowBattery</span>
                    @if (Session.CurrentState == EmotionalState.DESPERATE && Session.FlowBattery <= -2)
                    {
                        <span class="flow-warning">One more failure ends conversation!</span>
                    }
                </div>
            </div>

            <!-- Atmosphere and Rapport Bar -->
            <div class="atmosphere-rapport-bar">
                <div class="atmosphere-display">
                    <span class="atmosphere-label">Atmosphere:</span>
                    <span class="atmosphere-current">@GetCurrentAtmosphereDisplay()</span>
                    <span class="atmosphere-effect">(@GetAtmosphereEffectDescription())</span>
                </div>
                
                <div class="rapport-display">
                    <span class="rapport-label">Rapport:</span>
                    <span class="rapport-value">@(Session?.RapportManager?.CurrentRapport ?? 0)</span>
                    <span class="rapport-effect">(+@(Session?.RapportManager?.GetSuccessModifier() ?? 0)% all cards)</span>
                </div>
            </div>
        }

    <!-- CENTRAL: Narrative Section (from mockup) -->
    <div class="narrative-section">
        @if (!string.IsNullOrEmpty(LastNarrative))
        {
            <div class="narrative-text">
                @LastNarrative
            </div>
        }
        @if (!string.IsNullOrEmpty(LastDialogue))
        {
            <div class="npc-dialogue @GetStateClass()">
                "@LastDialogue"
            </div>
        }
    </div>

    <!-- Action Choice (from mockup) -->
    <div class="action-section">
        @if ((Context?.Type ?? ConversationType.FriendlyChat) == ConversationType.Commerce)
        {
            <!-- Quick Exchanges: Select a card then SPEAK to accept it -->
            <div class="turn-indicator">Select an exchange card to trade</div>
            <div class="action-choices">
                <div class="action-button" @onclick="ExecuteSpeak" disabled="@(!CanSpeak() || IsProcessing)">
                    <div>TRADE</div>
                    <div class="action-details">@GetSpeakDetails()</div>
                </div>
                <div class="action-button exit-button" @onclick="ExitConversation">
                    <div>EXIT</div>
                    <div class="action-details">Leave without trading</div>
                </div>
            </div>
        }
        else if (!IsConversationExhausted)
        {
            <div class="action-choices">
                <div class="action-button @(ShowListenPreview ? "preview-active" : "")" 
                     @onclick="ExecuteListen" 
                     @onmouseenter="ShowListenPreviewHandler" 
                     @onmouseleave="HidePreviewHandler" 
                     disabled="@IsProcessing">
                    <div>LISTEN</div>
                    <div class="action-details">@GetListenActionText()</div>
                    @if (ShowListenPreview)
                    {
                        <div class="action-preview listen-preview">
                            @GetListenPreviewContent()
                        </div>
                    }
                </div>
                <div class="action-button @(ShowSpeakPreview ? "preview-active" : "")" 
                     @onclick="ExecuteSpeak" 
                     @onmouseenter="ShowSpeakPreviewHandler" 
                     @onmouseleave="HidePreviewHandler" 
                     disabled="@(!CanSpeak() || IsProcessing)">
                    <div>SPEAK</div>
                    <div class="action-details">@GetSpeakActionText()</div>
                    @if (ShowSpeakPreview)
                    {
                        <div class="action-preview speak-preview">
                            @GetSpeakPreviewContent()
                        </div>
                    }
                </div>
            </div>
        }
        else
        {
            <div class="conversation-exhausted">
                <div class="exhaustion-message">
                    <p>@ExhaustionReason</p>
                </div>
                <div class="exhaustion-actions">
                    <div class="action-button primary" @onclick="ManuallyEndConversation">
                        <div>END CONVERSATION</div>
                        <div class="action-details">Return to location</div>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Focus Display (Above Cards) -->
    <div class="focus-display-section">
        <span class="focus-label">Focus:</span>
        <div class="focus-dots">
            @for (int i = 1; i <= (Session?.GetEffectiveFocusCapacity() ?? 3); i++)
            {
                <span class="focus-dot @(i <= (Session?.GetAvailableFocus() ?? 0) ? "available" : "spent")"></span>
            }
        </div>
        <span class="focus-numbers">@(Session?.GetAvailableFocus() ?? 0)/@(Session?.GetEffectiveFocusCapacity() ?? 3)</span>
        <span class="focus-note">Cards above your focus are disabled</span>
    </div>

    <!-- Cards Section -->
    <div class="cards-section">
        @if ((Context?.Type ?? ConversationType.FriendlyChat) == ConversationType.Commerce)
        {
            @* For exchanges, show cards as full selectable cards like conversations *@
            <div class="cards-header">
                <div class="cards-title">Available Exchanges</div>
            </div>
            
            <div class="card-grid">
                @foreach (var card in Session.HandCards)
                {
                    <div class="@GetCardCssClasses(card) exchange @(!CanSelectCard(card) ? "unavailable" : "")"
                         @onclick="() => ToggleCardSelection(card)">
                        <div class="card-marker exchange">EXCHANGE</div>
                        <div class="card-content">
                            <div class="card-main">
                                <div class="card-identity">
                                    <div class="card-name">@GetCardName(card)</div>
                                    @if (card.Context?.ExchangeData?.CanBarter == true)
                                    {
                                        <span class="tag">Negotiable</span>
                                    }
                                </div>
                                @if (card.Context != null)
                                {
                                    <div class="card-text">
                                        @GetCardText(card)
                                    </div>
                                    <div class="exchange-visual">
                                        <div class="exchange-flow">
                                            <div class="exchange-cost">
                                                <div class="exchange-label">You Pay</div>
                                                <div class="exchange-value cost-value">@GetExchangeCostDisplay(card)</div>
                                            </div>
                                            <div class="exchange-arrow">â†’</div>
                                            <div class="exchange-reward">
                                                <div class="exchange-label">You Receive</div>
                                                <div class="exchange-value reward-value">@GetExchangeRewardDisplay(card)</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    @if (card.Context.ExchangeData?.CanBarter == true)
                                    {
                                        <div class="special-effects">
                                            Base @(card.Context.ExchangeData?.BaseSuccessRate ?? 60)% + @GetTokenBonus(GetExchangeTokenType(card)) tokens (@GetTokenBonusPercentage(card)%) = @GetExchangeSuccessRate(card)% success rate
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            @* Normal conversation cards *@
            <div class="cards-header">
                <div class="cards-title">Your Hand</div>
            </div>
            
            <div class="card-grid">
                @foreach (var convCard in Session.HandCards)
                {
                    @if (convCard.Properties.Contains(CardProperty.DeliveryEligible))
                    {
                        @* Promise/Request Card (Goal) with rapport threshold *@
                        <div class="card promise @(CanSelectCard(convCard) ? "" : "disabled")"
                             @onclick="() => ToggleCardSelection(convCard)">
                            <div class="promise-threshold @(GetCurrentRapport() >= GetRequestRapportThreshold(convCard) ? "promise-active" : "")">
                                Requires @GetRequestRapportThreshold(convCard)+ Rapport (Currently: @GetCurrentRapport())
                            </div>
                            <div class="card-content">
                                <div class="card-main">
                                    <div class="card-header">
                                        <div class="card-name">@GetProperCardName(convCard)</div>
                                    </div>
                                    <div class="card-text">
                                        "@GetProperCardDialogue(convCard)"
                                    </div>
                                </div>
                                <div class="card-outcomes">
                                    <div class="outcome success">
                                        <div class="outcome-chance">100%</div>
                                        <div class="outcome-label">Always Succeeds</div>
                                        <div class="outcome-effect">@GetSuccessEffectDescription(convCard)</div>
                                    </div>
                                    <div class="outcome">
                                        <div class="outcome-chance">Ends</div>
                                        <div class="outcome-label">Conversation</div>
                                        <div class="outcome-effect">Complete</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        @* Regular conversation card *@
                        <div class="@GetCardCssClasses(convCard) @(IsObservationExpired(convCard) || !CanSelectCard(convCard) ? "disabled" : "")"
                             @onclick="() => ToggleCardSelection(convCard)">
                            
                            @* Persistence tags *@
                            @if (convCard.Properties.Contains(CardProperty.Impulse))
                            {
                                <span class="persistence-tag impulse">Impulse</span>
                            }
                            @if (convCard.Properties.Contains(CardProperty.Opening))
                            {
                                <span class="persistence-tag opening">Opening</span>
                            }
                            
                            <div class="card-content">
                                <div class="card-main">
                                    <div class="card-header">
                                        <div class="card-name">@GetProperCardName(convCard)</div>
                                        <div class="card-focus">@convCard.GetEffectiveFocus(Context.Session.CurrentState)</div>
                                    </div>
                                    <div class="card-text">
                                        "@GetProperCardDialogue(convCard)"
                                    </div>
                                @{
                                    var atmosphereScaling = GetAtmosphereScaling(convCard);
                                    if (!string.IsNullOrEmpty(atmosphereScaling))
                                    {
                                        <div class="card-scaling">@atmosphereScaling</div>
                                    }
                                }
                                @if (HasAtmosphereEffect(convCard))
                                {
                                    <div class="atmosphere-change">@GetAtmosphereEffectLabel(convCard)</div>
                                }
                                </div>
                                @* Two-column Success/Failure layout *@
                                <div class="card-outcomes">
                                    <div class="outcome success">
                                        <div class="outcome-chance">@GetSuccessChance(convCard)%</div>
                                        <div class="outcome-label">Success</div>
                                        <div class="outcome-effect">@GetSuccessEffectDescription(convCard)</div>
                                        @if (GetRapportModifier() != 0)
                                        {
                                            <div class="outcome-modifiers">(@GetBaseSuccessPercentage(convCard.Difficulty)% BASE +@GetRapportModifier()% from rapport)</div>
                                        }
                                    </div>
                                    <div class="outcome failure">
                                        <div class="outcome-chance">@GetFailureChance(convCard)%</div>
                                        <div class="outcome-label">Failure</div>
                                        <div class="outcome-effect">@GetFailureEffectDescription(convCard)</div>
                                    </div>
                                </div>
                        </div>
                        @* Exhaust strip below card *@
                            @if (HasExhaustEffect(convCard))
                            {
                                <div class="exhaust-effect">
                                    <span class="exhaust-label">If not played:</span>
                                    @GetExhaustEffectDescription(convCard)
                                </div>
                            }
                        </div>
                    }
                }
            </div>
        }
    </div>
    </div>
}
else
{
    <div class="loading">Loading conversation...</div>
}