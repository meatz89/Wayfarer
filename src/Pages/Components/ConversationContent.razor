@inherits ConversationContentBase

@namespace Wayfarer.Pages.Components

@* ARCHITECTURAL PRINCIPLE: Screen components (LocationContent, ConversationContent, etc.) are rendered INSIDE GameScreen's game-container.
   They must NEVER define their own game-container, header, or resource bars - those are managed by the parent GameScreen.
   Screen components should only contain their specific content wrapped in a semantic class like 'conversation-content'. *@

@if (Session != null)
{
    <div class="conversation-content">
        <!-- Location context bar -->
        <div class="location-context">
            <span>
                @{
                    var (locationName, spotName, spotTraits) = GetLocationContextParts();
                }
                @locationName
                @if (!string.IsNullOrEmpty(spotName))
                {
                    <span class="icon-arrow-right"></span>
                    @spotName
                    @if (!string.IsNullOrEmpty(spotTraits))
                    {
                        <span> (@spotTraits)</span>
                    }
                }
            </span>
        </div>

        <!-- NPC Bar -->
        <div class="npc-bar">
            <div class="npc-info">
                <div class="npc-name">@NpcName</div>
                <div class="npc-status">
                    @{
                        var statusParts = GetNpcStatusParts();
                        for (int i = 0; i < statusParts.Count; i++)
                        {
                            <span>@statusParts[i]</span>
                            if (i < statusParts.Count - 1)
                            {
                                <span class="icon-bullet"></span>
                            }
                        }
                    }
                </div>
            </div>
            <div class="personality-rule">@(Session?.PersonalityEnforcer?.GetRuleDescription() ?? "")</div>
        </div>

        <!-- Core Resources Display (matching mockup exactly) -->
        <div class="resources-display">
            <ResourceBar Label="Momentum"
                         CurrentValue="@(Session?.CurrentMomentum ?? 0)"
                         MaxValue="16"
                         BarType="progress"
                         TooltipContent="@TooltipContentProvider.Get("Momentum")"
                         ShowMaxValue="false" />

            <RhythmScale LeftLabel="Listen Heavy"
                         RightLabel="Speak Heavy"
                         CurrentValue="@GetCurrentCadence()"
                         MinValue="-5"
                         MaxValue="5" />

            <ResourceBar Label="Doubt"
                         CurrentValue="@(Session?.CurrentDoubt ?? 0)"
                         MaxValue="@(Session?.MaxDoubt ?? 10)"
                         BarType="consequence"
                         TooltipContent="@TooltipContentProvider.Get("Doubt")"
                         ShowMaxValue="false" />
        </div>

        <!-- Goal Thresholds Display (matching mockup) -->
        <div class="goals-section">
            <div class="goals-container">
                <div class="goal-card @(GetCurrentMomentum() >= 8 ? "achievable" : "")">
                    <div class="goal-threshold">8</div>
                    <div class="goal-name">Basic Delivery</div>
                    <div class="goal-reward">1 Trust token</div>
                </div>
                <div class="goal-card @(GetCurrentMomentum() >= 12 ? "achievable" : "") @(GetCurrentMomentum() >= 12 ? "active" : "")">
                    <div class="goal-threshold">12</div>
                    <div class="goal-name">Priority Delivery</div>
                    <div class="goal-reward">2 Trust + Observation</div>
                </div>
                <div class="goal-card @(GetCurrentMomentum() >= 16 ? "achievable" : "")">
                    <div class="goal-threshold">16</div>
                    <div class="goal-name">Immediate Action</div>
                    <div class="goal-reward">3 Trust + Permit</div>
                </div>
            </div>
        </div>


    <!-- CENTRAL: Narrative Section (from mockup) -->
    <div class="narrative-section">
        @if (!string.IsNullOrEmpty(LastNarrative))
        {
            <div class="narrative-text @GetNarrativeClass()">
                @LastNarrative
            </div>
        }
        @if (!string.IsNullOrEmpty(LastDialogue))
        {
            <div class="npc-dialogue @GetStateClass() @GetNarrativeClass()">
                "@LastDialogue"
            </div>
        }
    </div>

        <!-- Action Section (matching mockup layout) -->
        <div class="action-display">
            <div class="pile-display">
                <div class="pile-count">
                    <span>Deck:</span>
                    <span class="pile-number">@GetDeckCount()</span>
                </div>
            </div>
            <div class="action-section">
                @if (!IsConversationEnded)
                {
                    <div class="action-button @(IsGeneratingNarrative || IsProcessing ? "disabled" : "")"
                         @onclick="ExecuteListen"
                         disabled="@(IsGeneratingNarrative || IsProcessing)">
                        LISTEN
                        <div class="tooltip card-effects-tooltip">
                            <div class="tooltip-title">Listen</div>
                            <div class="tooltip-section">
                                <strong>Effects:</strong>
                                <ul>
                                    <li>Cadence: @(Session?.GetListenCadenceEffect() ?? -1)</li>
                                    <li>Draw @(Session?.GetDrawCount() ?? 3) cards</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="action-button primary @(SelectedCard == null || IsGeneratingNarrative || IsProcessing ? "disabled" : "")"
                         @onclick="ExecuteSpeak"
                         disabled="@(SelectedCard == null || IsGeneratingNarrative || IsProcessing)">
                        SPEAK
                        @if (SelectedCard != null)
                        {
                            <div class="tooltip card-effects-tooltip">
                                <div class="tooltip-title">@GetProperCardName(SelectedCard)</div>
                                @if (GetCardInitiativeCost(SelectedCard) > 0)
                                {
                                    <div class="tooltip-section">
                                        <strong>Costs:</strong>
                                        <ul>
                                            <li>Initiative: @GetCardInitiativeCost(SelectedCard)</li>
                                            <li>Cadence: @GetCardDeliveryCadenceEffect(SelectedCard)</li>
                                        </ul>
                                    </div>
                                }
                                <div class="tooltip-section">
                                    <strong>Effects:</strong>
                                    <div>
                                        @if (GetCardInitiativeGeneration(SelectedCard) > 0)
                                        {
                                            <div>Initiative +@GetCardInitiativeGeneration(SelectedCard) (@GetCardMove(SelectedCard))</div>
                                        }
                                        @GetCardEffectDescription(SelectedCard)
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="tooltip">Select a card to see effects</div>
                        }
                    </div>
                }
                else
                {
                    <div class="action-button primary" @onclick="ManuallyEndConversation">
                        END CONVERSATION
                    </div>
                }
            </div>
            <div class="pile-display">
                <div class="pile-count">
                    <span>Spoken:</span>
                    <span class="pile-number">@GetSpokenCount()</span>
                </div>
            </div>
        </div>

        <!-- Initiative Display (with glowing orbs matching mockup) -->
        <ActionEconomyDisplay Label="Initiative"
                              CurrentValue="@GetCurrentInitiative()"
                              MaxValue="@GetMaxInitiative()"
                              TooltipContent="@TooltipContentProvider.Get("Initiative")" />

        <!-- Tier Unlock Display -->
        <div class="tier-display">
            <div class="tier-info">
                <GameTooltip Content="@TooltipContentProvider.Get("Understanding")" Position="right">
                    <span class="tier-label">Understanding: @GetCurrentUnderstanding() / @GetMaxUnderstanding()</span>
                </GameTooltip>
                <div class="tier-unlocks">
                    @foreach (var tier in GetAllTiers())
                    {
                        <span class="tier-badge @(IsTierUnlocked(tier.TierNumber) ? "unlocked" : "locked")">
                            TIER @tier.TierNumber (@tier.MinDepth-@tier.MaxDepth)<br/><small>Understanding @tier.UnderstandingThreshold</small>
                        </span>
                    }
                </div>
            </div>
        </div>

        <!-- Statement Counts Display -->
        <div class="statement-display">
            <div class="statement-counts">
                <span class="statement-label">Statement History</span>
                <div class="statement-stats">
                    <div class="stat-count">
                        <span class="stat-icon insight">‚ö°</span>
                        <span class="stat-value">@GetStatementCount("Insight")</span>
                    </div>
                    <div class="stat-count">
                        <span class="stat-icon rapport">‚ù§</span>
                        <span class="stat-value">@GetStatementCount("Rapport")</span>
                    </div>
                    <div class="stat-count">
                        <span class="stat-icon authority">‚öî</span>
                        <span class="stat-value">@GetStatementCount("Authority")</span>
                    </div>
                    <div class="stat-count">
                        <span class="stat-icon diplomacy">üí∞</span>
                        <span class="stat-value">@GetStatementCount("Diplomacy")</span>
                    </div>
                    <div class="stat-count">
                        <span class="stat-icon cunning">üé≠</span>
                        <span class="stat-value">@GetStatementCount("Cunning")</span>
                    </div>
                </div>
            </div>
        </div>

    <!-- NPC Observation Cards Section -->
    @{
        var observationCards = GetNPCObservationCards();
    }
    @if (observationCards.Any())
    {
        <div class="observation-cards-section">
            <div class="cards-header">
                <div class="cards-title">Knowledge</div>
            </div>
            
            <div class="observation-card-grid">
                @foreach (var obsCard in observationCards)
                {
                    <div class="observation-card" @onclick="() => PlayObservationCard(obsCard)">
                        <div class="card-marker observation">KNOWLEDGE</div>
                        <div class="card-content">
                            <!-- Card header: Name and Focus cost -->
                            <div class="card-header">
                                <div class="card-name">@obsCard.ConversationCardTemplate.Id</div>
                                <div class="card-initiative">0</div>
                            </div>

                            <!-- Card dialogue text -->
                            <div class="card-text">
                                "@obsCard.ConversationCardTemplate.Title"
                            </div>

                            <!-- Effect description -->
                            <div class="card-effect">
                                <strong>Effect:</strong> @GetSuccessEffectDescription(obsCard)<br>
                                <strong>Consumed:</strong> Card removed after playing
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

        <!-- Cards Section (Mind) -->
        <div class="cards-section">
            <div class="pile-display">
                <div class="pile-count">
                    <span>Mind:</span>
                    <span class="pile-number">@GetMindCount()</span>
                </div>
            </div>
            
            <div class="card-grid slot-aware-container" style="@GetContainerCSSVariables()">
                @foreach (var displayCard in GetAllDisplayCards())
                {
                    var convCard = displayCard.Card;

                    <SocialCard Card="@convCard"
                                IsSelected="@(SelectedCard?.InstanceId == convCard.InstanceId)"
                                IsSelectable="@CanSelectCard(convCard)"
                                OnCardClick="@(() => ToggleCardSelection(convCard))"
                                CardNarratives="@CurrentCardNarratives"
                                Session="@Session">
                        <SystemSpecificBadges>
                            <span class="card-move @GetCardMoveClass(convCard)" title="Conversational move type">
                                @GetCardMove(convCard)
                            </span>
                            <span class="card-delivery @GetCardDeliveryClass(convCard)" title="Cadence effect on SPEAK">
                                @GetCardDelivery(convCard) (@GetCardDeliveryCadenceEffect(convCard))
                            </span>
                            <span class="card-persistence" title="@GetPersistenceTooltip(convCard)">@GetCardPersistenceType(convCard)</span>
                        </SystemSpecificBadges>
                    </SocialCard>
                }
            </div>
    </div>
    </div>
}
else
{
    <div class="loading">Loading conversation...</div>
}