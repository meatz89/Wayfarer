@inherits ConversationContentBase

@namespace Wayfarer.Pages.Components

@* ARCHITECTURAL PRINCIPLE: Screen components (LocationContent, ConversationContent, etc.) are rendered INSIDE GameScreen's game-container.
   They must NEVER define their own game-container, header, or resource bars - those are managed by the parent GameScreen.
   Screen components should only contain their specific content wrapped in a semantic class like 'conversation-content'. *@

@if (Session != null)
{
    <div class="conversation-content">
        <!-- Location context bar -->
        <div class="location-context">
            <span>@GetLocationContext()</span>
        </div>

        <!-- NPC Bar -->
        <div class="npc-bar">
            <div class="npc-info">
                <div class="npc-name">@NpcName</div>
                <div class="npc-status">@GetNpcStatusLine()</div>
            </div>

            <div class="personality-badge">@(Session?.PersonalityEnforcer?.GetRuleDescription() ?? "")</div>
        </div>

            <!-- Resource Display Bar - 4-Resource System -->
            <div class="resource-bar">
                <!-- Initiative Display -->
                <div class="initiative-display">
                    <span class="initiative-label">Initiative</span>
                    <div class="initiative-counter">
                        <span class="initiative-value">@GetCurrentInitiative()</span>
                    </div>
                    <span class="initiative-info">Earn with Foundation cards</span>
                </div>

                <!-- Cadence Meter -->
                <div class="cadence-display">
                    <span class="cadence-label">Conversation Balance</span>
                    <div class="cadence-meter">
                        <div class="cadence-track">
                            <div class="cadence-indicator" style="left: @GetCadencePosition()%"></div>
                            <div class="cadence-center-line"></div>
                        </div>
                        <div class="cadence-labels">
                            <span class="cadence-min">-10</span>
                            <span class="cadence-value">@GetCurrentCadence()</span>
                            <span class="cadence-max">+10</span>
                        </div>
                    </div>
                </div>

                <!-- Momentum Display -->
                <div class="momentum-display">
                    <span class="momentum-label">Momentum</span>
                    <span class="momentum-counter">@(Session?.CurrentMomentum ?? 0)</span>
                    <div class="momentum-goals">
                        <span class="goal-threshold @(GetCurrentMomentum() >= 8 ? "achieved" : "")">8</span>
                        <span class="goal-threshold @(GetCurrentMomentum() >= 12 ? "achieved" : "")">12</span>
                        <span class="goal-threshold @(GetCurrentMomentum() >= 16 ? "achieved" : "")">16</span>
                    </div>
                </div>

                <!-- Doubt Display -->
                <div class="doubt-display">
                    <span class="doubt-label">Doubt</span>
                    <div class="doubt-slots">
                        @for (int i = 1; i <= Session.MaxDoubt; i++)
                        {
                            <span class="doubt-slot @GetDoubtSlotClass(i)"></span>
                        }
                    </div>
                </div>
            </div>


    <!-- CENTRAL: Narrative Section (from mockup) -->
    <div class="narrative-section">
        @if (!string.IsNullOrEmpty(LastNarrative))
        {
            <div class="narrative-text @GetNarrativeClass()">
                @LastNarrative
            </div>
        }
        @if (!string.IsNullOrEmpty(LastDialogue))
        {
            <div class="npc-dialogue @GetStateClass() @GetNarrativeClass()">
                "@LastDialogue"
            </div>
        }
    </div>

    <!-- Action Choice (from mockup) -->
    <div class="action-section">
        @if (!IsConversationEnded)
        {
            <div class="action-choices">
                <GameTooltip Position="top" CssClass="action-tooltip" Content="@(ConversationFacade?.GetListenActionPreview() ?? "")">
                    <div class="action-button @(IsGeneratingNarrative || IsProcessing ? "disabled" : "")"
                         @onclick="ExecuteListen"
                         disabled="@(IsGeneratingNarrative || IsProcessing)">
                        <div>LISTEN</div>
                        <div class="action-details">@(IsProcessing ? "Processing..." : IsGeneratingNarrative ? "Generating narrative..." : $"Draw {Session?.GetDrawCount() ?? 3} cards")</div>
                    </div>
                </GameTooltip>
                <GameTooltip Position="top" CssClass="action-tooltip" Content="@(ConversationFacade?.GetSpeakActionPreview(SelectedCard) ?? "")">
                    <div class="action-button @(SelectedCard == null || IsGeneratingNarrative || IsProcessing ? "disabled" : "")"
                         @onclick="ExecuteSpeak"
                         disabled="@(SelectedCard == null || IsGeneratingNarrative || IsProcessing)">
                        <div>SPEAK</div>
                        <div class="action-details">@(IsProcessing ? "Processing..." : IsGeneratingNarrative ? "Generating narrative..." : (ConversationFacade?.GetSpeakActionText(SelectedCard) ?? ""))</div>
                    </div>
                </GameTooltip>
            </div>
        }
        else
        {
            <div class="conversation-ended">
                <div class="end-message">
                    <p>@EndReason</p>
                </div>
                <div class="end-actions">
                    <div class="action-button primary" @onclick="ManuallyEndConversation">
                        <div>END CONVERSATION</div>
                        <div class="action-details">Return to location</div>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Initiative Display (Above Cards) -->
    <div class="initiative-display-section">
        <div class="initiative-content">
            <span class="initiative-label">INITIATIVE AVAILABLE</span>
            <div class="initiative-counter-large">
                <span class="initiative-value-large">@GetCurrentInitiative()</span>
            </div>
            <span class="initiative-info">Build with Foundation cards â€¢ Spend on Standard/Decisive cards</span>
        </div>
    </div>

    <!-- NPC Observation Cards Section -->
    @{
        var observationCards = GetNPCObservationCards();
    }
    @if (observationCards.Any())
    {
        <div class="observation-cards-section">
            <div class="cards-header">
                <div class="cards-title">Knowledge</div>
            </div>
            
            <div class="observation-card-grid">
                @foreach (var obsCard in observationCards)
                {
                    <div class="observation-card" @onclick="() => PlayObservationCard(obsCard)">
                        <div class="card-marker observation">KNOWLEDGE</div>
                        <div class="card-content">
                            <!-- Card header: Name and Focus cost -->
                            <div class="card-header">
                                <div class="card-name">@obsCard.Id</div>
                                <div class="card-initiative">0</div>
                            </div>

                            <!-- Card dialogue text -->
                            <div class="card-text">
                                "@obsCard.Description"
                            </div>

                            <!-- Effect description -->
                            <div class="card-effect">
                                <strong>Effect:</strong> @GetSuccessEffectDescription(obsCard)<br>
                                <strong>Consumed:</strong> Card removed after playing
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Cards Section -->
    <div class="cards-section">
        @* Normal conversation cards *@
            <div class="cards-header">
                <div class="cards-title">Your Hand</div>
            </div>
            
            <div class="card-grid slot-aware-container" style="@GetContainerCSSVariables()">
                @foreach (var displayCard in GetAllDisplayCards())
                {
                    var convCard = displayCard.Card;

                    @if (convCard.CardType == CardType.Letter || convCard.CardType == CardType.Letter)
                    {
                        <div class="card promise @GetCardDepthClass(convCard) @GetCardNarrativeClass(convCard) @(CanSelectCard(convCard) ? "" : "disabled")"
                             @onclick="() => ToggleCardSelection(convCard)">
                            <div class="card-depth-marker">@GetDepthDisplayName(convCard)</div>
                            <div class="promise-threshold @((Session?.MomentumManager?.CurrentMomentum ?? 0) >= (convCard?.Context?.MomentumThreshold ?? 0) ? "promise-active" : "")">
                                Requires @(convCard?.Context?.MomentumThreshold ?? 0)+ Momentum (Currently: @(Session?.MomentumManager?.CurrentMomentum ?? 0))
                            </div>
                            <div class="card-content">
                                <!-- Top row: Category tag and Stat badge -->
                                <div class="card-top-row">
                                    <div class="card-tags">
                                        @* Legacy persistence types removed in 4-resource system *@
                                        <span class="category-tag @GetCategoryClass(convCard.ConversationCardTemplate)">@GetCategoryDisplayName(convCard.ConversationCardTemplate.Category)</span>
                                    </div>
                                    <div class="stat-badge @GetCardStatClass(convCard)">
                                        @GetCardStatName(convCard) Lv @(GameFacade.GetPlayerStats().GetLevel(convCard.ConversationCardTemplate.BoundStat ?? PlayerStatType.Rapport))
                                        @if (!string.IsNullOrEmpty((ConversationFacade?.GetCardStatBonus(convCard) ?? "")))
                                        {
                                            <span class="stat-bonus">@(ConversationFacade?.GetCardStatBonus(convCard) ?? "")</span>
                                        }
                                    </div>
                                </div>

                                <!-- Card header: Name and Focus cost -->
                                <div class="card-header">
                                    <div class="card-name">
                                        @GetProperCardName(convCard)
                                    </div>
                                    <div class="card-initiative">@GetCardInitiativeCost(convCard)</div>
                                </div>

                                <!-- Card dialogue text -->
                                <div class="card-text @GetNarrativeClass()">
                                    "@GetProperCardDialogue(convCard)"
                                </div>

                                <!-- Effect description -->
                                <div class="card-effect">
                                    <strong>@GetCategoryDisplayName(convCard.ConversationCardTemplate.Category):</strong> @GetCardEffectDescription(convCard)
                                </div>

                                <!-- Alternative costs -->
                                @if (HasAlternativeCosts(convCard))
                                {
                                    <div class="alternative-costs">
                                        <div class="alt-cost-header">Alternative Costs:</div>
                                        @foreach (var altCost in GetAvailableAlternativeCosts(convCard))
                                        {
                                            <div class="alt-cost-option @(CanAffordAlternativeCost(convCard, altCost) ? "" : "disabled")"
                                                 @onclick="() => PlayCardWithAltCost(convCard, altCost)">
                                                @GetAlternativeCostDescription(altCost)
                                            </div>
                                        }
                                    </div>
                                }

                                <!-- Impulse warning -->
                            </div>
                        </div>
                    }
                        else
                    {
                        <div class="card @GetCardDepthClass(convCard) @GetCardStatColorClass(convCard) @GetCardCssClasses(convCard) @GetCardNarrativeClass(convCard) @(IsObservationExpired(convCard) || !CanSelectCard(convCard) ? "disabled" : "")"
                             @onclick="() => ToggleCardSelection(convCard)">
                            <div class="card-depth-marker">@GetDepthDisplayName(convCard)</div>

                            <div class="card-content">
                                <!-- Top row: Category tag and Stat badge -->
                                <div class="card-top-row">
                                    <div class="card-tags">
                                        @* Legacy persistence types removed in 4-resource system *@
                                        <span class="category-tag @GetCategoryClass(convCard.ConversationCardTemplate)">@GetCategoryDisplayName(convCard.ConversationCardTemplate.Category)</span>
                                    </div>
                                    <div class="stat-badge @GetCardStatClass(convCard)">
                                        @GetCardStatName(convCard) Lv @(GameFacade.GetPlayerStats().GetLevel(convCard.ConversationCardTemplate.BoundStat ?? PlayerStatType.Rapport))
                                        @if (!string.IsNullOrEmpty((ConversationFacade?.GetCardStatBonus(convCard) ?? "")))
                                        {
                                            <span class="stat-bonus">@(ConversationFacade?.GetCardStatBonus(convCard) ?? "")</span>
                                        }
                                    </div>
                                </div>

                                <!-- Card header: Name and Focus cost -->
                                <div class="card-header">
                                    <div class="card-name">
                                        @GetProperCardName(convCard)
                                    </div>
                                    <div class="card-initiative">@GetCardInitiativeCost(convCard)</div>
                                </div>

                                <!-- Card dialogue text -->
                                <div class="card-text @GetNarrativeClass()">
                                    "@GetProperCardDialogue(convCard)"
                                </div>

                                <!-- Effect description -->
                                <div class="card-effect">
                                    <strong>@GetCategoryDisplayName(convCard.ConversationCardTemplate.Category):</strong> @GetCardEffectDescription(convCard)
                                </div>

                                <!-- Alternative costs -->
                                @if (HasAlternativeCosts(convCard))
                                {
                                    <div class="alternative-costs">
                                        <div class="alt-cost-header">Alternative Costs:</div>
                                        @foreach (var altCost in GetAvailableAlternativeCosts(convCard))
                                        {
                                            <div class="alt-cost-option @(CanAffordAlternativeCost(convCard, altCost) ? "" : "disabled")"
                                                 @onclick="() => PlayCardWithAltCost(convCard, altCost)">
                                                @GetAlternativeCostDescription(altCost)
                                            </div>
                                        }
                                    </div>
                                }

                                <!-- Impulse warning -->
                            </div>
                        </div>
                    }
                }
            </div>
    </div>
    </div>
}
else
{
    <div class="loading">Loading conversation...</div>
}