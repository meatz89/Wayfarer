@inherits ConversationContentBase

@namespace Wayfarer.Pages.Components

<div class="conversation-content">
    @if (Session != null)
    {
        <!-- NPC Info -->
        <div class="npc-header">
            <div class="npc-info">
                <h2>@NpcName</h2>
            </div>
        </div>

        @* Display letter delivery indicators *@
        @if (Context?.LettersCarriedForNpc?.Any() == true)
        {
            <div class="letter-delivery-indicators">
                @foreach (var letter in Context.LettersCarriedForNpc)
                {
                    <div class="letter-indicator">
                        <span class="icon icon-letter"></span>
                        <span>Carrying letter from @letter.SenderName</span>
                        @if (letter.DeadlineInMinutes <= 360)
                        {
                            <span class="deadline-urgent">(@(letter.DeadlineInMinutes / 60)h remaining!)</span>
                        }
                    </div>
                }
            </div>
        }

        <!-- Location Context -->
        <div class="location-context">
            @GetLocationContext()
        </div>

        @if ((Context?.Type ?? ConversationType.FriendlyChat) != ConversationType.Commerce)
        {
            <!-- Streamlined Conversation State -->
            <div class="conversation-state-bar">
                <div class="npc-header">
                    <div class="npc-identity">
                        <div class="npc-name">@NpcName</div>
                        <div class="emotional-state">@Session.CurrentState</div>
                    </div>
                    <div class="state-indicators">
                        <div class="indicator">
                            <span class="indicator-label">Patience</span>
                            <span class="indicator-value">@Session.CurrentPatience/@Session.MaxPatience</span>
                        </div>
                        <div class="comfort-indicator">
                            <span class="indicator-label">Comfort</span>
                            <div class="comfort-dots">
                                @for (int i = -3; i <= 3; i++)
                                {
                                    <span class="comfort-dot @GetComfortDotClass(i)"></span>
                                }
                            </div>
                            @if (Math.Abs(Session.CurrentComfort) == 3)
                            {
                                <span class="comfort-transition-hint">â†’ @GetTransitionHint()</span>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Token Strip -->
            <div class="token-strip">
                @foreach (var tokenType in Enum.GetValues<ConnectionType>().Where(t => t != ConnectionType.None))
                {
                    <div class="token-compact">
                        <span class="token-type">@tokenType:</span>
                        <span class="token-count">@GetTokenCount(tokenType) @GetTokenBonus(tokenType)</span>
                    </div>
                }
            </div>
        }

        <!-- Narrative Section -->
        <div class="narrative-section">
            @if (!string.IsNullOrEmpty(LastNarrative))
            {
                <div class="narrative-text">@LastNarrative</div>
            }
            @if (!string.IsNullOrEmpty(LastDialogue))
            {
                <div class="npc-dialogue @GetStateClass()">
                    "@LastDialogue"
                </div>
            }
        </div>

        <!-- Action Section -->
        <div class="action-section">
            @if ((Context?.Type ?? ConversationType.FriendlyChat) == ConversationType.Commerce)
            {
                <!-- Quick Exchanges: Select a card then SPEAK to accept it -->
                <div class="turn-indicator">Select an exchange card to trade</div>
                <div class="action-choices">
                    <button class="action-button" @onclick="ExecuteSpeak" disabled="@(!CanSpeak() || IsProcessing)">
                        <div>TRADE</div>
                        <div class="action-details">@GetSpeakDetails()</div>
                    </button>
                    <button class="action-button exit-button" @onclick="ExitConversation">
                        <div>EXIT</div>
                        <div class="action-details">Leave without trading</div>
                    </button>
                </div>
            }
            else if (!IsConversationExhausted)
            {
                <div class="turn-indicator">Turn @(Session.TurnNumber + 1) â€¢ @Session.CurrentPatience patience remaining</div>
                <div class="action-choices">
                    <div class="action-button" @onclick="ExecuteListen" disabled="@IsProcessing">
                        <div>ðŸ‘‚ LISTEN</div>
                        <div class="action-details">@GetListenDetails()</div>
                    </div>
                    <div class="action-button" @onclick="ExecuteSpeak" disabled="@(!CanSpeak() || IsProcessing)">
                        <div>ðŸ’¬ SPEAK</div>
                        <div class="action-details">@GetSpeakDetails()</div>
                    </div>
                    <div class="action-button exit-button" @onclick="ExitConversation">
                        <div>ðŸšª EXIT</div>
                        <div class="action-details">Leave conversation</div>
                    </div>
                </div>
            }
            else
            {
                <div class="conversation-exhausted">
                    <div class="exhaustion-message">
                        <p>@ExhaustionReason</p>
                    </div>
                    <div class="exhaustion-actions">
                        <button class="action-button primary" @onclick="ManuallyEndConversation">
                            <div>END CONVERSATION</div>
                            <div class="action-details">Return to location</div>
                        </button>
                    </div>
                </div>
            }
        </div>

        <!-- Cards Section -->
        <div class="cards-section">
            @if ((Context?.Type ?? ConversationType.FriendlyChat) == ConversationType.Commerce)
            {
                @* For exchanges, show cards as full selectable cards like conversations *@
                <div class="cards-header">
                    <div class="cards-title">Available Exchanges</div>
                    <div class="weight-tracker">
                        <span>Select one:</span>
                    </div>
                </div>
                
                <div class="card-grid">
                    @foreach (var card in Session.HandCards)
                    {
                        <div class="dialog-card exchange-card @GetCardClass(card) @(IsCardSelected(card) ? "selected" : "")"
                             @onclick="() => ToggleCardSelection(card)">
                            <div class="card-marker exchange">EXCHANGE</div>
                            <div class="card-header">
                                <div class="card-identity">
                                    <div class="card-name">@GetCardName(card)</div>
                                    <div class="card-tags">
                                        <span class="tag">Exchange</span>
                                        @if (card.Context?.ExchangeData?.CanBarter == true)
                                        {
                                            <span class="tag">Negotiable</span>
                                        }
                                    </div>
                                </div>
                            </div>
                            @if (card.Context != null)
                            {
                                <div class="card-text">
                                    @GetCardText(card)
                                </div>
                                <div class="exchange-details">
                                    <div class="exchange-cost">
                                        <div class="exchange-label">You Pay</div>
                                        <div class="exchange-value cost-value">@GetExchangeCostDisplay(card)</div>
                                    </div>
                                    <div class="exchange-arrow">â†’</div>
                                    <div class="exchange-reward">
                                        <div class="exchange-label">You Receive</div>
                                        <div class="exchange-value reward-value">@GetExchangeRewardDisplay(card)</div>
                                    </div>
                                </div>
                                
                                @if (card.Context.ExchangeData?.CanBarter == true)
                                {
                                    <div class="barter-info">
                                        <span class="barter-label">Barter Success:</span>
                                        <span class="barter-rate">@GetExchangeSuccessRate(card)%</span>
                                        <span class="barter-hint">(Better price on success)</span>
                                    </div>
                                }
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                @* Normal conversation cards *@
                <div class="cards-header">
                    <div class="cards-title">Your Hand</div>
                    <div class="weight-tracker @(TotalSelectedWeight > GetWeightLimit() ? "over-limit" : "")">
                        <span>Card Weight:</span>
                        <span style="font-weight: bold;">@TotalSelectedWeight/@GetWeightLimit()</span>
                    </div>
                </div>
                
                <div class="card-grid">
                    @foreach (var convCard in Session.HandCards)
                    {
                        <div class="card @GetCardClass(convCard) @GetObservationDecayClass(convCard) @(IsCardSelected(convCard) ? "selected" : "") @(IsObservationExpired(convCard) ? "unavailable" : "")"
                             @onclick="() => ToggleCardSelection(convCard)">
                            @if (convCard.GetEffectiveWeight(Context.Session.CurrentState) == 0 && convCard.Weight > 0)
                            {
                                <div class="card-marker free-weight">FREE!</div>
                            }
                            @if (convCard.Category == CardCategory.Burden)
                            {
                                <div class="card-marker burden">Burden</div>
                            }
                            @if (convCard.IsObservation)
                            {
                                <div class="card-marker expires">24hr</div>
                            }
                            @if (convCard.Category == CardCategory.Exchange)
                            {
                                <div class="card-marker goal">Goal Card</div>
                            }
                            <div class="card-content">
                                <div class="card-main">
                                    <div class="card-identity">
                                        <div class="card-name">@GetCardName(convCard)</div>
                                        <div class="card-weight">@convCard.GetEffectiveWeight(Context.Session.CurrentState)</div>
                                    </div>
                                    @if (convCard.DrawableStates != null && convCard.DrawableStates.Any())
                                    {
                                        <div class="card-drawable">Drawable: @string.Join(", ", convCard.DrawableStates)</div>
                                    }
                                    <div class="card-text">
                                        @GetCardText(convCard)
                                    </div>
                                </div>
                                <div class="card-outcomes">
                                    <div class="outcome success">
                                        <div class="outcome-chance">@GetSuccessChance(convCard)%</div>
                                        <div class="outcome-label">Success</div>
                                        <div class="outcome-effect">@GetSuccessEffect(convCard)</div>
                                        @if (!string.IsNullOrEmpty(GetTokenBonusText(convCard)))
                                        {
                                            <div class="token-bonus">@GetTokenBonusText(convCard)</div>
                                        }
                                    </div>
                                    <div class="outcome">
                                        <div class="outcome-chance">@GetFailureChance(convCard)%</div>
                                        <div class="outcome-label">Failure</div>
                                        <div class="outcome-effect">@GetFailureEffect(convCard)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    }
    else
    {
        <div class="loading">Loading conversation...</div>
    }
</div>