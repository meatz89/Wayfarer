@inherits ConversationContentBase
@using Wayfarer.GameState.Enums

@namespace Wayfarer.Pages.Components

@* ARCHITECTURAL PRINCIPLE: Screen components (LocationContent, ConversationContent, etc.) are rendered INSIDE GameScreen's game-container.
   They must NEVER define their own game-container, header, or resource bars - those are managed by the parent GameScreen.
   Screen components should only contain their specific content wrapped in a semantic class like 'conversation-content'. *@

@if (Session != null)
{
    <div class="conversation-content">
        <!-- Location context bar -->
        <div class="location-context">
            <span>@GetLocationContext()</span>
        </div>

        <!-- Player Stats Display -->
        <div class="stats-display">
            @foreach (var stat in GetPlayerStats())
            {
                <div class="stat-item">
                    <div class="stat-name">@stat.Name</div>
                    <div class="stat-level">@stat.Level</div>
                    <div class="stat-xp">@stat.CurrentXP/@stat.RequiredXP XP</div>
                </div>
            }
        </div>

        <!-- NPC Bar -->
        <div class="npc-bar">
            <div class="npc-info">
                <div class="npc-name">@NpcName</div>
                <div class="npc-status">@GetNpcStatusLine()</div>
            </div>

            <div class="personality-badge">@GetPersonalityRuleShort()</div>
        </div>

            <!-- Win/Lose Conditions Bar -->
            <div class="conditions-bar">

                <div class="momentum-display">
                    <span class="momentum-label">Momentum</span>
                    <span class="momentum-counter">@(Session?.CurrentMomentum ?? 0)</span>
                </div>

                <!-- Flow State Container - Centered wrapper -->
                <div class="flow-state-wrapper">
                    <div class="flow-container">
                        <div class="flow-negative">
                            @for (int i = -1; i >= -3; i--)
                            {
                                <span class="flow-segment @GetFlowSegmentClass(i)"></span>
                            }
                        </div>

                        <div class="current-state">
                            <div class="state-name">@GetConnectionStateDisplay()</div>
                            <div class="state-rules">Focus: @(Session?.GetEffectiveFocusCapacity() ?? 3) • Draw: @(Session?.GetDrawCount() ?? 3)</div>
                        </div>

                        <div class="flow-positive">
                            @for (int i = 1; i <= 3; i++)
                            {
                                <span class="flow-segment @GetFlowSegmentClass(i)"></span>
                            }
                        </div>
                    </div>
                </div>

                <div class="doubt-display">
                    <span class="doubt-label">Doubt</span>
                    <div class="doubt-slots">
                        @for (int i = 1; i <= Session.MaxDoubt; i++)
                        {
                            <span class="doubt-slot @GetDoubtSlotClass(i)"></span>
                        }
                    </div>
                </div>
            </div>

    <!-- Goal Thresholds Display -->
    @if (GetRequestGoals().Any())
    {
        <div class="goals-section">
            <div class="goals-header">Request Goals - @GetRequestName()</div>
            <div class="goals-container">
                @foreach (var goal in GetRequestGoals())
                {
                    <div class="goal-card @GetGoalCardClass(goal.Threshold)">
                        <div class="goal-threshold">@goal.Threshold</div>
                        <div class="goal-name">@goal.Name</div>
                        <div class="goal-reward">@goal.Reward</div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- CENTRAL: Narrative Section (from mockup) -->
    <div class="narrative-section">
        @if (!string.IsNullOrEmpty(LastNarrative))
        {
            <div class="narrative-text @GetNarrativeClass()">
                @LastNarrative
            </div>
        }
        @if (!string.IsNullOrEmpty(LastDialogue))
        {
            <div class="npc-dialogue @GetStateClass() @GetNarrativeClass()">
                "@LastDialogue"
            </div>
        }
    </div>

    <!-- Action Choice (from mockup) -->
    <div class="action-section">
        @if (!IsConversationExhausted)
        {
            <div class="action-choices">
                <div class="action-button @(IsGeneratingNarrative || IsProcessing ? "disabled" : "")"
                     @onclick="ExecuteListen"
                     disabled="@(IsGeneratingNarrative || IsProcessing)">
                    <div>LISTEN</div>
                    <div class="action-details">@(IsProcessing ? "Processing..." : IsGeneratingNarrative ? "Generating narrative..." : $"Draw {Session?.GetDrawCount() ?? 3} cards")</div>
                    <div class="button-preview">
                        @GetListenPreview()
                    </div>
                </div>
                <div class="action-button @(!CanSpeak() || IsGeneratingNarrative || IsProcessing ? "disabled" : "")"
                     @onclick="ExecuteSpeak"
                     disabled="@(!CanSpeak() || IsGeneratingNarrative || IsProcessing)">
                    <div>SPEAK</div>
                    <div class="action-details">@(IsProcessing ? "Processing..." : IsGeneratingNarrative ? "Generating narrative..." : GetSpeakActionText())</div>
                    <div class="button-preview">
                        @GetSpeakPreview()
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="conversation-exhausted">
                <div class="exhaustion-message">
                    <p>@ExhaustionReason</p>
                </div>
                <div class="exhaustion-actions">
                    <div class="action-button primary" @onclick="ManuallyEndConversation">
                        <div>END CONVERSATION</div>
                        <div class="action-details">Return to location</div>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Focus Display (Above Cards) -->
    <div class="focus-display-section">
        <div class="focus-content">
            <span class="focus-label">FOCUS AVAILABLE</span>
            <div class="focus-dots">
                @for (int i = 1; i <= (Session?.GetEffectiveFocusCapacity() ?? 3); i++)
                {
                    <span class="focus-dot @(i <= (Session?.GetAvailableFocus() ?? 0) ? "available" : "spent")"></span>
                }
            </div>
            <span class="focus-value">@(Session?.GetAvailableFocus() ?? 0)/@(Session?.GetEffectiveFocusCapacity() ?? 3)</span>
            <span class="focus-warning">Unspent → +1 doubt each</span>
        </div>
    </div>

    <!-- NPC Observation Cards Section -->
    @{
        var observationCards = GetNPCObservationCards();
    }
    @if (observationCards.Any())
    {
        <div class="observation-cards-section">
            <div class="cards-header">
                <div class="cards-title">Knowledge</div>
            </div>
            
            <div class="observation-card-grid">
                @foreach (var obsCard in observationCards)
                {
                    <div class="observation-card" @onclick="() => PlayObservationCard(obsCard)">
                        <div class="card-marker observation">KNOWLEDGE</div>
                        <div class="card-content">
                            <div class="card-main">
                                <div class="card-identity">
                                    <div class="card-name">@obsCard.Id</div>
                                    <div class="card-focus">0</div>
                                </div>
                                <div class="card-text">
                                    "@obsCard.Description"
                                </div>
                            </div>
                            <div class="card-outcomes">
                                <div class="outcome success">
                                    <div class="outcome-label">Effect</div>
                                    <div class="outcome-effect">@GetSuccessEffectDescription(obsCard)</div>
                                </div>
                                <div class="outcome consumed">
                                    <div class="outcome-label">Consumed</div>
                                    <div class="outcome-effect">Card removed after playing</div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Cards Section -->
    <div class="cards-section">
        @* Normal conversation cards *@
            <div class="cards-header">
                <div class="cards-title">Your Hand</div>
            </div>
            
            <div class="card-grid">
                @foreach (var displayCard in GetAllDisplayCards())
                {
                    var convCard = displayCard.Card;

                    @* Display regular hand cards and animating played cards *@
                    @if (displayCard.IsAnimating)
                    {
                        @* Animating card that's been played *@
                        <div class="card @displayCard.AnimationState @GetCardNarrativeClass(convCard)">
                            <div class="card-content">
                                <div class="card-main">
                                    <div class="card-header">
                                        <div class="card-name">@GetProperCardName(convCard)</div>
                                        <div class="card-focus">@convCard.GetEffectiveFocus(Context.Session.CurrentState)</div>
                                    </div>
                                    <div class="card-text @GetNarrativeClass()">
                                        "@GetProperCardDialogue(convCard)"
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else if (convCard.CardType == CardType.Letter || convCard.CardType == CardType.BurdenGoal)
                    {
                        @* Goal Card with rapport threshold - using same layout as regular cards but with distinct styling *@
                        <div class="card promise @GetCardNarrativeClass(convCard) @(CanSelectCard(convCard) ? "" : "disabled")"
                             @onclick="() => ToggleCardSelection(convCard)">
                            <div class="promise-threshold @(GetCurrentMomentum() >= GetRequestMomentumThreshold(convCard) ? "promise-active" : "")">
                                Requires @GetRequestMomentumThreshold(convCard)+ Momentum (Currently: @GetCurrentMomentum())
                            </div>
                            <div class="card-content">
                                <div class="card-body">
                                    <div class="card-main">
                                        <div class="persistence-tag-container">
                                            @if (convCard.Persistence == PersistenceType.Impulse)
                                            {
                                                <span class="persistence-tag impulse">Impulse</span>
                                            }
                                            @if (convCard.Persistence == PersistenceType.Opening)
                                            {
                                                <span class="persistence-tag opening">Opening</span>
                                            }
                                            @if (convCard.Persistence == PersistenceType.Thought)
                                            {
                                                <span class="persistence-tag thought">Thought</span>
                                            }
                                            <span class="category-tag @GetCategoryClass(convCard.Template)">@GetCategoryDisplayName(convCard.Template.Category)</span>
                                        </div>
                                        <!-- Stat badge -->
                                        <div class="stat-badge @GetCardStatClass(convCard)">
                                            @GetCardStatName(convCard) Lv @GetCardLevel(convCard)
                                            @if (!string.IsNullOrEmpty(GetStatBonus(convCard)))
                                            {
                                                <span class="stat-bonus">@GetStatBonus(convCard)</span>
                                            }
                                        </div>
                                        <div class="card-header">
                                            <div class="card-name">
                                                @GetProperCardName(convCard)
                                                <span class="xp-gain">+@GetXPGain() XP</span>
                                            </div>
                                            <div class="card-focus">@convCard.GetEffectiveFocus(Context.Session.CurrentState)</div>
                                        </div>
                                        <div class="card-text @GetNarrativeClass()">
                                            "@GetProperCardDialogue(convCard)"
                                        </div>
                                        <div class="effect-tags">
                                            @foreach (var tag in GetCardEffectTags(convCard))
                                            {
                                                <span class="effect-tag">@tag</span>
                                            }
                                        </div>
                                    </div>
                                    @* Card Effect Display *@
                                    <div class="card-outcomes">
                                        <div class="outcome effect-calculation">
                                            <div class="outcome-label">@GetCategoryDisplayName(convCard.Template.Category)</div>
                                            <div class="effect-details">@GetMomentumCalculation(convCard)</div>
                                            <div class="outcome-effect">@GetCardEffectDescription(convCard)</div>
                                        </div>
                                        @if (convCard.Persistence == PersistenceType.Impulse)
                                        {
                                            <div class="outcome impulse-warning">
                                                <div class="outcome-label">If Unplayed</div>
                                                <div class="outcome-effect">-1 card draw next LISTEN</div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        @* Regular conversation card *@
                        var animationState = GetCardAnimationState(convCard);
                        var animationStyle = animationState != null && animationState.AnimationDelay > 0
                            ? $"animation-delay: {animationState.AnimationDelay:F2}s;"
                            : "";

                        <div class="card @GetCardStatColorClass(convCard) @GetCardCssClasses(convCard) @GetCardNarrativeClass(convCard) @(IsObservationExpired(convCard) || !CanSelectCard(convCard) ? "disabled" : "") @(IsIllegalPlay(convCard) ? "illegal-play" : "")"
                             style="@animationStyle"
                             @onclick="() => ToggleCardSelection(convCard)">

                            <div class="card-content">
                                <div class="card-body">
                                    <div class="card-main">
                                        <div class="persistence-tag-container">
                                            @* Persistence tags *@
                                            @if (convCard.Persistence == PersistenceType.Impulse)
                                            {
                                                <span class="persistence-tag impulse">Impulse</span>
                                            }
                                            @if (convCard.Persistence == PersistenceType.Opening)
                                            {
                                                <span class="persistence-tag opening">Opening</span>
                                            }
                                            @if (convCard.Persistence == PersistenceType.Thought)
                                            {
                                                <span class="persistence-tag thought">Thought</span>
                                            }
                                            <span class="category-tag @GetCategoryClass(convCard.Template)">@GetCategoryDisplayName(convCard.Template.Category)</span>
                                        </div>
                                        <!-- Stat badge -->
                                        <div class="stat-badge @GetCardStatClass(convCard)">
                                            @GetCardStatName(convCard) Lv @GetCardLevel(convCard)
                                            @if (!string.IsNullOrEmpty(GetStatBonus(convCard)))
                                            {
                                                <span class="stat-bonus">@GetStatBonus(convCard)</span>
                                            }
                                        </div>
                                        <div class="card-header">
                                            <div class="card-name">
                                                @GetProperCardName(convCard)
                                                <span class="xp-gain">+@GetXPGain() XP</span>
                                            </div>
                                            <div class="card-focus">@convCard.GetEffectiveFocus(Context.Session.CurrentState)</div>
                                        </div>
                                        <div class="card-text @GetNarrativeClass()">
                                            "@GetProperCardDialogue(convCard)"
                                        </div>
                                        <div class="effect-tags">
                                            @foreach (var tag in GetCardEffectTags(convCard))
                                            {
                                                <span class="effect-tag">@tag</span>
                                            }
                                        </div>
                                    @{
                                        var atmosphereScaling = GetAtmosphereScaling(convCard);
                                        if (!string.IsNullOrEmpty(atmosphereScaling))
                                        {
                                            <div class="card-scaling">@atmosphereScaling</div>
                                        }
                                    }
                                    @if (HasAtmosphereEffect(convCard))
                                    {
                                        <div class="atmosphere-change">@GetAtmosphereEffectLabel(convCard)</div>
                                    }
                                    </div>
                                    @* Card Effect Display *@
                                    <div class="card-outcomes">
                                        <div class="outcome effect-calculation">
                                            <div class="outcome-label">@GetCategoryDisplayName(convCard.Template.Category)</div>
                                            <div class="effect-details">@GetMomentumCalculation(convCard)</div>
                                            <div class="outcome-effect">@GetCardEffectDescription(convCard)</div>
                                        </div>
                                        @if (convCard.Persistence == PersistenceType.Impulse)
                                        {
                                            <div class="outcome impulse-warning">
                                                <div class="outcome-label">If Unplayed</div>
                                                <div class="outcome-effect">-1 card draw next LISTEN</div>
                                            </div>
                                        }
                                    </div>
                                </div>
                        </div>
                        </div>
                    }
                }
            </div>
    </div>
    </div>
}
else
{
    <div class="loading">Loading conversation...</div>
}