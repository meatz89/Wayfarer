@inherits ConversationContentBase

@namespace Wayfarer.Pages.Components

@if (Session != null)
{
    <!-- Location Context (from mockup) -->
    <div class="location-context">
        @GetLocationContext()
    </div>

    @if ((Context?.Type ?? ConversationType.FriendlyChat) != ConversationType.Commerce)
    {
        <!-- Streamlined Conversation State Bar (from mockup) -->
        <div class="conversation-state-bar">
            <div class="npc-header">
                <div class="npc-identity">
                    <div class="npc-name">@NpcName</div>
                    <div class="emotional-state">@GetEmotionalStateDisplay()</div>
                </div>
                <div class="state-indicators">
                    <div class="indicator">
                        <span class="indicator-label">Patience</span>
                        <span class="indicator-value">@Session.CurrentPatience/@Session.MaxPatience</span>
                    </div>
                    <div class="weight-pool-indicator">
                        <span class="indicator-label">Weight Pool</span>
                        <div class="weight-pool-display">
                            <span class="weight-value">@GetWeightPoolDisplay()</span>
                            <div class="weight-dots">
                                @for (int i = 0; i < (Session?.GetEffectiveWeightCapacity() ?? 5); i++)
                                {
                                    <span class="weight-dot @(i < (Session?.GetAvailableWeight() ?? 0) ? "filled" : "empty")">‚óè</span>
                                }
                            </div>
                            @if (Session?.CurrentAtmosphere == AtmosphereType.Prepared)
                            {
                                <span class="atmosphere-bonus">(+1 from Prepared)</span>
                            }
                        </div>
                    </div>
                    <div class="comfort-indicator">
                        <span class="indicator-label">Comfort Battery</span>
                        <div class="comfort-battery">
                            <span class="comfort-value">@GetComfortBatteryDisplay()</span>
                            <div class="comfort-dots">
                                @for (int i = -3; i <= 3; i++)
                                {
                                    <span class="comfort-dot @GetComfortDotClass(i)" title="@GetComfortDotTooltip(i)">
                                        @if (i == Session.ComfortBattery)
                                        {
                                            <span class="dot-marker">‚óè</span>
                                        }
                                        else if (i == 0)
                                        {
                                            <span class="dot-marker">‚óã</span>
                                        }
                                        else
                                        {
                                            <span class="dot-marker">¬∑</span>
                                        }
                                    </span>
                                }
                            </div>
                        </div>
                        @if (Math.Abs(Session.ComfortBattery) == 2)
                        {
                            <div class="comfort-transition-hint @(Session.CurrentState == EmotionalState.DESPERATE && Session.ComfortBattery == -2 ? "danger" : "")">
                                @GetTransitionHint()
                            </div>
                        }
                        @if (Session.CurrentState == EmotionalState.DESPERATE && Session.ComfortBattery <= -2)
                        {
                            <div class="comfort-warning">‚ö† Conversation ends at -3!</div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Atmosphere Display (enhanced with persistence indicator) -->
        @if (Session.CurrentAtmosphere != AtmosphereType.Neutral || HasTemporaryAtmosphereEffects())
        {
            <div class="atmosphere-bar @GetAtmosphereClass()">
                <div class="atmosphere-header">
                    @if (Session.CurrentAtmosphere != AtmosphereType.Neutral)
                    {
                        <div class="atmosphere-label">Atmosphere:</div>
                        <div class="atmosphere-value">
                            <span class="atmosphere-icon">@GetAtmosphereIcon()</span>
                            <span class="atmosphere-name">@GetCurrentAtmosphereDisplay()</span>
                        </div>
                    }
                </div>
                @if (!string.IsNullOrEmpty(GetAtmosphereEffectDescription()))
                {
                    <div class="atmosphere-description">
                        @GetAtmosphereEffectDescription()
                        @if (Session.CurrentAtmosphere != AtmosphereType.Neutral)
                        {
                            <span class="persistence-note">(Persists until changed or failure)</span>
                        }
                    </div>
                }
                @if (HasTemporaryAtmosphereEffects())
                {
                    <div class="temporary-effects">
                        @GetTemporaryEffectsDescription()
                    </div>
                }
            </div>
        }

        <!-- Token Strip (from mockup) -->
        <div class="token-strip">
            <div class="token-compact">
                <span class="token-type">Trust:</span>
                <span class="token-count">@GetTokenCount(ConnectionType.Trust) @GetTokenBonus(ConnectionType.Trust)</span>
            </div>
            <div class="token-compact">
                <span class="token-type">Commerce:</span>
                <span class="token-count">@GetTokenCount(ConnectionType.Commerce) @GetTokenBonus(ConnectionType.Commerce)</span>
            </div>
            <div class="token-compact">
                <span class="token-type">Status:</span>
                <span class="token-count">@GetTokenCount(ConnectionType.Status) @GetTokenBonus(ConnectionType.Status)</span>
            </div>
            <div class="token-compact">
                <span class="token-type">Shadow:</span>
                <span class="token-count">@GetTokenCount(ConnectionType.Shadow) @GetTokenBonus(ConnectionType.Shadow)</span>
            </div>
        </div>
    }

    <!-- CENTRAL: Narrative Section (from mockup) -->
    <div class="narrative-section">
        @if (!string.IsNullOrEmpty(LastNarrative))
        {
            <div class="narrative-text">
                @LastNarrative
            </div>
        }
        @if (!string.IsNullOrEmpty(LastDialogue))
        {
            <div class="npc-dialogue @GetStateClass()">
                "@LastDialogue"
            </div>
        }
    </div>

    <!-- Action Choice (from mockup) -->
    <div class="action-section">
        @if ((Context?.Type ?? ConversationType.FriendlyChat) == ConversationType.Commerce)
        {
            <!-- Quick Exchanges: Select a card then SPEAK to accept it -->
            <div class="turn-indicator">Select an exchange card to trade</div>
            <div class="action-choices">
                <div class="action-button" @onclick="ExecuteSpeak" disabled="@(!CanSpeak() || IsProcessing)">
                    <div>TRADE</div>
                    <div class="action-details">@GetSpeakDetails()</div>
                </div>
                <div class="action-button exit-button" @onclick="ExitConversation">
                    <div>EXIT</div>
                    <div class="action-details">Leave without trading</div>
                </div>
            </div>
        }
        else if (!IsConversationExhausted)
        {
            <div class="turn-info">
                <div class="turn-detail">
                    <span>Turn</span>
                    <span class="turn-value">@(Session.TurnNumber + 1)/10</span>
                </div>
                <div class="turn-detail">
                    <span>Weight Pool:</span>
                    <span class="turn-value">@GetWeightPoolDisplay()</span>
                </div>
                <div class="turn-detail">
                    <span>State</span>
                    <span class="turn-value">@GetEmotionalStateDisplay()</span>
                </div>
            </div>
            <div class="action-choices">
                <div class="action-button" @onclick="ExecuteListen" disabled="@IsProcessing">
                    <div>üëÇ LISTEN</div>
                    <div class="action-details">@GetListenActionText()</div>
                </div>
                <div class="action-button" @onclick="ExecuteSpeak" disabled="@(!CanSpeak() || IsProcessing)">
                    <div>üí¨ SPEAK</div>
                    <div class="action-details">@GetSpeakActionText()</div>
                </div>
            </div>
        }
        else
        {
            <div class="conversation-exhausted">
                <div class="exhaustion-message">
                    <p>@ExhaustionReason</p>
                </div>
                <div class="exhaustion-actions">
                    <div class="action-button primary" @onclick="ManuallyEndConversation">
                        <div>END CONVERSATION</div>
                        <div class="action-details">Return to location</div>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- CENTRAL: Cards Section (from mockup) -->
    <div class="cards-section">
        @if ((Context?.Type ?? ConversationType.FriendlyChat) == ConversationType.Commerce)
            {
            @* For exchanges, show cards as full selectable cards like conversations *@
            <div class="cards-header">
                <div class="cards-title">Available Exchanges</div>
            </div>
            
            <div class="card-grid">
                @foreach (var card in Session.HandCards)
                {
                    <div class="card exchange @GetCardClass(card) @(IsCardSelected(card) ? "selected" : "") @(!CanSelectCard(card) ? "unavailable" : "")"
                         @onclick="() => ToggleCardSelection(card)">
                        <div class="card-marker exchange">EXCHANGE</div>
                        <div class="card-content">
                            <div class="card-main">
                                <div class="card-identity">
                                    <div class="card-name">@GetCardName(card)</div>
                                    @if (card.Context?.ExchangeData?.CanBarter == true)
                                    {
                                        <span class="tag">Negotiable</span>
                                    }
                                </div>
                                @if (card.Context != null)
                                {
                                    <div class="card-text">
                                        @GetCardText(card)
                                    </div>
                                    <div class="exchange-visual">
                                        <div class="exchange-flow">
                                            <div class="exchange-cost">
                                                <div class="exchange-label">You Pay</div>
                                                <div class="exchange-value cost-value">@GetExchangeCostDisplay(card)</div>
                                            </div>
                                            <div class="exchange-arrow">‚Üí</div>
                                            <div class="exchange-reward">
                                                <div class="exchange-label">You Receive</div>
                                                <div class="exchange-value reward-value">@GetExchangeRewardDisplay(card)</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    @if (card.Context.ExchangeData?.CanBarter == true)
                                    {
                                        <div class="special-effects">
                                            Base @(card.Context.ExchangeData?.BaseSuccessRate ?? 60)% + @GetTokenBonus(GetExchangeTokenType(card)) tokens (@GetTokenBonusPercentage(card)%) = @GetExchangeSuccessRate(card)% success rate
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
            }
        else
        {
            @* Normal conversation cards *@
            <div class="cards-header">
                <div class="cards-title">Your Hand</div>
            </div>
            
            <div class="card-grid">
                @foreach (var convCard in Session.HandCards)
                {
                    <div class="card @GetCardClass(convCard) @(IsCardSelected(convCard) ? "selected" : "") @(IsObservationExpired(convCard) || !CanSelectCard(convCard) ? "unavailable" : "")"
                         @onclick="() => ToggleCardSelection(convCard)">
                        @if (convCard.IsFleeting)
                        {
                            <div class="card-marker fleeting" title="Will be discarded after SPEAK">‚ö° FLEETING</div>
                        }
                        @if (HasFinalWord(convCard))
                        {
                            <div class="card-marker final-word" title="Must play or conversation fails!">üéØ FINAL WORD</div>
                        }
                        @if (convCard.IsObservation)
                        {
                            <div class="card-marker expires">24hr</div>
                        }
                        @if (convCard.Category == nameof(CardCategory.Burden))
                        {
                            <div class="card-marker blocks">Blocks</div>
                        }
                        @if (convCard.Category == nameof(CardCategory.Promise))
                        {
                            <div class="card-marker goal">Goal Card</div>
                        }
                        @if (convCard.Category == nameof(CardCategory.Exchange))
                        {
                            <div class="card-marker exchange">Exchange</div>
                        }
                        <div class="card-content">
                            <div class="card-main">
                                <div class="card-identity">
                                    <div class="card-name">@GetProperCardName(convCard)</div>
                                    <div class="card-weight">@convCard.GetEffectiveWeight(Context.Session.CurrentState)</div>
                                </div>
                                <div class="card-drawable">@GetCardTypeLabel(convCard)</div>
                                <div class="card-text">
                                    "@GetProperCardDialogue(convCard)"
                                </div>
                            </div>
                            <div class="card-outcomes">
                                <div class="outcome success">
                                    <div class="outcome-chance">@GetSuccessChance(convCard)%</div>
                                    <div class="outcome-label">Success</div>
                                    <div class="outcome-effect">@GetSuccessEffect(convCard)</div>
                                </div>
                                <div class="outcome">
                                    <div class="outcome-chance">@GetFailureChance(convCard)%</div>
                                    <div class="outcome-label">Failure</div>
                                    <div class="outcome-effect">@GetFailureEffect(convCard)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
            
            @* Fleeting card warning indicator *@
            @if (CountFleetingCards() > 0 || HasGoalWithFinalWord())
            {
                <div class="fleeting-indicator">
                    @if (CountFleetingCards() > 0)
                    {
                        <div class="fleeting-warning">
                            <span class="warning-icon">‚ö°</span>
                            <span class="warning-text">@CountFleetingCards() fleeting card(s) will be discarded after SPEAK action</span>
                        </div>
                    }
                    
                    @if (HasGoalWithFinalWord())
                    {
                        <div class="final-word-alert">
                            <span class="alert-icon">üéØ</span>
                            <span class="alert-text">Goal card with Final Word must be played this turn or conversation fails!</span>
                        </div>
                    }
                </div>
            }
        }
    </div>
}
else
{
    <div class="loading">Loading conversation...</div>
}