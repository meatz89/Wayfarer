@* Renders card dialogue from categorical templates - NO hardcoded text *@
@using Wayfarer.Subsystems.NarrativeSubsystem
@inject DialogueGenerationService DialogueGenerator
@inject NarrativeRenderer NarrativeRenderer

@code {
    [Parameter] public string TemplateId { get; set; }
    [Parameter] public CardContext Context { get; set; }
    [Parameter] public string NPCName { get; set; }
    [Parameter] public bool IsPlayerCard { get; set; } = true;
    [Parameter] public CardInstance Card { get; set; }

    private string GetCardText()
    {
        // Generate categorical template from card type
        var template = DialogueGenerator.GenerateCardDialogue(TemplateId, IsPlayerCard);
        
        // Render template to human-readable text
        var text = NarrativeRenderer.RenderTemplate(template);
        
        // Add NPC name if contextually appropriate - only in disconnected state
        if (!string.IsNullOrEmpty(NPCName) && Context?.ConnectionState == ConnectionState.DISCONNECTED)
        {
            text = text.Replace("you", NPCName);
        }
        
        return text;
    }

    private string GetSuccessDescription()
    {
        var focus = GetCardFocus();
        var successChance = Math.Max(10, Math.Min(95, 70 - (focus * 10)));
        return $"{successChance}%";
    }

    private int GetCardFocus()
    {
        // Get focus directly from the card's mechanical properties
        return Card?.ConversationCardTemplate.InitiativeCost ?? 1; // Default to 1 if Card is null
    }

    private string GetCardTypeClass()
    {
        // Determine card visual category from template
        if (TemplateId != null && (TemplateId.Contains("Calm") || TemplateId.Contains("Opening")))
            return "state";
        return "flow";
    }
}

@GetCardText()