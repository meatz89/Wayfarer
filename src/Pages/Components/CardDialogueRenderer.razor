@* Renders card dialogue from categorical templates - NO hardcoded text *@
@inject DialogueGenerationService DialogueGenerator
@inject NarrativeRenderer NarrativeRenderer

@code {
    [Parameter] public CardTemplateType Template { get; set; }
    [Parameter] public CardContext Context { get; set; }
    [Parameter] public string NPCName { get; set; }
    [Parameter] public bool IsPlayerCard { get; set; } = true;

    private string GetCardText()
    {
        // Generate categorical template from card type
        var template = DialogueGenerator.GenerateCardDialogue(Template, IsPlayerCard);
        
        // Render template to human-readable text
        var text = NarrativeRenderer.RenderTemplate(template);
        
        // Add NPC name if contextually appropriate
        if (!string.IsNullOrEmpty(NPCName) && Context?.EmotionalState == EmotionalState.DESPERATE)
        {
            text = text.Replace("you", NPCName);
        }
        
        return text;
    }

    private string GetSuccessDescription()
    {
        var weight = GetCardWeight();
        var successChance = Math.Max(10, Math.Min(95, 70 - (weight * 10)));
        return $"{successChance}%";
    }

    private int GetCardWeight()
    {
        // Get weight from card template configuration
        return Template switch
        {
            CardTemplateType.SimpleGreeting => 0,
            CardTemplateType.ActiveListening => 1,
            CardTemplateType.CasualInquiry => 1,
            CardTemplateType.OfferHelp => 2,
            CardTemplateType.SharePersonal => 2,
            CardTemplateType.ShareSecret => 3,
            CardTemplateType.MakeDesperatePromise => 5,
            CardTemplateType.UrgentPlea => 4,
            _ => 1
        };
    }

    private string GetCardTypeClass()
    {
        // Determine card visual category from template
        if (Template.ToString().Contains("Calm") || Template.ToString().Contains("Opening"))
            return "state";
        if (Template.ToString().Contains("Desperate") || Template.ToString().Contains("Urgent"))
            return "crisis";
        return "comfort";
    }
}

@GetCardText()