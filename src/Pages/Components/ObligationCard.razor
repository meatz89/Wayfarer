@namespace Wayfarer.Pages.Components
@*
Obligation Card - Individual obligation display
Shows type, deadline, rewards, and patron info
*@

<div class="obligation-card @ObligationTypeClass @UrgencyClass">
    <div class="obligation-header">
        <h4 class="obligation-name">@Obligation.Name</h4>
        <span class="obligation-type-badge @ObligationTypeClass">@ObligationTypeName</span>
    </div>

    <p class="obligation-description">@Obligation.Description</p>

    @if (Obligation.ObligationType == ObligationObligationType.NPCCommissioned)
    {
        <div class="obligation-deadline-section">
            <ObligationDeadlineTracker
                DeadlineSegment="@(Obligation.DeadlineSegment ?? 0)"
                CurrentSegment="@CurrentSegment" />

            @if (!string.IsNullOrEmpty(Obligation.PatronNpcId))
            {
                <div class="obligation-patron">
                    <span class="patron-label">Patron:</span>
                    <span class="patron-name">@Obligation.PatronNpcId</span>
                </div>
            }
        </div>
    }
    else
    {
        <div class="obligation-self-discovered">
            <span class="no-deadline-badge">No Deadline - Explore at Leisure</span>
        </div>
    }

    @if (Obligation.CompletionRewardCoins > 0 || (Obligation.CompletionRewardItems != null && Obligation.CompletionRewardItems.Count > 0))
    {
        <div class="obligation-rewards">
            <span class="rewards-label">Rewards:</span>
            @if (Obligation.CompletionRewardCoins > 0)
            {
                <span class="reward-coins">@Obligation.CompletionRewardCoins coins</span>
            }
            @if (Obligation.CompletionRewardItems != null && Obligation.CompletionRewardItems.Count > 0)
            {
                <span class="reward-items">@Obligation.CompletionRewardItems.Count item(s)</span>
            }
        </div>
    }

    <div class="obligation-progress">
        <span class="progress-label">Progress:</span>
        <span class="progress-value">@CompletedPhases/@TotalPhases phases</span>
    </div>
</div>

@code {
    [Parameter] public Obligation Obligation { get; set; }
    [Parameter] public int CurrentSegment { get; set; }

    private string ObligationTypeClass => Obligation.ObligationType == ObligationObligationType.NPCCommissioned
        ? "npc-commissioned"
        : "self-discovered";

    private string ObligationTypeName => Obligation.ObligationType == ObligationObligationType.NPCCommissioned
        ? "Commissioned"
        : "Self-Discovered";

    private string UrgencyClass
    {
        get
        {
            if (Obligation.ObligationType != ObligationObligationType.NPCCommissioned || !Obligation.DeadlineSegment.HasValue)
                return "";

            int segmentsRemaining = Obligation.DeadlineSegment.Value - CurrentSegment;

            return segmentsRemaining switch
            {
                <= 2 => "urgency-critical",
                <= 4 => "urgency-high",
                <= 8 => "urgency-moderate",
                _ => "urgency-low"
            };
        }
    }

    private int CompletedPhases => 0; // TODO: Calculate from actual phase completion
    private int TotalPhases => Obligation.PhaseDefinitions?.Count ?? 0;
}
