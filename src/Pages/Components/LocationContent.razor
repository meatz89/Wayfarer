@inherits LocationContentBase

@namespace Wayfarer.Pages.Components

<div class="location-content content-area">
    <!-- Atmospheric Description -->
    @if (CurrentSpot != null)
    {
        <LocationAtmosphereRenderer CurrentSpot="CurrentSpot" 
                                     CurrentTime="CurrentTime" 
                                     NPCsPresent="NPCsAtSpot" />
    }

    <!-- Priority Obligation Display -->
    @if (FirstObligation != null)
    {
        <div class="priority-obligation-display" @onclick="() => GameScreen?.NavigateToQueue()">
            <div class="obligation-header">
                <span class="icon icon-letter-urgent"></span>
                <span>Priority Delivery</span>
            </div>
            <div class="obligation-details">
                <div class="obligation-route">
                    <span class="sender">@FirstObligation.SenderName</span>
                    <span class="arrow">‚Üí</span>
                    <span class="recipient">@FirstObligation.RecipientName</span>
                </div>
                <div class="obligation-deadline @GetDeadlineClass(FirstObligation.DeadlineInMinutes)">
                    @if (FirstObligation.DeadlineInMinutes <= 0)
                    {
                        <span>EXPIRED</span>
                    }
                    else if (FirstObligation.DeadlineInMinutes < 60)
                    {
                        <span>@FirstObligation.DeadlineInMinutes min remaining</span>
                    }
                    else
                    {
                        <span>@(FirstObligation.DeadlineInMinutes / 60)h remaining</span>
                    }
                </div>
                <div class="obligation-stakes">
                    @FirstObligation.Stakes stakes
                </div>
            </div>
            <div class="click-hint">Click to manage queue</div>
        </div>
    }

    <!-- Available NPCs -->
    @if (AvailableNpcs.Any())
    {
        <div class="npcs-section">
            <h4 class="section-header">People Here</h4>
            <div class="npc-list">
                @foreach (var npc in AvailableNpcs)
                {
                    <div class="card-base card-standard npc-card">
                        <div class="npc-header">
                            <div class="npc-name">@npc.Name</div>
                            <div class="npc-state @GetStateClass(npc.EmotionalState)">@npc.EmotionalState</div>
                        </div>
                        <div class="npc-description">@GetNPCDescription(npc)</div>
                        @if (npc.HasCrisis)
                        {
                            <div class="crisis-indicator">‚ö† Crisis</div>
                        }
                        <div class="npc-actions">
                            @foreach (var option in npc.ConversationOptions)
                            {
                                <div class="npc-action @GetActionClass(option.Type)" 
                                     @onclick="() => StartTypedConversation(npc.Id, option.Type)">
                                    <span class="action-type">@option.Label</span>
                                    <span class="action-details">
                                        @if (option.AttentionCost == 0)
                                        {
                                            <span class="action-reward">Free!</span>
                                        }
                                        else
                                        {
                                            <span>@option.AttentionCost attention</span>
                                        }
                                    </span>
                                </div>
                            }
                            @if (DevMode?.ShowDeckViewer == true)
                            {
                                <div class="npc-action dev-mode-action" 
                                     @onclick="() => ViewNPCDeck(npc.Id)">
                                    <span class="action-type">üîç View Deck (Dev)</span>
                                    <span class="action-details">Debug Tool</span>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Available Observations -->
    @if (AvailableObservations.Any() || TakenObservations.Any())
    {
        <div class="observations">
            <div class="observation-note">You notice some interesting details about this place...</div>
            <div class="observation-list">
                @* Show taken observations first *@
                @foreach (var taken in TakenObservations)
                {
                    <div class="observation-item revealed card-base card-compact">
                        <div style="display: flex; justify-content: space-between; width: 100%;">
                            <div class="observation-text">@taken.Name</div>
                            <div>
                                <span>Observed</span>
                                <span> ‚Ä¢ </span>
                                @if (taken.GeneratedCard != null)
                                {
                                    <span class="reward-card">
                                        @taken.GeneratedCard.ConversationCard.Template Card
                                        <span class="card-depth">(Depth @taken.GeneratedCard.ConversationCard.Depth)</span>
                                    </span>
                                }
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(taken.NarrativeText))
                        {
                            <div class="observation-narrative">
                                @taken.NarrativeText
                            </div>
                        }
                        @if (taken.GeneratedCard != null)
                        {
                            var currentGameTime = DateTime.Now; // This should come from TimeManager ideally  
                            var decayDescription = taken.GeneratedCard.GetDecayStateDescription(currentGameTime);
                            if (!string.IsNullOrEmpty(decayDescription))
                            {
                                <div class="observation-decay">Card freshness: @decayDescription</div>
                            }
                        }
                    </div>
                }
                
                @* Show available observations *@
                @foreach (var obs in AvailableObservations)
                {
                    <div class="observation-item card-base card-compact" @onclick="() => TakeObservation(obs.Id)">
                        <div class="observation-text">@obs.Name</div>
                        <div class="observation-reward">
                            <span class="reward-card">+Card</span>
                            <span class="action-details">1 attention</span>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Available Spots -->
    @if (AvailableSpots.Any())
    {
        <div class="spots-section">
            <h4 class="section-header">Move Within Location</h4>
            <div class="cards-grid-2col">
                @foreach (var spot in AvailableSpots)
                {
                    <div class="card-base card-compact spot-card" @onclick="() => MoveToSpot(spot.Id)">
                        <div class="spot-card-name">@spot.Name</div>
                        @if (spot.Properties.Any())
                        {
                            <div class="spot-traits">
                                @foreach (var prop in spot.Properties)
                                {
                                    <span class="spot-trait">@prop</span>
                                }
                            </div>
                        }
                        <div class="spot-move-action">Move here (free)</div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Section Divider -->
    @if (CanTravel || CanWork)
    {
        <div class="section-divider">
            <span class="divider-text">Actions</span>
        </div>
    }

    <!-- Travel Option -->
    @if (CanTravel)
    {
        <div class="travel-section">
            <button class="travel-button" @onclick="NavigateToTravel">
                <span class="travel-icon">üó∫Ô∏è</span>
                <span>Travel to Another Location</span>
            </button>
        </div>
    }

    <!-- Work Action -->
    @if (CanWork)
    {
        <div class="cards-grid">
            <div class="card-base card-standard action-card" @onclick="PerformWork">
                <div class="action-name">Work for Coins</div>
                <div class="action-cost">
                    <span class="cost-value">2</span> attention ‚Üí 
                    <span class="cost-value">8</span> coins
                </div>
            </div>
        </div>
    }
</div>