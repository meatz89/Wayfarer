@inherits LocationContentBase

@namespace Wayfarer.Pages.Components

@if (CurrentSpot != null)
{
    <!-- Venue Header -->
    <div class="location-header">
        <div class="location-path">
            @if (!string.IsNullOrEmpty(CurrentLocation?.Name))
            {
                <span>Lower Wards</span>
                <span class="icon-arrow-right"></span>
                <span>@CurrentLocation.Name</span>
            }
        </div>
        <div class="location-name">@CurrentLocation?.Name</div>
        <div class="location-traits">
            <span class="trait">Public</span>
            <span class="trait">@GetTimeOfDayTrait()</span>
        </div>
    </div>

    <!-- Current Spot Banner -->
    <div class="current-spot-banner">
        <div class="current-spot-name">@CurrentSpot.Name</div>
        <div class="spot-traits">
            @foreach (var prop in CurrentSpot.LocationProperties ?? new List<LocationPropertyType>())
            {
                <span class="spot-trait @GetSpotTraitClass(prop)">@GetSpotTraitDisplay(prop)</span>
            }
        </div>
    </div>

    <!-- VISUAL NOVEL SCENE NAVIGATION -->
    <div class="content-area">
        @* Atmosphere shown on Landing and Looking Around views *@
        @if ((ViewState == LocationViewState.Landing || ViewState == LocationViewState.LookingAround) && CurrentSpot != null)
        {
            <div class="atmosphere-text">
                <LocationAtmosphereRenderer CurrentLocation="CurrentSpot"
                                             CurrentTime="CurrentTime"
                                             NPCsPresent="NPCsAtSpot" />
            </div>
        }

        @* CONDITIONAL VIEW RENDERING - Render separate components *@
        @switch (ViewState)
        {
            case LocationViewState.Landing:
                <Landing HasSpots="@AvailableSpots.Any()"
                         CurrentLocationName="@CurrentLocation?.Name"
                         TravelActions="@GetTravelActions()"
                         PlayerActions="@GetPlayerActions()"
                         OnNavigateToView="HandleNavigateToView"
                         OnExecuteLocationAction="HandleExecuteLocationAction" />
                break;

            case LocationViewState.LookingAround:
                @* UNIFIED VIEW - Shows NPCs + Social + Mental + Physical goals all at once *@
                @* Uses same CSS structure as NPCDetailView + LocationChallenges *@
                <div class="location-npc-list-view">
                    <div class="section-header">You scan the area...</div>

                    @* ========== NPCs AND SOCIAL INTERACTIONS ========== *@
                    @if (AvailableNpcs.Any())
                    {
                        <div class="section-subheader">People Here</div>

                        @foreach (var npc in AvailableNpcs)
                        {
                            @* Full NPC card with same structure as NPCDetailView *@
                            <div class="npc-card">
                                <div class="npc-header">
                                    <div>
                                        <div class="npc-name">@npc.Name</div>
                                        <div class="npc-type">@npc.PersonalityType</div>
                                    </div>
                                    <div class="npc-state @(npc.ConnectionState == "DISCONNECTED" ? "disconnected" : "")">@npc.ConnectionState</div>
                                </div>
                                <div class="npc-description">@GetNPCDescription(npc)</div>
                            </div>

                            @* Social Goals for this NPC *@
                            @if (AvailableSocialGoals.Where(g => g.PlacementNpcId == npc.Id).Any())
                            {
                                <div class="actions-grid">
                                    @foreach (var goal in AvailableSocialGoals.Where(g => g.PlacementNpcId == npc.Id))
                                    {
                                        <div class="goal-action-btn @(!string.IsNullOrEmpty(goal.InvestigationId) ? "intro-action" : "")"
                                             @onclick="() => HandleNavigateToGoal(goal.Id)">
                                            <div class="goal-system-badge social">Social</div>
                                            <div class="goal-name">@goal.Name</div>
                                            @if (!string.IsNullOrEmpty(goal.Description))
                                            {
                                                <div class="goal-description">@goal.Description</div>
                                            }
                                            <div class="goal-difficulty">
                                                <span class="difficulty-label">Doubt:</span>
                                                <span class="difficulty-value">@GetGoalDifficulty(goal)</span>
                                            </div>
                                            @if (!string.IsNullOrEmpty(goal.InvestigationId))
                                            {
                                                <div class="goal-investigation-tag intro-tag">üîç Investigation</div>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        }
                    }

                    @* ========== MENTAL CHALLENGES ========== *@
                    @if (AvailableMentalGoals.Any())
                    {
                        <div class="section-subheader">Mental Challenges</div>
                        <div class="actions-grid">
                            @foreach (var goal in AvailableMentalGoals)
                            {
                                <div class="goal-action-btn @(!string.IsNullOrEmpty(goal.InvestigationId) ? "intro-action" : "")"
                                     @onclick="() => HandleNavigateToGoal(goal.Id)">
                                    <div class="goal-system-badge mental">Mental</div>
                                    <div class="goal-name">@goal.Name</div>
                                    @if (!string.IsNullOrEmpty(goal.Description))
                                    {
                                        <div class="goal-description">@goal.Description</div>
                                    }
                                    <div class="goal-difficulty">
                                        <span class="difficulty-label">Exposure:</span>
                                        <span class="difficulty-value">@GetGoalDifficulty(goal)</span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(goal.InvestigationId))
                                    {
                                        <div class="goal-investigation-tag intro-tag">üîç Investigation</div>
                                    }
                                </div>
                            }
                        </div>
                    }

                    @* ========== PHYSICAL CHALLENGES ========== *@
                    @if (AvailablePhysicalGoals.Any())
                    {
                        <div class="section-subheader">Physical Challenges</div>
                        <div class="actions-grid">
                            @foreach (var goal in AvailablePhysicalGoals)
                            {
                                <div class="goal-action-btn @(!string.IsNullOrEmpty(goal.InvestigationId) ? "intro-action" : "")"
                                     @onclick="() => HandleNavigateToGoal(goal.Id)">
                                    <div class="goal-system-badge physical">Physical</div>
                                    <div class="goal-name">@goal.Name</div>
                                    @if (!string.IsNullOrEmpty(goal.Description))
                                    {
                                        <div class="goal-description">@goal.Description</div>
                                    }
                                    <div class="goal-difficulty">
                                        <span class="difficulty-label">Danger:</span>
                                        <span class="difficulty-value">@GetGoalDifficulty(goal)</span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(goal.InvestigationId))
                                    {
                                        <div class="goal-investigation-tag intro-tag">üîç Investigation</div>
                                    }
                                </div>
                            }
                        </div>
                    }

                    @* ========== EMPTY STATE ========== *@
                    @if (!AvailableNpcs.Any() && !AvailableMentalGoals.Any() && !AvailablePhysicalGoals.Any())
                    {
                        <p>The area is quiet. No one else is here, and nothing catches your attention.</p>
                    }

                    <button class="back-button" @onclick="NavigateBack">Back</button>
                </div>
                break;

            @* REMOVED: ApproachNPC - consolidated into LookingAround *@
            @* REMOVED: LocationChallenges - consolidated into LookingAround *@

            case LocationViewState.GoalDetail:
                <GoalDetailView SelectedGoal="@GetGoalDetailViewModel()"
                                OnCommitToGoal="HandleCommitToGoal"
                                OnNavigateBack="NavigateBack" />
                break;

            case LocationViewState.Spots:
                <SpotsView CurrentLocationName="@CurrentLocation?.Name"
                           AvailableSpots="@GetSpotsViewModel()"
                           OnMoveToSpot="HandleMoveToSpot"
                           OnNavigateBack="NavigateBack" />
                break;

            case LocationViewState.Equipment:
                <EquipmentInventory OnInventoryChanged="HandleInventoryChanged" />
                <div class="back-button-container">
                    <button class="back-button" @onclick="NavigateBack">‚Üê Back</button>
                </div>
                break;
        }
    </div>
}
else
{
    <div class="loading">
        Loading location...
    </div>
}
