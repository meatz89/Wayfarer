@inherits LocationContentBase

@namespace Wayfarer.Pages.Components

@if (ViewModel != null && ViewModel.Header != null)
{
    <!-- Venue Header -->
    <div class="location-header">
        <div class="location-path">
            <span>Lower Wards</span>
            <span class="icon-arrow-right"></span>
            <span>@ViewModel.Header.VenueName</span>
        </div>
        <div class="location-name">@ViewModel.Header.VenueName</div>
        <div class="location-traits">
            <span class="trait">Public</span>
            <span class="trait">@ViewModel.Header.TimeOfDayTrait</span>
        </div>
    </div>

    <!-- Current Spot Banner -->
    <div class="current-spot-banner">
        <div class="current-spot-name">@ViewModel.Header.SpotName</div>
        <div class="spot-traits">
            @foreach (var trait in ViewModel.Header.SpotTraits)
            {
                <span class="spot-trait">@trait</span>
            }
        </div>
    </div>

    <!-- VISUAL NOVEL SCENE NAVIGATION -->
    <div class="content-area">
        @* Atmosphere shown on Landing and Looking Around views - pre-generated by backend *@
        @if ((ViewState == LocationViewState.Landing || ViewState == LocationViewState.LookingAround) && ViewModel.Header != null)
        {
            <div class="atmosphere-text">
                @ViewModel.Header.AtmosphereText
            </div>
        }

        @* CONDITIONAL VIEW RENDERING - Render separate components *@
        @switch (ViewState)
        {
            case LocationViewState.Landing:
                <Landing HasSpots="@ViewModel.HasSpots"
                         CurrentLocationName="@ViewModel.Header.VenueName"
                         TravelActions="@ViewModel.TravelActions"
                         PlayerActions="@ViewModel.PlayerActions"
                         OnNavigateToView="HandleNavigateToView"
                         OnExecuteLocationAction="HandleExecuteLocationAction" />
                break;

            case LocationViewState.LookingAround:
                @* UNIFIED VIEW - NPCs with goals PRE-GROUPED by backend *@
                <div class="location-npc-list-view">
                    <div class="section-header">You scan the area...</div>

                    @* ========== NPCs WITH THEIR SOCIAL GOALS ========== *@
                    @if (ViewModel.NPCsWithGoals.Any())
                    {
                        <div class="section-subheader">People Here</div>

                        @foreach (var npcWithGoals in ViewModel.NPCsWithGoals)
                        {
                            @* NPC Card *@
                            <div class="npc-card">
                                <div class="npc-header">
                                    <div>
                                        <div class="npc-name">@npcWithGoals.Name</div>
                                        <div class="npc-type">@npcWithGoals.PersonalityType</div>
                                    </div>
                                    <div class="npc-state @npcWithGoals.StateClass">@npcWithGoals.ConnectionState</div>
                                </div>
                                <div class="npc-description">@npcWithGoals.Description</div>
                            </div>

                            @* Ambient Social Goals (without obstacles) *@
                            @if (npcWithGoals.AmbientSocialGoals.Any())
                            {
                                <div class="actions-grid">
                                    @foreach (var goal in npcWithGoals.AmbientSocialGoals)
                                    {
                                        <div class="goal-action-btn @(goal.IsIntroAction ? "intro-action" : "")"
                                             @onclick="() => HandleNavigateToGoal(goal.Id)">
                                            <div class="goal-system-badge social">Social</div>
                                            <div class="goal-name">@goal.Name</div>
                                            @if (!string.IsNullOrEmpty(goal.Description))
                                            {
                                                <div class="goal-description">@goal.Description</div>
                                            }
                                            <div class="goal-difficulty">
                                                <span class="difficulty-label">@goal.DifficultyLabel:</span>
                                                <span class="difficulty-value">@goal.Difficulty</span>
                                            </div>
                                            @if (goal.IsIntroAction)
                                            {
                                                <div class="goal-obligation-tag intro-tag">üîç Obligation</div>
                                            }
                                        </div>
                                    }
                                </div>
                            }

                            @* Social Obstacles with nested goals *@
                            @foreach (var obstacle in npcWithGoals.SocialObstacles)
                            {
                                <div class="obstacle-card">
                                    <div class="obstacle-header">
                                        <div class="obstacle-name">@obstacle.Name</div>
                                        <div class="obstacle-meta">
                                            <span class="obstacle-intensity">Intensity: @obstacle.Intensity</span>
                                            <span class="obstacle-contexts">@obstacle.ContextsDisplay</span>
                                        </div>
                                    </div>
                                    <div class="obstacle-description">@obstacle.Description</div>

                                    <div class="actions-grid">
                                        @foreach (var goal in obstacle.Goals)
                                        {
                                            <div class="goal-action-btn @(goal.IsIntroAction ? "intro-action" : "")"
                                                 @onclick="() => HandleNavigateToGoal(goal.Id)">
                                                <div class="goal-system-badge social">Social</div>
                                                <div class="goal-name">@goal.Name</div>
                                                @if (!string.IsNullOrEmpty(goal.Description))
                                                {
                                                    <div class="goal-description">@goal.Description</div>
                                                }
                                                <div class="goal-difficulty">
                                                    <span class="difficulty-label">@goal.DifficultyLabel:</span>
                                                    <span class="difficulty-value">@goal.Difficulty</span>
                                                </div>
                                                @if (goal.IsIntroAction)
                                                {
                                                    <div class="goal-obligation-tag intro-tag">üîç Obligation</div>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            }

                            @* Exchange Option for MERCANTILE NPCs *@
                            @if (npcWithGoals.HasExchange)
                            {
                                <div class="actions-grid">
                                    <div class="goal-action-btn"
                                         @onclick="async () => await HandleStartExchange(npcWithGoals.Id)">
                                        <div class="goal-system-badge exchange">Exchange</div>
                                        <div class="goal-name">Trading</div>
                                        <div class="goal-description">@npcWithGoals.ExchangeDescription</div>
                                    </div>
                                </div>
                            }
                        }
                    }

                    @* ========== MENTAL CHALLENGES ========== *@
                    @if (ViewModel.AmbientMentalGoals.Any() || ViewModel.MentalObstacles.Any())
                    {
                        <div class="section-subheader">Mental Challenges</div>

                        @* Ambient Mental Goals (without obstacles) *@
                        @if (ViewModel.AmbientMentalGoals.Any())
                        {
                            <div class="actions-grid">
                                @foreach (var goal in ViewModel.AmbientMentalGoals)
                                {
                                    <div class="goal-action-btn @(goal.IsIntroAction ? "intro-action" : "")"
                                         @onclick="() => HandleNavigateToGoal(goal.Id)">
                                        <div class="goal-system-badge mental">Mental</div>
                                        <div class="goal-name">@goal.Name</div>
                                        @if (!string.IsNullOrEmpty(goal.Description))
                                        {
                                            <div class="goal-description">@goal.Description</div>
                                        }
                                        <div class="goal-difficulty">
                                            <span class="difficulty-label">@goal.DifficultyLabel:</span>
                                            <span class="difficulty-value">@goal.Difficulty</span>
                                        </div>
                                        @if (goal.IsIntroAction)
                                        {
                                            <div class="goal-obligation-tag intro-tag">üîç Obligation</div>
                                        }
                                    </div>
                                }
                            </div>
                        }

                        @* Mental Obstacles with nested goals *@
                        @foreach (var obstacle in ViewModel.MentalObstacles)
                        {
                            <div class="obstacle-card">
                                <div class="obstacle-header">
                                    <div class="obstacle-name">@obstacle.Name</div>
                                    <div class="obstacle-meta">
                                        <span class="obstacle-intensity">Intensity: @obstacle.Intensity</span>
                                        <span class="obstacle-contexts">@obstacle.ContextsDisplay</span>
                                    </div>
                                </div>
                                <div class="obstacle-description">@obstacle.Description</div>

                                <div class="actions-grid">
                                    @foreach (var goal in obstacle.Goals)
                                    {
                                        <div class="goal-action-btn @(goal.IsIntroAction ? "intro-action" : "")"
                                             @onclick="() => HandleNavigateToGoal(goal.Id)">
                                            <div class="goal-system-badge mental">Mental</div>
                                            <div class="goal-name">@goal.Name</div>
                                            @if (!string.IsNullOrEmpty(goal.Description))
                                            {
                                                <div class="goal-description">@goal.Description</div>
                                            }
                                            <div class="goal-difficulty">
                                                <span class="difficulty-label">@goal.DifficultyLabel:</span>
                                                <span class="difficulty-value">@goal.Difficulty</span>
                                            </div>
                                            @if (goal.IsIntroAction)
                                            {
                                                <div class="goal-obligation-tag intro-tag">üîç Obligation</div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }

                    @* ========== PHYSICAL CHALLENGES ========== *@
                    @if (ViewModel.AmbientPhysicalGoals.Any() || ViewModel.PhysicalObstacles.Any())
                    {
                        <div class="section-subheader">Physical Challenges</div>

                        @* Ambient Physical Goals (without obstacles) *@
                        @if (ViewModel.AmbientPhysicalGoals.Any())
                        {
                            <div class="actions-grid">
                                @foreach (var goal in ViewModel.AmbientPhysicalGoals)
                                {
                                    <div class="goal-action-btn @(goal.IsIntroAction ? "intro-action" : "")"
                                         @onclick="() => HandleNavigateToGoal(goal.Id)">
                                        <div class="goal-system-badge physical">Physical</div>
                                        <div class="goal-name">@goal.Name</div>
                                        @if (!string.IsNullOrEmpty(goal.Description))
                                        {
                                            <div class="goal-description">@goal.Description</div>
                                        }
                                        <div class="goal-difficulty">
                                            <span class="difficulty-label">@goal.DifficultyLabel:</span>
                                            <span class="difficulty-value">@goal.Difficulty</span>
                                        </div>
                                        @if (goal.IsIntroAction)
                                        {
                                            <div class="goal-obligation-tag intro-tag">üîç Obligation</div>
                                        }
                                    </div>
                                }
                            </div>
                        }

                        @* Physical Obstacles with nested goals *@
                        @foreach (var obstacle in ViewModel.PhysicalObstacles)
                        {
                            <div class="obstacle-card">
                                <div class="obstacle-header">
                                    <div class="obstacle-name">@obstacle.Name</div>
                                    <div class="obstacle-meta">
                                        <span class="obstacle-intensity">Intensity: @obstacle.Intensity</span>
                                        <span class="obstacle-contexts">@obstacle.ContextsDisplay</span>
                                    </div>
                                </div>
                                <div class="obstacle-description">@obstacle.Description</div>

                                <div class="actions-grid">
                                    @foreach (var goal in obstacle.Goals)
                                    {
                                        <div class="goal-action-btn @(goal.IsIntroAction ? "intro-action" : "")"
                                             @onclick="() => HandleNavigateToGoal(goal.Id)">
                                            <div class="goal-system-badge physical">Physical</div>
                                            <div class="goal-name">@goal.Name</div>
                                            @if (!string.IsNullOrEmpty(goal.Description))
                                            {
                                                <div class="goal-description">@goal.Description</div>
                                            }
                                            <div class="goal-difficulty">
                                                <span class="difficulty-label">@goal.DifficultyLabel:</span>
                                                <span class="difficulty-value">@goal.Difficulty</span>
                                            </div>
                                            @if (goal.IsIntroAction)
                                            {
                                                <div class="goal-obligation-tag intro-tag">üîç Obligation</div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }

                    @* ========== EMPTY STATE ========== *@
                    @if (!ViewModel.NPCsWithGoals.Any()
                        && !ViewModel.AmbientMentalGoals.Any() && !ViewModel.MentalObstacles.Any()
                        && !ViewModel.AmbientPhysicalGoals.Any() && !ViewModel.PhysicalObstacles.Any())
                    {
                        <p>The area is quiet. No one else is here, and nothing catches your attention.</p>
                    }

                    <button class="back-button" @onclick="NavigateBack">Back</button>
                </div>
                break;

            @* REMOVED: ApproachNPC - consolidated into LookingAround *@
            @* REMOVED: LocationChallenges - consolidated into LookingAround *@

            case LocationViewState.GoalDetail:
                <GoalDetailView SelectedGoal="@GetGoalDetailViewModel()"
                                OnCommitToGoal="HandleCommitToGoal"
                                OnNavigateBack="NavigateBack" />
                break;

            case LocationViewState.Spots:
                <SpotsView CurrentLocationName="@ViewModel.Header.VenueName"
                           AvailableSpots="@ViewModel.AvailableSpots"
                           OnMoveToSpot="HandleMoveToSpot"
                           OnNavigateBack="NavigateBack" />
                break;

            case LocationViewState.Equipment:
                <EquipmentInventory OnInventoryChanged="HandleInventoryChanged" />
                <div class="back-button-container">
                    <button class="back-button" @onclick="NavigateBack">‚Üê Back</button>
                </div>
                break;
        }
    </div>
}
else
{
    <div class="loading">
        Loading location...
    </div>
}
