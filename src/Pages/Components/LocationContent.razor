@inherits LocationContentBase

@namespace Wayfarer.Pages.Components

@if (ViewModel != null && ViewModel.Header != null)
{
    <!-- Venue Header -->
    <div class="location-header">
        <div class="location-path">
            <span>Lower Wards</span>
            <span class="icon-arrow-right"></span>
            <span>@ViewModel.Header.VenueName</span>
        </div>
        <div class="location-name">@ViewModel.Header.VenueName</div>
        <div class="location-traits">
            <span class="trait">Public</span>
            <span class="trait">@ViewModel.Header.TimeOfDayTrait</span>
        </div>
    </div>

    <!-- Current Spot Banner -->
    <div class="current-spot-banner">
        <div class="current-spot-name">@ViewModel.Header.SpotName</div>
        <div class="spot-traits">
            @foreach (var trait in ViewModel.Header.SpotTraits)
            {
                <span class="spot-trait">@trait</span>
            }
        </div>
    </div>

    <!-- VISUAL NOVEL SCENE NAVIGATION -->
    <div class="content-area">
        @* Atmosphere shown on Landing and Looking Around views - pre-generated by backend *@
        @if ((ViewState == LocationViewState.Landing || ViewState == LocationViewState.LookingAround) && ViewModel.Header != null)
        {
            <div class="atmosphere-text">
                @ViewModel.Header.AtmosphereText
            </div>
        }

        @* CONDITIONAL VIEW RENDERING - Render separate components *@
        @switch (ViewState)
        {
            case LocationViewState.Landing:
                <Landing HasSpots="@ViewModel.HasSpots"
                         CurrentLocationName="@ViewModel.Header.VenueName"
                         TravelActions="@ViewModel.TravelActions"
                         PlayerActions="@ViewModel.PlayerActions"
                         OnNavigateToView="HandleNavigateToView"
                         OnExecuteLocationAction="HandleExecuteLocationAction" />
                break;

            case LocationViewState.LookingAround:
                @* UNIFIED VIEW - NPCs with situations PRE-GROUPED by backend *@
                <div class="location-npc-list-view">
                    <div class="section-header">You scan the area...</div>

                    @* ========== NPCs WITH THEIR SOCIAL SITUATIONS ========== *@
                    @if (ViewModel.NPCsWithSituations.Any())
                    {
                        <div class="section-subheader">People Here</div>

                        @foreach (var npcWithSituations in ViewModel.NPCsWithSituations)
                        {
                            @* NPC Card *@
                            <div class="npc-card">
                                <div class="npc-header">
                                    <div>
                                        <div class="npc-name">@npcWithSituations.Name</div>
                                        <div class="npc-type">@npcWithSituations.PersonalityType</div>
                                    </div>
                                    <div class="npc-state @npcWithSituations.StateClass">@npcWithSituations.ConnectionState</div>
                                </div>
                                <div class="npc-description">@npcWithSituations.Description</div>
                            </div>

                            @* Ambient Social Situations (without obstacles) *@
                            @if (npcWithSituations.AmbientSocialSituations.Any())
                            {
                                <div class="actions-grid">
                                    @foreach (var situation in npcWithSituations.AmbientSocialSituations)
                                    {
                                        <div class="situation-action-btn @(situation.IsIntroAction ? "intro-action" : "")"
                                             @onclick="() => HandleNavigateToSituation(situation.Id)">
                                            <div class="situation-system-badge social">Social</div>
                                            <div class="situation-name">@situation.Name</div>
                                            @if (!string.IsNullOrEmpty(situation.Description))
                                            {
                                                <div class="situation-description">@situation.Description</div>
                                            }
                                            <div class="situation-difficulty">
                                                <span class="difficulty-label">@situation.DifficultyLabel:</span>
                                                <span class="difficulty-value">@situation.Difficulty</span>
                                            </div>
                                            @if (situation.IsIntroAction)
                                            {
                                                <div class="situation-obligation-tag intro-tag">üîç Obligation</div>
                                            }
                                        </div>
                                    }
                                </div>
                            }

                            @* Social Obstacles with nested situations *@
                            @foreach (var obstacle in npcWithSituations.SocialObstacles)
                            {
                                <div class="obstacle-card">
                                    <div class="obstacle-header">
                                        <div class="obstacle-name">@obstacle.Name</div>
                                        <div class="obstacle-meta">
                                            <span class="obstacle-intensity">Intensity: @obstacle.Intensity</span>
                                            <span class="obstacle-contexts">@obstacle.ContextsDisplay</span>
                                        </div>
                                    </div>
                                    <div class="obstacle-description">@obstacle.Description</div>

                                    <div class="actions-grid">
                                        @foreach (var situation in obstacle.Situations)
                                        {
                                            <div class="situation-action-btn @(situation.IsIntroAction ? "intro-action" : "")"
                                                 @onclick="() => HandleNavigateToSituation(situation.Id)">
                                                <div class="situation-system-badge social">Social</div>
                                                <div class="situation-name">@situation.Name</div>
                                                @if (!string.IsNullOrEmpty(situation.Description))
                                                {
                                                    <div class="situation-description">@situation.Description</div>
                                                }
                                                <div class="situation-difficulty">
                                                    <span class="difficulty-label">@situation.DifficultyLabel:</span>
                                                    <span class="difficulty-value">@situation.Difficulty</span>
                                                </div>
                                                @if (situation.IsIntroAction)
                                                {
                                                    <div class="situation-obligation-tag intro-tag">üîç Obligation</div>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            }

                            @* Exchange Option for MERCANTILE NPCs *@
                            @if (npcWithSituations.HasExchange)
                            {
                                <div class="actions-grid">
                                    <div class="situation-action-btn"
                                         @onclick="async () => await HandleStartExchange(npcWithSituations.Id)">
                                        <div class="situation-system-badge exchange">Exchange</div>
                                        <div class="situation-name">Trading</div>
                                        <div class="situation-description">@npcWithSituations.ExchangeDescription</div>
                                    </div>
                                </div>
                            }
                        }
                    }

                    @* ========== MENTAL CHALLENGES ========== *@
                    @if (ViewModel.AmbientMentalSituations.Any() || ViewModel.MentalObstacles.Any())
                    {
                        <div class="section-subheader">Mental Challenges</div>

                        @* Ambient Mental Situations (without obstacles) *@
                        @if (ViewModel.AmbientMentalSituations.Any())
                        {
                            <div class="actions-grid">
                                @foreach (var situation in ViewModel.AmbientMentalSituations)
                                {
                                    <div class="situation-action-btn @(situation.IsIntroAction ? "intro-action" : "")"
                                         @onclick="() => HandleNavigateToSituation(situation.Id)">
                                        <div class="situation-system-badge mental">Mental</div>
                                        <div class="situation-name">@situation.Name</div>
                                        @if (!string.IsNullOrEmpty(situation.Description))
                                        {
                                            <div class="situation-description">@situation.Description</div>
                                        }
                                        <div class="situation-difficulty">
                                            <span class="difficulty-label">@situation.DifficultyLabel:</span>
                                            <span class="difficulty-value">@situation.Difficulty</span>
                                        </div>
                                        @if (situation.IsIntroAction)
                                        {
                                            <div class="situation-obligation-tag intro-tag">üîç Obligation</div>
                                        }
                                    </div>
                                }
                            </div>
                        }

                        @* Mental Obstacles with nested situations *@
                        @foreach (var obstacle in ViewModel.MentalObstacles)
                        {
                            <div class="obstacle-card">
                                <div class="obstacle-header">
                                    <div class="obstacle-name">@obstacle.Name</div>
                                    <div class="obstacle-meta">
                                        <span class="obstacle-intensity">Intensity: @obstacle.Intensity</span>
                                        <span class="obstacle-contexts">@obstacle.ContextsDisplay</span>
                                    </div>
                                </div>
                                <div class="obstacle-description">@obstacle.Description</div>

                                <div class="actions-grid">
                                    @foreach (var situation in obstacle.Situations)
                                    {
                                        <div class="situation-action-btn @(situation.IsIntroAction ? "intro-action" : "")"
                                             @onclick="() => HandleNavigateToSituation(situation.Id)">
                                            <div class="situation-system-badge mental">Mental</div>
                                            <div class="situation-name">@situation.Name</div>
                                            @if (!string.IsNullOrEmpty(situation.Description))
                                            {
                                                <div class="situation-description">@situation.Description</div>
                                            }
                                            <div class="situation-difficulty">
                                                <span class="difficulty-label">@situation.DifficultyLabel:</span>
                                                <span class="difficulty-value">@situation.Difficulty</span>
                                            </div>
                                            @if (situation.IsIntroAction)
                                            {
                                                <div class="situation-obligation-tag intro-tag">üîç Obligation</div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }

                    @* ========== PHYSICAL CHALLENGES ========== *@
                    @if (ViewModel.AmbientPhysicalSituations.Any() || ViewModel.PhysicalObstacles.Any())
                    {
                        <div class="section-subheader">Physical Challenges</div>

                        @* Ambient Physical Situations (without obstacles) *@
                        @if (ViewModel.AmbientPhysicalSituations.Any())
                        {
                            <div class="actions-grid">
                                @foreach (var situation in ViewModel.AmbientPhysicalSituations)
                                {
                                    <div class="situation-action-btn @(situation.IsIntroAction ? "intro-action" : "")"
                                         @onclick="() => HandleNavigateToSituation(situation.Id)">
                                        <div class="situation-system-badge physical">Physical</div>
                                        <div class="situation-name">@situation.Name</div>
                                        @if (!string.IsNullOrEmpty(situation.Description))
                                        {
                                            <div class="situation-description">@situation.Description</div>
                                        }
                                        <div class="situation-difficulty">
                                            <span class="difficulty-label">@situation.DifficultyLabel:</span>
                                            <span class="difficulty-value">@situation.Difficulty</span>
                                        </div>
                                        @if (situation.IsIntroAction)
                                        {
                                            <div class="situation-obligation-tag intro-tag">üîç Obligation</div>
                                        }
                                    </div>
                                }
                            </div>
                        }

                        @* Physical Obstacles with nested situations *@
                        @foreach (var obstacle in ViewModel.PhysicalObstacles)
                        {
                            <div class="obstacle-card">
                                <div class="obstacle-header">
                                    <div class="obstacle-name">@obstacle.Name</div>
                                    <div class="obstacle-meta">
                                        <span class="obstacle-intensity">Intensity: @obstacle.Intensity</span>
                                        <span class="obstacle-contexts">@obstacle.ContextsDisplay</span>
                                    </div>
                                </div>
                                <div class="obstacle-description">@obstacle.Description</div>

                                <div class="actions-grid">
                                    @foreach (var situation in obstacle.Situations)
                                    {
                                        <div class="situation-action-btn @(situation.IsIntroAction ? "intro-action" : "")"
                                             @onclick="() => HandleNavigateToSituation(situation.Id)">
                                            <div class="situation-system-badge physical">Physical</div>
                                            <div class="situation-name">@situation.Name</div>
                                            @if (!string.IsNullOrEmpty(situation.Description))
                                            {
                                                <div class="situation-description">@situation.Description</div>
                                            }
                                            <div class="situation-difficulty">
                                                <span class="difficulty-label">@situation.DifficultyLabel:</span>
                                                <span class="difficulty-value">@situation.Difficulty</span>
                                            </div>
                                            @if (situation.IsIntroAction)
                                            {
                                                <div class="situation-obligation-tag intro-tag">üîç Obligation</div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }

                    @* ========== CONVERSATION TREES ========== *@
                    @if (AvailableConversationTrees.Any())
                    {
                        <div class="section-subheader">Available Conversations</div>

                        <div class="actions-grid">
                            @foreach (var tree in AvailableConversationTrees)
                            {
                                <div class="situation-action-btn"
                                     @onclick="async () => await HandleStartConversationTree(tree.Id)">
                                    <div class="situation-system-badge conversation">Conversation</div>
                                    <div class="situation-name">@tree.Name</div>
                                    @if (!string.IsNullOrEmpty(tree.Description))
                                    {
                                        <div class="situation-description">@tree.Description</div>
                                    }
                                    @if (tree.Npc != null)
                                    {
                                        <div class="situation-meta">with @tree.Npc.Name</div>
                                    }
                                </div>
                            }
                        </div>
                    }

                    @* ========== OBSERVATION SCENES ========== *@
                    @if (AvailableObservationScenes.Any())
                    {
                        <div class="section-subheader">Investigate</div>

                        <div class="actions-grid">
                            @foreach (var scene in AvailableObservationScenes)
                            {
                                <div class="situation-action-btn"
                                     @onclick="async () => await HandleStartObservationScene(scene.Id)">
                                    <div class="situation-system-badge observation">Observation</div>
                                    <div class="situation-name">@scene.Name</div>
                                    @if (!string.IsNullOrEmpty(scene.Description))
                                    {
                                        <div class="situation-description">@scene.Description</div>
                                    }
                                </div>
                            }
                        </div>
                    }

                    @* ========== EMPTY STATE ========== *@
                    @if (!ViewModel.NPCsWithSituations.Any()
                        && !ViewModel.AmbientMentalSituations.Any() && !ViewModel.MentalObstacles.Any()
                        && !ViewModel.AmbientPhysicalSituations.Any() && !ViewModel.PhysicalObstacles.Any()
                        && !AvailableConversationTrees.Any() && !AvailableObservationScenes.Any())
                    {
                        <p>The area is quiet. No one else is here, and nothing catches your attention.</p>
                    }

                    <button class="back-button" @onclick="NavigateBack">Back</button>
                </div>
                break;

            @* REMOVED: ApproachNPC - consolidated into LookingAround *@
            @* REMOVED: LocationChallenges - consolidated into LookingAround *@

            case LocationViewState.SituationDetail:
                <SituationDetailView SelectedSituation="@GetSituationDetailViewModel()"
                                OnCommitToSituation="HandleCommitToSituation"
                                OnNavigateBack="NavigateBack" />
                break;

            case LocationViewState.Spots:
                <SpotsView CurrentLocationName="@ViewModel.Header.VenueName"
                           AvailableSpots="@ViewModel.AvailableSpots"
                           OnMoveToSpot="HandleMoveToSpot"
                           OnNavigateBack="NavigateBack" />
                break;

            case LocationViewState.Equipment:
                <EquipmentInventory OnInventoryChanged="HandleInventoryChanged" />
                <div class="back-button-container">
                    <button class="back-button" @onclick="NavigateBack">‚Üê Back</button>
                </div>
                break;
        }
    </div>
}
else
{
    <div class="loading">
        Loading location...
    </div>
}
