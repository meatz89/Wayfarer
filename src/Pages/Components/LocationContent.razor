@inherits LocationContentBase

@namespace Wayfarer.Pages.Components

<div class="location-content content-area">
    <!-- Active Obligations Queue - Always show to emphasize the queue system -->
    <div class="obligations-panel" @onclick="() => GameScreen?.NavigateToQueue()">
        <div class="obligations-header">
            <span>Active Obligations</span>
            <span class="queue-rule">Must complete Position 1 first!</span>
        </div>
        <div class="obligation-list">
            @{
                var obligationsList = ActiveObligations?.ToList() ?? new List<DeliveryObligation>();
            }
            @for (int i = 0; i < 3; i++)
            {
                if (i > 0)
                {
                    <span class="queue-arrow">‚Üí</span>
                }
                
                @if (i < obligationsList.Count)
                {
                    var obligation = obligationsList[i];
                    <div class="obligation-item @(i == 0 ? "position-1" : "")">
                        <span class="queue-position">@(i + 1)</span>
                        @obligation.SenderName ‚Üí @obligation.RecipientName
                        <span class="deadline">(@GetDeadlineText(obligation.DeadlineInMinutes))</span>
                    </div>
                }
                else
                {
                    <div class="obligation-item empty">
                        <span class="queue-position">@(i + 1)</span>
                        <span style="color: #7a6250;">[Empty]</span>
                    </div>
                }
            }
        </div>
    </div>

    <!-- Atmospheric Description -->
    @if (CurrentSpot != null)
    {
        <LocationAtmosphereRenderer CurrentSpot="CurrentSpot" 
                                     CurrentTime="CurrentTime" 
                                     NPCsPresent="NPCsAtSpot" />
    }


    <!-- Available NPCs -->
    @if (AvailableNpcs.Any())
    {
        <div class="npcs-section">
            <h4 class="section-header">People Here</h4>
            <div class="npc-list">
                @foreach (var npc in AvailableNpcs)
                {
                    <div class="card-base card-standard npc-card">
                        <div class="npc-header">
                            <div>
                                <div class="npc-name">@npc.Name</div>
                                <div class="npc-type">@GetNPCPersonalityDescription(npc)</div>
                            </div>
                            <div class="npc-state @GetStateClass(npc.EmotionalState)">@npc.EmotionalState</div>
                        </div>
                        <div class="npc-tokens">
                            <div class="token-display">Trust: <span class="token-count">@GetTokenCount(npc.Id, ConnectionType.Trust)</span> <span class="token-effect">(@GetTokenEffect(npc.Id, ConnectionType.Trust))</span></div>
                            <div class="token-display">Commerce: <span class="token-count">@GetTokenCount(npc.Id, ConnectionType.Commerce)</span> <span class="token-effect">(@GetTokenEffect(npc.Id, ConnectionType.Commerce))</span></div>
                            <div class="token-display">Status: <span class="token-count">@GetTokenCount(npc.Id, ConnectionType.Status)</span> <span class="token-effect">(@GetTokenEffect(npc.Id, ConnectionType.Status))</span></div>
                            <div class="token-display">Shadow: <span class="token-count">@GetTokenCount(npc.Id, ConnectionType.Shadow)</span> <span class="token-effect">(@GetTokenEffect(npc.Id, ConnectionType.Shadow))</span></div>
                        </div>
                        <div class="npc-description">@GetNPCDescription(npc)</div>
                        <div class="npc-actions">
                            @foreach (var option in npc.ConversationOptions)
                            {
                                <div class="dialog-card @GetActionClass(option.Type)" 
                                     @onclick="() => StartTypedConversation(npc.Id, option.Type)">
                                    <div class="card-header">
                                        <span class="card-type">@option.Label</span>
                                        <span class="card-cost">
                                            @if (option.AttentionCost == 0)
                                            {
                                                <span class="free-tag">FREE</span>
                                            }
                                            else
                                            {
                                                <span>@option.AttentionCost attention</span>
                                            }
                                        </span>
                                    </div>
                                    <div class="card-body">
                                        @if (option.Type == ConversationType.Exchange)
                                        {
                                            <div class="card-text">Trade coins for items or permits</div>
                                            <div class="card-outcomes">
                                                <div class="outcome">Spend coins ‚Üí Get permits/items</div>
                                            </div>
                                        }
                                        else if (option.Type == ConversationType.Promise)
                                        {
                                            <div class="card-text">@(HasLetterGoal(npc.Id) ? "Letter available - negotiate delivery terms" : "No letter offers at this time")</div>
                                            <div class="card-outcomes">
                                                <div class="outcome success">Success: Better queue position & payment</div>
                                                <div class="outcome failure">Failure: Worse position & tight deadline</div>
                                            </div>
                                        }
                                        else if (option.Type == ConversationType.Standard)
                                        {
                                            <div class="card-text">Engage in conversation to build relationship</div>
                                            <div class="card-outcomes">
                                                <div class="outcome">Build trust & earn tokens</div>
                                            </div>
                                        }
                                        else if (option.Type == ConversationType.Resolution)
                                        {
                                            <div class="card-text">Address @GetBurdenCount(npc.Id) burdens weighing on relationship</div>
                                            <div class="card-outcomes">
                                                <div class="outcome success">Clear burdens & restore trust</div>
                                                <div class="outcome failure">Burdens remain</div>
                                            </div>
                                        }
                                        <div class="patience-info">
                                            <span>@GetPatience(npc, CurrentSpot) patience</span>
                                            @if (CurrentSpot?.Properties.Contains("Public") == true)
                                            {
                                                <span class="patience-modifier"> (base @GetBasePatience(npc) -1 public)</span>
                                            }
                                            else if (CurrentSpot?.Properties.Contains("Private") == true)
                                            {
                                                <span class="patience-modifier"> (base @GetBasePatience(npc) +1 private)</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                            @if (DevMode?.ShowDeckViewer == true)
                            {
                                <div class="npc-action dev-mode-action" 
                                     @onclick="() => ViewNPCDeck(npc.Id)">
                                    <span class="action-type">üîç View Deck (Dev)</span>
                                    <span class="action-details">Debug Tool</span>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Available Observations -->
    @if (AvailableObservations.Any() || TakenObservations.Any())
    {
        <div class="observations">
            <div class="observation-note">Spend 1 attention to observe, gain a state change card for conversations:</div>
            <div class="observation-list">
                @* Show taken observations first *@
                @foreach (var taken in TakenObservations)
                {
                    <div class="observation-item revealed card-base card-compact">
                        <div style="display: flex; justify-content: space-between; width: 100%;">
                            <div class="observation-text">@taken.Name</div>
                            <div>
                                <span>Observed</span>
                                <span> ‚Ä¢ </span>
                                @if (taken.GeneratedCard != null)
                                {
                                    <span class="reward-card">
                                        @taken.GeneratedCard.ConversationCard.TemplateId Card
                                    </span>
                                }
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(taken.NarrativeText))
                        {
                            <div class="observation-narrative">
                                @taken.NarrativeText
                            </div>
                        }
                        @if (taken.GeneratedCard != null)
                        {
                            var currentGameTime = DateTime.Now; // This should come from TimeManager ideally  
                            var decayDescription = taken.GeneratedCard.GetDecayStateDescription(currentGameTime);
                            if (!string.IsNullOrEmpty(decayDescription))
                            {
                                <div class="observation-decay">Card freshness: @decayDescription</div>
                            }
                        }
                    </div>
                }
                
                @* Show available observations *@
                @foreach (var obs in AvailableObservations)
                {
                    <div class="observation-item card-base card-compact" @onclick="() => TakeObservation(obs.Id)">
                        <div class="observation-text">@obs.Name</div>
                        <div class="observation-reward">
                            <span class="cost-value">1 attention</span>
                            <span class="reward-card">+Card</span>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Available Spots -->
    @if (AvailableSpots.Any())
    {
        <div class="spots-section">
            <h4 class="section-header">Move Within Location</h4>
            <div class="cards-grid-2col">
                @foreach (var spot in AvailableSpots)
                {
                    <div class="card-base card-compact spot-card" @onclick="() => MoveToSpot(spot.Id)">
                        <div class="spot-card-name">@spot.Name</div>
                        @if (spot.Properties.Any())
                        {
                            <div class="spot-traits">
                                @foreach (var prop in spot.Properties)
                                {
                                    <span class="spot-trait">@prop</span>
                                }
                            </div>
                        }
                        <div class="spot-move-action">Move here (free)</div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Section Divider -->
    @if (CanTravel || CanWork)
    {
        <div class="section-divider">
            <span class="divider-text">Actions</span>
        </div>
    }

    <!-- Travel Option -->
    @if (CanTravel)
    {
        <div class="travel-section">
            <button class="travel-button" @onclick="NavigateToTravel">
                <span class="travel-icon">üó∫Ô∏è</span>
                <span>Travel to Another Location</span>
            </button>
        </div>
    }

    <!-- Work Action -->
    @if (CanWork)
    {
        <div class="cards-grid">
            <div class="card-base card-standard action-card" @onclick="PerformWork">
                <div class="action-name">Work for Coins</div>
                <div class="action-cost">
                    <span class="cost-value">2</span> attention ‚Üí 
                    <span class="cost-value">8</span> coins
                </div>
            </div>
        </div>
    }
</div>