@inherits LocationContentBase

@namespace Wayfarer.Pages.Components

@if (ViewModel != null && ViewModel.Header != null)
{
    <!-- Venue Header -->
    <div class="location-header">
        <div class="location-path">
            <span>Lower Wards</span>
            <span class="icon-arrow-right"></span>
            <span>@ViewModel.Header.VenueName</span>
        </div>
        <div class="location-name">@ViewModel.Header.VenueName</div>
        <div class="location-traits">
            <span class="trait">Public</span>
            <span class="trait">@ViewModel.Header.TimeOfDayTrait</span>
        </div>
    </div>

    <!-- Current Spot Banner -->
    <div class="current-spot-banner">
        <div class="current-spot-name">@ViewModel.Header.SpotName</div>
        <div class="spot-traits">
            @foreach (var trait in ViewModel.Header.SpotTraits)
            {
                <span class="spot-trait">@trait</span>
            }
        </div>
    </div>

    <!-- VISUAL NOVEL SCENE NAVIGATION -->
    <div class="content-area">
        @* Atmosphere shown on Landing and Looking Around views - pre-generated by backend *@
        @if ((ViewState == LocationViewState.Landing || ViewState == LocationViewState.LookingAround) && ViewModel.Header != null)
        {
            <div class="atmosphere-text">
                @ViewModel.Header.AtmosphereText
            </div>
        }

        @* CONDITIONAL VIEW RENDERING - Render separate components *@
        @switch (ViewState)
        {
            case LocationViewState.Landing:
                <Landing CurrentLocationName="@ViewModel.Header.VenueName"
                         TravelActions="@ViewModel.TravelActions"
                         LocationSpecificActions="@ViewModel.LocationSpecificActions"
                         PlayerActions="@ViewModel.PlayerActions"
                         OnNavigateToView="HandleNavigateToView"
                         OnExecuteLocationAction="HandleExecuteLocationAction" />
                break;

            case LocationViewState.LookingAround:
                @* UNIFIED VIEW - NPCs with situations PRE-GROUPED by backend *@
                <div class="location-npc-list-view">
                    <div class="section-header">You scan the area...</div>

                    @* ========== NPCs PRESENT ========== *@
                    @if (ViewModel.NPCsWithSituations.Any())
                    {
                        <div class="section-subheader">People Here</div>

                        @foreach (var npc in ViewModel.NPCsWithSituations)
                        {
                            @* NPC Card with simple "Talk to" engagement *@
                            <div class="npc-card">
                                <div class="npc-header">
                                    <div>
                                        <div class="npc-name">@npc.Name</div>
                                        <div class="npc-type">@npc.PersonalityType - <span class="npc-state @npc.StateClass">@npc.ConnectionState</span></div>
                                    </div>
                                </div>
                                <div class="npc-description">@npc.Description</div>

                                @* Single "Talk to NPC" button - scenes/situations appear AFTER engagement *@
                                <div class="actions-grid">
                                    <div class="situation-action-btn" @onclick="async () => await HandleTalkToNPC(npc.Id)">
                                        <div class="situation-name">Talk to @npc.Name</div>
                                    </div>

                                    @* Exchange Option for MERCANTILE NPCs *@
                                    @if (npc.HasExchange)
                                    {
                                        <div class="situation-action-btn" @onclick="async () => await HandleStartExchange(npc.Id)">
                                            <div class="situation-system-badge exchange">Exchange</div>
                                            <div class="situation-name">Trading</div>
                                            <div class="situation-description">@npc.ExchangeDescription</div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }

                    @* ========== CONVERSATION TREES ========== *@
                    @if (AvailableConversationTrees.Any())
                    {
                        <div class="section-subheader">Available Conversations</div>

                        <div class="actions-grid">
                            @foreach (var tree in AvailableConversationTrees)
                            {
                                <div class="situation-action-btn"
                                     @onclick="async () => await HandleStartConversationTree(tree.Id)">
                                    <div class="situation-system-badge conversation">Conversation</div>
                                    <div class="situation-name">@tree.Name</div>
                                    @if (!string.IsNullOrEmpty(tree.Description))
                                    {
                                        <div class="situation-description">@tree.Description</div>
                                    }
                                    @if (tree.Npc != null)
                                    {
                                        <div class="situation-meta">with @tree.Npc.Name</div>
                                    }
                                </div>
                            }
                        </div>
                    }

                    @* ========== OBSERVATION SCENES ========== *@
                    @if (AvailableObservationScenes.Any())
                    {
                        <div class="section-subheader">Investigate</div>

                        <div class="actions-grid">
                            @foreach (var scene in AvailableObservationScenes)
                            {
                                <div class="situation-action-btn"
                                     @onclick="async () => await HandleStartObservationScene(scene.Id)">
                                    <div class="situation-system-badge observation">Observation</div>
                                    <div class="situation-name">@scene.Name</div>
                                    @if (!string.IsNullOrEmpty(scene.Description))
                                    {
                                        <div class="situation-description">@scene.Description</div>
                                    }
                                </div>
                            }
                        </div>
                    }

                    @* ========== EMPTY STATE ========== *@
                    @if (!ViewModel.NPCsWithSituations.Any()
                        && !ViewModel.AmbientMentalSituations.Any() && !ViewModel.MentalScenes.Any()
                        && !ViewModel.AmbientPhysicalSituations.Any() && !ViewModel.PhysicalScenes.Any()
                        && !AvailableConversationTrees.Any() && !AvailableObservationScenes.Any())
                    {
                        <p>The area is quiet. No one else is here, and nothing catches your attention.</p>
                    }

                    <button class="back-button" @onclick="NavigateBack">Back</button>
                </div>
                break;

            @* REMOVED: ApproachNPC - consolidated into LookingAround *@
            @* REMOVED: LocationChallenges - consolidated into LookingAround *@

            case LocationViewState.SituationDetail:
                <SituationDetailView SelectedSituation="@GetSituationDetailViewModel()"
                                OnCommitToSituation="HandleCommitToSituation"
                                OnNavigateBack="NavigateBack" />
                break;

            case LocationViewState.Spots:
                <SpotsView CurrentLocationName="@ViewModel.Header.VenueName"
                           AvailableSpots="@ViewModel.AvailableSpots"
                           OnMoveToSpot="HandleMoveToSpot"
                           OnNavigateBack="NavigateBack" />
                break;

            case LocationViewState.JobBoard:
                <JobBoardView CurrentLocationId="@GameWorld.GetPlayerCurrentLocation().Id"
                              OnAcceptJob="HandleAcceptJob"
                              OnNavigateBack="NavigateBack" />
                break;
        }
    </div>
}
else
{
    <div class="loading">
        Loading location...
    </div>
}
