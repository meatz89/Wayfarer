@inherits PhysicalContentBase

@namespace Wayfarer.Pages.Components
@using Wayfarer.Pages.Components.Shared

@if (Session != null)
{
    <div class="physical-content">
        <!-- Venue context bar -->
        <div class="location-context">
            <span>
                Challenge: @Session.ChallengeId
            </span>
        </div>

        <!-- Challenge Bar -->
        <div class="challenge-bar">
            <div class="challenge-info">
                <div class="challenge-name">Physical Challenge</div>
                <div class="challenge-status">
                    Phase @Session.CurrentPhaseIndex | Tier @GetCurrentTier()
                </div>
            </div>
        </div>

        <!-- Core Resources Display -->
        <div class="resources-display">
            <ResourceBar Label="Breakthrough"
                         CurrentValue="@Session.CurrentBreakthrough"
                         MaxValue="20"
                         BarType="progress"
                         ShowMaxValue="true" />

            <RhythmScale LeftLabel="Overcautious"
                         RightLabel="Reckless"
                         CurrentValue="@Session.Aggression"
                         MinValue="-10"
                         MaxValue="10" />

            <ResourceBar Label="Danger"
                         CurrentValue="@Session.CurrentDanger"
                         MaxValue="@Session.MaxDanger"
                         BarType="consequence"
                         ShowMaxValue="true" />
        </div>

        <!-- Situation Thresholds Display -->
        <div class="situations-section">
            <div class="situations-container">
                <div class="situation-card @(Session.CurrentBreakthrough >= 10 ? "achievable" : "")">
                    <div class="situation-threshold">10</div>
                    <div class="situation-name">Partial Progress</div>
                    <div class="situation-reward">Continue</div>
                </div>
                <div class="situation-card @(Session.CurrentBreakthrough >= 20 ? "achievable active" : "")">
                    <div class="situation-threshold">20</div>
                    <div class="situation-name">Challenge Complete</div>
                    <div class="situation-reward">Success + Reward</div>
                </div>
            </div>
        </div>

        <!-- Narrative Section -->
        <div class="narrative-section">
            @if (!string.IsNullOrEmpty(LastNarrative))
            {
                <div class="narrative-text">
                    @LastNarrative
                </div>
            }
        </div>

        <!-- Action Section -->
        <div class="action-display">
            <div class="pile-display">
                <div class="pile-count">
                    <span>Situation:</span>
                    <span class="pile-number">@GetDeckCount()</span>
                </div>
            </div>
            <div class="action-section">
                @if (!IsChallengeEnded)
                {
                    <div class="action-button"
                         @onclick="ExecuteAssess">
                        ASSESS
                        @if (SelectedCard != null)
                        {
                            <div class="tooltip card-effects-tooltip">
                                <div class="tooltip-title">Assess</div>
                                <div class="tooltip-section">
                                    <strong>Effects:</strong>
                                    <ul>
                                        <li>Balance: -1 (toward Overcautious)</li>
                                        <li>Play selected card</li>
                                    </ul>
                                </div>
                            </div>
                        }
                    </div>
                    <div class="action-button primary @(SelectedCard == null || IsProcessing ? "disabled" : "")"
                         @onclick="ExecuteExecute"
                         disabled="@(SelectedCard == null || IsProcessing)">
                        EXECUTE
                        @if (SelectedCard != null)
                        {
                            <div class="tooltip card-effects-tooltip">
                                <div class="tooltip-title">Execute</div>
                                <div class="tooltip-section">
                                    <strong>Effects:</strong>
                                    <ul>
                                        <li>Balance: +1 (toward Reckless)</li>
                                        <li>Play selected card</li>
                                    </ul>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="action-button primary" @onclick="EndChallenge">
                        END CHALLENGE
                    </div>
                }
            </div>
        </div>

        <!-- Exertion Display (with glowing orbs matching mockup) -->
        <ActionEconomyDisplay Label="Exertion"
                              CurrentValue="@GetCurrentExertion()"
                              MaxValue="@GetMaxExertion()"
                              TooltipContent="@TooltipContentProvider.Get("Exertion")" />

        <!-- Tier Unlock Display -->
        <div class="tier-display">
            <div class="tier-info">
                <GameTooltip Content="@TooltipContentProvider.Get("Understanding")" Position="right">
                    <span class="tier-label">Understanding: @GetCurrentUnderstanding() / @GetMaxUnderstanding()</span>
                </GameTooltip>
                <div class="tier-unlocks">
                    @foreach (var tier in GetAllTiers())
                    {
                        <span class="tier-badge @(IsTierUnlocked(tier.TierNumber) ? "unlocked" : "locked")">
                            TIER @tier.TierNumber (@tier.MinDepth-@tier.MaxDepth)<br /><small>Understanding @tier.UnderstandingThreshold</small>
                        </span>
                    }
                </div>
            </div>
        </div>

        <!-- Available Situation Cards (Victory Conditions) -->
        @if (GetAvailableSituationCards().Any())
        {
            <div class="available-situations-section">
                <div class="pile-display">
                    <div class="pile-count">
                        <span>Available Situations:</span>
                        <span class="pile-number">@GetAvailableSituationCards().Count</span>
                    </div>
                </div>

                <div class="situation-cards-grid">
                    @foreach (var situationCard in GetAvailableSituationCards())
                    {
                        <SituationCard Card="@situationCard"
                                  CurrentProgress="@Session.CurrentBreakthrough"
                                  CalculatedDifficulty="@GetSituationDifficulty(situationCard)"
                                  OnCardClick="@PlaySituationCard" />
                    }
                </div>
            </div>
        }

        <!-- Locked Cards Display (Prepared Combo) -->
        @if (GetLockedCards().Count > 0)
        {
            <div class="locked-cards-section">
                <div class="pile-display">
                    <div class="pile-count">
                        <span>Locked Options (Combo):</span>
                        <span class="pile-number">@GetLockedCards().Count</span>
                    </div>
                </div>

                <div class="card-grid locked-cards-container">
                    @foreach (var lockedCard in GetLockedCards())
                    {
                        <PhysicalCard Card="@lockedCard"
                                      IsLocked="true"
                                      IsSelectable="false"
                                      Session="@Session"
                                      OnCardClick="@(() => {})">
                            <SystemSpecificBadges>
                                <span class="card-approach" title="Physical approach">
                                    @lockedCard.PhysicalCardTemplate.Approach
                                </span>
                                <span class="locked-badge">LOCKED</span>
                            </SystemSpecificBadges>
                        </PhysicalCard>
                    }
                </div>
            </div>
        }

        <!-- Hand Display -->
        <div class="cards-section">
            <div class="pile-display">
                <div class="pile-count">
                    <span>Options:</span>
                    <span class="pile-number">@Hand.Count</span>
                </div>
            </div>

            <div class="card-grid slot-aware-container" style="@GetContainerCSSVariables()">
                @foreach (var displayCard in GetAllDisplayCards())
                {
                    var card = displayCard.Card;

                    <PhysicalCard Card="@card"
                                  IsSelected="@(SelectedCard == card)"
                                  IsSelectable="true"
                                  Session="@Session"
                                  OnCardClick="@(() => SelectCard(card))">
                        <SystemSpecificBadges>
                            <span class="card-approach" title="Physical approach">
                                @card.PhysicalCardTemplate.Approach
                            </span>
                        </SystemSpecificBadges>
                    </PhysicalCard>
                }
            </div>
        </div>

        @if (IsProcessing)
        {
            <div class="processing-overlay">
                <div class="spinner"></div>
            </div>
        }
    </div>
}
else
{
    <div class="no-session">
        <p>No active physical challenge session</p>
    </div>
}
