@namespace Wayfarer.Pages.Components

@if (IsVisible)
{
    <div class="travel-overlay" @onclick="HandleOverlayClick">
        <div class="travel-modal" @onclick:stopPropagation="true">
            <button class="close-button" @onclick="Close">Ã—</button>
            <div class="travel-header">
                <div class="travel-title">Select Destination</div>
                <div class="travel-subtitle">From: @CurrentLocationName</div>
            </div>
            
            <div class="route-list">
                @if (Routes?.Any() == true)
                {
                    @foreach (var destinationGroup in Routes.GroupBy(r => r.Destination))
                    {
                        <div class="destination-group">
                            <div class="destination-header">@destinationGroup.Key</div>
                            <div class="destination-routes">
                                @foreach (var route in destinationGroup)
                                {
                                    <div class="route-card @(route.IsLocked ? "locked" : "")" @onclick="() => SelectRoute(route)">
                                        <div class="route-header">
                                            <div class="route-method">@GetTransportMethodDisplay(route.TransportMethod)</div>
                                            <div class="route-cost">@GetTransportCost(route.TransportMethod)</div>
                                        </div>
                                        <div class="route-info">
                                            <span class="route-detail">@route.TravelTime</span>
                                            <span class="route-description">@route.Detail</span>
                                        </div>
                                        
                                        @if (!string.IsNullOrEmpty(route.Familiarity))
                                        {
                                            <div class="route-familiarity">@route.Familiarity</div>
                                        }
                                        
                                        @if (route.IsLocked)
                                        {
                                            <div class="route-requirement">@route.LockReason</div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div style="text-align: center; padding: 20px; color: #7a6250;">
                        No travel routes available from this location.
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public string CurrentLocationName { get; set; } = "Current Location";
    [Parameter] public List<RouteOptionViewModel> Routes { get; set; }
    [Parameter] public EventCallback<RouteOptionViewModel> OnRouteSelected { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private async Task HandleOverlayClick()
    {
        await Close();
    }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }

    private async Task SelectRoute(RouteOptionViewModel route)
    {
        if (!route.IsLocked)
        {
            // Route already has its transport method set
            await OnRouteSelected.InvokeAsync(route);
            await Close();
        }
    }

    private string GetTransportMethodDisplay(string method)
    {
        return method?.ToLower() switch
        {
            "walking" => "ðŸš¶ Walk",
            "cart" => "ðŸ›’ Cart",
            "carriage" => "ðŸš Carriage",
            "boat" => "â›µ Boat",
            _ => "ðŸš¶ Walk"
        };
    }

    private string GetTransportCost(string method)
    {
        return method?.ToLower() switch
        {
            "walking" => "Free",
            "cart" => "2 coins",
            "carriage" => "5 coins",
            "boat" => "3 coins",
            _ => "Free"
        };
    }
}