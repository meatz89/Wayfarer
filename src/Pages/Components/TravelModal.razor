@namespace Wayfarer.Pages.Components

@if (IsVisible)
{
    <div class="travel-overlay" @onclick="HandleOverlayClick">
        <div class="travel-modal" @onclick:stopPropagation="true">
            <button class="close-button" @onclick="Close">Ã—</button>
            <div class="travel-header">
                <div class="travel-title">Select Destination</div>
                <div class="travel-subtitle">From: @CurrentLocationName</div>
            </div>
            
            <div class="route-list">
                @if (Routes?.Any() == true)
                {
                    @foreach (var route in Routes)
                    {
                        <div class="route-card @(route.IsLocked ? "locked" : "")" @onclick="() => SelectRoute(route)">
                            <div class="route-destination">@route.Destination</div>
                            <div class="route-info">
                                <span class="route-detail">@route.TravelTime</span>
                                <span class="route-detail">@route.Detail</span>
                            </div>
                            @if (!string.IsNullOrEmpty(route.Familiarity))
                            {
                                <div class="route-familiarity">@route.Familiarity</div>
                            }
                            
                            @if (!route.IsLocked)
                            {
                                <div class="transport-options">
                                    <div class="transport-option" @onclick:stopPropagation="true" @onclick="() => TravelByWalking(route)">
                                        <div class="transport-type">Walk</div>
                                        <div class="transport-time">@route.TravelTime</div>
                                        <div class="transport-cost">Free</div>
                                    </div>
                                    
                                    @if (route.SupportsCart)
                                    {
                                        <div class="transport-option" @onclick:stopPropagation="true" @onclick="() => TravelByCart(route)">
                                            <div class="transport-type">Cart</div>
                                            <div class="transport-time">Half time</div>
                                            <div class="transport-cost">2 coins</div>
                                        </div>
                                    }
                                    
                                    @if (route.SupportsCarriage)
                                    {
                                        <div class="transport-option" @onclick:stopPropagation="true" @onclick="() => TravelByCarriage(route)">
                                            <div class="transport-type">Carriage</div>
                                            <div class="transport-time">Quarter time</div>
                                            <div class="transport-cost">5 coins</div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="route-requirement">@route.LockReason</div>
                            }
                        </div>
                    }
                }
                else
                {
                    <div style="text-align: center; padding: 20px; color: #7a6250;">
                        No travel routes available from this location.
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public string CurrentLocationName { get; set; } = "Current Location";
    [Parameter] public List<RouteOptionViewModel> Routes { get; set; }
    [Parameter] public EventCallback<RouteOptionViewModel> OnRouteSelected { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private async Task HandleOverlayClick()
    {
        await Close();
    }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }

    private async Task SelectRoute(RouteOptionViewModel route)
    {
        if (!route.IsLocked)
        {
            // Default to walking
            await TravelByWalking(route);
        }
    }

    private async Task TravelByWalking(RouteOptionViewModel route)
    {
        route.TransportMethod = "walk";
        await OnRouteSelected.InvokeAsync(route);
        await Close();
    }

    private async Task TravelByCart(RouteOptionViewModel route)
    {
        route.TransportMethod = "cart";
        await OnRouteSelected.InvokeAsync(route);
        await Close();
    }

    private async Task TravelByCarriage(RouteOptionViewModel route)
    {
        route.TransportMethod = "carriage";
        await OnRouteSelected.InvokeAsync(route);
        await Close();
    }
}