@inherits DiscoveryJournalBase
@namespace Wayfarer.Pages.Components

<div class="discovery-journal">
    <div class="journal-header">
        <h2><Icon Name="open-book" CssClass="icon-neutral" /> Obligation Journal</h2>
        <button class="close-btn" @onclick="CloseJournal">✕</button>
    </div>

    <!-- Tabs -->
    <div class="journal-tabs">
        <div class="journal-tab @(CurrentTab == "active" ? "active" : "")" @onclick='() => SelectTab("active")'>
            Active Obligations
        </div>
        <div class="journal-tab @(CurrentTab == "discovered" ? "active" : "")" @onclick='() => SelectTab("discovered")'>
            Discovered
        </div>
        <div class="journal-tab @(CurrentTab == "completed" ? "active" : "")" @onclick='() => SelectTab("completed")'>
            Completed
        </div>
        <div class="journal-tab @(CurrentTab == "discoveries" ? "active" : "")" @onclick='() => SelectTab("discoveries")'>
            Discoveries
        </div>
    </div>

    <div class="journal-content">
        @if (CurrentTab == "active")
        {
            <!-- Active Obligations Tab -->
            var activeObligations = GetActiveObligations();
            @if (activeObligations.Any())
            {
                @foreach (var activeInv in activeObligations)
                {
                    Obligation inv = GetObligationById(activeInv.ObligationId);
                    if (inv != null)
                    {
                        <div class="obligation-card">
                            <div class="obligation-header-row">
                                <div class="obligation-title">@inv.Name</div>
                                <div class="obligation-progress-label">@GetObligationProgress(activeInv)/@GetObligationTotalSituations(activeInv.ObligationId) completed</div>
                            </div>

                            <div class="obligation-progress-bar">
                                <div class="obligation-progress-fill" style="width: @GetObligationProgressPercent(activeInv)%"></div>
                            </div>

                            <div class="situation-list">
                                @foreach (var completedPhase in GetCompletedPhases(activeInv))
                                {
                                    <div class="situation-item">
                                        <div class="situation-status completed">✓</div>
                                        <div class="situation-text completed">@completedPhase.Name</div>
                                    </div>
                                }
                                @foreach (var activePhase in GetActivePhases(activeInv))
                                {
                                    <div class="situation-item">
                                        <div class="situation-status active">→</div>
                                        <div class="situation-text">@activePhase.Name</div>
                                    </div>
                                }
                            </div>

                            @{
                                var locationCounts = GetRemainingSituationsByLocation(activeInv);
                            }
                            @if (locationCounts.Any())
                            {
                                <div class="location-hints">
                                    <div class="hints-title">Situations remaining at:</div>
                                    <div class="location-list">
                                        @foreach (var kvp in locationCounts)
                                        {
                                            <div class="location-tag">
                                                @kvp.Key
                                                <span class="location-count">@kvp.Value</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                }
            }
            else
            {
                <div class="empty-state">
                    <div class="empty-icon"><Icon Name="magnifying-glass" CssClass="icon-neutral" /></div>
                    <div class="empty-text">No active obligations</div>
                </div>
            }
        }
        else if (CurrentTab == "discovered")
        {
            <!-- Discovered Obligations Tab - HIGHLANDER: Object references ONLY -->
            var discoveredObligations = GetDiscoveredObligations();
            @if (discoveredObligations.Any())
            {
                @foreach (Obligation inv in discoveredObligations)
                {
                    if (inv != null && inv.IntroAction != null)
                    {
                        <div class="obligation-card discovered-card">
                            <div class="discovered-header">
                                <div class="discovered-icon"><Icon Name="magnifying-glass" CssClass="icon-neutral" /></div>
                                <div class="discovered-title">@inv.Name</div>
                            </div>
                            <div class="discovered-description">@inv.Description</div>
                            <div class="intro-action-hint">
                                <div class="hint-icon">→</div>
                                <div class="hint-text">@inv.IntroAction.ActionText</div>
                            </div>
                        </div>
                    }
                }
            }
            else
            {
                <div class="empty-state">
                    <div class="empty-icon"><Icon Name="magnifying-glass" CssClass="icon-neutral" /></div>
                    <div class="empty-text">No obligations discovered yet</div>
                </div>
            }
        }
        else if (CurrentTab == "completed")
        {
            <!-- Completed Obligations Tab - HIGHLANDER: Object references ONLY -->
            var completedObligations = GetCompletedObligations();
            @if (completedObligations.Any())
            {
                @foreach (Obligation inv in completedObligations)
                {
                    if (inv != null)
                    {
                        <div class="obligation-card">
                            <div class="completed-summary">
                                <div class="completed-title">@inv.Name</div>
                                @if (inv.CompletionRewardCoins > 0)
                                {
                                    <div class="completed-rewards">+@inv.CompletionRewardCoins coins</div>
                                }
                            </div>
                            <div class="completed-narrative">@inv.CompletionNarrative</div>
                        </div>
                    }
                }
            }
            else
            {
                <div class="empty-state">
                    <div class="empty-icon"><Icon Name="sparkles" CssClass="icon-positive" /></div>
                    <div class="empty-text">No completed obligations yet</div>
                </div>
            }
        }
        else if (CurrentTab == "discoveries")
        {
            <!-- Discoveries Tab (existing content) -->
            <!-- Locations Section -->
            <div class="journal-section">
                <h3>Locations Discovered (@GetDiscoveredLocationCount()/@GetTotalLocationCount())</h3>
                <div class="location-list">
                    @foreach (var location in GetDiscoveredLocations())
                    {
                        <div class="location-entry">
                            <div class="location-name">@location.Name</div>
                            <div class="familiarity-bar">
                                <span class="familiarity-label">Familiarity: @GetFamiliarity(location)/3</span>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: @GetFamiliarityPercent(location, 3)%"></div>
                                </div>
                            </div>
                            @if (GetFamiliarity(location) >= 3)
                            {
                                <span class="complete-badge">✓ Fully Explored</span>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- Observations Section -->
            <div class="journal-section">
                <h3>Observations Collected (@GetCollectedObservationCount())</h3>
                <div class="observation-list">
                    @foreach (var obs in GetCollectedObservations())
                    {
                        <div class="observation-entry">
                            <div class="observation-name">@obs</div>
                        </div>
                    }
                </div>
            </div>

            <!-- Routes Section -->
            <div class="journal-section">
                <h3>Routes Explored (@GetExploredRouteCount())</h3>
                <div class="route-list">
                    @foreach (var route in GetKnownRoutes())
                    {
                        <div class="route-entry">
                            <div class="route-path">@route.OriginName → @route.DestinationName</div>
                            <div class="route-familiarity">
                                Familiarity: @GetRouteFamiliarity(route)/5
                                @if (GetRouteFamiliarity(route) >= 5)
                                {
                                    <span class="mastered-badge"><Icon Name="round-star" CssClass="icon-positive" /> Mastered</span>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>
