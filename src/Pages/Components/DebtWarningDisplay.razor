@using System.Linq
@inject ConnectionTokenManager TokenManager
@inject NPCRepository NPCRepository

@if (DebtWarnings.Any())
{
    <div class="debt-warning-panel">
        <div class="debt-header">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <span>Active Debts</span>
        </div>
        <div class="debt-list">
            @foreach (var warning in DebtWarnings)
            {
                <div class="debt-warning @GetDebtSeverityClass(warning.DebtAmount)">
                    <div class="debt-npc">
                        <span class="npc-name">@warning.NPCName</span>
                        <span class="debt-amount">-@Math.Abs(warning.DebtAmount) @warning.TokenType tokens</span>
                    </div>
                    <div class="debt-effects">
                        @foreach (var effect in warning.Effects)
                        {
                            <div class="debt-effect">
                                <span class="effect-icon">@effect.Icon</span>
                                <span class="effect-text">@effect.Description</span>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
}

@code {
    private List<DebtWarning> DebtWarnings = new();
    
    protected override void OnInitialized()
    {
        RefreshDebtWarnings();
    }
    
    private void RefreshDebtWarnings()
    {
        DebtWarnings.Clear();
        
        var allNPCs = NPCRepository.GetAllNPCs();
        
        foreach (var npc in allNPCs)
        {
            var tokens = TokenManager.GetTokensWithNPC(npc.ID);
            
            foreach (var (tokenType, balance) in tokens)
            {
                if (balance < 0)
                {
                    var warning = new DebtWarning
                    {
                        NPCId = npc.ID,
                        NPCName = npc.Name,
                        TokenType = tokenType,
                        DebtAmount = balance,
                        Effects = GetDebtEffects(npc, tokenType, balance)
                    };
                    
                    DebtWarnings.Add(warning);
                }
            }
        }
        
        // Sort by severity (most negative first)
        DebtWarnings = DebtWarnings.OrderBy(w => w.DebtAmount).ToList();
    }
    
    private List<DebtEffect> GetDebtEffects(NPC npc, ConnectionType tokenType, int debtAmount)
    {
        var effects = new List<DebtEffect>();
        
        // Queue priority effect
        if (debtAmount <= -1)
        {
            effects.Add(new DebtEffect
            {
                Icon = "ðŸ“Œ",
                Description = $"Letters get priority queue position ({Math.Abs(debtAmount)} positions higher)"
            });
        }
        
        // Skip cost effect
        if (debtAmount <= -2)
        {
            effects.Add(new DebtEffect
            {
                Icon = "ðŸ’°",
                Description = "May trigger increased skip costs"
            });
        }
        
        // Extreme leverage
        if (debtAmount <= -5)
        {
            effects.Add(new DebtEffect
            {
                Icon = "âš ï¸",
                Description = "EXTREME LEVERAGE - Letters may jump to top positions"
            });
        }
        
        // Patron-level debt
        if (debtAmount <= -10)
        {
            effects.Add(new DebtEffect
            {
                Icon = "ðŸ‘‘",
                Description = "OVERWHELMING DEBT - Near-absolute control over queue"
            });
        }
        
        return effects;
    }
    
    private string GetDebtSeverityClass(int debtAmount)
    {
        return Math.Abs(debtAmount) switch
        {
            >= 10 => "debt-critical",
            >= 5 => "debt-severe",
            >= 3 => "debt-moderate",
            _ => "debt-minor"
        };
    }
    
    private class DebtWarning
    {
        public string NPCId { get; set; }
        public string NPCName { get; set; }
        public ConnectionType TokenType { get; set; }
        public int DebtAmount { get; set; }
        public List<DebtEffect> Effects { get; set; } = new();
    }
    
    private class DebtEffect
    {
        public string Icon { get; set; }
        public string Description { get; set; }
    }
}

<style>
    .debt-warning-panel {
        background: var(--surface-color);
        border: 2px solid var(--danger-color);
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }
    
    .debt-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: bold;
        color: var(--danger-color);
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
    }
    
    .debt-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .debt-warning {
        background: var(--background-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 0.75rem;
    }
    
    .debt-warning.debt-minor {
        border-color: var(--warning-color);
    }
    
    .debt-warning.debt-moderate {
        border-color: var(--warning-color);
        background: rgba(255, 193, 7, 0.1);
    }
    
    .debt-warning.debt-severe {
        border-color: var(--danger-color);
        background: rgba(220, 53, 69, 0.1);
    }
    
    .debt-warning.debt-critical {
        border-color: var(--danger-color);
        background: rgba(220, 53, 69, 0.2);
        box-shadow: 0 0 10px rgba(220, 53, 69, 0.3);
    }
    
    .debt-npc {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .npc-name {
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .debt-amount {
        color: var(--danger-color);
        font-weight: bold;
    }
    
    .debt-effects {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        font-size: 0.9rem;
    }
    
    .debt-effect {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-secondary);
        padding-left: 0.5rem;
    }
    
    .effect-icon {
        font-size: 1rem;
    }
    
    .effect-text {
        flex: 1;
    }
</style>