@inherits TravelPathContentBase
@namespace Wayfarer.Pages.Components

@if (TravelContext != null && TravelContext.Session != null)
{
    <!-- Route Header (Enhanced from mockup) -->
    <div class="route-header">
        <div class="route-info">
            <div class="route-name">@GetOriginLocationName() <span class="icon-arrow-right"></span> @GetDestinationName()</div>
            <div class="route-properties">
                <div class="route-property">
                    <span class="property-label">Transport</span>
                    <span class="property-value">@GetTransportType()</span>
                </div>
                <div class="route-property">
                    <span class="property-label">Distance</span>
                    <span class="property-value">@GetSegmentCount() segments</span>
                </div>
                <div class="route-property">
                    <span class="property-label">Base Time</span>
                    <span class="property-value">@GetBaseTravelTime() min</span>
                </div>
            </div>
            @if (!string.IsNullOrEmpty(GetTransportType()))
            {
                <span class="transport-badge">@GetTransportType().ToUpper()</span>
            }
        </div>
    </div>

    <!-- Travel State Bar -->
    <div class="travel-state-bar">
        <div class="travel-state">
            <span class="state-label">Current Segment</span>
            <span class="state-name">Segment @GetCurrentSegment() of @GetSegmentCount()</span>
        </div>
        <div class="travel-state">
            <span class="state-label">Travel State</span>
            <span class="state-name">@GetTravelStateText()</span>
        </div>
    </div>

    <!-- Stamina Bar -->
    <div class="stamina-section">
        <span class="stamina-label">Stamina:</span>
        <div class="stamina-dots">
            @foreach (var dot in GetStaminaDots())
            {
                <span class="stamina-dot @(dot.State == StaminaDotState.Available ? "available" : dot.State == StaminaDotState.Spent ? "spent" : "")"></span>
            }
        </div>
        <span class="stamina-numbers">@GetStaminaDisplay()</span>
        <span class="stamina-note">@GetTravelStateText()</span>
    </div>

    <!-- Segment Progress -->
    <div class="segment-progress">
        SEGMENT @GetCurrentSegment() OF @GetSegmentCount()
        <span class="segment-dots">
            @{
                var segmentDots = GetSegmentDots();
                for (int i = 0; i < segmentDots.Count; i++)
                {
                    var dot = segmentDots[i];
                    <span class="segment-dot @GetSegmentDotClass(dot.State)"></span>
                    @if (i < segmentDots.Count - 1)
                    {
                        <span class="icon-arrow-right"></span>
                    }
                }
            }
        </span>
    </div>

    <!-- Path Cards Section -->
    <div class="paths-section">
        <div class="paths-title">@GetPathsTitle()</div>
        
        @{
            var eventNarrative = GetEventNarrative();
            var eventTitle = GetEventTitle();
            var eventType = GetEventType();
        }
        @if (!string.IsNullOrEmpty(eventNarrative))
        {
            @if (!string.IsNullOrEmpty(eventTitle))
            {
                <!-- Structured Event Card for Caravan Events -->
                <div class="event-card">
                    <div class="event-header">
                        <div class="event-title">@eventTitle</div>
                        @if (!string.IsNullOrEmpty(eventType))
                        {
                            <div class="event-type">@eventType</div>
                        }
                    </div>
                    <div class="event-narrative-text">@eventNarrative</div>
                </div>
            }
            else
            {
                <!-- Simple narrative for walking encounters -->
                <div class="event-narrative simple">@eventNarrative</div>
            }
        }
        
        <div class="path-grid">
            @if (IsCurrentSegmentRoutePathType())
            {
                @* NEW SYSTEM: Core Loop RoutePaths - Direct choice with perfect information *@
                @foreach (var routePath in GetAvailableRoutePaths())
                {
                    var isAvailable = CanSelectRoutePath(routePath.Id);

                    <div class="path-card core-loop @(isAvailable ? "" : "unavailable")"
                         @onclick="async () => { if (isAvailable) await SelectRoutePath(routePath.Id); }">

                        <div class="path-content">
                            <div class="path-main">
                                <div class="path-header">
                                    <div class="path-name">@routePath.Description</div>
                                    <div class="path-stamina">@routePath.StaminaCost</div>
                                </div>

                                @* Costs/Effects *@
                                <div class="path-mechanics">
                                    @if (routePath.TimeSegments > 0)
                                    {
                                        <div class="path-time"><span class="icon-clock"></span> @routePath.TimeSegments segments</div>
                                    }
                                    @if (routePath.StaminaCost > 0)
                                    {
                                        <div class="path-stamina-cost"><span class="icon-attention"></span> @routePath.StaminaCost stamina</div>
                                    }
                                </div>

                                @* Core Loop: Goal Preview (challenges spawned by obstacle on this path) *@
                                @if (!string.IsNullOrEmpty(routePath.OptionalObstacleId))
                                {
                                    var goalPreviews = GetGoalPreviewsForPath(routePath.OptionalObstacleId);
                                    if (goalPreviews != null && goalPreviews.Any())
                                    {
                                        <div class="path-challenges-preview">
                                            <div class="challenges-header">Challenges ahead:</div>

                                            @foreach (var goalPreview in goalPreviews)
                                            {
                                                <div class="goal-preview-card">
                                                    <div class="goal-preview-header">
                                                        <span class="goal-preview-name">@goalPreview.Name</span>
                                                        <span class="goal-preview-system">@goalPreview.SystemType</span>
                                                    </div>

                                                    @if (!string.IsNullOrEmpty(goalPreview.Description))
                                                    {
                                                        <div class="goal-preview-description">@goalPreview.Description</div>
                                                    }

                                                    @if (goalPreview.Contexts != null && goalPreview.Contexts.Any())
                                                    {
                                                        <div class="goal-preview-contexts">
                                                            @foreach (var context in goalPreview.Contexts)
                                                            {
                                                                <ContextTag ContextName="@context.ToString()" IsMatch="false" />
                                                            }
                                                        </div>
                                                    }

                                                    @* Equipment Help Indicator *@
                                                    @if (goalPreview.MatchingEquipment.Any())
                                                    {
                                                        <div class="goal-equipment-help">
                                                            <span class="help-icon">⚙</span>
                                                            <span class="help-text">Equipment can help: @string.Join(", ", goalPreview.MatchingEquipment.Select(e => e.EquipmentName))</span>
                                                            <span class="help-reduction">(-@goalPreview.TotalReduction intensity)</span>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                }
            }
            else if (GetAvailablePathCards().Any())
            {
                @* OLD SYSTEM: PathCard rendering with reveal mechanic (UNCHANGED) *@
                @foreach (var pathCardData in GetAvailablePathCards())
                {
                    var card = pathCardData.Card;
                    var isDiscovered = pathCardData.IsDiscovered;
                    var isAvailable = pathCardData.CanPlay && !ShouldDisableCard(card.Id);
                    var isBeingRevealed = IsCardBeingRevealed(card.Id);
                    
                    <div class="path-card @GetPathCardCssClass(isDiscovered, isAvailable) @(isBeingRevealed ? "revealed" : "") @(ShouldDisableCard(card.Id) ? "disabled-during-reveal" : "") @(IsReadyToComplete() ? "complete" : "")"
                         data-unavailable-reason="@(!isAvailable ? GetUnavailableReason(card.Id) : "")"
                         @onclick="async () => { if (!IsReadyToComplete()) await SelectPathCard(card.Id); }">
                        
                        @if (isDiscovered)
                        {
                            <!-- Face-Up Path Card -->
                            <div class="path-content">
                                <div class="path-main">
                                    <div class="path-header">
                                        <div class="path-name">@card.Name</div>
                                        <div class="path-stamina">@card.StaminaCost</div>
                                    </div>
                                    
                                    @{
                                        var requirements = GetRequirementsText(card);
                                    }
                                    @if (!string.IsNullOrEmpty(requirements))
                                    {
                                        <div class="path-requirements">@requirements</div>
                                    }

                                    @* Stat Requirements Visual Indicators *@
                                    @if (card.StatRequirements != null && card.StatRequirements.Count > 0)
                                    {
                                        <div class="path-stat-requirements">
                                            @foreach (var statReq in card.StatRequirements)
                                            {
                                                Player player = GameFacade.GetPlayer();
                                                bool meetsRequirement = false;
                                                string statName = "";
                                                int required = statReq.Value;
                                                int current = 0;

                                                if (Enum.TryParse<PlayerStatType>(statReq.Key, true, out PlayerStatType statType))
                                                {
                                                    statName = GetStatDisplayName(statType);
                                                    current = player.Stats.GetLevel(statType);
                                                    meetsRequirement = current >= required;
                                                }
                                                <div class="stat-requirement @(meetsRequirement ? "met" : "unmet")">
                                                    <span class="stat-icon @GetStatIconClass(statReq.Key)"></span>
                                                    <span class="stat-info">@statName @required+</span>
                                                    @if (!meetsRequirement)
                                                    {
                                                        <span class="current-level">(@current)</span>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }

                                    @* Core Loop: Goal Preview (challenges on this path) *@
                                    @if (!string.IsNullOrEmpty(card.ObstacleId))
                                    {
                                        var goalPreviews = GetGoalPreviewsForPath(card.ObstacleId);
                                        if (goalPreviews != null && goalPreviews.Any())
                                        {
                                            <div class="path-challenges-preview">
                                                <div class="challenges-header">Challenges ahead:</div>

                                                @foreach (var goalPreview in goalPreviews)
                                                {
                                                    <div class="goal-preview-card">
                                                        <div class="goal-preview-header">
                                                            <span class="goal-preview-name">@goalPreview.Name</span>
                                                            <span class="goal-preview-system">@goalPreview.SystemType</span>
                                                        </div>

                                                        @if (!string.IsNullOrEmpty(goalPreview.Description))
                                                        {
                                                            <div class="goal-preview-description">@goalPreview.Description</div>
                                                        }

                                                        @if (goalPreview.Contexts != null && goalPreview.Contexts.Any())
                                                        {
                                                            <div class="goal-preview-contexts">
                                                                @foreach (var context in goalPreview.Contexts)
                                                                {
                                                                    <ContextTag ContextName="@context.ToString()" IsMatch="false" />
                                                                }
                                                            </div>
                                                        }

                                                        @* Equipment Help Indicator *@
                                                        @if (goalPreview.MatchingEquipment.Any())
                                                        {
                                                            <div class="goal-equipment-help">
                                                                <span class="help-icon">⚙</span>
                                                                <span class="help-text">Equipment can help: @string.Join(", ", goalPreview.MatchingEquipment.Select(e => e.EquipmentName))</span>
                                                                <span class="help-reduction">(-@goalPreview.TotalReduction intensity)</span>
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        }
                                    }

                                    <!-- Mechanical Effects Section -->
                                    @{
                                        var hasEffects = card.TravelTimeSegments > 0 || card.HungerEffect != 0 || 
                                                        card.CoinReward > 0 || card.StaminaRestore > 0 || 
                                                        card.HealthEffect != 0 ||
                                                        card.ForceReturn || (card.TokenGains?.Any() ?? false) ||
                                                        (card.RevealsPaths?.Any() ?? false) || 
                                                        (!string.IsNullOrEmpty(card.OneTimeReward) && card.IsOneTime);
                                    }
                                    @if (hasEffects)
                                    {
                                        <div class="path-mechanics">
                                            @if (card.TravelTimeSegments > 0)
                                            {
                                                <div class="path-time"><span class="icon-clock"></span> @card.TravelTimeSegments segments</div>
                                            }
                                            
                                            @if (card.HungerEffect != 0)
                                            {
                                                <div class="path-hunger @(card.HungerEffect > 0 ? "cost" : "reward")">
                                                    @if (card.HungerEffect > 0)
                                                    {
                                                        <span><span class="icon-food"></span> +@card.HungerEffect hunger</span>
                                                    }
                                                    else
                                                    {
                                                        <span><span class="icon-food"></span> @card.HungerEffect hunger</span>
                                                    }
                                                </div>
                                            }
                                            
                                            @if (card.CoinReward > 0)
                                            {
                                                <div class="path-coins reward"><span class="icon-coin"></span> +@card.CoinReward coins</div>
                                            }
                                            
                                            @if (card.StaminaRestore > 0)
                                            {
                                                <div class="path-stamina-restore"><span class="icon-attention"></span> Restore @card.StaminaRestore stamina</div>
                                            }
                                            
                                            
                                            @if (card.HealthEffect != 0)
                                            {
                                                <div class="path-health @(card.HealthEffect < 0 ? "damage" : "heal")">
                                                    @if (card.HealthEffect < 0)
                                                    {
                                                        <span><span class="icon-health"></span> @card.HealthEffect health</span>
                                                    }
                                                    else
                                                    {
                                                        <span><span class="icon-health"></span> +@card.HealthEffect health</span>
                                                    }
                                                </div>
                                            }
                                            
                                            @if (card.TokenGains != null && card.TokenGains.Any())
                                            {
                                                @foreach (var token in card.TokenGains)
                                                {
                                                    <div class="path-tokens"><span class="icon-token"></span> +@token.Value @token.Key token@(token.Value > 1 ? "s" : "")</div>
                                                }
                                            }
                                            
                                            @if (card.RevealsPaths != null && card.RevealsPaths.Any())
                                            {
                                                <div class="path-reveals"><span class="icon-map"></span> Reveals @card.RevealsPaths.Count path@(card.RevealsPaths.Count > 1 ? "s" : "")</div>
                                            }
                                            
                                            @if (!string.IsNullOrEmpty(card.OneTimeReward) && card.IsOneTime)
                                            {
                                                var rewardParsed = ParseReward(card.OneTimeReward);
                                                var alreadyClaimed = IsOneTimeRewardClaimed(card);
                                                <div class="path-reward">
                                                    <span class="icon-star"></span> @rewardParsed
                                                    @if (alreadyClaimed)
                                                    {
                                                        <span class="path-already-claimed">(already claimed)</span>
                                                    }
                                                </div>
                                            }
                                            
                                            @if (card.ForceReturn)
                                            {
                                                <div class="path-force-return"><span class="icon-warning"></span> DEAD END - Must return</div>
                                            }
                                        </div>
                                    }
                                    
                                    <div class="path-effect">
                                        @card.NarrativeText
                                    </div>
                                </div>
                            </div>
                        }
                        else if (!IsCurrentSegmentEventType())
                        {
                            <!-- Face-Down Path Card (only for FixedPath segments) -->
                            <div class="card-back-pattern"></div>
                            <div class="card-back">
                                <span class="card-back-name">
                                    @card.Name
                                </span>
                                <div class="card-back-info">
                                    <span class="card-back-cost">@card.StaminaCost stamina</span>
                                    @if (card.TravelTimeSegments > 0)
                                    {
                                        <span class="card-back-time">@card.TravelTimeSegments seg</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            else
            {
                <div class="unknown-hint">
                    No path cards available for this segment.
                </div>
            }
        </div>

        @if (IsRevealingCard())
        {
            <div class="continue-section">
                @if (IsReadyToComplete())
                {
                    <div class="continue-button" @onclick="FinishRoute">
                        <div>FINISH ROUTE</div>
                        <div class="continue-details">Complete your journey to @GetDestinationName()</div>
                    </div>
                }
                else
                {
                    <div class="continue-button" @onclick="ConfirmRevealedCard">
                        <div>CONTINUE TO NEXT SEGMENT</div>
                        <div class="continue-details">Confirm this path choice and proceed</div>
                    </div>
                }
            </div>
        }
        else if (IsReadyToComplete())
        {
            <div class="continue-section">
                <div class="continue-button" @onclick="FinishRoute">
                    <div>FINISH ROUTE</div>
                    <div class="continue-details">Complete your journey to @GetDestinationName()</div>
                </div>
            </div>
        }
        else if (!IsJourneyComplete())
        {
            <div class="unknown-hint">
                Unknown paths will reveal permanently when played. The <span class="icon-warning"></span> symbol indicates possible encounters.
            </div>
        }
    </div>

    <!-- Action Section -->
    <div class="action-section">
        <div class="action-choices">
            <div class="action-button @(!CanRest() ? "disabled" : "")" 
                 @onclick="RestAction">
                <div>REST</div>
                <div class="action-details">Skip segment, +3 segments, restore stamina</div>
            </div>
            <div class="action-button @(!MustTurnBack() ? "disabled" : "")" 
                 @onclick="TurnBack">
                <div>TURN BACK</div>
                <div class="action-details">Return to @GetOriginLocationName()</div>
            </div>
        </div>
    </div>
}
else
{
    <!-- No active travel session -->
    <div class="paths-section">
        <div class="paths-title">No Active Journey</div>
        <div class="unknown-hint">
            Start a journey from the travel routes screen to see path cards.
        </div>
    </div>
}

@code {
    protected string GetOriginLocationName()
    {
        if (TravelContext?.CurrentRoute == null)
            return "Origin";
        
        // Get current player location
        var player = GameFacade.GetPlayer();
        if (player?.CurrentLocation?.VenueId != null)
        {
            var Venue = GameFacade.GetLocationById(player.CurrentLocation.VenueId);
            return Venue?.Name ?? "Origin";
        }
        
        return "Origin";
    }
    
    protected string GetSegmentDotClass(SegmentDotState state)
    {
        return state switch
        {
            SegmentDotState.Complete => "complete",
            SegmentDotState.Current => "current",
            _ => ""
        };
    }
    
    protected string ParseReward(string reward)
    {
        if (string.IsNullOrEmpty(reward))
            return "";
            
        // Parse rewards like "5_coins" to "5 coins"
        if (reward.Contains("_coin"))
        {
            return reward.Replace("_", " ");
        }
        
        return reward;
    }
    
    protected string GetEventTitle()
    {
        // This would get the event title from the current event collection
        // For now, return empty as this needs backend support
        return "";
    }
    
    protected string GetEventType()
    {
        // This would get the event type (e.g., "Opportunity Event", "Challenge Event")
        // For now, return empty as this needs backend support
        return "";
    }
    
    protected bool IsOneTimeRewardClaimed(PathCardDTO card)
    {
        // Check if this one-time reward has already been claimed
        // This would need to check game state for claimed rewards
        return false; // For now, assume not claimed
    }
}