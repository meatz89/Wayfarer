@inherits TravelPathContentBase
@namespace Wayfarer.Pages.Components

@if (TravelContext != null && TravelContext.Session != null)
{
    <!-- Route Info -->
    <div class="route-info">
        <div class="route-title">@GetOriginLocationName() ‚Üí @GetDestinationName()</div>
        <div class="route-details">Base Time: @GetBaseTravelTime() minutes ‚Ä¢ Distance: @GetSegmentCount() segments ‚Ä¢ Route Familiarity: @GetRouteFamiliarity()</div>
    </div>

    <!-- Stamina Bar -->
    <div class="stamina-section">
        <span class="stamina-label">Stamina:</span>
        <div class="stamina-dots">
            @foreach (var dot in GetStaminaDots())
            {
                <span class="stamina-dot @(dot.State == StaminaDotState.Available ? "available" : dot.State == StaminaDotState.Spent ? "spent" : "")"></span>
            }
        </div>
        <span class="stamina-numbers">@GetStaminaDisplay()</span>
        <span class="stamina-note">@GetTravelStateText()</span>
    </div>

    <!-- Segment Progress -->
    <div class="segment-progress">
        SEGMENT @GetCurrentSegment() OF @GetSegmentCount()
        <span class="segment-dots">
            @{
                var segmentDots = GetSegmentDots();
                for (int i = 0; i < segmentDots.Count; i++)
                {
                    var dot = segmentDots[i];
                    <span class="segment-dot @GetSegmentDotClass(dot.State)"></span>
                    @if (i < segmentDots.Count - 1)
                    {
                        <span>‚Üí</span>
                    }
                }
            }
        </span>
    </div>

    <!-- Path Cards Section -->
    <div class="paths-section">
        <div class="paths-title">@GetPathsTitle()</div>
        
        @{
            var eventNarrative = GetEventNarrative();
        }
        @if (!string.IsNullOrEmpty(eventNarrative))
        {
            <div class="event-narrative">@eventNarrative</div>
        }
        
        <div class="path-grid">
            @if (GetAvailablePathCards().Any())
            {
                @foreach (var pathCardData in GetAvailablePathCards())
                {
                    var card = pathCardData.Card;
                    var isDiscovered = pathCardData.IsDiscovered;
                    var isAvailable = pathCardData.CanPlay && !ShouldDisableCard(card.Id);
                    var isBeingRevealed = IsCardBeingRevealed(card.Id);
                    
                    <div class="path-card @GetPathCardCssClass(isDiscovered, isAvailable) @(isBeingRevealed ? "revealed" : "") @(ShouldDisableCard(card.Id) ? "disabled-during-reveal" : "")" @onclick="() => SelectPathCard(card.Id)">
                        
                        @if (isDiscovered)
                        {
                            <!-- Face-Up Path Card -->
                            <div class="path-content">
                                <div class="path-main">
                                    <div class="path-header">
                                        <div class="path-name">@card.Name</div>
                                        <div class="path-stamina">@card.StaminaCost</div>
                                    </div>
                                    
                                    @{
                                        var requirements = GetRequirementsText(card);
                                    }
                                    @if (!string.IsNullOrEmpty(requirements))
                                    {
                                        <div class="path-requirements">Requires: @requirements</div>
                                    }
                                    
                                    <!-- Mechanical Effects Section -->
                                    <div class="path-mechanics">
                                        @if (card.TravelTimeMinutes > 0)
                                        {
                                            <div class="path-time">‚è±Ô∏è @card.TravelTimeMinutes minutes</div>
                                        }
                                        
                                        @if (card.HungerEffect != 0)
                                        {
                                            <div class="path-hunger @(card.HungerEffect > 0 ? "cost" : "reward")">
                                                @if (card.HungerEffect > 0)
                                                {
                                                    <span>üçñ +@card.HungerEffect hunger</span>
                                                }
                                                else
                                                {
                                                    <span>üçñ @card.HungerEffect hunger</span>
                                                }
                                            </div>
                                        }
                                        
                                        @if (!string.IsNullOrEmpty(card.OneTimeReward) && card.IsOneTime)
                                        {
                                            var rewardParsed = ParseReward(card.OneTimeReward);
                                            <div class="path-reward">
                                                üí∞ @rewardParsed @GetOneTimeStatus(card)
                                            </div>
                                        }
                                    </div>
                                    
                                    <div class="path-effect">
                                        @card.NarrativeText
                                    </div>
                                </div>
                            </div>
                        }
                        else if (!IsCurrentSegmentEventType())
                        {
                            <!-- Face-Down Path Card (only for FixedPath segments) -->
                            <div class="card-back-pattern"></div>
                            <div class="card-back">
                                <span class="card-back-name">
                                    @card.Name
                                </span>
                                <div class="card-back-info">
                                    <span class="card-back-cost">@card.StaminaCost stamina</span>
                                    @if (card.TravelTimeMinutes > 0)
                                    {
                                        <span class="card-back-time">@card.TravelTimeMinutes min</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            else
            {
                <div class="unknown-hint">
                    No path cards available for this segment.
                </div>
            }
        </div>

        @if (IsRevealingCard())
        {
            <div class="continue-section">
                <div class="continue-button" @onclick="ConfirmRevealedCard">
                    <div>CONTINUE TO NEXT SEGMENT</div>
                    <div class="continue-details">Confirm this path choice and proceed</div>
                </div>
            </div>
        }
        else if (!IsJourneyComplete())
        {
            <div class="unknown-hint">
                Unknown paths will reveal permanently when played. The ‚ö† symbol indicates possible encounters.
            </div>
        }
    </div>

    <!-- Action Section -->
    <div class="action-section">
        <div class="action-choices">
            <div class="action-button @(!CanRest() ? "disabled" : "")" 
                 @onclick="RestAction">
                <div>REST</div>
                <div class="action-details">Skip segment, +30 minutes, restore stamina</div>
            </div>
            <div class="action-button @(!MustTurnBack() ? "disabled" : "")" 
                 @onclick="TurnBack">
                <div>TURN BACK</div>
                <div class="action-details">Return to @GetOriginLocationName()</div>
            </div>
        </div>
    </div>
}
else
{
    <!-- No active travel session -->
    <div class="paths-section">
        <div class="paths-title">No Active Journey</div>
        <div class="unknown-hint">
            Start a journey from the travel routes screen to see path cards.
        </div>
    </div>
}

@code {
    protected string GetOriginLocationName()
    {
        if (TravelContext?.CurrentRoute == null)
            return "Origin";
        
        // Get current player location
        var player = GameFacade.GetPlayer();
        if (player?.CurrentLocationSpot?.LocationId != null)
        {
            var location = GameFacade.GetLocationById(player.CurrentLocationSpot.LocationId);
            return location?.Name ?? "Origin";
        }
        
        return "Origin";
    }
    
    protected string GetSegmentDotClass(SegmentDotState state)
    {
        return state switch
        {
            SegmentDotState.Complete => "complete",
            SegmentDotState.Current => "current",
            _ => ""
        };
    }
    
    protected string ParseReward(string reward)
    {
        if (string.IsNullOrEmpty(reward))
            return "";
            
        // Parse rewards like "5_coins" to "5 coins"
        if (reward.Contains("_coin"))
        {
            return reward.Replace("_", " ");
        }
        
        return reward;
    }
}