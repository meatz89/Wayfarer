@inherits TravelPathContentBase
@namespace Wayfarer.Pages.Components

@if (TravelContext != null && TravelContext.Session != null)
{
    @* ========== DEAD-END SEGMENT (travel-dead-end.html) ========== *@
    @if (IsDeadEnd())
    {
        <!-- Blocked Banner -->
        <div class="blocked-banner">
            <div class="blocked-title">⚠ PATH BLOCKED</div>
            <div class="blocked-subtitle">All routes ahead are impassable</div>
        </div>

        <!-- Current State Info -->
        <div class="travel-state-bar">
            <div class="travel-state">
                <span class="state-label">Current Segment</span>
                <span class="state-name">Segment @GetCurrentSegment() of @GetSegmentCount()</span>
            </div>
            <div class="travel-state">
                <span class="state-label">Location</span>
                <span class="state-name">@GetOriginLocationName() → @GetDestinationName()</span>
            </div>
        </div>

        <!-- Stamina Display -->
        <div class="stamina-section">
            <span class="stamina-label">Stamina:</span>
            <div class="stamina-dots">
                @foreach (var dot in GetStaminaDots())
                {
                    <span class="stamina-dot @(dot.State == StaminaDotState.Available ? "available" : dot.State == StaminaDotState.Spent ? "spent" : "")"></span>
                }
            </div>
            <span class="stamina-numbers">@GetStaminaDisplay()</span>
        </div>

        <!-- Dead-End Section -->
        <div class="deadend-section">
            <div class="deadend-explanation">
                <div class="explanation-text">
                    <div class="warning-icon">⚠</div>
                    You cannot proceed further. All paths ahead are blocked due to insufficient resources or requirements.
                </div>
            </div>

            <!-- Blocked Paths Display -->
            <div class="requirements-title">Blocked Paths</div>
            <div class="blocked-paths">
                <div class="path-grid">
                    @foreach (var pathCardData in GetAvailablePathCards())
                    {
                        var card = pathCardData.Card;
                        <div class="path-card blocked">
                            <div class="path-content">
                                <div class="path-main">
                                    <div class="path-header">
                                        <div class="path-name">@card.Name</div>
                                        <div class="path-stamina">@card.StaminaCost</div>
                                    </div>
                                    <div class="blocked-reason">@GetUnavailableReason(card)</div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Turn Back Action -->
            <div class="turnback-section">
                <div class="turnback-message">You must return to your starting location</div>
                <div class="turnback-button" @onclick="TurnBack">
                    TURN BACK
                </div>
            </div>
        </div>
    }
    @* ========== ENCOUNTER SEGMENT (Mandatory Challenge) ========== *@
    else if (IsEncounterSegment())
    {
        <!-- Encounter Banner -->
        <div class="encounter-banner">
            <div class="encounter-icon">⚔</div>
            <div class="encounter-title">CHALLENGE AHEAD</div>
            <div class="encounter-subtitle">You must overcome this scene to proceed</div>
        </div>

        <!-- Current State Info -->
        <div class="encounter-state-bar">
            <div class="travel-state">
                <span class="state-label">Current Segment</span>
                <span class="state-name">Segment @GetCurrentSegment() of @GetSegmentCount()</span>
            </div>
            <div class="travel-state">
                <span class="state-label">Location</span>
                <span class="state-name">@GetOriginLocationName() → @GetDestinationName()</span>
            </div>
        </div>

        <!-- Stamina Display -->
        <div class="stamina-section">
            <span class="stamina-label">Stamina:</span>
            <div class="stamina-dots">
                @foreach (var dot in GetStaminaDots())
                {
                    <span class="stamina-dot @(dot.State == StaminaDotState.Available ? "available" : dot.State == StaminaDotState.Spent ? "spent" : "")"></span>
                }
            </div>
            <span class="stamina-numbers">@GetStaminaDisplay()</span>
        </div>

        <!-- Encounter Section -->
        <div class="encounter-section">
            <div class="encounter-message">
                <div class="challenge-icon">⚔</div>
                <div class="encounter-text">
                    <div class="encounter-primary">Mandatory Challenge</div>
                    <div class="encounter-secondary">You must resolve this scene before continuing your journey</div>
                </div>
            </div>

            <!-- Scene Display -->
            @{
                var segment = GetCurrentRouteSegment();
                if (segment != null && segment.MandatorySceneTemplate != null)
                {
                    var scene = GameWorld.Scenes.FirstOrDefault(s => s.Template == segment.MandatorySceneTemplate);
                    if (scene != null)
                    {
                        <div class="scene-display">
                            <div class="scene-name">@scene.DisplayName</div>
                            <div class="scene-description">@scene.IntroNarrative</div>
                            @* ARCHITECTURE UPDATE: Scene.Intensity removed *@

                            <!-- Available Situations -->
                            <div class="situations-list">
                                <div class="situations-title">Available Approaches</div>
                                @{
                                    // Direct access to scene's situations (Scene owns Situations)
                                    var situations = scene.Situations.ToList();
                                }
                                @foreach (var situation in situations)
                                {
                                    if (situation != null)
                                    {
                                        <div class="situation-card">
                                            <div class="situation-header">
                                                <div class="situation-name">@situation.Name</div>
                                                <div class="situation-system">@situation.SystemType</div>
                                            </div>
                                            <div class="situation-description">@situation.Description</div>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    }
                }
            }

            <!-- Action: Engage Challenge -->
            <div class="encounter-actions">
                <div class="encounter-button primary" @onclick="EngageEncounter">
                    <div class="encounter-button-text">ENGAGE CHALLENGE</div>
                    <div class="encounter-button-subtitle">Begin scene resolution</div>
                </div>
                <div class="encounter-button secondary" @onclick="TurnBack">
                    <div class="encounter-button-text">TURN BACK</div>
                    <div class="encounter-button-subtitle">Return to @GetOriginLocationName()</div>
                </div>
            </div>
        </div>
    }
    @* ========== DISCOVERY REVEAL SEGMENT (travel-discovery.html) ========== *@
    else if (IsDiscoveryReveal())
    {
        <!-- Discovery Banner -->
        <div class="discovery-banner">
            <div class="discovery-icon"><Icon Name="magnifying-glass" CssClass="icon-positive" /></div>
            <div class="discovery-title">PATH REVEALED</div>
            <div class="discovery-subtitle">A new route has been discovered</div>
        </div>

        <!-- Current State Info -->
        <div class="discovery-state-bar">
            <div class="travel-state">
                <span class="state-label">Current Segment</span>
                <span class="state-name">Segment @GetCurrentSegment() of @GetSegmentCount()</span>
            </div>
            <div class="travel-state">
                <span class="state-label">Progress</span>
                <span class="state-name">@GetOriginLocationName() → @GetDestinationName()</span>
            </div>
        </div>

        <!-- Discovery Content -->
        <div class="discovery-section">
            <div class="discovery-message">
                Your exploration has revealed a previously hidden path!
            </div>

            <!-- Revealed Card Display -->
            <div class="revealed-card-display">
                @{
                    var revealedCard = GetRevealedCard();
                    if (revealedCard != null)
                    {
                        <div class="discovery-card">
                            <div class="discovery-card-header">
                                <div class="discovery-card-name">@revealedCard.Name</div>
                                <div class="discovery-card-cost">@revealedCard.StaminaCost stamina</div>
                            </div>

                            @if (!string.IsNullOrEmpty(revealedCard.NarrativeText))
                            {
                                <div class="discovery-card-narrative">@revealedCard.NarrativeText</div>
                            }

                            @{
                                var hasEffects = revealedCard.TravelTimeSegments > 0 || revealedCard.HungerEffect != 0 ||
                                                revealedCard.CoinReward > 0 || revealedCard.StaminaRestore > 0 ||
                                                revealedCard.HealthEffect != 0 ||
                                                (revealedCard.TokenGains?.Any() ?? false);
                            }
                            @if (hasEffects)
                            {
                                <div class="discovery-card-effects">
                                    @if (revealedCard.TravelTimeSegments > 0)
                                    {
                                        <div class="effect-item time"><span class="icon-clock"></span> @revealedCard.TravelTimeSegments segments</div>
                                    }
                                    @if (revealedCard.StaminaCost > 0)
                                    {
                                        <div class="effect-item stamina"><span class="icon-attention"></span> @revealedCard.StaminaCost stamina cost</div>
                                    }
                                    @if (revealedCard.HungerEffect != 0)
                                    {
                                        <div class="effect-item @(revealedCard.HungerEffect > 0 ? "hunger" : "food")">
                                            <span class="icon-food"></span> @(revealedCard.HungerEffect > 0 ? "+" : "")@revealedCard.HungerEffect hunger
                                        </div>
                                    }
                                    @if (revealedCard.CoinReward > 0)
                                    {
                                        <div class="effect-item coins"><span class="icon-coin"></span> +@revealedCard.CoinReward coins</div>
                                    }
                                    @if (revealedCard.StaminaRestore > 0)
                                    {
                                        <div class="effect-item restore"><span class="icon-attention"></span> Restore @revealedCard.StaminaRestore stamina</div>
                                    }
                                    @if (revealedCard.HealthEffect != 0)
                                    {
                                        <div class="effect-item @(revealedCard.HealthEffect < 0 ? "damage" : "heal")">
                                            <span class="icon-health"></span> @(revealedCard.HealthEffect > 0 ? "+" : "")@revealedCard.HealthEffect health
                                        </div>
                                    }
                                    @if (revealedCard.TokenGains != null && revealedCard.TokenGains.Any())
                                    {
                                        @foreach (var token in revealedCard.TokenGains)
                                        {
                                            <div class="effect-item token"><span class="icon-token"></span> +@token.Amount @token.TokenType</div>
                                        }
                                    }
                                </div>
                            }
                        </div>
                    }
                }
            </div>

            <!-- Results Summary -->
            <div class="results-section">
                <div class="results-title">Path Effects</div>
                <div class="results-grid">
                    @{
                        var revealedCardEffects = GetRevealedCard();
                        if (revealedCardEffects != null)
                        {
                            if (revealedCardEffects.TravelTimeSegments > 0)
                            {
                                <div class="result-card time">
                                    <div class="result-icon">⏱</div>
                                    <div class="result-label">Time</div>
                                    <div class="result-value">+@revealedCardEffects.TravelTimeSegments seg</div>
                                </div>
                            }
                            if (revealedCardEffects.StaminaCost > 0)
                            {
                                <div class="result-card stamina">
                                    <div class="result-icon"><Icon Name="sprint" CssClass="resource-stamina" /></div>
                                    <div class="result-label">Stamina</div>
                                    <div class="result-value">-@revealedCardEffects.StaminaCost</div>
                                </div>
                            }
                            if (revealedCardEffects.CoinReward > 0)
                            {
                                <div class="result-card coins">
                                    <div class="result-icon"><Icon Name="coins" CssClass="resource-coin" /></div>
                                    <div class="result-label">Coins</div>
                                    <div class="result-value">+@revealedCardEffects.CoinReward</div>
                                </div>
                            }
                        }
                    }
                </div>
            </div>

            <!-- Continue Button -->
            <div class="continue-section">
                @if (IsReadyToComplete())
                {
                    <div class="continue-button discovery" @onclick="FinishRoute">
                        <div>FINISH ROUTE</div>
                        <div class="continue-details">Complete your journey to @GetDestinationName()</div>
                    </div>
                }
                else
                {
                    <div class="continue-button discovery" @onclick="ConfirmRevealedCard">
                        <div>CONTINUE TO NEXT SEGMENT</div>
                        <div class="continue-details">Proceed with this path choice</div>
                    </div>
                }
            </div>
        </div>
    }
    @* ========== FINISH ROUTE SCREEN (when journey complete) ========== *@
    else if (IsReadyToComplete())
    {
        <!-- Journey Complete Banner -->
        <div class="discovery-banner">
            <div class="discovery-icon"><Icon Name="check-mark" CssClass="icon-positive" /></div>
            <div class="discovery-title">JOURNEY COMPLETE</div>
            <div class="discovery-subtitle">You have reached your destination</div>
        </div>

        <!-- Finish Button -->
        <div class="continue-section">
            <div class="continue-button discovery" @onclick="FinishRoute">
                <div>FINISH ROUTE</div>
                <div class="continue-details">Complete your journey to @GetDestinationName()</div>
            </div>
        </div>
    }
    @* ========== CARAVAN/EVENT SEGMENT (travel-caravan.html) ========== *@
    else if (IsEventSegment())
    {
        <!-- Caravan Header -->
        <div class="caravan-header">
            <div class="caravan-name">@GetOriginLocationName() → @GetDestinationName()</div>
            <div class="caravan-info">
                <div class="comfort-badge">Comfort: Standard</div>
                <div class="event-progress">Event @GetCurrentSegment() of @GetSegmentCount()</div>
            </div>
        </div>

        <!-- Stamina Display -->
        <div class="stamina-section">
            <span class="stamina-label">Stamina:</span>
            <div class="stamina-dots">
                @foreach (var dot in GetStaminaDots())
                {
                    <span class="stamina-dot @(dot.State == StaminaDotState.Available ? "available" : dot.State == StaminaDotState.Spent ? "spent" : "")"></span>
                }
            </div>
            <span class="stamina-numbers">@GetStaminaDisplay()</span>
        </div>

        <!-- Event Narrative -->
        @if (!string.IsNullOrEmpty(GetEventNarrative()))
        {
            <div class="event-card">
                @if (!string.IsNullOrEmpty(GetEventTitle()))
                {
                    <div class="event-header">
                        <div class="event-title">@GetEventTitle()</div>
                        @if (!string.IsNullOrEmpty(GetEventType()))
                        {
                            <div class="event-type">@GetEventType()</div>
                        }
                    </div>
                }
                <div class="event-narrative-text">@GetEventNarrative()</div>
            </div>
        }

        <!-- Response Cards (Path Cards for Events) -->
        <div class="response-section">
            <div class="response-title">Your Response</div>
            <div class="response-grid">
                @foreach (var pathCardData in GetAvailablePathCards())
                {
                    var card = pathCardData.Card;
                    var isAvailable = pathCardData.CanPlay;
                    <div class="response-card @(isAvailable ? "" : "unavailable")"
                         @onclick="async () => { if (isAvailable) await SelectPathCard(card); }">
                        <div class="response-header">
                            <div class="response-name">@card.Name</div>
                            @if (card.StaminaCost == 0)
                            {
                                <div class="response-cost">0 stamina</div>
                            }
                            else
                            {
                                <div class="response-cost">@card.StaminaCost stamina</div>
                            }
                        </div>
                        @if (!string.IsNullOrEmpty(card.NarrativeText))
                        {
                            <div class="response-narrative">@card.NarrativeText</div>
                        }
                        @{
                            var hasEffects = card.TravelTimeSegments > 0 || card.HungerEffect != 0 ||
                                            card.CoinReward > 0 || card.StaminaRestore > 0 ||
                                            card.HealthEffect != 0;
                        }
                        @if (hasEffects)
                        {
                            <div class="response-effects">
                                @if (card.TravelTimeSegments > 0)
                                {
                                    <div class="response-effect"><span class="icon-clock"></span> @card.TravelTimeSegments segments</div>
                                }
                                @if (card.HungerEffect != 0)
                                {
                                    <div class="response-effect"><span class="icon-food"></span> @(card.HungerEffect > 0 ? "+" : "")@card.HungerEffect hunger</div>
                                }
                                @if (card.CoinReward > 0)
                                {
                                    <div class="response-effect"><span class="icon-coin"></span> +@card.CoinReward coins</div>
                                }
                                @if (card.StaminaRestore > 0)
                                {
                                    <div class="response-effect"><span class="icon-attention"></span> +@card.StaminaRestore stamina</div>
                                }
                                @if (card.HealthEffect != 0)
                                {
                                    <div class="response-effect"><span class="icon-health"></span> @(card.HealthEffect > 0 ? "+" : "")@card.HealthEffect health</div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

    }
    @* ========== WALKING/FIXEDPATH SEGMENT (travel-walking.html) ========== *@
    else if (IsFixedPathSegment())
    {
        <!-- Route Header -->
        <div class="route-header">
            <div class="route-info">
                <div class="route-name">@GetOriginLocationName() <span class="icon-arrow-right"></span> @GetDestinationName()</div>
                <div class="route-properties">
                    <div class="route-property">
                        <span class="property-label">Transport</span>
                        <span class="property-value">@GetTransportType()</span>
                    </div>
                    <div class="route-property">
                        <span class="property-label">Distance</span>
                        <span class="property-value">@GetSegmentCount() segments</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Travel State Bar -->
        <div class="travel-state-bar">
            <div class="travel-state">
                <span class="state-label">Current Segment</span>
                <span class="state-name">Segment @GetCurrentSegment() of @GetSegmentCount()</span>
            </div>
            <div class="travel-state">
                <span class="state-label">Travel State</span>
                <span class="state-name">@GetTravelStateText()</span>
            </div>
        </div>

        <!-- Stamina Bar -->
        <div class="stamina-section">
            <span class="stamina-label">Stamina:</span>
            <div class="stamina-dots">
                @foreach (var dot in GetStaminaDots())
                {
                    <span class="stamina-dot @(dot.State == StaminaDotState.Available ? "available" : dot.State == StaminaDotState.Spent ? "spent" : "")"></span>
                }
            </div>
            <span class="stamina-numbers">@GetStaminaDisplay()</span>
            <span class="stamina-note">@GetTravelStateText()</span>
        </div>

        <!-- Segment Progress -->
        <div class="segment-progress">
            SEGMENT @GetCurrentSegment() OF @GetSegmentCount()
            <span class="segment-dots">
                @{
                    var segmentDots = GetSegmentDots();
                    for (int i = 0; i < segmentDots.Count; i++)
                    {
                        var dot = segmentDots[i];
                        <span class="segment-dot @GetSegmentDotClass(dot.State)"></span>
                        @if (i < segmentDots.Count - 1)
                        {
                            <span class="icon-arrow-right"></span>
                        }
                    }
                }
            </span>
        </div>

        <!-- Path Cards Section -->
        <div class="paths-section">
            <div class="paths-title">@GetPathsTitle()</div>

            @if (!string.IsNullOrEmpty(GetEventNarrative()))
            {
                <div class="event-narrative simple">@GetEventNarrative()</div>
            }

            <div class="path-grid">
                @if (GetAvailablePathCards().Any())
                {
                    @* OLD SYSTEM: PathCard rendering with reveal mechanic *@
                    @foreach (var pathCardData in GetAvailablePathCards())
                    {
                        var card = pathCardData.Card;
                        var isDiscovered = pathCardData.IsDiscovered;
                        var isAvailable = pathCardData.CanPlay && !ShouldDisableCard(card);
                        var isBeingRevealed = IsCardBeingRevealed(card);

                        <div class="path-card @GetPathCardCssClass(isDiscovered, isAvailable) @(isBeingRevealed ? "revealed" : "") @(ShouldDisableCard(card) ? "disabled-during-reveal" : "") @(IsReadyToComplete() ? "complete" : "")"
                             data-unavailable-reason="@(!isAvailable ? GetUnavailableReason(card) : "")"
                             @onclick="async () => { if (!IsReadyToComplete()) await SelectPathCard(card); }">

                            @if (isDiscovered)
                            {
                                <!-- Face-Up Path Card -->
                                <div class="path-content">
                                    <div class="path-main">
                                        <div class="path-header">
                                            <div class="path-name">@card.Name</div>
                                            <div class="path-stamina">@card.StaminaCost</div>
                                        </div>

                                        @{
                                            var requirements = GetRequirementsText(card);
                                        }
                                        @if (!string.IsNullOrEmpty(requirements))
                                        {
                                            <div class="path-requirements">@requirements</div>
                                        }

                                        @if (card.StatRequirements != null && card.StatRequirements.Count > 0)
                                        {
                                            <div class="path-stat-requirements">
                                                @foreach (var statReq in card.StatRequirements)
                                                {
                                                    Player player = GameOrchestrator.GetPlayer();
                                                    bool meetsRequirement = false;
                                                    string statName = "";
                                                    int required = statReq.Value;
                                                    int current = 0;

                                                    if (Enum.TryParse<PlayerStatType>(statReq.Stat, true, out PlayerStatType statType))
                                                    {
                                                        statName = GetStatDisplayName(statType);
                                                        current = statType switch
                                                        {
                                                            PlayerStatType.Insight => player.Insight,
                                                            PlayerStatType.Rapport => player.Rapport,
                                                            PlayerStatType.Authority => player.Authority,
                                                            PlayerStatType.Diplomacy => player.Diplomacy,
                                                            PlayerStatType.Cunning => player.Cunning,
                                                            _ => 0
                                                        };
                                                        meetsRequirement = current >= required;
                                                    }
                                                    <div class="stat-requirement @(meetsRequirement ? "met" : "unmet")">
                                                        <span class="stat-icon @GetStatIconClass(statReq.Stat)"></span>
                                                        <span class="stat-info">@statName @required+</span>
                                                        @if (!meetsRequirement)
                                                        {
                                                            <span class="current-level">(@current)</span>
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        }

                                        @if (!string.IsNullOrEmpty(card.SceneId))
                                        {
                                            var situationPreviews = GetSituationPreviewsForPath(card.SceneId);
                                            if (situationPreviews != null && situationPreviews.Any())
                                            {
                                                <div class="path-challenges-preview">
                                                    <div class="challenges-header">Challenges ahead:</div>

                                                    @foreach (var situationPreview in situationPreviews)
                                                    {
                                                        <div class="situation-preview-card">
                                                            <div class="situation-preview-header">
                                                                <span class="situation-preview-name">@situationPreview.Name</span>
                                                                <span class="situation-preview-system">@situationPreview.SystemType</span>
                                                            </div>

                                                            @if (!string.IsNullOrEmpty(situationPreview.Description))
                                                            {
                                                                <div class="situation-preview-description">@situationPreview.Description</div>
                                                            }

                                                        </div>
                                                    }
                                                </div>
                                            }
                                        }

                                        @{
                                            var hasEffects = card.TravelTimeSegments > 0 || card.HungerEffect != 0 ||
                                                            card.CoinReward > 0 || card.StaminaRestore > 0 ||
                                                            card.HealthEffect != 0 ||
                                                            card.ForceReturn || (card.TokenGains?.Any() ?? false) ||
                                                            (card.RevealsPaths?.Any() ?? false) ||
                                                            (!string.IsNullOrEmpty(card.OneTimeReward) && card.IsOneTime);
                                        }
                                        @if (hasEffects)
                                        {
                                            <div class="path-mechanics">
                                                @if (card.TravelTimeSegments > 0)
                                                {
                                                    <div class="path-time"><span class="icon-clock"></span> @card.TravelTimeSegments segments</div>
                                                }

                                                @if (card.HungerEffect != 0)
                                                {
                                                    <div class="path-hunger @(card.HungerEffect > 0 ? "cost" : "reward")">
                                                        @if (card.HungerEffect > 0)
                                                        {
                                                            <span><span class="icon-food"></span> +@card.HungerEffect hunger</span>
                                                        }
                                                        else
                                                        {
                                                            <span><span class="icon-food"></span> @card.HungerEffect hunger</span>
                                                        }
                                                    </div>
                                                }

                                                @if (card.CoinReward > 0)
                                                {
                                                    <div class="path-coins reward"><span class="icon-coin"></span> +@card.CoinReward coins</div>
                                                }

                                                @if (card.StaminaRestore > 0)
                                                {
                                                    <div class="path-stamina-restore"><span class="icon-attention"></span> Restore @card.StaminaRestore stamina</div>
                                                }

                                                @if (card.HealthEffect != 0)
                                                {
                                                    <div class="path-health @(card.HealthEffect < 0 ? "damage" : "heal")">
                                                        @if (card.HealthEffect < 0)
                                                        {
                                                            <span><span class="icon-health"></span> @card.HealthEffect health</span>
                                                        }
                                                        else
                                                        {
                                                            <span><span class="icon-health"></span> +@card.HealthEffect health</span>
                                                        }
                                                    </div>
                                                }

                                                @if (card.TokenGains != null && card.TokenGains.Any())
                                                {
                                                    @foreach (var token in card.TokenGains)
                                                    {
                                                        <div class="path-tokens"><span class="icon-token"></span> +@token.Amount @token.TokenType token@(token.Amount > 1 ? "s" : "")</div>
                                                    }
                                                }

                                                @if (card.RevealsPaths != null && card.RevealsPaths.Any())
                                                {
                                                    <div class="path-reveals"><span class="icon-map"></span> Reveals @card.RevealsPaths.Count path@(card.RevealsPaths.Count > 1 ? "s" : "")</div>
                                                }

                                                @if (!string.IsNullOrEmpty(card.OneTimeReward) && card.IsOneTime)
                                                {
                                                    var rewardParsed = ParseReward(card.OneTimeReward);
                                                    var alreadyClaimed = IsOneTimeRewardClaimed(card);
                                                    <div class="path-reward">
                                                        <span class="icon-star"></span> @rewardParsed
                                                        @if (alreadyClaimed)
                                                        {
                                                            <span class="path-already-claimed">(already claimed)</span>
                                                        }
                                                    </div>
                                                }

                                                @if (card.ForceReturn)
                                                {
                                                    <div class="path-force-return"><span class="icon-warning"></span> DEAD END - Must return</div>
                                                }
                                            </div>
                                        }

                                        <div class="path-effect">
                                            @card.NarrativeText
                                        </div>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <!-- Face-Down Path Card -->
                                <div class="card-back-pattern"></div>
                                <div class="card-back">
                                    <span class="card-back-name">
                                        @card.Name
                                    </span>
                                    <div class="card-back-info">
                                        <span class="card-back-cost">@card.StaminaCost stamina</span>
                                        @if (card.TravelTimeSegments > 0)
                                        {
                                            <span class="card-back-time">@card.TravelTimeSegments seg</span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                }
                else
                {
                    <div class="unknown-hint">
                        No path cards available for this segment.
                    </div>
                }
            </div>

            @* Encounter Deck Preview - Show possible encounters from scene situations *@
            @{
                var encounterSituations = GetEncounterSituationsForCurrentSegment();
            }
            @if (encounterSituations.Any())
            {
                <div class="encounter-preview">
                    <div class="encounter-title">Possible Encounters:</div>
                    <div class="encounter-list">
                        @foreach (var situationName in encounterSituations)
                        {
                            <span class="encounter-item">@situationName</span>
                        }
                    </div>
                </div>
            }

            @if (!IsJourneyComplete())
            {
                <div class="unknown-hint">
                    Unknown paths will reveal permanently when played. The <span class="icon-warning"></span> symbol indicates possible encounters.
                </div>
            }
        </div>

        <!-- Action Section -->
        <div class="action-section">
            <div class="action-choices">
                <div class="action-button @(!CanRest() ? "disabled" : "")"
                     @onclick="RestAction">
                    <div>REST</div>
                    <div class="action-details">+1 stamina, +1 segment)</div>
                </div>
                <div class="action-button @(!MustTurnBack() ? "disabled" : "")"
                     @onclick="TurnBack">
                    <div>TURN BACK</div>
                    <div class="action-details">Return to @GetOriginLocationName()</div>
                </div>
            </div>
        </div>
    }
}
else
{
    <!-- No active travel session -->
    <div class="paths-section">
        <div class="paths-title">No Active Journey</div>
        <div class="unknown-hint">
            Start a journey from the travel routes screen to see path cards.
        </div>
    </div>
}

@code {
    protected string GetOriginLocationName()
    {
        if (TravelContext?.CurrentRoute == null)
            return "Origin";

        var player = GameOrchestrator.GetPlayer();
        Location currentLocation = GameOrchestrator.GetPlayerCurrentLocation();
        // ADR-007: Use Venue object reference instead of deleted VenueId
        if (currentLocation?.Venue != null)
        {
            return currentLocation.Venue.Name ?? "Origin";
        }

        return "Origin";
    }

    protected string GetSegmentDotClass(SegmentDotState state)
    {
        return state switch
        {
            SegmentDotState.Complete => "complete",
            SegmentDotState.Current => "current",
            _ => ""
        };
    }

    protected string ParseReward(string reward)
    {
        if (string.IsNullOrEmpty(reward))
            return "";

        if (reward.Contains("_coin"))
        {
            return reward.Replace("_", " ");
        }

        return reward;
    }

    protected string GetEventTitle()
    {
        return "";
    }

    protected string GetEventType()
    {
        return "";
    }

    protected bool IsOneTimeRewardClaimed(PathCardDTO card)
    {
        return false;
    }

    // ADR-007: Get RevealedCard object directly (no ID lookup needed)
    protected PathCardDTO GetRevealedCard()
    {
        if (TravelContext?.Session == null)
            throw new InvalidOperationException("Cannot get revealed card: TravelContext.Session is null");

        if (TravelContext.Session.RevealedCard == null)
            throw new InvalidOperationException("Cannot get revealed card: RevealedCard is null");

        return TravelContext.Session.RevealedCard;
    }
}
