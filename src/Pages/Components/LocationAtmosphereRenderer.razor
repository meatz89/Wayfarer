@* Maps location atmosphere categories to descriptive text *@

@inject ObligationQueueManager LetterQueueManager

@code {
    [Parameter] public LocationSpot CurrentSpot { get; set; }
    [Parameter] public TimeBlocks CurrentTime { get; set; }
    [Parameter] public List<NPC> NPCsPresent { get; set; }

    private SpotDescriptionGenerator _descriptionGenerator = new SpotDescriptionGenerator();

    private string GetAtmosphereText()
    {
        if (CurrentSpot == null)
            return "An undefined location.";

        // Get active properties including time-specific ones
        var activeProperties = new List<SpotPropertyType>(CurrentSpot.SpotProperties ?? new List<SpotPropertyType>());
        if (CurrentSpot.TimeSpecificProperties?.ContainsKey(CurrentTime) == true)
        {
            activeProperties.AddRange(CurrentSpot.TimeSpecificProperties[CurrentTime]);
        }

        // Count urgent obligations for tension
        var urgentObligations = LetterQueueManager?.GetActiveObligations()
            ?.Count(o => o.DeadlineInSegments < 360) ?? 0;

        // Generate description from categorical properties
        return _descriptionGenerator.GenerateDescription(
            activeProperties,
            CurrentTime,
            urgentObligations,
            NPCsPresent?.Count ?? 0
        );
    }

    private string GetNPCFocusDescription(NPC npc)
    {
        // Generate description from categorical properties
        var connectionState = DetermineConnectionState(npc);
        var hasUrgentLetter = HasUrgentLetter(npc);
        
        var baseActivity = GetProfessionActivity(npc.Profession);
        var emotionalModifier = GetEmotionalModifier(connectionState, hasUrgentLetter);
        var contextualProp = GetContextualProp(npc.Profession, hasUrgentLetter);
        
        // Combine categorical elements into description
        if (connectionState == ConnectionState.DISCONNECTED && hasUrgentLetter)
        {
            return $"{emotionalModifier} {contextualProp}, {GetDisconnectedDetail()}";
        }
        
        return $"{baseActivity}, {emotionalModifier}";
    }
    
    private ConnectionState DetermineConnectionState(NPC npc)
    {
        // In the 5-state system, NPCs always start NEUTRAL at locations
        // Their state changes during conversations based on mechanics
        return ConnectionState.NEUTRAL;
    }
    
    private bool HasUrgentLetter(NPC npc)
    {
        var obligations = LetterQueueManager?.GetActiveObligations() ?? new DeliveryObligation[0];
        return obligations.Any(o => 
            (o.SenderId == npc.ID || o.SenderName == npc.Name) && 
            o.DeadlineInSegments < 360);
    }
    
    private string GetProfessionActivity(Professions profession)
    {
        return profession switch
        {
            Professions.Scribe => "Hunched over documents",
            Professions.Merchant => "Arranging goods with practiced efficiency",
            Professions.Innkeeper => "Polishing glasses behind the bar",
            Professions.Soldier => "Standing at attention",
            Professions.Noble => "Reviewing correspondence",
            Professions.Scholar => "Studying texts intently",
            _ => "Going about their business"
        };
    }
    
    private string GetEmotionalModifier(ConnectionState state, bool hasUrgentLetter)
    {
        return state switch
        {
            ConnectionState.DISCONNECTED => "visibly distressed",
            ConnectionState.GUARDED => "occasionally glancing around nervously",
            ConnectionState.NEUTRAL => "focused on the task at hand",
            ConnectionState.RECEPTIVE => "with a welcoming demeanor",
            ConnectionState.TRUSTING => "radiating warmth and connection",
            _ => "focused on the task at hand"
        };
    }
    
    private string GetContextualProp(Professions profession, bool hasUrgentLetter)
    {
        if (hasUrgentLetter) return "a sealed letter";
        
        return profession switch
        {
            Professions.Scribe => "quill and parchment",
            Professions.Merchant => "ledger and scales",
            Professions.Innkeeper => "a well-worn mug",
            Professions.Soldier => "weapon at the ready",
            _ => "their tools"
        };
    }
    
    private string GetDisconnectedDetail()
    {
        return "eyes darting to the door with each patron's entrance";
    }

    private string GetObservationHint()
    {
        if (CurrentSpot == null)
            return null;

        var activeProperties = new List<SpotPropertyType>(CurrentSpot.SpotProperties ?? new List<SpotPropertyType>());
        if (CurrentSpot.TimeSpecificProperties?.ContainsKey(CurrentTime) == true)
        {
            activeProperties.AddRange(CurrentSpot.TimeSpecificProperties[CurrentTime]);
        }

        // Generate hints based on view properties
        if (activeProperties.Contains(SpotPropertyType.ViewsMarket))
            return "Commerce flows visibly. Merchant patterns emerge.";
        
        if (activeProperties.Contains(SpotPropertyType.ViewsMainEntrance))
            return "Guard rotations and arrivals draw your attention.";
        
        if (activeProperties.Contains(SpotPropertyType.ViewsBackAlley))
            return "Discrete movements catch your eye.";
        
        if (activeProperties.Contains(SpotPropertyType.ViewsTemple))
            return "Devotional patterns become apparent.";

        if (activeProperties.Contains(SpotPropertyType.Crossroads))
            return "Multiple paths of activity intersect here.";

        return null;
    }
}

<div class="atmosphere-section">
    <div class="atmosphere-text">
        @GetAtmosphereText()
    </div>

    @if (NPCsPresent?.Any() == true)
    {
        <div class="npcs-present">
            @foreach (var npc in NPCsPresent)
            {
                <div class="npc-focus">
                    <div class="npc-name">@npc.Name</div>
                    <div class="npc-description">
                        @GetNPCFocusDescription(npc)
                    </div>
                </div>
            }
        </div>
    }

    @{
        var hint = GetObservationHint();
        if (!string.IsNullOrEmpty(hint))
        {
            <div class="observation-hint">
                <em>@hint</em>
            </div>
        }
    }
</div>