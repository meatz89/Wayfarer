@* Maps location atmosphere categories to descriptive text *@

@inject ObligationQueueManager LetterQueueManager

@code {
    [Parameter] public string LocationName { get; set; }
    [Parameter] public List<string> DomainTags { get; set; }
    [Parameter] public TimeBlocks CurrentTime { get; set; }
    [Parameter] public List<NPC> NPCsPresent { get; set; }

    private string GetAtmosphereText()
    {
        // Generate atmosphere based on location and context
        if (LocationName?.Contains("Market") == true)
        {
            return CurrentTime switch
            {
                TimeBlocks.Morning => "Merchant calls echo across cobblestones. The fountain's spray catches morning light. Early shoppers browse the stalls.",
                TimeBlocks.Afternoon => "The market bustles at its peak. Crowds flow between stalls like water finding its course. The air fills with haggling voices.",
                TimeBlocks.Evening => "Vendors pack their wares as shadows lengthen. The square empties slowly, leaving only the dedicated traders.",
                TimeBlocks.Night => "The market lies quiet under moonlight. Only the fountain's gentle splash breaks the silence.",
                _ => "The market square stretches before you."
            };
        }

        if (LocationName?.Contains("Tavern") == true)
        {
            // Generate based on NPCs present, not specific names
            if (NPCsPresent?.Any() == true)
            {
                return "Firelight dances on worn wooden beams. The clink of pottery mingles with hushed conversations.";
            }
            return "Warm hearth-light fills the common room. Low voices share the day's gossip over ale and bread.";
        }

        if (LocationName?.Contains("Noble") == true)
        {
            return CurrentTime switch
            {
                TimeBlocks.Morning => "Manicured gardens glisten with dew. Servants hurry about their morning duties.",
                TimeBlocks.Afternoon => "The district radiates quiet wealth. Guards stand at attention, their armor gleaming.",
                TimeBlocks.Evening => "Lamp-lighters begin their rounds. Noble carriages rattle over cobblestones.",
                _ => "The noble district maintains its austere grandeur."
            };
        }

        // Default atmospheric text based on tags
        if (DomainTags?.Contains("CROWDED") == true)
        {
            return "People press in from all sides. The air buzzes with countless conversations.";
        }

        if (DomainTags?.Contains("QUIET") == true)
        {
            return "A peaceful quiet settles over the area. You can hear your own footsteps clearly.";
        }

        return "The location has its own distinct character.";
    }

    private string GetNPCPresenceDescription(NPC npc)
    {
        // Generate description from categorical properties
        var emotionalState = DetermineEmotionalState(npc);
        var hasUrgentLetter = HasUrgentLetter(npc);
        
        var baseActivity = GetProfessionActivity(npc.Profession);
        var emotionalModifier = GetEmotionalModifier(emotionalState, hasUrgentLetter);
        var contextualProp = GetContextualProp(npc.Profession, hasUrgentLetter);
        
        // Combine categorical elements into description
        if (emotionalState == EmotionalState.DESPERATE && hasUrgentLetter)
        {
            return $"{emotionalModifier} {contextualProp}, {GetDesperateDetail()}";
        }
        
        return $"{baseActivity}, {emotionalModifier}";
    }
    
    private EmotionalState DetermineEmotionalState(NPC npc)
    {
        // Determine state from letter deadlines
        var obligations = LetterQueueManager?.GetActiveObligations() ?? new DeliveryObligation[0];
        var npcLetters = obligations.Where(o => o.SenderId == npc.ID || o.SenderName == npc.Name);
        var mostUrgent = npcLetters.OrderBy(o => o.DeadlineInMinutes).FirstOrDefault();
        
        if (mostUrgent == null) return EmotionalState.NEUTRAL;
        
        // Apply conversation-system.md rules
        if (mostUrgent.Stakes == StakeType.SAFETY && mostUrgent.DeadlineInMinutes < 360)
            return EmotionalState.DESPERATE;
        if (mostUrgent.DeadlineInMinutes < 720)
            return EmotionalState.TENSE;
            
        return EmotionalState.NEUTRAL;
    }
    
    private bool HasUrgentLetter(NPC npc)
    {
        var obligations = LetterQueueManager?.GetActiveObligations() ?? new DeliveryObligation[0];
        return obligations.Any(o => 
            (o.SenderId == npc.ID || o.SenderName == npc.Name) && 
            o.DeadlineInMinutes < 360);
    }
    
    private string GetProfessionActivity(Professions profession)
    {
        return profession switch
        {
            Professions.Scribe => "Hunched over documents",
            Professions.Merchant => "Arranging goods with practiced efficiency",
            Professions.Innkeeper => "Polishing glasses behind the bar",
            Professions.Soldier => "Standing at attention",
            Professions.Noble => "Reviewing correspondence",
            Professions.Scholar => "Studying texts intently",
            _ => "Going about their business"
        };
    }
    
    private string GetEmotionalModifier(EmotionalState state, bool hasUrgentLetter)
    {
        return state switch
        {
            EmotionalState.DESPERATE when hasUrgentLetter => "clutching a sealed letter with white knuckles",
            EmotionalState.DESPERATE => "visibly distressed",
            EmotionalState.TENSE => "occasionally glancing around nervously",
            EmotionalState.HOSTILE => "glaring at anyone who approaches",
            EmotionalState.OPEN => "with a welcoming demeanor",
            EmotionalState.GUARDED => "keeping a watchful eye on surroundings",
            _ => "focused on the task at hand"
        };
    }
    
    private string GetContextualProp(Professions profession, bool hasUrgentLetter)
    {
        if (hasUrgentLetter) return "a sealed letter";
        
        return profession switch
        {
            Professions.Scribe => "quill and parchment",
            Professions.Merchant => "ledger and scales",
            Professions.Innkeeper => "a well-worn mug",
            Professions.Soldier => "weapon at the ready",
            _ => "their tools"
        };
    }
    
    private string GetDesperateDetail()
    {
        return "eyes darting to the door with each patron's entrance";
    }

    private string GetObservationHint()
    {
        // Hint at available observations
        if (LocationName?.Contains("Market") == true)
        {
            return "You notice guard movements, merchant negotiations, and cart schedules.";
        }

        if (LocationName?.Contains("Tavern") == true)
        {
            return "The notice board catches your eye. Someone's distress is palpable.";
        }

        return null;
    }
}

<div class="atmosphere-section">
    <div class="atmosphere-text">
        @GetAtmosphereText()
    </div>

    @if (NPCsPresent?.Any() == true)
    {
        <div class="npcs-present">
            @foreach (var npc in NPCsPresent)
            {
                <div class="npc-presence">
                    <div class="npc-name">@npc.Name</div>
                    <div class="npc-description">
                        @GetNPCPresenceDescription(npc)
                    </div>
                </div>
            }
        </div>
    }

    @{
        var hint = GetObservationHint();
        if (!string.IsNullOrEmpty(hint))
        {
            <div class="observation-hint">
                <em>@hint</em>
            </div>
        }
    }
</div>