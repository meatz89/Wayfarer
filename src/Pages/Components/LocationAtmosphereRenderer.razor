@* Maps Venue atmosphere categories to descriptive text *@

@code {
    [Parameter] public Location CurrentLocation { get; set; }
    [Parameter] public TimeBlocks CurrentTime { get; set; }
    [Parameter] public List<NPC> NPCsPresent { get; set; }

    private LocationDescriptionGenerator _descriptionGenerator = new LocationDescriptionGenerator();

    private string GetAtmosphereText()
    {
        if (CurrentLocation == null)
            return "An undefined location.";

        // Get active properties including time-specific ones
        var activeProperties = new List<LocationPropertyType>(CurrentLocation.LocationProperties ?? new List<LocationPropertyType>());
        if (CurrentLocation.TimeSpecificProperties?.Any(t => t.TimeBlock == CurrentTime) == true)
        {
            activeProperties.AddRange(CurrentLocation.TimeSpecificProperties.First(t => t.TimeBlock == CurrentTime).Properties);
        }

        // Generate description from categorical properties
        return _descriptionGenerator.GenerateDescription(
            activeProperties,
            CurrentTime,
            NPCsPresent?.Count ?? 0
        );
    }

    private string GetNPCFocusDescription(NPC npc)
    {
        // Generate description from categorical properties
        var connectionState = DetermineConnectionState(npc);
        
        var baseActivity = GetProfessionActivity(npc.Profession);
        
        return $"{baseActivity}";
    }
    
    private ConnectionState DetermineConnectionState(NPC npc)
    {
        // In the 5-state system, NPCs always start NEUTRAL at locations
        // Their state changes during conversations based on mechanics
        return ConnectionState.NEUTRAL;
    }
    
    private string GetProfessionActivity(Professions profession)
    {
        return profession switch
        {
            Professions.Scribe => "Hunched over documents",
            Professions.Merchant => "Arranging goods with practiced efficiency",
            Professions.Innkeeper => "Polishing glasses behind the bar",
            Professions.Soldier => "Standing at attention",
            Professions.Noble => "Reviewing correspondence",
            Professions.Scholar => "Studying texts intently",
            _ => "Going about their business"
        };
    }
    
    private string GetEmotionalModifier(ConnectionState state, bool hasUrgentLetter)
    {
        return state switch
        {
            ConnectionState.DISCONNECTED => "visibly distressed",
            ConnectionState.GUARDED => "occasionally glancing around nervously",
            ConnectionState.NEUTRAL => "focused on the task at hand",
            ConnectionState.RECEPTIVE => "with a welcoming demeanor",
            ConnectionState.TRUSTING => "radiating warmth and connection",
            _ => "focused on the task at hand"
        };
    }
    
    private string GetContextualProp(Professions profession, bool hasUrgentLetter)
    {
        if (hasUrgentLetter) return "a sealed letter";
        
        return profession switch
        {
            Professions.Scribe => "quill and parchment",
            Professions.Merchant => "ledger and scales",
            Professions.Innkeeper => "a well-worn mug",
            Professions.Soldier => "weapon at the ready",
            _ => "their tools"
        };
    }
    
    private string GetDisconnectedDetail()
    {
        return "eyes darting to the door with each patron's entrance";
    }

    private string? GetObservationHint()
    {
        if (CurrentLocation == null)
            return null;

        var activeProperties = new List<LocationPropertyType>(CurrentLocation.LocationProperties ?? new List<LocationPropertyType>());
        if (CurrentLocation.TimeSpecificProperties?.Any(t => t.TimeBlock == CurrentTime) == true)
        {
            activeProperties.AddRange(CurrentLocation.TimeSpecificProperties.First(t => t.TimeBlock == CurrentTime).Properties);
        }

        // Generate hints based on view properties
        if (activeProperties.Contains(LocationPropertyType.ViewsMarket))
            return "Diplomacy flows visibly. Merchant patterns emerge.";

        if (activeProperties.Contains(LocationPropertyType.ViewsMainEntrance))
            return "Guard rotations and arrivals draw your attention.";

        if (activeProperties.Contains(LocationPropertyType.ViewsBackAlley))
            return "Discrete movements catch your eye.";

        if (activeProperties.Contains(LocationPropertyType.ViewsTemple))
            return "Devotional patterns become apparent.";

        if (activeProperties.Contains(LocationPropertyType.Crossroads))
            return "Multiple paths of activity intersect here.";

        return null;
    }
}

<div class="atmosphere-section">
    <div class="atmosphere-text">
        @GetAtmosphereText()
    </div>

    @{
        var hint = GetObservationHint();
        if (!string.IsNullOrEmpty(hint))
        {
            <div class="observation-hint">
                <em>@hint</em>
            </div>
        }
    }
</div>