@using Wayfarer.ViewModels
@inject StandingObligationManager ObligationManager

@if (ActiveObligationCount > 0)
{
    <div class="obligation-indicator" @onclick="ToggleExpanded">
        <span class="obligation-icon">⚖</span>
        <span class="obligation-count">@ActiveObligationCount</span>
        @if (HasCriticalObligations)
        {
            <span class="critical-marker">!</span>
        }
    </div>
    
    @if (IsExpanded)
    {
        <div class="obligation-tooltip">
            @foreach (var obligation in ActiveObligations.Take(3))
            {
                <div class="compact-obligation">
                    <span class="compact-name">@obligation.Name</span>
                    @if (obligation.ConstraintEffects.Any())
                    {
                        <span class="compact-warning">⚠</span>
                    }
                </div>
            }
            @if (ActiveObligationCount > 3)
            {
                <div class="more-obligations">
                    +@(ActiveObligationCount - 3) more...
                </div>
            }
        </div>
    }
}

@code {
    private List<StandingObligation> ActiveObligations = new List<StandingObligation>();
    private int ActiveObligationCount => ActiveObligations.Count;
    private bool HasCriticalObligations => ActiveObligations.Any(o => o.Tier >= 4);
    private bool IsExpanded = false;
    
    protected override void OnInitialized()
    {
        LoadObligations();
    }
    
    private void LoadObligations()
    {
        ActiveObligations = ObligationManager.GetActiveObligations();
        StateHasChanged();
    }
    
    private void ToggleExpanded()
    {
        IsExpanded = !IsExpanded;
    }
}