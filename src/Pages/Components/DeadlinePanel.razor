@using Wayfarer.Pages.Components
@inherits ComponentBase
@implements IDisposable

@inject ObligationQueueManager QueueManager
@inject TimeManager TimeManager
@inject NPCRepository NPCRepository
@inject GameFacade GameFacade

@if (HasActiveObligations())
{
    <div class="obligations-panel" @onclick="OpenObligationQueue" @onclick:preventDefault="true" @onclick:stopPropagation="true" style="cursor: pointer;">
        <div class="obligations-header">Active Obligations</div>
        <div class="obligation-list">
            @foreach (var item in GetTopObligations())
            {
                <div class="obligation-item @GetObligationClass(item)">
                    <div class="obligation-action">@GetObligationAction(item)</div>
                    <div class="obligation-target">@GetObligationTargetOnly(item)</div>
                    <div class="obligation-time">@GetObligationTime(item)</div>
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter] public EventCallback OnOpenQueue { get; set; }
    
    // Represents any obligation with a deadline
    private class ObligationItem
    {
        public string Type { get; set; } // "delivery" or "meeting"
        public string TargetName { get; set; }
        public string TargetId { get; set; }
        public int DeadlineInMinutes { get; set; }
        public StakeType? Stakes { get; set; }
    }

    private System.Threading.Timer? _refreshTimer;

    protected override void OnInitialized()
    {
        // Refresh every 30 seconds to update time remaining
        _refreshTimer = new System.Threading.Timer(_ => InvokeAsync(() =>
        {
            StateHasChanged();
        }), null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    private bool HasActiveObligations()
    {
        var deliveries = QueueManager.GetPlayerQueue();
        var meetings = QueueManager.GetActiveMeetingObligations();
        return (deliveries?.Any(d => d?.DeadlineInMinutes > 0) == true) ||
               (meetings?.Any(m => m?.DeadlineInMinutes > 0) == true);
    }

    private List<ObligationItem> GetTopObligations()
    {
        var obligations = new List<ObligationItem>();
        
        // Add delivery obligations
        var deliveries = QueueManager.GetPlayerQueue();
        if (deliveries != null)
        {
            obligations.AddRange(deliveries
                .Where(d => d?.DeadlineInMinutes > 0)
                .Select(d => new ObligationItem
                {
                    Type = "delivery",
                    TargetName = d.RecipientName,
                    TargetId = d.RecipientId,
                    DeadlineInMinutes = d.DeadlineInMinutes,
                    Stakes = d.Stakes
                }));
        }
        
        // Add meeting obligations
        var meetings = QueueManager.GetActiveMeetingObligations();
        if (meetings != null)
        {
            obligations.AddRange(meetings
                .Where(m => m?.DeadlineInMinutes > 0)
                .Select(m => new ObligationItem
                {
                    Type = "meeting",
                    TargetName = m.RequesterName,
                    TargetId = m.RequesterId,
                    DeadlineInMinutes = m.DeadlineInMinutes,
                    Stakes = m.Stakes
                }));
        }
        
        // Sort by deadline and take top 3
        return obligations
            .OrderBy(o => o.DeadlineInMinutes)
            .Take(3)
            .ToList();
    }

    private string GetObligationClass(ObligationItem item)
    {
        if (item.DeadlineInMinutes <= 120) return "critical"; // 2 hours
        if (item.DeadlineInMinutes <= 480) return "urgent"; // 8 hours
        return "normal";
    }

    private string GetObligationAction(ObligationItem item)
    {
        return item.Type == "delivery" ? "Deliver" : "Meet";
    }
    
    private string GetObligationTargetOnly(ObligationItem item)
    {
        if (item.Type == "delivery")
        {
            // For delivery, show the location
            var npc = NPCRepository.GetByName(item.TargetName);
            if (npc != null)
            {
                var location = GameFacade.GetLocationById(npc.Location);
                if (location != null)
                {
                    return location.Name;
                }
            }
            return item.TargetName; // Fallback to NPC name
        }
        else // meeting
        {
            // For meeting, show the NPC name and location
            var npc = NPCRepository.GetByName(item.TargetName);
            if (npc != null)
            {
                var location = GameFacade.GetLocationById(npc.Location);
                if (location != null)
                {
                    return $"{item.TargetName} â€¢ {location.Name}";
                }
            }
            return item.TargetName;
        }
    }

    private string GetObligationLocation(ObligationItem item)
    {
        // Look up the actual NPC to find their location
        var npc = NPCRepository.GetByName(item.TargetName);
        if (npc != null)
        {
            var location = GameFacade.GetLocationById(npc.Location);
            if (location != null)
            {
                return location.Name;
            }
        }
        
        // If NPC not found, return empty string (no hardcoded fallback)
        return "";
    }

    private string GetObligationTime(ObligationItem item)
    {
        int minutes = item.DeadlineInMinutes;
        
        if (minutes <= 0) return "EXPIRED";
        if (minutes < 60) return $"{minutes}m";
        if (minutes < 120) return $"1h {minutes - 60}m";
        if (minutes < 1440) return $"{minutes / 60}h";
        
        int days = minutes / 1440;
        return days == 1 ? "Tomorrow" : $"{days} days";
    }

    private async Task OpenObligationQueue()
    {
        Console.WriteLine("[DeadlinePanel] OpenObligationQueue called");
        
        // If we have a callback from parent, use it
        if (OnOpenQueue.HasDelegate)
        {
            Console.WriteLine("[DeadlinePanel] Using parent callback");
            await OnOpenQueue.InvokeAsync();
        }
        else
        {
            // No parent callback available
            Console.WriteLine("[DeadlinePanel] No navigation handler available");
        }
    }
    
    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }
}