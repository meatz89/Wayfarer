@using Wayfarer.Pages.Components

@inherits MainGameplayViewBase

@{
    Console.WriteLine($"[MainGameplayView.razor] Rendering with CurrentScreen: {CurrentScreen}");
    Console.WriteLine($"[MainGameplayView.razor] CurrentView parameter: {CurrentView}");
}

@if (!IsTutorialActive())
{
    <SystemMessageDisplay Messages="@SystemMessages" OnMessagesExpired="HandleMessagesExpired" />
    <ObjectiveView StateVersion="@StateVersion" />
}

<NarrativeOverlay IsMinimizable="true" />

@if (!IsTutorialActive())
{
    <NavigationBar CurrentView="@CurrentView" OnNavigate="@OnNavigate" />
}

<div class="game-status-bar">
    <div class="player-status">
        <div class="status-item">
            <span class="status-label">Stamina</span>
            <span class="status-value">@Stamina</span>
            <span class="danger">@(TurnActionPoints * -1)</span>
        </div>

        <div class="status-item">
            <span class="status-label">Concentration</span>
            <span class="status-value">@Concentration</span>
            <span class="danger">@(TurnActionPoints * -1)</span>
        </div>
    </div>

    <div class="game-info">
        <div class="time-display @StyleHelper.GetTimeBlocksStyle(CurrentTime)">
            <span class="time-icon">@StyleHelper.GetIconForCurrentTimeBlock(CurrentTime)</span>
            <span class="time-hours">@CurrentHour:00</span>
        </div>
        <div class="weather-display">
            <span class="weather-icon">@GetWeatherIcon(CurrentWeather)</span>
            <span class="weather-text">@CurrentWeather.ToString()</span>
        </div>
    </div>
</div>

<div class="game-content @(IsTutorialActive() ? "tutorial-mode" : "")">
    <div class="main-content">
        @switch (CurrentScreen)
        {
            case CurrentViews.LetterQueueScreen:
                <LetterQueueScreen />
                break;

            case CurrentViews.ConversationScreen:
                <ConversationView NPCId="@CurrentConversation?.NpcId"
                               OnConversationCompleted="@(() => OnConversationCompleted())"
                               @key="StateVersion" />
                break;

            case CurrentViews.NarrativeScreen:
                @* NarrativeView - STUB *@
                <div>Narrative screen placeholder</div>
                break;

            case CurrentViews.MapScreen:
                <div class="location-container">
                    <div class="location-header">
                        <h2 class="location-title">@GetCurrentLocation().Id</h2>
                    </div>
                </div>
                <div class="map-container">
                    @if (IsGameDataReady())
                    {
                        <AreaMap CurrentLocation="@GetCurrentLocation()"
                                 Locations="@Locations"
                                 OnShowTravelScreen="@SwitchToTravelScreen" />
                    }
                    else
                    {
                        <div class="loading-message">Loading map data...</div>
                    }
                </div>
                break;

            case CurrentViews.LocationScreen:
                <LocationScreen OnActionExecuted="RefreshUI" OnNavigate="HandleNavigation" />
                break;

            case CurrentViews.TravelScreen:
                <div class="location-container">
                    <div class="location-header">
                        <h2 class="location-title">Travel from @GetCurrentLocation()?.Name</h2>
                    </div>
                </div>
                <div class="travel-container">
                    <TravelSelection 
                        CurrentLocation="@GetCurrentLocation()"
                        Locations="@Locations"
                        OnTravelRoute="@HandleTravelRoute" />
                </div>
                break;

            case CurrentViews.MarketScreen:
                <div class="location-container">
                    <div class="location-header">
                        <h2 class="location-title">@GetCurrentLocation()?.Name Market</h2>
                    </div>
                </div>
                <div class="market-container">
                    @if (IsGameDataReady())
                    {
                        <Market />
                    }
                    else
                    {
                        <div class="loading-message">Loading market data...</div>
                    }
                </div>
                break;

            case CurrentViews.RestScreen:
                <div class="location-container">
                    <div class="location-header">
                        <h2 class="location-title">Rest in @GetCurrentLocation()?.Name</h2>
                    </div>
                </div>
                <div class="rest-container">
                    @if (IsGameDataReady())
                    {
                        <RestUI 
                            Location="@GetCurrentLocation()"
                            OnRestComplete="HandleRestComplete" />
                    }
                    else
                    {
                        <div class="loading-message">Loading rest options...</div>
                    }
                </div>
                break;
                    
            case CurrentViews.PlayerStatusScreen:
                <div class="location-container">
                    <div class="location-header">
                        <h2 class="location-title">Character Status</h2>
                    </div>
                    <PlayerStatusView OnClose="() => OnNavigate?.Invoke(CurrentViews.LocationScreen)" />
                </div>
                break;
                    
            case CurrentViews.InformationDiscoveryScreen:
                <InformationDiscoveryScreen />
                break;
                    
            case CurrentViews.EventLogScreen:
                <EventLogScreen />
                break;
                    
            case CurrentViews.RelationshipScreen:
                <div class="location-container">
                    <div class="location-header">
                        <h2 class="location-title">Character Relationships</h2>
                    </div>
                </div>
                @if (IsGameDataReady())
                {
                    <CharacterRelationshipScreen />
                }
                else
                {
                    <div class="loading-message">Loading relationship data...</div>
                }
                break;
                    
            case CurrentViews.ObligationsScreen:
                <div class="location-container">
                    <div class="location-header">
                        <h2 class="location-title">Standing Obligations</h2>
                    </div>
                </div>
                @if (IsGameDataReady())
                {
                    <StandingObligationsScreen />
                }
                else
                {
                    <div class="loading-message">Loading obligations data...</div>
                }
                break;
                    
            case CurrentViews.LetterBoardScreen:
                <div class="location-container">
                    <div class="location-header">
                        <h2 class="location-title">Morning Letter Board</h2>
                    </div>
                </div>
                @if (IsGameDataReady())
                {
                    <LetterBoardScreen />
                }
                else
                {
                    <div class="loading-message">Loading letter board...</div>
                }
                break;
                
            case CurrentViews.SealProgressionScreen:
                <div class="location-container">
                    <div class="location-header">
                        <h2 class="location-title">Seal Progression</h2>
                    </div>
                </div>
                @if (IsGameDataReady())
                {
                    <SealProgressionScreen OnActionExecuted="RefreshUI" />
                }
                else
                {
                    <div class="loading-message">Loading seal information...</div>
                }
                break;
        }
    </div>

    @if (CurrentScreen == CurrentViews.LocationScreen && !IsTutorialActive())
    {
        <SidebarPanel />
    }
</div>

@* Morning Summary Dialog *@
@if (ShowMorningSummary && MorningActivityResult != null)
{
    <MorningSummaryDialog 
        ShowDialog="@ShowMorningSummary"
        MorningResult="@MorningActivityResult"
        CurrentDay="@GameWorld.CurrentDay"
        OnContinue="@HandleMorningSummaryContinue"
        HasLetterBoard="true" />
}

@* Debug Panel Toggle *@
@if (!IsTutorialActive())
{
    <button class="debug-toggle" @onclick="ToggleDebugPanel" title="Toggle Debug Panel">
        ðŸ”§
    </button>
}

@* Debug Panel *@
@if (ShowDebugPanel)
{
    <div class="debug-panel">
        <div class="debug-header">
            <h3>Debug Information</h3>
            <button class="debug-close" @onclick="ToggleDebugPanel">Ã—</button>
        </div>
        <div class="debug-content">
            <div class="debug-section">
                <h4>Current State</h4>
                <p>Screen: @CurrentScreen</p>
                <p>Location: @(LocationRepository?.GetLocation(PlayerState?.CurrentLocationSpot?.LocationId)?.Name) (@PlayerState?.CurrentLocationSpot?.LocationId)</p>
                <p>Spot: @PlayerState?.CurrentLocationSpot?.Name (@PlayerState?.CurrentLocationSpot?.SpotID)</p>
                <p>Time: @CurrentTime (@CurrentHour:00)</p>
                <p>Day: @GameWorld.CurrentDay</p>
            </div>
            
            <div class="debug-section">
                <h4>Conversation State</h4>
                <p>Pending: @ConversationStateManager.ConversationPending</p>
                <p>Manager Exists: @(ConversationStateManager.PendingConversationManager != null)</p>
                @* PendingCommand removed - using intent-based system *@
            </div>
            
            <div class="debug-section">
                <h4>NPCs at Current Spot</h4>
                @{
                    var npcsAtSpot = GetNPCsAtCurrentSpot();
                    var availableNpcs = GetAvailableNPCsAtCurrentSpot();
                }
                <p>Total NPCs: @npcsAtSpot.Count</p>
                <p>Available: @availableNpcs.Count</p>
                @foreach (var npc in npcsAtSpot)
                {
                    <p class="debug-npc">
                        @npc.Name (@npc.ID) - 
                        @(npc.IsAvailable(CurrentTime) ? "ðŸŸ¢" : "ðŸ”´")
                    </p>
                }
            </div>
            
            <div class="debug-actions">
                <button class="debug-button" @onclick="PrintDebugState">Print Full State</button>
                <button class="debug-button" @onclick="RunVerification">Run Verification</button>
                <button class="debug-button" @onclick="StartTutorialManually">Start Tutorial</button>
            </div>
        </div>
    </div>
}