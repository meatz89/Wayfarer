@* MarketUI.razor *@
@inject GameWorld GameWorld
@inject GameWorldManager GameManager
@* MarketManager removed - all actions through GameWorldManager *@
@* ItemRepository allowed for read-only UI data binding *@
@inject ItemRepository ItemRepository

<div class="market-container">
    <h2>@Location.Name Market</h2>
    
    <div class="market-status">
        @{
            string marketStatus = GameManager.GetMarketAvailabilityStatus(Location.Id);
            var currentTraders = GameManager.GetTradingNPCs(Location.Id).Where(npc => npc.IsAvailable(GameWorld.TimeManager.GetCurrentTimeBlock())).ToList();
        }
        <span class="@(marketStatus.Contains("Open") ? "market-open" : "market-closed")">
            @marketStatus
        </span>
        
        @if (currentTraders.Any())
        {
            <span class="trader-count">(@currentTraders.Count trader@(currentTraders.Count != 1 ? "s" : "") available)</span>
        }
    </div>

    @* Compact player status *@
    <div class="player-status-compact">
        @{
            var inventory = GameWorld.GetPlayer().Inventory;
            int freeSlots = inventory.Size - inventory.UsedCapacity;
        }
        💰 @GameWorld.GetPlayer().Coins | 
        🎒 @inventory.UsedCapacity/@inventory.Size | 
        @if (freeSlots == 0)
        {
            <span class="warning">Inventory Full!</span>
        }
    </div>

    @* Basic category filter for items *@
    @{
        var categoryFilter = GetSelectedCategoryFilter();
    }
    
    <div class="category-filter-section">
        <h4>Filter Items</h4>
        <div class="category-filters">
            <button class="category-filter @(categoryFilter == "All" ? "active" : "")" 
                    @onclick='() => SetCategoryFilter("All")'>All Items</button>
            @foreach (var category in GetAvailableEquipmentCategories())
            {
                <button class="category-filter @(categoryFilter == category.ToString() ? "active" : "")"
                        @onclick='() => SetCategoryFilter(category.ToString())'>
                    @category.ToString().Replace('_', ' ')
                </button>
            }
        </div>
    </div>

    <div class="market-table">
        <div class="table-header">
            <div class="item-name">Item</div>
            <div class="item-buy">Buy</div>
            <div class="item-sell">Sell</div>
            <div class="item-actions">Action</div>
        </div>

        @foreach (Item item in GetFilteredMarketItems())
        {
            if (item == null) continue;
            
            Player playerState = GameWorld.GetPlayer();
            bool canBuy = GameManager.CanBuyMarketItem(item.Id ?? item.Name, Location.Id);
            bool canSell = playerState.Inventory.HasItem(item.Name);

            <div class="market-item">
                <div class="item-name">@item.Name</div>
                <div class="item-buy">@item.BuyPrice</div>
                <div class="item-sell">@item.SellPrice</div>
                <div class="item-actions">
                    @if (canBuy)
                    {
                        <button class="buy-button" @onclick="() => BuyItem(item)">Buy</button>
                    }
                    else if (canSell)
                    {
                        <button class="sell-button" @onclick="() => SellItem(item)">Sell</button>
                    }
                    else
                    {
                        <span class="no-action">-</span>
                    }
                </div>
            </div>
        }
    </div>

</div>

@code {

@namespace Wayfarer.Pages
    [Parameter] public Location Location { get; set; }
    
    private string _selectedCategoryFilter = "All";

    private void BuyItem(Item item)
    {
        GameManager.ExecuteTradeAction(item.Id ?? item.Name, "buy", Location.Id);
        StateHasChanged();
    }

    private void SellItem(Item item)
    {
        GameManager.ExecuteTradeAction(item.Id ?? item.Name, "sell", Location.Id);
        StateHasChanged();
    }


    /// <summary>
    /// Get available equipment categories in the current market
    /// </summary>
    public List<ItemCategory> GetAvailableEquipmentCategories()
    {
        var allItems = GameManager.GetAvailableMarketItems(Location.Id);
        return allItems.SelectMany(i => i.Categories).Distinct().ToList();
    }

    /// <summary>
    /// Get currently selected category filter
    /// </summary>
    public string GetSelectedCategoryFilter()
    {
        return _selectedCategoryFilter;
    }

    /// <summary>
    /// Set category filter for market items
    /// </summary>
    public void SetCategoryFilter(string category)
    {
        _selectedCategoryFilter = category;
        StateHasChanged();
    }

    /// <summary>
    /// Get market items filtered by selected category
    /// </summary>
    public List<Item> GetFilteredMarketItems()
    {
        var allItems = GameManager.GetAvailableMarketItems(Location.Id);
        
        if (_selectedCategoryFilter == "All")
            return allItems;
            
        if (Enum.TryParse<ItemCategory>(_selectedCategoryFilter, out var category))
        {
            return allItems.Where(i => i.Categories.Contains(category)).ToList();
        }
        
        return allItems;
    }

    /// <summary>
    /// Get CSS class for weight status
    /// </summary>
    public string GetWeightClass(int totalWeight)
    {
        if (totalWeight <= 3) return "weight-light";
        if (totalWeight <= 6) return "weight-medium";
        return "weight-heavy";
    }
}