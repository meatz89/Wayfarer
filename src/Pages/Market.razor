@* MarketUI.razor - Pure presentation layer, no game logic *@
@inject MarketUIService MarketUIService

<div class="market-container">
    <h2>@_viewModel.LocationName Market</h2>
    
    <div class="market-status">
        <span class="@(_viewModel.IsOpen ? "market-open" : "market-closed")">
            @_viewModel.MarketStatus
        </span>
        
        @if (_viewModel.TraderCount > 0)
        {
            <span class="trader-count">(@_viewModel.TraderCount trader@(_viewModel.TraderCount != 1 ? "s" : "") available)</span>
        }
    </div>

    @* Compact player status *@
    <div class="player-status-compact">
        💰 @_viewModel.PlayerCoins | 
        🎒 @_viewModel.InventoryUsed/@_viewModel.InventoryCapacity | 
        @if (_viewModel.IsInventoryFull)
        {
            <span class="warning">Inventory Full!</span>
        }
    </div>

    @* Basic category filter for items *@
    <div class="category-filter-section">
        <h4>Filter Items</h4>
        <div class="category-filters">
            @foreach (var category in _viewModel.AvailableCategories)
            {
                <button class="category-filter @(_viewModel.SelectedCategory == category ? "active" : "")"
                        @onclick='() => SetCategoryFilter(category)'>
                    @category.Replace('_', ' ')
                </button>
            }
        </div>
    </div>

    <div class="market-table">
        <div class="table-header">
            <div class="item-name">Item</div>
            <div class="item-buy">Buy</div>
            <div class="item-sell">Sell</div>
            <div class="item-actions">Action</div>
        </div>

        @foreach (var item in GetFilteredItems())
        {
            <div class="market-item">
                <div class="item-info">
                    <div class="item-name">@item.Name</div>
                    <div class="item-description">@item.Item.Description</div>
                    @if (item.Item.HasTokenEffects())
                    {
                        <div class="item-token-effects">
                            <span class="token-icon">🎯</span> @item.Item.GetTokenEffectsDescription()
                        </div>
                    }
                </div>
                <div class="item-buy">@item.BuyPrice</div>
                <div class="item-sell">@item.SellPrice</div>
                <div class="item-actions">
                    @if (item.CanBuy)
                    {
                        <button class="buy-button" @onclick="() => BuyItem(item)">Buy</button>
                    }
                    else if (item.CanSell)
                    {
                        <button class="sell-button" @onclick="() => SellItem(item)">Sell</button>
                    }
                    else
                    {
                        <span class="no-action">-</span>
                    }
                </div>
            </div>
        }
    </div>

</div>

@code {

@namespace Wayfarer.Pages
    [Parameter] public string LocationId { get; set; }
    
    private MarketViewModel _viewModel;

    protected override void OnInitialized()
    {
        RefreshViewModel();
    }
    
    protected override void OnParametersSet()
    {
        RefreshViewModel();
    }

    private void RefreshViewModel()
    {
        _viewModel = MarketUIService.GetMarketViewModel(LocationId);
    }

    private async Task BuyItem(MarketItemViewModel item)
    {
        await MarketUIService.ExecuteTradeAsync(item.ItemId, "buy", LocationId);
        RefreshViewModel();
        StateHasChanged();
    }

    private async Task SellItem(MarketItemViewModel item)
    {
        await MarketUIService.ExecuteTradeAsync(item.ItemId, "sell", LocationId);
        RefreshViewModel();
        StateHasChanged();
    }

    private void SetCategoryFilter(string category)
    {
        _viewModel.SelectedCategory = category;
        StateHasChanged();
    }

    private List<MarketItemViewModel> GetFilteredItems()
    {
        return MarketUIService.GetFilteredItems(_viewModel, _viewModel.SelectedCategory);
    }
}