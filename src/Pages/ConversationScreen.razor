@page "/conversation/{NpcId}"
@using Wayfarer.ViewModels
@using Wayfarer.Pages.Components
@using Wayfarer.Models
@using Wayfarer.GameState
@inherits ConversationScreenBase

<div class="container">
    @* Unified Attention Bar - Persistent across all screens *@
    <UnifiedAttentionBar />
    
    @* Bottom Status Bar - Shows queue status and allows navigation *@
    <BottomStatusBar OnNavigate="@OnNavigate" />
    
    @* Exit button for manual conversation exit *@
    <div class="conversation-exit-controls">
        <button class="exit-conversation-btn" @onclick="HandleExitConversation">
            ← Exit Conversation
        </button>
    </div>
    
    @if (Model != null)
    {

        <!-- Peripheral Awareness - SUBTLE HINTS -->
        <div class="peripheral-layer">
            @if (!string.IsNullOrEmpty(Model.DeadlinePressure))
            {
                <div class="deadline-pressure">
                    ⚡ @Model.DeadlinePressure
                </div>
            }
            
            @if (Model.EnvironmentalHints?.Any() == true)
            {
                @foreach (var hint in Model.EnvironmentalHints)
                {
                    <div class="environmental-hints">
                        @hint
                    </div>
                }
            }
        </div>

        <!-- Location Header - SETS ATMOSPHERE -->
        <div class="location-header">
            <div class="location-name">@(Model.LocationName ?? "The Copper Kettle - Corner Table")</div>
            <div class="location-atmosphere">@(Model.LocationAtmosphere ?? "Warm hearth-light, nervous energy in the air")</div>
        </div>

        <!-- Main Scene Content -->
        <div class="scene-content">
            <!-- Character Focus - TRANSPARENT EMOTIONAL STATE -->
            <div class="character-focus">
                @if (CurrentEmotionalState != null)
                {
                    <EmotionalStateDisplay 
                        NpcName="@Model.NpcName"
                        CurrentState="@CurrentEmotionalState.Value"
                        Stakes="@CurrentStakes"
                        StakesDescription="@GetStakesDescription()"
                        TimeRemaining="@GetTimeRemaining()"
                        ShowFormula="true"
                        ShowMechanicalEffects="true" />
                }
                else
                {
                    <div class="character-name">@Model.NpcName</div>
                    <div class="character-state">@(Model.CharacterState ?? "leaning forward, fingers worrying her shawl")</div>
                }
                
                @* Token Display - Shows contextually relevant relationship currency *@
                @if (NpcTokens != null)
                {
                    <TokenDisplay 
                        Tokens="@NpcTokens" 
                        NpcName="@Model.NpcName" 
                        ConversationContext="@GetCurrentConversationContext()"
                        NpcRole="@GetNpcRole()"
                        ShowOnlyRelevant="true"
                        UseNarrativeDescriptions="true" />
                }
                
                @if (Model.RelationshipStatus?.Any() == true)
                {
                    <div class="relationship-status">
                        @foreach (var status in Model.RelationshipStatus)
                        {
                            <span>@status.Value</span>
                        }
                    </div>
                }
            </div>

            <!-- Current Dialogue - NARRATIVE FOCUS -->
            <div class="dialogue-container">
                <div class="spoken-words">
                    @Model.CurrentText
                </div>
                
                @if (!string.IsNullOrEmpty(Model.CharacterAction))
                {
                    <div class="character-action">
                        @Model.CharacterAction
                    </div>
                }
            </div>

            <!-- Choice Options - Card-based conversation system -->
            <div class="choice-container">
                @if (Choices?.Any() == true)
                {
                    @foreach (var choice in Choices)
                    {
                        <div class="@GetChoiceClass(choice)" @onclick="() => HandleChoice(choice)">
                            <!-- Attention cost badge -->
                            @if (choice.AttentionCost > 0)
                            {
                                <div class="attention-cost">
                                    @GetCostDisplay(choice.AttentionCost)
                                </div>
                            }
                            else
                            {
                                <div class="attention-cost free">
                                    FREE
                                </div>
                            }
                            
                            <!-- Main choice text -->
                            <div class="choice-content">
                                <div class="choice-text">
                                    "@choice.NarrativeText"
                                </div>
                                
                                <!-- Mechanical previews -->
                                @if (!string.IsNullOrEmpty(choice.MechanicalDescription))
                                {
                                    <div class="choice-mechanics">
                                        @foreach (var part in ParseMechanicalDescription(choice.MechanicalDescription))
                                        {
                                            <div class="mechanic-item @GetMechanicClass(part)">
                                                <span class="mechanic-icon">
                                                    @GetEffectIcon(part)
                                                </span>
                                                <span class="mechanic-text">
                                                    @((MarkupString)part)
                                                </span>
                                            </div>
                                        }
                                    </div>
                                }
                                
                                <!-- Lock reason if unavailable -->
                                @if (!choice.IsAvailable && !string.IsNullOrEmpty(choice.MechanicalDescription))
                                {
                                    <div class="lock-reason">
                                        @choice.MechanicalDescription
                                    </div>
                                }
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="choice-option" @onclick="() => HandleChoice(DefaultChoice)">
                        <div class="attention-cost free">FREE</div>
                        <div class="choice-content">
                            <div class="choice-text">"@DefaultChoice.NarrativeText"</div>
                            <div class="choice-mechanics">
                                <div class="mechanic-item mechanic-neutral">
                                    <span class="mechanic-icon">→</span>
                                    <span class="mechanic-text">@DefaultChoice.MechanicalDescription</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="loading">Loading conversation...</div>
    }
</div>

