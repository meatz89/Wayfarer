@page "/conversation/{NpcId}"
@using Wayfarer.ViewModels
@using Wayfarer.Pages.Components
@using Wayfarer.GameState
@using Microsoft.AspNetCore.Components
@inherits ConversationScreenBase

<div class="container">
    
    @* System messages display for conversation feedback *@
    <MessageDisplay />
    
    @* Exit button for manual conversation exit *@
    <div class="conversation-exit-controls">
        <button class="exit-conversation-btn" @onclick="HandleExitConversation">
            ← Exit Conversation
        </button>
    </div>
    
    @if (Model != null)
    {

        <!-- Peripheral Awareness - COGNITIVE EDGES -->
        <div class="peripheral-layer">
            
            <!-- Environmental Hints - Peripheral Awareness -->
            @if (Model.EnvironmentalHints?.Any() == true)
            {
                @foreach (var hint in Model.EnvironmentalHints)
                {
                    <div class="environmental-hints clickable-peripheral" @onclick="() => InvestigateEnvironment(hint)" title="Spend attention to investigate">
                        @hint
                    </div>
                }
            }
            
            <!-- Queue Weight - Bottom Left -->
            <div class="satchel-weight" title="Letter queue burden">
                Heavy (Queue weight indicator)
            </div>
            
        </div>

        <!-- Location Header - SETS ATMOSPHERE -->
        <div class="location-header">
            <div class="location-name">@(Model.LocationName ?? "The Copper Kettle - Corner Table")</div>
            <div class="location-atmosphere">@(Model.LocationAtmosphere ?? "Warm hearth-light, nervous energy in the air")</div>
        </div>

        <!-- Main Scene Content -->
        <div class="scene-content">
            <!-- Character Name Only -->
            <div class="character-focus">
                <div class="character-name">@Model.NpcName</div>
            </div>
                
            @* NPC Patience and Comfort Display - Core conversation mechanics *@
            <div class="npc-conversation-state">
                <div class="patience-display">
                    <span class="patience-label">@Model.NpcName's Patience:</span>
                    <div class="patience-orbs">
                        @for (int i = 0; i < MaxPatience; i++)
                        {
                            <div class="patience-orb @(i < CurrentPatience ? "active" : "spent")" 
                                 aria-label="@GetPatienceOrbLabel(i)">
                            </div>
                        }
                    </div>
                </div>
                
                <div class="comfort-display">
                    <span class="comfort-label">Comfort: @GetComfortDescription()</span>
                </div>
            </div>
                
            @if (Model.RelationshipStatus?.Any() == true)
            {
                <div class="relationship-status">
                    @foreach (var status in Model.RelationshipStatus)
                    {
                        <span>@status.Value</span>
                    }
                </div>
            }

            <!-- Current Dialogue - NARRATIVE FOCUS -->
            <div class="dialogue-container">
                <div class="spoken-words">
                    @Model.CurrentText
                </div>
                
                @if (!string.IsNullOrEmpty(Model.CharacterAction))
                {
                    <div class="character-action">
                        @Model.CharacterAction
                    </div>
                }
            </div>

            <!-- SHARP FOCUS: Elena and Conversation Choices -->
            <div class="sharp-focus" id="main-focus">
                
                <!-- Token Relationship Display -->
                @if (!string.IsNullOrEmpty(GetTokenBondsDisplay()))
                {
                    <div class="relationship-bonds">
                        @GetTokenBondsDisplay()
                    </div>
                }
                
                <!-- Choice Cards - Beautiful Conversation Options -->
                <div class="conversation-responses">
                    @if (Choices?.Any() == true)
                    {
                        @foreach (var choice in Choices)
                        {
                            <div class="response-card @(choice.IsAvailable ? "" : "unplayable") @GetChoiceColorClass(choice)" @onclick="() => HandleChoice(choice)">
                                
                                <!-- Patience Cost Badge -->
                                <div class="patience-cost @(choice.PatienceCost == 0 ? "free" : "")">
                                    @if (choice.PatienceCost == 0)
                                    {
                                        <span>FREE</span>
                                    }
                                    else
                                    {
                                        <span>@choice.PatienceCost</span>
                                    }
                                </div>
                                
                                <!-- Choice Content -->
                                <div class="choice-content">
                                    <div class="response-thought">
                                        "@choice.NarrativeText"
                                    </div>
                                    <div class="success-probability">
                                        @GetSuccessProbabilityDisplay(choice)
                                    </div>
                                    
                                    <!-- Compact Outcome Tiers -->
                                    <div class="outcome-tiers">
                                        <div class="outcome-tier tier-success">
                                            ✓ @((MarkupString)GetOutcomePreview(choice, Wayfarer.Game.ConversationSystem.ConversationOutcome.Success))
                                        </div>
                                        <div class="outcome-tier tier-neutral">
                                            ⚬ @((MarkupString)GetOutcomePreview(choice, Wayfarer.Game.ConversationSystem.ConversationOutcome.Neutral))
                                        </div>
                                        <div class="outcome-tier tier-failure">
                                            ✗ @((MarkupString)GetOutcomePreview(choice, Wayfarer.Game.ConversationSystem.ConversationOutcome.Failure))
                                        </div>
                                    </div>
                                    
                                    @if (!choice.IsAvailable)
                                    {
                                        <div class="lock-reason">
                                            @choice.MechanicalDescription
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }
                else
                {
                    <div class="choice-option" @onclick="() => HandleChoice(DefaultChoice)">
                        <div class="patience-cost free">FREE</div>
                        <div class="choice-content">
                            <div class="choice-text">"@DefaultChoice.NarrativeText"</div>
                            <div class="choice-mechanics">
                                <div class="mechanic-item mechanic-neutral">
                                    <span class="icon icon-arrow"></span>
                                    <span class="mechanic-text">@DefaultChoice.MechanicalDescription</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
        </div> @* Close scene-content *@
    }
    else
    {
        <div class="loading">Loading conversation...</div>
    }
</div>

