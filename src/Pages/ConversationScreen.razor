@page "/conversation/{NpcId}"
@using Wayfarer.ViewModels
@using Wayfarer.Pages.Components
@inherits ConversationScreenBase

<div class="container">
    @* Unified Attention Bar - Persistent across all screens *@
    <UnifiedAttentionBar />
    
    @* Bottom Status Bar - Shows queue status and allows navigation *@
    <BottomStatusBar OnNavigate="@OnNavigate" />
    
    @* Exit button for manual conversation exit *@
    <div class="conversation-exit-controls">
        <button class="exit-conversation-btn" @onclick="HandleExitConversation">
            ← Exit Conversation
        </button>
    </div>
    
    @if (Model != null)
    {

        <!-- Peripheral Awareness - SUBTLE HINTS -->
        <div class="peripheral-layer">
            @if (!string.IsNullOrEmpty(Model.DeadlinePressure))
            {
                <div class="deadline-pressure">
                    ⚡ @Model.DeadlinePressure
                </div>
            }
            
            @if (Model.EnvironmentalHints?.Any() == true)
            {
                @foreach (var hint in Model.EnvironmentalHints)
                {
                    <div class="environmental-hints">
                        @hint
                    </div>
                }
            }
        </div>

        <!-- Location Header - SETS ATMOSPHERE -->
        <div class="location-header">
            <div class="location-name">@(Model.LocationName ?? "The Copper Kettle - Corner Table")</div>
            <div class="location-atmosphere">@(Model.LocationAtmosphere ?? "Warm hearth-light, nervous energy in the air")</div>
        </div>

        <!-- Main Scene Content -->
        <div class="scene-content">
            <!-- Character Focus - BODY LANGUAGE NOT STATS -->
            <div class="character-focus">
                <div class="character-name">@Model.NpcName</div>
                <div class="character-state">@(Model.CharacterState ?? "leaning forward, fingers worrying her shawl")</div>
                
                @* Token Display - Shows contextually relevant relationship currency *@
                @if (NpcTokens != null)
                {
                    <TokenDisplay 
                        Tokens="@NpcTokens" 
                        NpcName="@Model.NpcName" 
                        ConversationContext="@GetCurrentConversationContext()"
                        NpcRole="@GetNpcRole()"
                        ShowOnlyRelevant="true"
                        UseNarrativeDescriptions="true" />
                }
                
                @if (Model.RelationshipStatus?.Any() == true)
                {
                    <div class="relationship-status">
                        @foreach (var status in Model.RelationshipStatus)
                        {
                            <span>@status.Value</span>
                        }
                    </div>
                }
            </div>

            <!-- Current Dialogue - NARRATIVE FOCUS -->
            <div class="dialogue-container">
                <div class="spoken-words">
                    @Model.CurrentText
                </div>
                
                @if (!string.IsNullOrEmpty(Model.CharacterAction))
                {
                    <div class="character-action">
                        @Model.CharacterAction
                    </div>
                }
            </div>

            <!-- Choice Options - Using Unified Components -->
            <div class="choice-container">
                @if (UnifiedChoices?.Any() == true)
                {
                    @foreach (var choice in UnifiedChoices)
                    {
                        <UnifiedChoice Choice="@choice" 
                                      AvailableAttention="@CurrentAttention"
                                      OnSelected="@HandleUnifiedChoice" />
                    }
                }
                else
                {
                    <!-- Default choice using unified component -->
                    <UnifiedChoice Choice="@GetDefaultChoice()" 
                                  AvailableAttention="@CurrentAttention"
                                  OnSelected="@HandleUnifiedChoice" />
                }
            </div>
        </div>
    }
    else
    {
        <div class="loading">Loading conversation...</div>
    }
</div>

