@page "/conversation/{NpcId}"
@using Wayfarer.ViewModels
@using Wayfarer.Pages.Components
@using Wayfarer.GameState
@inherits ConversationScreenBase

<div class="container">
    
    
    @* Exit button for manual conversation exit *@
    <div class="conversation-exit-controls">
        <button class="exit-conversation-btn" @onclick="HandleExitConversation">
            ‚Üê Exit Conversation
        </button>
    </div>
    
    @if (Model != null)
    {

        <!-- Peripheral Awareness - SUBTLE HINTS -->
        <div class="peripheral-layer">
            @if (!string.IsNullOrEmpty(Model.DeadlinePressure))
            {
                <div class="deadline-pressure">
                    <span class="icon icon-deadline-critical"></span> @Model.DeadlinePressure
                </div>
            }
            
            @if (Model.EnvironmentalHints?.Any() == true)
            {
                @foreach (var hint in Model.EnvironmentalHints)
                {
                    <div class="environmental-hints">
                        @hint
                    </div>
                }
            }
        </div>

        <!-- Location Header - SETS ATMOSPHERE -->
        <div class="location-header">
            <div class="location-name">@(Model.LocationName ?? "The Copper Kettle - Corner Table")</div>
            <div class="location-atmosphere">@(Model.LocationAtmosphere ?? "Warm hearth-light, nervous energy in the air")</div>
        </div>

        <!-- Main Scene Content -->
        <div class="scene-content">
            <!-- Character Focus - TRANSPARENT EMOTIONAL STATE -->
            <div class="character-focus">
                @if (CurrentEmotionalState != null)
                {
                    <EmotionalStateDisplay 
                        NpcName="@Model.NpcName"
                        CurrentState="@CurrentEmotionalState.Value"
                        Stakes="@CurrentStakes"
                        StakesDescription="@GetStakesDescription()"
                        TimeRemaining="@GetTimeRemaining()"
                        ShowFormula="true"
                        ShowMechanicalEffects="true" />
                }
                else
                {
                    <div class="character-name">@Model.NpcName</div>
                    <div class="character-state">@(Model.CharacterState ?? "leaning forward, fingers worrying her shawl")</div>
                }
                
                @* NPC Patience and Comfort Display - Core conversation mechanics *@
                <div class="npc-conversation-state">
                    <div class="patience-display">
                        <span class="patience-label">@Model.NpcName's Patience:</span>
                        <div class="patience-orbs">
                            @* Debug: Show patience values *@
                            <span style="font-size: 0.8em; color: #888;">(@CurrentPatience/@MaxPatience)</span>
                            @for (int i = 0; i < MaxPatience; i++)
                            {
                                <div class="patience-orb @(i < CurrentPatience ? "active" : "spent")" 
                                     aria-label="@GetPatienceOrbLabel(i)">
                                </div>
                            }
                        </div>
                    </div>
                    
                    <div class="comfort-display">
                        <span class="comfort-label">Comfort:</span>
                        <div class="comfort-indicator @GetComfortClass()">
                            @GetComfortDescription()
                        </div>
                        <div class="comfort-progress-bar">
                            <div class="comfort-progress-fill" style="width: @GetComfortProgressPercentage()%"></div>
                            <div class="comfort-thresholds">
                                <div class="threshold maintain @(GetComfortThresholdClass("maintain"))"></div>
                                <div class="threshold letter @(GetComfortThresholdClass("letter"))"></div>
                                <div class="threshold perfect @(GetComfortThresholdClass("perfect"))"></div>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(GetComfortProgressHint()))
                        {
                            <div class="comfort-progress-hint">
                                @GetComfortProgressHint()
                            </div>
                        }
                    </div>
                </div>
                
                @if (Model.RelationshipStatus?.Any() == true)
                {
                    <div class="relationship-status">
                        @foreach (var status in Model.RelationshipStatus)
                        {
                            <span>@status.Value</span>
                        }
                    </div>
                }
            </div>

            <!-- Current Dialogue - NARRATIVE FOCUS -->
            <div class="dialogue-container">
                <div class="spoken-words">
                    @Model.CurrentText
                </div>
                
                @if (!string.IsNullOrEmpty(Model.CharacterAction))
                {
                    <div class="character-action">
                        @Model.CharacterAction
                    </div>
                }
            </div>

            <!-- Choice Options - Card-based conversation system -->
            <div class="choice-container">
                @if (Choices?.Any() == true)
                {
                    @foreach (var choice in Choices)
                    {
                        <div class="@GetChoiceClass(choice)" @onclick="() => HandleChoice(choice)">
                            <!-- Patience cost badge -->
                            @if (choice.PatienceCost > 0)
                            {
                                <div class="patience-cost">
                                    @GetCostDisplay(choice.PatienceCost)
                                </div>
                            }
                            else
                            {
                                <div class="patience-cost free">
                                    FREE
                                </div>
                            }
                            
                            <!-- Main choice text -->
                            <div class="choice-content">
                                <div class="choice-text">
                                    "@choice.NarrativeText"
                                </div>
                                
                                <!-- Success probability and mechanical previews -->
                                <div class="choice-mechanics">
                                    <!-- Success probability display -->
                                    <div class="mechanic-item success-probability">
                                        <span class="success-icon">üéØ</span>
                                        <span class="mechanic-text">
                                            @GetSuccessProbabilityDisplay(choice)
                                        </span>
                                    </div>
                                    
                                    <!-- Existing mechanical description -->
                                    @if (!string.IsNullOrEmpty(choice.MechanicalDescription))
                                    {
                                        @foreach (var part in ParseMechanicalDescription(choice.MechanicalDescription))
                                        {
                                            <div class="mechanic-item @GetMechanicClass(part)">
                                                <span class="@GetEffectIcon(part)"></span>
                                                <span class="mechanic-text">
                                                    @((MarkupString)part)
                                                </span>
                                            </div>
                                        }
                                    }
                                </div>
                                
                                <!-- Lock reason if unavailable -->
                                @if (!choice.IsAvailable && !string.IsNullOrEmpty(choice.MechanicalDescription))
                                {
                                    <div class="lock-reason">
                                        @choice.MechanicalDescription
                                    </div>
                                }
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="choice-option" @onclick="() => HandleChoice(DefaultChoice)">
                        <div class="patience-cost free">FREE</div>
                        <div class="choice-content">
                            <div class="choice-text">"@DefaultChoice.NarrativeText"</div>
                            <div class="choice-mechanics">
                                <div class="mechanic-item mechanic-neutral">
                                    <span class="icon icon-arrow"></span>
                                    <span class="mechanic-text">@DefaultChoice.MechanicalDescription</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="loading">Loading conversation...</div>
    }
</div>

