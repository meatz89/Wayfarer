@page "/conversation/{NpcId}"
@using Wayfarer.ViewModels
@inherits ConversationScreenBase

<div class="container">
    @if (Model != null)
    {
        <!-- Attention Display - ALWAYS VISIBLE -->
        <div class="attention-bar">
            <span class="attention-label">Attention:</span>
            @for (int i = 0; i < Model.MaxAttention; i++)
            {
                <div class="attention-point @(i < Model.CurrentAttention ? "" : "spent")"></div>
            }
        </div>

        <!-- Peripheral Awareness - SUBTLE HINTS -->
        <div class="peripheral-layer">
            @if (!string.IsNullOrEmpty(Model.DeadlinePressure))
            {
                <div class="deadline-pressure">
                    ⚡ @Model.DeadlinePressure
                </div>
            }
            
            @if (Model.EnvironmentalHints?.Any() == true)
            {
                @foreach (var hint in Model.EnvironmentalHints)
                {
                    <div class="environmental-hints">
                        @hint
                    </div>
                }
            }
        </div>

        <!-- Location Header - SETS ATMOSPHERE -->
        <div class="location-header">
            <div class="location-name">@(Model.LocationName ?? "The Copper Kettle - Corner Table")</div>
            <div class="location-atmosphere">@(Model.LocationAtmosphere ?? "Warm hearth-light, nervous energy in the air")</div>
        </div>

        <!-- Main Scene Content -->
        <div class="scene-content">
            <!-- Character Focus - BODY LANGUAGE NOT STATS -->
            <div class="character-focus">
                <div class="character-name">@Model.NpcName</div>
                <div class="character-state">@(Model.CharacterState ?? "leaning forward, fingers worrying her shawl")</div>
                @if (Model.RelationshipStatus?.Any() == true)
                {
                    <div class="relationship-status">
                        @foreach (var status in Model.RelationshipStatus)
                        {
                            <span>@status.Key @status.Value</span>
                        }
                    </div>
                }
            </div>

            <!-- Current Dialogue - NARRATIVE FOCUS -->
            <div class="dialogue-container">
                <div class="spoken-words">
                    @Model.CurrentText
                </div>
                
                @if (!string.IsNullOrEmpty(Model.CharacterAction))
                {
                    <div class="character-action">
                        @Model.CharacterAction
                    </div>
                }
            </div>

            <!-- Choice Options - INTERNAL THOUGHTS WITH COSTS -->
            <div class="choice-container">
                @if (Model.Choices?.Any() == true)
                {
                    @foreach (var choice in Model.Choices)
                    {
                        <div class="choice-option @(!choice.IsAvailable ? "locked" : "")" 
                             @onclick="@(async () => await SelectChoice(choice.Id))">
                            <div class="attention-cost @(choice.AttentionCost == 0 ? "free" : "")">
                                @if (choice.AttentionCost == 0)
                                {
                                    @:Free
                                }
                                else
                                {
                                    @for (int i = 0; i < choice.AttentionCost; i++)
                                    {
                                        @:◆
                                    }
                                    @: @choice.AttentionCost
                                }
                            </div>
                            <div class="choice-text">@choice.Text</div>
                            @if (choice.Mechanics?.Any() == true)
                            {
                                <div class="choice-mechanics">
                                    @foreach (var mechanic in choice.Mechanics)
                                    {
                                        <div class="mechanic-item @GetMechanicTypeClass(mechanic.Type)">
                                            @mechanic.Icon @mechanic.Description
                                        </div>
                                    }
                                </div>
                            }
                            else if (!choice.IsAvailable)
                            {
                                <div class="choice-mechanics">
                                    <div class="mechanic-item">
                                        [@choice.UnavailableReason ?? $"Requires {choice.AttentionCost} attention points"]
                                    </div>
                                </div>
                            }
                        </div>
                    }
                }
                else
                {
                    <!-- Default choices if none generated -->
                    <div class="choice-option">
                        <div class="attention-cost free">Free</div>
                        <div class="choice-text">"I understand. I'll see what I can do."</div>
                        <div class="choice-mechanics">
                            <div class="mechanic-item mechanic-neutral">
                                → Continue conversation
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="loading">Loading conversation...</div>
    }
</div>

@code {
    private string GetMechanicTypeClass(MechanicEffectType type)
    {
        return type switch
        {
            MechanicEffectType.Positive => "mechanic-positive",
            MechanicEffectType.Negative => "mechanic-negative",
            _ => "mechanic-neutral"
        };
    }
}