@page "/queue"
@inherits MainGameplayViewBase

<div class="main-container">
    <!-- Exit button -->
    <div class="queue-navigation-controls">
        <button class="exit-queue-btn" @onclick="HandleExitQueue">
            ← Back
        </button>
    </div>
    
    <!-- Header -->
    <div class="header">
        <div class="time-bar">
            <span>@GetCurrentTime()</span>
            <span class="deadline-timer">@GetNextDeadline()</span>
        </div>
        @if (HasCriticalDeadlines())
        {
            <div class="critical-deadline-alert">
                @GetCriticalLetterWarning()
            </div>
        }
    </div>

    <!-- Location Header -->
    <div class="location-header">
        <div class="location-path">
            <span>@GetLocationPath()</span>
            <span>→</span>
            <span>@GetSpotPath()</span>
        </div>
        <div class="location-name">@GetCurrentSpotName()</div>
    </div>

    <div class="content-area">
        <div class="atmosphere-text">
            @GetAtmosphereText()
        </div>

        <!-- Active Obligations Display -->
        <ObligationDisplay />

        <!-- Letter Queue Section - MINIMAL AS PER MOCKUP -->
        <div class="letter-queue-section">
            <h3 class="section-header">Letter Queue [@GetTotalWeight()/@GetMaxWeight() weight]</h3>
            
            <!-- Visual Queue Display - ASCII STYLE -->
            <div class="visual-queue">
                @for (int i = 0; i < 8; i++)
                {
                    var position = i + 1;
                    var letter = GetLetterAtPosition(position);
                    <div class="queue-slot @(expandedPosition == position ? "expanded" : "") @(_selectedForReorder == position ? "selected-for-reorder" : "") @(_isReordering && _selectedForReorder != position ? "reorder-target" : "")" 
                         @onclick="() => HandleSlotClick(position)">
                        
                        <!-- Position and Weight Blocks -->
                        <span class="slot-display">
                            [@(position)]
                            @if (letter != null)
                            {
                                <span class="weight-blocks">[</span>
                                @for (int w = 0; w < letter.Weight; w++)
                                {
                                    <text>■</text>
                                }
                                <span class="weight-blocks">]</span>
                                @if (letter.EmotionalWeight >= EmotionalWeight.HIGH)
                                {
                                    <span class="emotional-indicator">@letter.GetEmotionalWeightIcon()</span>
                                }
                            }
                            else
                            {
                                <span class="empty-display">[_]</span>
                            }
                        </span>
                        
                        <!-- Deadline and Human Context -->
                        @if (letter != null)
                        {
                            <span class="deadline-wrapper">
                                <span class="deadline-icon">@GetDeadlineIcon(letter)</span>
                                <span class="deadline @GetDeadlineClass(letter)">
                                    @GetShortDeadline(letter)
                                </span>
                            </span>
                            <span class="route-preview">@letter.RecipientName</span>
                            @if (!string.IsNullOrEmpty(letter.HumanContext))
                            {
                                <span class="human-context">"@letter.HumanContext"</span>
                            }
                        }
                        else
                        {
                            <span class="deadline empty">___</span>
                        }
                    </div>
                }
            </div>
            
            <!-- Progressive Disclosure - Details for Expanded Letter -->
            @if (expandedPosition > 0)
            {
                var letter = expandedPosition.HasValue ? GetLetterAtPosition(expandedPosition.Value) : null;
                if (letter != null)
                {
                    <div class="letter-details">
                        <div class="detail-route">
                            @letter.SenderName → @letter.RecipientName
                        </div>
                        <div class="detail-desc">
                            @if (!string.IsNullOrEmpty(letter.HumanContext))
                            {
                                <div class="human-context-full">@letter.HumanContext</div>
                            }
                            else
                            {
                                @letter.Description
                            }
                        </div>
                        <div class="detail-consequences">
                            @if (!string.IsNullOrEmpty(letter.ConsequenceIfDelivered))
                            {
                                <div class="consequence-success">✓ If delivered: @letter.ConsequenceIfDelivered</div>
                            }
                            @if (!string.IsNullOrEmpty(letter.ConsequenceIfLate))
                            {
                                <div class="consequence-failure">✗ If late: @letter.ConsequenceIfLate</div>
                            }
                        </div>
                        <div class="detail-meta">
                            Stakes: @GetStakesDisplay(letter.Stakes) | 
                            Deadline: @GetDeadlineDisplay(letter) |
                            Weight: @GetEmotionalWeightDisplay(letter.EmotionalWeight)
                        </div>
                        <div class="letter-actions">
                            @if (expandedPosition == 1)
                            {
                                @if (CanDeliverNow())
                                {
                                    <button @onclick="DeliverLetter" class="primary-action">Deliver This Letter</button>
                                }
                                else
                                {
                                    <button @onclick="NavigateToRecipient" class="primary-action">Travel to Recipient</button>
                                    <span class="delivery-hint">Must be at recipient's location to deliver</span>
                                }
                            }
                            else if (expandedPosition > 1)
                            {
                                <button @onclick="() => StartReorder(expandedPosition.Value)" class="secondary-action">Reorder Letter</button>
                                @if (TimeManager.GetCurrentTimeHours() < 10)
                                {
                                    <button @onclick="() => TryMorningSwap(expandedPosition.Value)" class="secondary-action">Morning Swap (Free)</button>
                                }
                            }
                        </div>
                    </div>
                }
            }
        </div>

        <!-- Available Actions -->
        <div class="actions-section">
            <h3>Actions</h3>
            <div class="action-list">
                <button @onclick="NavigateToLocation">Return to Location</button>
                <button @onclick="NavigateToConversation">Talk to Someone</button>
                @if (GetLetterAtPosition(1) != null)
                {
                    <button @onclick="NavigateToDelivery" class="primary-action">
                        Deliver Letter (Position 1)
                    </button>
                }
            </div>
        </div>
    </div>
</div>


