@page "/queue"
@inherits MainGameplayViewBase

@inject ConnectionTokenManager TokenManager
@inject StandingObligationManager ObligationManager
@inject ITimeManager TimeManager

<div class="letter-queue-screen">
    <div class="screen-header">
        <h1>üì¨ Letter Queue Management</h1>
        <p class="queue-subtitle">Your current obligations and delivery priorities</p>
    </div>
    
    <div class="queue-main-content">
        @* Primary Queue Display *@
        <div class="queue-section">
            <LetterQueueDisplay />
        </div>
        
        @* Active Obligations Summary *@
        <div class="obligations-summary">
            <h3>‚öñÔ∏è Active Obligations</h3>
            @{
                var activeObligations = ObligationManager.GetActiveObligations();
                if (activeObligations.Any())
                {
                    <ul class="obligation-list">
                        @foreach (var obligation in activeObligations)
                        {
                            <li class="obligation-item">
                                <span class="obligation-name">@obligation.Name</span>
                                <span class="obligation-effect">@obligation.Description</span>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p class="no-obligations">No standing obligations affecting your queue.</p>
                }
            }
        </div>
        
        @* Token Summary *@
        <div class="token-summary">
            <h3>ü™ô Connection Tokens</h3>
            <div class="token-grid">
                @foreach (var tokenType in Enum.GetValues<ConnectionType>())
                {
                    var count = TokenManager.GetTokenCount(tokenType);
                    <div class="token-item @(count < 0 ? "debt" : "")">
                        <span class="token-icon">@GetTokenIcon(tokenType)</span>
                        <span class="token-type">@tokenType</span>
                        <span class="token-count">@count</span>
                        @if (count < 0)
                        {
                            <span class="debt-indicator">DEBT</span>
                        }
                    </div>
                }
            </div>
        </div>
        
        @* Queue Statistics *@
        <div class="queue-stats">
            <h3>üìä Queue Statistics</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">Letters in Queue</span>
                    <span class="stat-value">@LetterQueueManager.GetLetterCount() / 8</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Urgent Letters</span>
                    <span class="stat-value urgent">@LetterQueueManager.GetExpiringLetters(1).Length</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Delivered</span>
                    <span class="stat-value success">@GameWorld.GetPlayer().TotalLettersDelivered</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Morning Swap Available</span>
                    <span class="stat-value">@(CanUseMorningSwap() ? "Yes" : "No")</span>
                </div>
            </div>
        </div>
        
        @* Letter History Preview *@
        <div class="letter-history">
            <h3>üìú Recent Letter Activity</h3>
            @{
                var recentActivity = GetRecentLetterActivity();
                if (recentActivity.Any())
                {
                    <ul class="history-list">
                        @foreach (var activity in recentActivity.Take(5))
                        {
                            <li class="history-item @activity.Type">
                                <span class="history-icon">@activity.Icon</span>
                                <span class="history-text">@activity.Description</span>
                                <span class="history-time">@activity.TimeAgo</span>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p class="no-history">No recent letter activity.</p>
                }
            }
        </div>
    </div>
    
    @* Quick Actions Bar *@
    <div class="quick-actions-bar">
        <button class="quick-action" @onclick="NavigateToLetterBoard" disabled="@(!IsLetterBoardAvailable())">
            üìã Letter Board @(IsLetterBoardAvailable() ? "" : "(Dawn Only)")
        </button>
        <button class="quick-action" @onclick="NavigateToLocation">
            üìç Current Location
        </button>
        <button class="quick-action" @onclick="NavigateToRelationships">
            üë• Relationships
        </button>
    </div>
</div>

@code {
    @namespace Wayfarer.Pages
    
    private class LetterActivity
    {
        public string Type { get; set; } = "";
        public string Icon { get; set; } = "";
        public string Description { get; set; } = "";
        public string TimeAgo { get; set; } = "";
    }
    
    private string GetTokenIcon(ConnectionType type)
    {
        return type switch
        {
            ConnectionType.Trust => "‚ù§Ô∏è",
            ConnectionType.Trade => "ü™ô",
            ConnectionType.Noble => "üëë",
            ConnectionType.Common => "üç∫",
            ConnectionType.Shadow => "üåë",
            _ => "‚ùì"
        };
    }
    
    private bool CanUseMorningSwap()
    {
        return TimeManager.GetCurrentTimeBlock() == TimeBlocks.Dawn &&
               GameWorld.GetPlayer().LastMorningSwapDay != GameWorld.CurrentDay;
    }
    
    private bool IsLetterBoardAvailable()
    {
        return TimeManager.GetCurrentTimeBlock() == TimeBlocks.Dawn;
    }
    
    private List<LetterActivity> GetRecentLetterActivity()
    {
        var activities = new List<LetterActivity>();
        
        // This would be populated from actual game history
        // For now, return empty list
        
        return activities;
    }
    
    private void NavigateToLetterBoard()
    {
        OnNavigate?.Invoke(CurrentViews.LetterBoardScreen);
    }
    
    private void NavigateToLocation()
    {
        OnNavigate?.Invoke(CurrentViews.LocationScreen);
    }
    
    private void NavigateToRelationships()
    {
        OnNavigate?.Invoke(CurrentViews.RelationshipScreen);
    }
}