@page "/queue"
@inherits MainGameplayViewBase

<div class="main-container">
    <!-- Header -->
    <div class="header">
        <div class="time-bar">
            <span>@GetCurrentTime()</span>
            <span class="deadline-timer">@GetNextDeadline()</span>
        </div>
    </div>

    <!-- Location Header -->
    <div class="location-header">
        <div class="location-path">
            <span>@GetLocationPath()</span>
            <span>→</span>
            <span>@GetSpotPath()</span>
        </div>
        <div class="location-name">@GetCurrentSpotName()</div>
    </div>

    <div class="content-area">
        <div class="atmosphere-text">
            @GetAtmosphereText()
        </div>

        <!-- Letter Queue Section - MINIMAL AS PER MOCKUP -->
        <div class="letter-queue-section">
            <h3 class="section-header">Letter Queue [@GetTotalWeight()/@GetMaxWeight() weight]</h3>
            
            <!-- Visual Queue Display - ASCII STYLE -->
            <div class="visual-queue">
                @for (int i = 0; i < 8; i++)
                {
                    var position = i + 1;
                    var letter = GetLetterAtPosition(position);
                    <div class="queue-slot @(expandedPosition == position ? "expanded" : "")" 
                         @onclick="() => TogglePosition(position)">
                        
                        <!-- Position and Weight Blocks -->
                        <span class="slot-display">
                            [@(position)]
                            @if (letter != null)
                            {
                                <span class="weight-blocks">[</span>
                                @for (int w = 0; w < letter.Weight; w++)
                                {
                                    <text>■</text>
                                }
                                <span class="weight-blocks">]</span>
                            }
                            else
                            {
                                <span class="empty-display">[_]</span>
                            }
                        </span>
                        
                        <!-- Deadline Indicator -->
                        @if (letter != null)
                        {
                            var deadline = GetShortDeadline(letter);
                            var isUrgent = letter.DeadlineInHours <= 48;
                            <span class="deadline @(isUrgent ? "urgent" : "")">
                                @(isUrgent ? "!" : "")@deadline
                            </span>
                        }
                        else
                        {
                            <span class="deadline empty">___</span>
                        }
                    </div>
                }
            </div>
            
            <!-- Progressive Disclosure - Details for Expanded Letter -->
            @if (expandedPosition > 0)
            {
                var letter = expandedPosition.HasValue ? GetLetterAtPosition(expandedPosition.Value) : null;
                if (letter != null)
                {
                    <div class="letter-details">
                        <div class="detail-route">
                            @letter.SenderName → @letter.RecipientName
                        </div>
                        <div class="detail-desc">
                            @letter.Description
                        </div>
                        <div class="detail-meta">
                            Stakes: @GetStakesDisplay(letter.Stakes) | 
                            Deadline: @GetDeadlineDisplay(letter)
                        </div>
                        @if (expandedPosition == 1)
                        {
                            <div class="delivery-action">
                                <button @onclick="DeliverLetter">Deliver This Letter</button>
                            </div>
                        }
                    </div>
                }
            }
        </div>

        <!-- Available Actions -->
        <div class="actions-section">
            <h3>Actions</h3>
            <div class="action-list">
                <button @onclick="NavigateToLocation">Return to Location</button>
                <button @onclick="NavigateToConversation">Talk to Someone</button>
                @if (GetLetterAtPosition(1) != null)
                {
                    <button @onclick="NavigateToDelivery" class="primary-action">
                        Deliver Letter (Position 1)
                    </button>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private int? expandedPosition = null;

    private void TogglePosition(int position)
    {
        if (expandedPosition == position)
        {
            expandedPosition = null;
        }
        else
        {
            expandedPosition = position;
        }
    }

    private async Task DeliverLetter()
    {
        var letter = GetLetterAtPosition(1);
        if (letter != null)
        {
            // Deliver the letter at position 1
            await GameFacade.DeliverLetterAsync(letter.Id);
            expandedPosition = null;
            StateHasChanged();
        }
    }

    private void NavigateToLocation()
    {
        OnNavigate?.Invoke(CurrentViews.LocationScreen);
    }

    private void NavigateToConversation()
    {
        OnNavigate?.Invoke(CurrentViews.ConversationScreen);
    }

    private void NavigateToDelivery()
    {
        var letter = GetLetterAtPosition(1);
        if (letter != null)
        {
            // Navigate to location screen to handle delivery
            OnNavigate?.Invoke(CurrentViews.LocationScreen);
        }
    }
}

