@page "/queue"
@inherits MainGameplayViewBase

<div class="letter-queue-screen">
    <div class="header">
        <div class="time-bar">
            <span>@GetCurrentTime()</span>
            <span class="deadline-timer">@GetNextDeadline()</span>
        </div>
    </div>

    <div class="location-header">
        <div class="location-path">
            <span>Market Square</span>
            <span>â†’</span>
            <span>West Side</span>
        </div>
        <div class="location-name">Copper Kettle Tavern</div>
        <div class="location-tags">
            <span class="tag atmosphere">ğŸ”¥ Hearth-warmed</span>
            <span class="tag">ğŸº Ale-scented</span>
            <span class="tag">ğŸµ Music drifting</span>
        </div>
    </div>

    <div class="content-area">
        <div class="atmosphere-text">
            Warm firelight. Clinking mugs. Low conversations blend with lute music. Smell of roasted meat.
        </div>

        @* Letter Queue Display *@
        <div class="queue-section">
            <h3>ğŸ“¬ Letter Queue</h3>
            <div class="queue-slots">
                @for (int i = 0; i < 8; i++)
                {
                    var letter = GetLetterAtPosition(i + 1);
                    <div class="queue-slot @(letter != null ? "occupied" : "empty") @(i == 0 ? "deliverable" : "")">
                        <div class="slot-number">@(i + 1)</div>
                        @if (letter != null)
                        {
                            <div class="letter-card">
                                <div class="letter-header">
                                    <span class="letter-sender">@letter.SenderName</span>
                                    <span class="letter-arrow">â†’</span>
                                    <span class="letter-recipient">@letter.RecipientName</span>
                                </div>
                                <div class="letter-description">
                                    @letter.Description
                                </div>
                                <div class="letter-meta">
                                    <span class="letter-stakes @GetStakesClass(letter.Stakes)">@letter.Stakes</span>
                                    <span class="letter-deadline">@GetDeadlineDisplay(letter)</span>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="empty-slot-text">Empty</div>
                        }
                    </div>
                }
            </div>
        </div>

        @* NPCs Present *@
        <div class="npcs-section">
            <h3>People Present</h3>
            
            @* Elena - DESPERATE state *@
            <div class="npc-present">
                <div class="npc-header">
                    <div>
                        <div class="npc-name">Elena</div>
                    </div>
                    <div class="npc-mood">ğŸ˜°</div>
                </div>
                <div class="npc-description">
                    Sitting alone at a corner table, nervously fidgeting with a sealed letter
                </div>
                <div class="interaction-options">
                    <div class="interaction" @onclick="@(() => StartConversation("elena"))">
                        <span>Approach her table</span>
                        <span style="font-size: 11px;">Start conversation</span>
                    </div>
                </div>
            </div>

            @* Bertram the Innkeeper *@
            <div class="npc-present">
                <div class="npc-header">
                    <div>
                        <div class="npc-name">Bertram the Innkeeper</div>
                    </div>
                    <div class="npc-mood">ğŸ˜Š</div>
                </div>
                <div class="npc-description">
                    Polishing glasses behind the bar, occasionally glancing your way with a welcoming nod
                </div>
                <div class="interaction-options">
                    <div class="interaction" @onclick="@(() => StartConversation("bertram"))">
                        <span>Ask about rumors</span>
                        <span style="font-size: 11px;">10 min</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string GetCurrentTime()
    {
        var timeInfo = GameFacade.GetTimeInfo();
        var day = timeInfo.currentDay;
        var dayName = new[] { "MON", "TUE", "WED", "THU", "FRI", "SAT", "SUN" }[day % 7];
        
        // Calculate hour from TimeBlocks - game world specified 3:45 PM (15.75 hours)
        // For now, use hardcoded mockup time
        var hour = 15;
        var minute = 45;
        var period = "PM";
        var displayHour = 3;
        
        return $"{dayName} {displayHour}:{minute:D2} {period}";
    }

    private string GetNextDeadline()
    {
        var letters = GameFacade.GetPlayer().LetterQueue;
        if (letters == null || !letters.Any(l => l != null)) return "";
        
        var nextDeadline = letters.Where(l => l != null)
            .OrderBy(l => l.DeadlineInDays)
            .FirstOrDefault();
            
        if (nextDeadline == null) return "";
        
        var hoursLeft = nextDeadline.DeadlineInDays * 24;
        // Mock: assume it's 3:45 PM (15.75 hours into the day)
        hoursLeft -= (int)(24 - 15.75); // Adjust for current time of day
        
        if (hoursLeft <= 3)
        {
            return $"âš¡ {hoursLeft}h until {GetShortName(nextDeadline.RecipientName)}";
        }
        else
        {
            var days = hoursLeft / 24;
            var hours = hoursLeft % 24;
            return $"â° {days}d {hours}h until {GetShortName(nextDeadline.RecipientName)}";
        }
    }

    private string GetShortName(string fullName)
    {
        if (fullName.StartsWith("Lord ")) return "Lord " + fullName.Substring(5).Substring(0, 1) + ".";
        return fullName.Split(' ')[0];
    }

    private Letter GetLetterAtPosition(int position)
    {
        var queue = GameFacade.GetPlayer().LetterQueue;
        if (queue == null || position > queue.Length || position < 1) return null;
        return queue[position - 1];
    }

    private string GetStakesClass(StakeType stakes)
    {
        return stakes switch
        {
            StakeType.REPUTATION => "reputation",
            StakeType.WEALTH => "wealth",
            StakeType.SAFETY => "safety",
            StakeType.SECRET => "secret",
            _ => ""
        };
    }

    private string GetDeadlineDisplay(Letter letter)
    {
        if (letter.DeadlineInDays <= 1) return "URGENT";
        if (letter.DeadlineInDays <= 2) return $"{letter.DeadlineInDays} days";
        return $"{letter.DeadlineInDays} days";
    }

    private async void StartConversation(string npcId)
    {
        await GameFacade.StartConversationAsync(npcId);
        // Navigation handled through MainGameplayViewBase
    }

    private int GetTokenCount(ConnectionType tokenType)
    {
        // Not used in current implementation
        return 0;
    }
}