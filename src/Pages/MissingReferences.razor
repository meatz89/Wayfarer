@page "/missing-references"
@using Microsoft.AspNetCore.Components
@inject ContentValidator Validator
@* Action system removed - location actions handled by LocationActionManager *@
@inject LocationCreationSystem LocationCreationSystem
@inject NavigationManager NavigationManager

<div class="missing-references-container">
    <h2 class="content-warning-title">Content Issues Detected</h2>
    <p class="content-warning-description">
        The following issues were found in the game content. You can choose to generate the missing content automatically
        or continue with missing references (which may cause errors).
    </p>

    @* Actions removed - using letter queue system *@

    @if (validationResult.MissingLocationSpots.Count > 0)
    {
        <div class="missing-section">
            <h3>Missing Locations</h3>
            <div class="missing-list">
                @foreach (var missing in validationResult.MissingLocationSpots)
                {
                    <div class="missing-item">
                        <span class="missing-id">@missing.LocationSpotId</span>
                        <span class="reference-detail">Referenced by spot: @missing.ReferencingLocation.Id</span>
                    </div>
                }
            </div>
        </div>
    }

    @if (validationResult.MissingConnectedLocations.Count > 0)
    {
        <div class="missing-section">
            <h3>Missing Connected Locations</h3>
            <div class="missing-list">
                @foreach (var missing in validationResult.MissingConnectedLocations)
                {
                    <div class="missing-item">
                        <span class="missing-id">@missing.LocationId</span>
                        <span class="reference-detail">Referenced by location: @missing.ReferencingLocation.Id</span>
                    </div>
                }
            </div>
        </div>
    }

    <div class="action-buttons">
        <button class="generate-button" disabled="true" @onclick="GenerateMissingContent">Generate Missing Content</button>
        <button class="continue-button" @onclick="ContinueWithoutGenerating">Continue Anyway</button>
    </div>

    @if (isGenerating)
    {
        <div class="generation-progress">
            <p>Generating missing content... (@generatedCount/@totalToGenerate)</p>
            <div class="progress-bar">
                <div class="progress-inner" style="width: @((generatedCount * 100 / Math.Max(1, totalToGenerate)))%"></div>
            </div>
        </div>
    }
</div>

@code {

@namespace Wayfarer.Pages
    [Parameter] public EventCallback OnMissingReferencesResolved { get; set; }

    private ContentValidationResult validationResult;
    private bool isGenerating = false;
    private int generatedCount = 0;
    private int totalToGenerate = 0;

    protected override void OnInitialized()
    {
        validationResult = Validator.ValidateContent();
    }

    private async Task GenerateMissingContent()
    {
        isGenerating = true;
        generatedCount = 0;
        totalToGenerate = validationResult.MissingLocationSpots.Count +
                         validationResult.MissingConnectedLocations.Count;

        // First generate missing locations as actions may depend on them
        foreach (var missingLocation in validationResult.MissingLocationSpots)
        {
            await LocationCreationSystem.CreateLocationSpot(missingLocation.ReferencingLocation.Id, missingLocation.LocationSpotId);
            generatedCount++;
            StateHasChanged();
        }

        // Then generate missing connected locations
        foreach (var missingConnected in validationResult.MissingConnectedLocations)
        {
            await LocationCreationSystem.CreateLocation(missingConnected.LocationId);
            generatedCount++;
            StateHasChanged();
        }

        // Actions removed - using letter queue system

        isGenerating = false;
        OnMissingReferencesResolved.InvokeAsync();
    }

    private void ContinueWithoutGenerating()
    {
        OnMissingReferencesResolved.InvokeAsync();
    }
}