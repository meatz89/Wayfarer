@inherits LiteraryConversationScreenBase

<div class="literary-conversation-container">
    @if (Conversation != null)
    {
        <div class="scene-atmosphere">
            <!-- Attention Display -->
            <AttentionDisplay 
                CurrentAttention="@Conversation.CurrentAttention" 
                MaxAttention="@Conversation.MaxAttention"
                Narrative="@Conversation.AttentionNarrative" />
            
            <!-- Context Tags -->
            <div class="context-tags">
                @if (Conversation.PressureTags?.Any() == true)
                {
                    <div class="tag-group pressure-tags">
                        @foreach (var tag in Conversation.PressureTags)
                        {
                            <span class="context-tag pressure">@tag</span>
                        }
                    </div>
                }
                
                @if (Conversation.FeelingTags?.Any() == true)
                {
                    <div class="tag-group feeling-tags">
                        @foreach (var tag in Conversation.FeelingTags)
                        {
                            <span class="context-tag feeling">@tag</span>
                        }
                    </div>
                }
            </div>
        </div>
        
        <!-- Main Conversation Content -->
        <div class="conversation-content">
            <div class="npc-presence">
                <h3 class="npc-name">@Conversation.NpcName</h3>
                @if (!string.IsNullOrEmpty(Conversation.BodyLanguageDescription))
                {
                    <p class="body-language">@Conversation.BodyLanguageDescription</p>
                }
            </div>
            
            <!-- Current Dialogue -->
            <div class="dialogue-text">
                <p>@Conversation.CurrentText</p>
            </div>
            
            <!-- Peripheral Awareness -->
            @if (Conversation.PeripheralObservations?.Any() == true)
            {
                <PeripheralAwareness Observations="@Conversation.PeripheralObservations" />
            }
            
            <!-- Internal Monologue -->
            @if (!string.IsNullOrEmpty(Conversation.InternalMonologue))
            {
                <div class="internal-monologue">
                    <em>@Conversation.InternalMonologue</em>
                </div>
            }
            
            <!-- Conversation Choices -->
            <div class="conversation-choices">
                @foreach (var choice in Conversation.Choices ?? new())
                {
                    @if (choice.IsInternalThought)
                    {
                        <InternalThoughtChoice 
                            Choice="@choice" 
                            OnChoiceSelected="@(async () => await SelectChoice(choice.Id))"
                            CurrentAttention="@Conversation.CurrentAttention" />
                    }
                    else
                    {
                        <div class="choice-container @(choice.IsAvailable ? "" : "unavailable")">
                            <button class="conversation-choice @choice.EmotionalTone" 
                                    @onclick="async () => await SelectChoice(choice.Id)"
                                    disabled="@(!choice.IsAvailable)">
                                <span class="choice-text">@choice.Text</span>
                                @if (choice.AttentionCost > 0)
                                {
                                    <span class="attention-cost" title="@choice.AttentionDescription">
                                        @string.Join("", Enumerable.Repeat("â—‹", choice.AttentionCost))
                                    </span>
                                }
                            </button>
                            @if (!choice.IsAvailable && !string.IsNullOrEmpty(choice.UnavailableReason))
                            {
                                <div class="unavailable-reason">@choice.UnavailableReason</div>
                            }
                        </div>
                    }
                }
            </div>
            
            <!-- Rumor Trading Section -->
            @if (Conversation.AvailableRumors?.Any() == true || Conversation.KnownRumors?.Any() == true)
            {
                <div class="rumor-section">
                    <h4>Information Exchange</h4>
                    @if (Conversation.AvailableRumors?.Any() == true)
                    {
                        <div class="available-rumors">
                            <h5>Rumors to Trade</h5>
                            @foreach (var rumor in Conversation.AvailableRumors)
                            {
                                <div class="rumor-item">
                                    <span class="confidence-symbol">@rumor.ConfidenceSymbol</span>
                                    <span class="rumor-text">@rumor.Text</span>
                                    @if (rumor.CanTrade)
                                    {
                                        <button class="trade-rumor" @onclick="async () => await TradeRumor(rumor.Id)">
                                            Trade
                                        </button>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
        
        <!-- Scene Pressure Indicators -->
        @if (Conversation.MinutesUntilDeadline > 0)
        {
            <div class="scene-pressure">
                <div class="deadline-pressure">
                    Time pressure: @FormatTimeUntilDeadline(Conversation.MinutesUntilDeadline)
                </div>
                @if (Conversation.LetterQueueSize > 0)
                {
                    <div class="queue-pressure">
                        Letters waiting: @Conversation.LetterQueueSize
                    </div>
                }
            </div>
        }
    }
    else
    {
        <div class="no-conversation">
            <p>No active conversation.</p>
        </div>
    }
</div>