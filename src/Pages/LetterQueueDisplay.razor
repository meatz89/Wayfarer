@using Wayfarer.GameState

@inject GameWorld GameWorld
@inject LetterQueueManager LetterQueueManager
@inject ConnectionTokenManager TokenManager
@inject MessageSystem MessageSystem

<div class="letter-queue-container">
    <h3>Letter Queue</h3>
    
    @* Token Display *@
    <div class="token-display">
        <h4>Connection Tokens</h4>
        <div class="token-list">
            @foreach (var tokenType in Enum.GetValues<ConnectionType>())
            {
                var count = TokenManager.GetTokenCount(tokenType);
                <div class="token-item">
                    <span class="token-icon">@GetTokenIcon(tokenType)</span>
                    <span class="token-type">@tokenType</span>
                    <span class="token-count">@count</span>
                </div>
            }
        </div>
    </div>
    
    @* Letter Queue Display *@
    <div class="letter-queue">
        @for (int position = 1; position <= 8; position++)
        {
            var letter = LetterQueueManager.GetLetterAt(position);
            <div class="queue-slot @(letter != null ? "occupied" : "empty") @(position == 1 ? "position-one" : "")">
                <div class="slot-number">[@position]</div>
                @if (letter != null)
                {
                    <div class="letter-card">
                        <div class="letter-header">
                            <span class="token-icon">@letter.GetTokenTypeIcon()</span>
                            <span class="letter-type">@letter.TokenType</span>
                        </div>
                        <div class="letter-route">
                            <span class="sender">@letter.SenderName</span>
                            <span class="arrow">‚Üí</span>
                            <span class="recipient">@letter.RecipientName</span>
                        </div>
                        <div class="letter-details">
                            <div class="deadline @GetDeadlineWarningClass(letter.Deadline)">
                                @GetDeadlineWarningIcon(letter.Deadline) @GetDeadlineDescription(letter.Deadline)
                            </div>
                            <div class="payment">@letter.Payment coins</div>
                        </div>
                        @if (position == 1)
                        {
                            <button class="btn btn-primary btn-sm deliver-btn" @onclick="() => DeliverLetter(letter)">
                                Deliver
                            </button>
                        }
                        else if (position > 1 && LetterQueueManager.GetLetterAt(1) == null)
                        {
                            var tokenCost = position - 1;
                            var hasEnoughTokens = TokenManager.HasTokens(letter.TokenType, tokenCost);
                            
                            <button class="btn btn-secondary btn-sm skip-btn" 
                                    disabled="@(!hasEnoughTokens)" 
                                    @onclick="() => SkipLetter(letter)">
                                Skip (@tokenCost @letter.TokenType)
                            </button>
                        }
                    </div>
                }
                else
                {
                    <div class="empty-slot">
                        [Empty]
                    </div>
                }
            </div>
        }
    </div>
    
    @* Queue Status *@
    <div class="queue-status">
        <p>Letters in queue: @LetterQueueManager.GetLetterCount() / 8</p>
        @{
            var expiredLetters = LetterQueueManager.GetExpiringLetters(0);
            var urgentLetters = LetterQueueManager.GetExpiringLetters(1);
            var warningLetters = LetterQueueManager.GetExpiringLetters(2);
            
            if (expiredLetters.Any())
            {
                <p class="deadline-expired">üíÄ @expiredLetters.Length letter(s) EXPIRED!</p>
            }
            if (urgentLetters.Any())
            {
                <p class="deadline-urgent">üö® @urgentLetters.Length letter(s) due TODAY!</p>
            }
            if (warningLetters.Any())
            {
                <p class="deadline-warning">‚ö†Ô∏è @warningLetters.Length letter(s) due in 2 days or less!</p>
            }
        }
    </div>
</div>

@code {
    protected override void OnInitialized()
    {
        // Add test letters for minimal POC demonstration
        if (LetterQueueManager.GetLetterCount() == 0)
        {
            AddTestLetters();
        }
    }
    
    private void AddTestLetters()
    {
        // Create a few test letters to show in the queue
        var testLetters = new[]
        {
            new Letter 
            { 
                SenderName = "Elena", 
                RecipientName = "Marcus", 
                Deadline = 3, 
                Payment = 5, 
                TokenType = ConnectionType.Trust 
            },
            new Letter 
            { 
                SenderName = "Lord Ashford", 
                RecipientName = "Lady Winters", 
                Deadline = 1, 
                Payment = 12, 
                TokenType = ConnectionType.Noble 
            },
            new Letter 
            { 
                SenderName = "Merchant Guild", 
                RecipientName = "Dock Master", 
                Deadline = 5, 
                Payment = 8, 
                TokenType = ConnectionType.Trade 
            },
            new Letter 
            { 
                SenderName = "Anonymous", 
                RecipientName = "The Fence", 
                Deadline = 2, 
                Payment = 15, 
                TokenType = ConnectionType.Shadow 
            }
        };
        
        foreach (var letter in testLetters)
        {
            LetterQueueManager.AddLetterToFirstEmpty(letter);
        }
        
        // Add some test tokens
        TokenManager.AddTokens(ConnectionType.Trust, 3);
        TokenManager.AddTokens(ConnectionType.Trade, 2);
        TokenManager.AddTokens(ConnectionType.Noble, 1);
    }
    
    private string GetTokenIcon(ConnectionType type)
    {
        return type switch
        {
            ConnectionType.Trust => "‚ù§Ô∏è",
            ConnectionType.Trade => "ü™ô",
            ConnectionType.Noble => "üëë",
            ConnectionType.Common => "üç∫",
            ConnectionType.Shadow => "üåë",
            _ => "‚ùì"
        };
    }
    
    private void DeliverLetter(Letter letter)
    {
        if (letter == null) return;
        
        // Give coins for delivery
        var player = GameWorld.GetPlayer();
        player.ModifyCoins(letter.Payment);
        
        // 50% chance to earn a token
        var random = new Random();
        bool earnedToken = random.Next(2) == 0;
        if (earnedToken)
        {
            TokenManager.AddTokens(letter.TokenType, 1);
        }
        
        // Remove from queue
        LetterQueueManager.RemoveLetterFromQueue(1);
        
        // Show feedback using MessageSystem
        string message = $"Delivered letter! Earned {letter.Payment} coins";
        if (earnedToken)
        {
            message += $" and 1 {letter.TokenType} token!";
        }
        MessageSystem.AddSystemMessage(message, SystemMessageTypes.Success);
        
        StateHasChanged();
    }
    
    private void SkipLetter(Letter letter)
    {
        if (letter == null) return;
        
        int tokenCost = letter.QueuePosition - 1;
        
        // Attempt to skip the letter
        bool success = LetterQueueManager.TrySkipDeliver(letter.QueuePosition);
        
        if (success)
        {
            // Show success message
            string message = $"Skipped letter to position 1! Spent {tokenCost} {letter.TokenType} tokens";
            MessageSystem.AddSystemMessage(message, SystemMessageTypes.Success);
        }
        else
        {
            // Show failure message
            string message = $"Cannot skip letter: insufficient {letter.TokenType} tokens or position 1 occupied";
            MessageSystem.AddSystemMessage(message, SystemMessageTypes.Danger);
        }
        
        StateHasChanged();
    }
    
    private string GetDeadlineWarningClass(int deadline)
    {
        return deadline switch
        {
            <= 0 => "deadline-expired",
            1 => "deadline-urgent",
            2 => "deadline-warning",
            _ => "deadline-normal"
        };
    }
    
    private string GetDeadlineWarningIcon(int deadline)
    {
        return deadline switch
        {
            <= 0 => "üíÄ",
            1 => "üö®",
            2 => "‚ö†Ô∏è",
            _ => "‚è∞"
        };
    }
    
    private string GetDeadlineDescription(int deadline)
    {
        return deadline switch
        {
            <= 0 => "EXPIRED",
            1 => "Due TODAY",
            2 => "Due in 2 days",
            _ => $"Due in {deadline} days"
        };
    }
}