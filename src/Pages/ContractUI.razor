@using Wayfarer.Game.ActionSystem
@using Wayfarer.Game.MainSystem
@inherits ContractUIBase

@* ContractUI.razor *@

<div class="contracts-list">
    @if (AvailableContracts.Any())
    {
        @foreach (var contract in AvailableContracts)
        {
            var contractStatus = ContractRepository.GetContractStatus(contract.Id);
            int daysRemaining = contract.DueDay - GameWorld.CurrentDay;
            bool canComplete = contractStatus.Status == ContractStatus.Completed;

            <div class="contract-card">
                <div class="contract-header">
                    <span class="contract-name">@contract.Description</span>
                    <span class="contract-time @(daysRemaining <= 1 ? "urgent" : "")">
                        @(daysRemaining > 0 ? $"{daysRemaining} days remaining" : "Due today!")
                    </span>
                </div>

                <!-- PROGRESS TRACKING SECTION -->
                <div class="contract-progress">
                    <div class="progress-header">
                        <span class="progress-label">Progress: @((int)(contractStatus.ProgressPercentage * 100))%</span>
                        <span class="progress-status @contractStatus.Status.ToString().ToLower()">@contractStatus.Status</span>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: @((int)(contractStatus.ProgressPercentage * 100))%"></div>
                    </div>
                </div>


                <!-- COMPLETION REQUIREMENTS SECTION -->
                <div class="contract-requirements">
                    @if (contract.CompletionSteps.Any())
                    {
                        <!-- NEW: ContractStep system display -->
                        <div class="requirement-section">
                            <h4 class="requirement-title">Contract Steps:</h4>
                            @foreach (var step in contract.CompletionSteps.OrderBy(s => s.OrderHint))
                            {
                                var stepRequirement = step.GetRequirement();
                                
                                <div class="requirement-item step-item @(step.IsCompleted ? "completed" : "pending") @(step.IsRequired ? "required" : "optional")">
                                    <div class="step-header">
                                        <span class="requirement-icon">@(step.IsCompleted ? "✅" : step.IsRequired ? "🔲" : "🔳")</span>
                                        <span class="step-description">@step.Description</span>
                                        @if (!step.IsRequired)
                                        {
                                            <span class="optional-badge">Optional</span>
                                        }
                                    </div>
                                    
                                    <div class="step-details">
                                        @switch (stepRequirement.Type)
                                        {
                                            case ContractStepType.Travel:
                                                <span class="step-detail">📍 Travel to @stepRequirement.TargetLocationId</span>
                                                break;
                                            case ContractStepType.Transaction:
                                                <span class="step-detail">
                                                    💰 @stepRequirement.TransactionType @stepRequirement.ItemId at @stepRequirement.TargetLocationId
                                                    @if (stepRequirement.Quantity > 1) { <text> (x@stepRequirement.Quantity)</text> }
                                                    @if (stepRequirement.MaxPrice.HasValue) { <text> (max: @stepRequirement.MaxPrice coins)</text> }
                                                    @if (stepRequirement.MinPrice.HasValue) { <text> (min: @stepRequirement.MinPrice coins)</text> }
                                                </span>
                                                break;
                                            case ContractStepType.Conversation:
                                                <span class="step-detail">
                                                    💬 Speak with @stepRequirement.RequiredNPCId
                                                    @if (!string.IsNullOrEmpty(stepRequirement.TargetLocationId)) { <text> at @stepRequirement.TargetLocationId</text> }
                                                </span>
                                                break;
                                            case ContractStepType.LocationAction:
                                                <span class="step-detail">⚡ Perform @stepRequirement.RequiredActionId at @stepRequirement.TargetLocationId</span>
                                                break;
                                            case ContractStepType.Equipment:
                                                <span class="step-detail">
                                                    🎒 Obtain: @string.Join(", ", stepRequirement.RequiredEquipmentCategories.Select(cat => cat.ToString().Replace("_", " ")))
                                                </span>
                                                break;
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>

                <!-- CATEGORICAL REQUIREMENTS SECTION -->
                @if (contract.RequiredEquipmentCategories.Any() || 
                     contract.PhysicalRequirement != PhysicalDemand.None)
                {
                    <div class="categorical-requirements">
                        <h4 class="requirement-title">Prerequisites:</h4>
                        
                        @if (contract.RequiredEquipmentCategories.Any())
                        {
                            <div class="category-requirement">
                                <span class="category-label">Equipment:</span>
                                <span class="category-list">@string.Join(", ", contract.RequiredEquipmentCategories.Select(ec => ec.ToString().Replace("_", " ")))</span>
                            </div>
                        }
                        
                        
                        @if (contract.PhysicalRequirement != PhysicalDemand.None)
                        {
                            <div class="category-requirement">
                                <span class="category-label">Physical Demand:</span>
                                <span class="category-list">@contract.PhysicalRequirement.ToString()</span>
                            </div>
                        }
                    </div>
                }

                <div class="contract-details">
                    <div class="detail">
                        <span class="detail-label">Payment:</span>
                        <span class="detail-value">@contract.Payment coins</span>
                    </div>
                    
                    <div class="detail">
                        <span class="detail-label">Category:</span>
                        <span class="detail-value">@contract.Category</span>
                    </div>
                    
                    <div class="detail">
                        <span class="detail-label">Priority:</span>
                        <span class="detail-value">@contract.Priority</span>
                    </div>
                </div>

                @if (canComplete)
                {
                    <button class="complete-button"
                            @onclick="() => CompleteContract(contract)">
                        Complete Contract
                    </button>
                }
                else if (contractStatus.Status == ContractStatus.Active)
                {
                    <div class="contract-status">
                        <span class="status-text">In Progress - Complete the required actions above</span>
                    </div>
                }
            </div>
        }
    }
    else
    {
        <div class="no-contracts">
            No contracts available at this time.
        </div>
    }
</div>
