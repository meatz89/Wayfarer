@page "/obligations"
@inherits MainGameplayViewBase

<div class="obligations-container">
    <h2>Standing Obligations</h2>
    
    <div class="obligations-summary">
        <p>Active Obligations: @obligationsData.ActiveObligations.Count</p>
        @if (obligationsData.ActiveObligations.Any(o => o.HasConflicts))
        {
            <p class="warning">‚ö†Ô∏è Some obligations have conflicts</p>
        }
    </div>
    
    @if (!obligationsData.ActiveObligations.Any())
    {
        <div class="no-obligations">
            <h3>No Active Obligations</h3>
            <p>You have not accepted any standing obligations yet. These permanent commitments reshape how your letter queue behaves, providing benefits but imposing constraints.</p>
            <p>Standing obligations are acquired through special letters that appear in your daily letter generation.</p>
        </div>
    }
    else
    {
        <div class="obligations-grid">
            @foreach (var obligation in obligationsData.ActiveObligations)
            {
                <div class="obligation-card @GetObligationStatusClass(obligation)">
                    <div class="obligation-header">
                        <h3>@obligation.Name</h3>
                        <span class="obligation-source">From: @obligation.Source</span>
                        <span class="obligation-duration">Day @obligation.DaysSinceAccepted</span>
                    </div>
                    
                    <div class="obligation-description">
                        <p>@obligation.Description</p>
                    </div>
                    
                    <div class="obligation-effects">
                        <div class="benefits">
                            <h4>Benefits</h4>
                            @if (obligation.BenefitDescriptions.Any())
                            {
                                <ul>
                                    @foreach (var benefit in obligation.BenefitDescriptions)
                                    {
                                        <li class="benefit-item">‚úì @benefit</li>
                                    }
                                </ul>
                            }
                            else
                            {
                                <p class="no-effects">No direct benefits</p>
                            }
                        </div>
                        
                        <div class="constraints">
                            <h4>Constraints</h4>
                            @if (obligation.ConstraintDescriptions.Any())
                            {
                                <ul>
                                    @foreach (var constraint in obligation.ConstraintDescriptions)
                                    {
                                        <li class="constraint-item">‚ö†Ô∏è @constraint</li>
                                    }
                                </ul>
                            }
                            else
                            {
                                <p class="no-effects">No constraints</p>
                            }
                        </div>
                    </div>
                    
                    @if (obligation.RelatedTokenType.HasValue)
                    {
                        <div class="obligation-tokens">
                            <h4>Related Token Type</h4>
                            <div class="token-display">
                                <span class="token-icon">@GetTokenIcon(obligation.RelatedTokenType.Value)</span>
                                <span class="token-type">@obligation.RelatedTokenType.Value</span>
                                <span class="token-count">(@obligation.TokenCount owned)</span>
                            </div>
                        </div>
                    }
                    
                    @if (obligation.HasForcedLetterWarning)
                    {
                        <div class="forced-letter-warning">
                            <span class="warning-icon">‚è∞</span>
                            <span class="warning-text">Forced letter due in @obligation.DaysUntilForcedLetter days</span>
                        </div>
                    }
                    
                    @if (obligation.HasConflicts)
                    {
                        <div class="conflict-warning">
                            <span class="conflict-icon">‚ö°</span>
                            <span class="conflict-text">Conflicts with other obligations</span>
                        </div>
                    }
                    
                </div>
            }
        </div>
    }
    
    @* Threshold Warnings Section - Phase 8.2 *@
    <div class="threshold-warnings-section">
        <h3>Approaching Thresholds</h3>
        <p class="section-subtitle">Token relationships approaching obligation triggers</p>
        
        @if (obligationsData.ThresholdWarnings.Any())
        {
            <div class="threshold-warnings">
                @foreach (var warning in obligationsData.ThresholdWarnings)
                {
                    <div class="threshold-warning @(warning.WarningType == "HighTokens" ? "warning-positive" : "warning-negative")">
                        <div class="warning-icon">
                            @if (warning.WarningType == "HighTokens")
                            {
                                <span class="positive-icon">‚ú®</span>
                            }
                            else
                            {
                                <span class="negative-icon">‚ö†Ô∏è</span>
                            }
                        </div>
                        <div class="warning-content">
                            <div class="warning-header">
                                <span class="warning-title">@(warning.WarningType == "HighTokens" ? $"Growing Bond - {warning.NPCName}" : $"Approaching Debt - {warning.NPCName}")</span>
                                <span class="threshold-indicator">@warning.CurrentValue ‚Üí @warning.ThresholdValue</span>
                            </div>
                            <div class="warning-description">@warning.Message</div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="no-warnings">
                <p>No approaching threshold changes.</p>
            </div>
        }
    </div>
    
    @* Debt Obligations Display - Phase 8.3 *@
    @if (obligationsData.DebtObligations.Any())
    {
        <div class="debt-obligations-section">
            <h3>Active Debts</h3>
            <p class="section-subtitle">Negative token balances creating leverage effects</p>
            
            <div class="debt-cards">
                @foreach (var debtObligation in obligationsData.DebtObligations)
                {
                    <div class="debt-card @GetDebtSeverityClass(debtObligation.LeverageAmount)">
                        <div class="debt-header">
                            <span class="npc-name">@debtObligation.LeverageHolderName</span>
                            <span class="debt-amount">@debtObligation.LeverageAmount debt</span>
                        </div>
                        <div class="debt-effects">
                            @foreach (var effect in debtObligation.EffectDescriptions)
                            {
                                <div class="leverage-effect">
                                    <span class="effect-icon">@(effect.Contains("position") ? "üìå" : effect.Contains("costs") ? "üí∞" : "üö´")</span>
                                    <span>@effect</span>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    
    <div class="available-templates">
        <h3>Available Obligation Templates</h3>
        <p class="info-text">These obligations can be acquired through special letters:</p>
        
        <div class="templates-grid">
            @foreach (var template in obligationsData.AvailableTemplates)
            {
                <div class="template-card @(!template.CanAccept ? "unavailable" : "")">
                    <div class="template-header">
                        <h4>@template.Name</h4>
                        <span class="template-source">@template.TriggerDescription</span>
                    </div>
                    
                    <div class="template-description">
                        <p>@template.Description</p>
                        @if (!string.IsNullOrEmpty(template.RequirementDescription))
                        {
                            <p class="requirement-text">@template.RequirementDescription</p>
                        }
                    </div>
                    
                    @if (!template.CanAccept)
                    {
                        <div class="conflict-notice">
                            <p class="conflict-reason">@template.CannotAcceptReason</p>
                            @if (template.ConflictingObligations.Any())
                            {
                                <p class="conflict-list">Conflicts with: @string.Join(", ", template.ConflictingObligations)</p>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

@code {

@namespace Wayfarer.Pages
    private DetailedObligationsViewModel obligationsData = new DetailedObligationsViewModel();
    
    protected override void OnInitialized()
    {
        base.OnInitialized();
        LoadObligationData();
    }
    
    private void LoadObligationData()
    {
        obligationsData = GameFacade.GetDetailedObligations();
    }
    
    private string GetObligationStatusClass(ActiveObligationViewModel obligation)
    {
        var classes = new List<string> { "obligation" };
        
        if (obligation.HasConflicts)
            classes.Add("conflicts");
            
        if (obligation.HasForcedLetterWarning)
            classes.Add("forced-pending");
            
        return string.Join(" ", classes);
    }
    
    private string GetTokenIcon(ConnectionType type)
    {
        return type switch
        {
            ConnectionType.Trust => "‚ù§Ô∏è",
            ConnectionType.Commerce => "ü™ô", 
            ConnectionType.Status => "üëë",
            ConnectionType.Shadow => "üåë",
            _ => "‚ùì"
        };
    }
    
    private string GetDebtSeverityClass(int debtAmount)
    {
        return Math.Abs(debtAmount) switch
        {
            >= 10 => "debt-critical",
            >= 5 => "debt-severe",
            >= 3 => "debt-moderate",
            _ => "debt-minor"
        };
    }
}

