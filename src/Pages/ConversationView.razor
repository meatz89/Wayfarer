@inherits ConversationViewBase

@using Microsoft.AspNetCore.Components.Web

@namespace Wayfarer.Pages

<div class="encounter-container">
    <div class="encounter-content">
        <div class="encounter-main">
            <div class="encounter-stage">
                @if (ConversationManager != null && ConversationManager.State != null)
                {
                    @if (IsStreaming)
                    {
                        <div class="stage-situation streaming-text">
                            @StreamingText
                            <span class="cursor">▊</span>
                        </div>
                        <div class="stream-progress">
                            <div class="progress-bar" style="width: @(StreamProgress)%"></div>
                        </div>
                    }
                    else
                    {
                        <div class="stage-situation fade-in">
                            @ConversationManager.State.CurrentNarrative
                        </div>
                    }
                }
                else
                {
                    <div class="stage-situation loading-text">Starting conversation...</div>
                }
            </div>

            <div class="encounter-choices">
                @if (ConversationManager != null && ConversationManager.Choices?.Any() == true && !ConversationManager.IsAwaitingResponse)
                {
                    @foreach (var choice in ConversationManager.Choices)
                    {
                        <div class="choice-option @GetChoiceClass(choice) @(choice.IsAffordable ? "" : "disabled")"
                             @onclick="(() => MakeChoice(choice.ChoiceID))"
                             @onmouseover="(e => ShowTooltip(e, choice))"
                             @onmouseout="HideTooltip">
                            <div class="choice-index">@choice.ChoiceID</div>
                            <div class="choice-content">
                                <div class="choice-name">@choice.NarrativeText</div>
                                @if (!choice.IsAffordable)
                                {
                                    <div class="choice-unavailable">Insufficient resources</div>
                                }
                                @if (choice.FocusCost > 0)
                                {
                                    <div class="choice-cost">@choice.FocusCost focus</div>
                                }
                            </div>
                            @if (GetChoiceIcon(choice) != null)
                            {
                                <div class="choice-icon">@GetChoiceIcon(choice)</div>
                            }
                        </div>
                    }

                    @if (showTooltip && hoveredChoice != null)
                    {
                        <ConversationChoiceTooltip hoveredChoice="hoveredChoice" tooltipX="tooltipX" tooltipY="tooltipY" />
                    }
                }
            </div>
            @if (ConversationManager?.IsAwaitingResponse == true)
            {
                <div class="loading-indicator">
                    <span>Thinking</span>
                    <div class="thinking-dots">
                        <span class="dot"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                    </div>
                </div>
            }
        </div>
    </div>

    @if (ConversationManager?.State?.IsConversationComplete == true)
    {
        <div class="conversation-complete">
            <button class="nav-button primary" @onclick="CompleteConversation">
                <span class="complete-icon">✓</span>
                Continue
            </button>
        </div>
    }

</div>