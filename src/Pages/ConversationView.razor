@inherits ConversationViewBase

@using Microsoft.AspNetCore.Components.Web

@namespace Wayfarer.Pages

@{
    Console.WriteLine($"[ConversationView.razor] Rendering with CurrentConversation null? {CurrentConversation == null}");
    if (CurrentConversation != null)
    {
        Console.WriteLine($"[ConversationView.razor] CurrentConversation.CurrentText: {CurrentConversation.CurrentText?.Substring(0, Math.Min(50, CurrentConversation.CurrentText?.Length ?? 0))}");
        Console.WriteLine($"[ConversationView.razor] CurrentConversation.IsComplete: {CurrentConversation.IsComplete}");
    }
}

<div class="encounter-container">
    <div class="encounter-content">
        <div class="encounter-main">
            <div class="encounter-stage">
                @if (CurrentConversation != null)
                {
                    @if (IsStreaming)
                    {
                        <div class="stage-situation streaming-text">
                            @StreamingText
                            <span class="cursor">▊</span>
                        </div>
                        <div class="stream-progress">
                            <div class="progress-bar" style="width: @(StreamProgress)%"></div>
                        </div>
                    }
                    else
                    {
                        <div class="stage-situation fade-in">
                            @CurrentConversation.CurrentText
                        </div>
                    }
                }
                else
                {
                    <div class="stage-situation loading-text">Starting conversation...</div>
                }
            </div>

            <div class="encounter-choices">
                @if (CurrentConversation?.Choices?.Any() == true && !CurrentConversation.IsComplete)
                {
                    @foreach (var choice in CurrentConversation.Choices)
                    {
                        <div class="choice-option @GetChoiceClass(choice) @(choice.IsAvailable ? "" : "disabled")"
                             @onclick="(() => MakeChoice(choice.Id))"
                             @onmouseover="(e => ShowTooltip(e, choice))"
                             @onmouseout="HideTooltip">
                            <div class="choice-index">@choice.Id</div>
                            <div class="choice-content">
                                <div class="choice-name">@choice.Text</div>
                                @if (!choice.IsAvailable)
                                {
                                    <div class="choice-unavailable">@(choice.UnavailableReason ?? "Insufficient resources")</div>
                                }
                            </div>
                            @if (GetChoiceIcon(choice) != null)
                            {
                                <div class="choice-icon">@GetChoiceIcon(choice)</div>
                            }
                        </div>
                    }

                    @* TODO: Update ConversationChoiceTooltip to use ConversationChoiceViewModel
                    @if (showTooltip && hoveredChoice != null)
                    {
                        <ConversationChoiceTooltip hoveredChoice="hoveredChoice" tooltipX="tooltipX" tooltipY="tooltipY" />
                    }
                    *@
                }
            </div>
            @* Remove the thinking indicator for now as we don't have that state in the view model *@
        </div>
    </div>

    @if (CurrentConversation?.IsComplete == true)
    {
        <div class="conversation-complete">
            <button class="nav-button primary" @onclick="CompleteConversation">
                <span class="complete-icon">✓</span>
                Continue
            </button>
        </div>
    }

</div>