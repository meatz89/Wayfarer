@inherits TravelSelectionBase
@inject GameWorldManager GameManager
@inject TravelManager TravelManager
@inject RouteUnlockManager RouteUnlockManager

@namespace Wayfarer.Pages

<div class="world-map-container">
    @* Context-aware travel planning status *@
    <div class="travel-status travel-context">
        @{
            int totalWeight1 = GameManager.CalculateTotalWeight();
            string weightClass = totalWeight1 <= 3 ? "" :
            (totalWeight1 <= 6 ? "warning" : "danger");
            string weightStatus = totalWeight1 <= 3 ? "Light load" :
            (totalWeight1 <= 6 ? "Medium load (+1 stamina)" :
            "Heavy load (+2 stamina)");
            int baseStaminaCost = totalWeight1 <= 3 ? 0 : (totalWeight1 <= 6 ? 1 : 2);
            var currentStamina = GameWorld.GetPlayer().Stamina;
            var currentEquipment = GetCurrentEquipmentCategories();
        }
        <div class="travel-resources">
            <div class="resource-block stamina-block">
                <span class="resource-icon">⚡</span>
                <div class="resource-info">
                    <span class="resource-main">@currentStamina stamina</span>
                    <span class="resource-detail">Available for travel</span>
                </div>
            </div>
            <div class="resource-block weight-block">
                <span class="resource-icon">⚖️</span>
                <div class="resource-info">
                    <span class="resource-main @weightClass">@weightStatus</span>
                    @if (baseStaminaCost > 0)
                    {
                        <span class="resource-detail warning">+@baseStaminaCost stamina per segment</span>
                    }
                    else
                    {
                        <span class="resource-detail">No stamina penalty</span>
                    }
                </div>
            </div>
            @{
                var carriedLetters = GameWorld.GetPlayer().CarriedLetters;
                var hasHeavyLetters = carriedLetters?.Any(l => l.PhysicalProperties.HasFlag(LetterPhysicalProperties.Heavy)) ?? false;
                var hasFragileLetters = carriedLetters?.Any(l => l.PhysicalProperties.HasFlag(LetterPhysicalProperties.Fragile)) ?? false;
                var hasBulkyLetters = carriedLetters?.Any(l => l.PhysicalProperties.HasFlag(LetterPhysicalProperties.Bulky)) ?? false;
                var hasPerishableLetters = carriedLetters?.Any(l => l.PhysicalProperties.HasFlag(LetterPhysicalProperties.Perishable)) ?? false;
            }
            @if (carriedLetters != null && carriedLetters.Any())
            {
                <div class="resource-block letter-block">
                    <span class="resource-icon">📬</span>
                    <div class="resource-info">
                        <span class="resource-main">@carriedLetters.Count letter@(carriedLetters.Count != 1 ? "s" : "") carried</span>
                        @if (hasHeavyLetters)
                        {
                            <span class="resource-detail warning">Heavy letters +1 stamina cost</span>
                        }
                        else if (hasBulkyLetters)
                        {
                            <span class="resource-detail warning">Bulky letters restrict movement</span>
                        }
                        else if (hasPerishableLetters)
                        {
                            <span class="resource-detail warning">Perishable letters - time sensitive</span>
                        }
                        else
                        {
                            <span class="resource-detail">No letter penalties</span>
                        }
                    </div>
                </div>
            }
            <div class="resource-block equipment-block">
                <span class="resource-icon">🛠️</span>
                <div class="resource-info">
                    <span class="resource-main">@currentEquipment.Count equipment types</span>
                    <span class="resource-detail">Affects route access</span>
                </div>
            </div>
        </div>
        @if (currentStamina < 3)
        {
            <div class="context-warning">
                ⚠️ Low stamina - consider resting before long journeys
            </div>
        }
    </div>


    <div class="locations-grid">
        @foreach (var location in GetTravelableLocations())
        {
            <div class="location-card">
                <div class="location-name">
                    @location.Name @(location.Id == CurrentLocation.Id ? "(Current)" : "")
                </div>
                <div class="location-routes">
                    @{
                        var availableRoutes = TravelManager.GetAvailableRoutes(CurrentLocation.Id, location.Id);
                        var allRoutes = GetAllRoutesToLocation(location.Id);
                        var lockedRoutes = allRoutes.Where(r => !r.IsDiscovered).ToList();
                        var unlockedRoutes = allRoutes.Where(r => r.IsDiscovered).ToList();
                    }
                    
                    @foreach (var route in unlockedRoutes)
                    {
                        var coinCost = TravelManager.CalculateCoinCost(route);
                        var routeStaminaCost = TravelManager.CalculateStaminaCost(route);
                        var letterStaminaPenalty = (hasHeavyLetters ? 1 : 0);
                        var staminaCost = routeStaminaCost + letterStaminaPenalty;
                        var canAfford = TravelManager.CanTravel(route) && GameWorld.GetPlayer().Stamina >= staminaCost;
                        var accessInfo = TravelManager.GetRouteAccessInfo(route);
                        var isBlocked = !accessInfo.IsAllowed;
                        
                        <div class="route-option @(!canAfford ? "disabled" : "") @(isBlocked ? "blocked" : "")">
                            <div class="route-header">
                                <div class="route-name">
                                    @route.Name
                                    @if (isBlocked)
                                    {
                                        <span class="blocked-indicator">🔒</span>
                                    }
                                </div>
                                <div class="route-costs">
                                    <span class="cost-item @(GameWorld.GetPlayer().Coins < coinCost ? "insufficient" : "")">💰 @coinCost</span>
                                    <span class="cost-item @(GameWorld.GetPlayer().Stamina < staminaCost ? "insufficient" : "")">
                                        ⚡ @staminaCost
                                        @if (letterStaminaPenalty > 0)
                                        {
                                            <span class="penalty-note">(+@letterStaminaPenalty heavy)</span>
                                        }
                                    </span>
                                </div>
                            </div>
                            
                            @if (route.TerrainCategories.Any())
                            {
                                <div class="route-terrain">
                                    @foreach (var terrain in route.TerrainCategories)
                                    {
                                        <span class="terrain-tag">@GetTerrainIcon(terrain) @terrain.ToString().Replace('_', ' ')</span>
                                    }
                                </div>
                            }
                            
                            @* Display departure time *@
                            @if (route.DepartureTime.HasValue)
                            {
                                <div class="departure-info">
                                    🕐 @route.DepartureTime.Value.ToString().Replace('_', ' ')
                                </div>
                            }
                            
                            @* Show blocking reason only once *@
                            @if (isBlocked && !string.IsNullOrEmpty(accessInfo.BlockingReason))
                            {
                                <div class="route-blocked">🚫 @accessInfo.BlockingReason</div>
                            }
                            
                            @* Show only the most critical warning *@
                            @{
                                var criticalWarning = "";
                                if (hasFragileLetters && (route.TerrainCategories.Contains(TerrainCategory.Requires_Climbing) || 
                                                         route.TerrainCategories.Contains(TerrainCategory.Wilderness_Terrain)))
                                {
                                    criticalWarning = "Fragile letters at risk on this route!";
                                }
                                else if (accessInfo.Warnings.Any())
                                {
                                    criticalWarning = accessInfo.Warnings.First();
                                }
                            }
                            @if (!string.IsNullOrEmpty(criticalWarning))
                            {
                                <div class="route-warning">⚠️ @criticalWarning</div>
                            }
                            @if (!string.IsNullOrEmpty(route.Description))
                            {
                                <div class="route-description">@route.Description</div>
                            }
                            @if (accessInfo.IsAllowed && canAfford)
                            {
                                <button class="travel-button"
                                        @onclick="() => OnTravelRoute.InvokeAsync(route)">
                                    Travel via @route.Method
                                </button>
                            }
                            else
                            {
                                <button class="travel-button"
                                        disabled="true">
                                    @(!accessInfo.IsAllowed ? "Blocked" : "Cannot Afford")
                                </button>
                            }
                        </div>
                    }
                    
                    @* Locked Routes Section *@
                    @if (lockedRoutes.Any())
                    {
                        <div class="route-section">
                            <h4 class="section-header">🔒 Locked Routes</h4>
                            @foreach (var route in lockedRoutes)
                            {
                                var unlockOptions = RouteUnlockManager.GetAvailableRouteUnlocks(CurrentLocation.Id)
                                                                     .Where(u => u.RouteId == route.Id)
                                                                     .ToList();
                                
                                <div class="route-option disabled">
                                    <div class="route-header">
                                        <div class="route-name">
                                            🔒 @route.Name
                                        </div>
                                        <div class="route-costs">
                                            <span class="cost-item">⚡ @route.BaseStaminaCost</span>
                                            <span class="cost-item">⏱️ @route.TravelTimeHours hours</span>
                                        </div>
                                    </div>
                                    
                                    @if (!string.IsNullOrEmpty(route.Description))
                                    {
                                        <div class="route-description">@route.Description</div>
                                    }
                                    
                                    @if (unlockOptions.Any())
                                    {
                                        <div class="route-details">
                                            @foreach (var unlock in unlockOptions)
                                            {
                                                <div class="equipment-required">
                                                    Ask @unlock.UnlockingNPC.Name: @unlock.TokenCost.Amount @unlock.TokenCost.TokenType tokens
                                                    @if (!unlock.CanAfford)
                                                    {
                                                        <span class="insufficient"> (Cannot afford)</span>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="route-blocked">
                                            🚫 No one here knows this route
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>