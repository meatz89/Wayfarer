@inherits TravelSelectionBase

@namespace Wayfarer.Pages

<div class="world-map-container">
    @* Context-aware travel planning status *@
    <div class="travel-status travel-context">
        @{
            var weightClass = TravelContext?.WeightClass ?? "";
            var weightStatus = TravelContext?.WeightStatus ?? "Light load";
            var baseStaminaCost = TravelContext?.BaseStaminaPenalty ?? 0;
            var currentStamina = TravelContext?.CurrentStamina ?? 0;
            var currentEquipment = TravelContext?.CurrentEquipmentCategories ?? new List<ItemCategory>();
        }
        <div class="travel-resources">
            <div class="resource-block stamina-block">
                <span class="resource-icon">⚡</span>
                <div class="resource-info">
                    <span class="resource-main">@currentStamina stamina</span>
                    <span class="resource-detail">Available for travel</span>
                </div>
            </div>
            <div class="resource-block weight-block">
                <span class="resource-icon">⚖️</span>
                <div class="resource-info">
                    <span class="resource-main @weightClass">@weightStatus</span>
                    @if (baseStaminaCost > 0)
                    {
                        <span class="resource-detail warning">+@baseStaminaCost stamina per segment</span>
                    }
                    else
                    {
                        <span class="resource-detail">No stamina penalty</span>
                    }
                </div>
            </div>
            @{
                var carriedLetterCount = TravelContext?.CarriedLetterCount ?? 0;
                var hasHeavyLetters = TravelContext?.HasHeavyLetters ?? false;
                var hasFragileLetters = TravelContext?.HasFragileLetters ?? false;
                var hasBulkyLetters = TravelContext?.HasBulkyLetters ?? false;
                var hasPerishableLetters = TravelContext?.HasPerishableLetters ?? false;
            }
            @if (carriedLetterCount > 0)
            {
                <div class="resource-block letter-block">
                    <span class="resource-icon">📬</span>
                    <div class="resource-info">
                        <span class="resource-main">@carriedLetterCount letter@(carriedLetterCount != 1 ? "s" : "") carried</span>
                        @if (hasHeavyLetters)
                        {
                            <span class="resource-detail warning">Heavy letters +1 stamina cost</span>
                        }
                        else if (hasBulkyLetters)
                        {
                            <span class="resource-detail warning">Bulky letters restrict movement</span>
                        }
                        else if (hasPerishableLetters)
                        {
                            <span class="resource-detail warning">Perishable letters - time sensitive</span>
                        }
                        else
                        {
                            <span class="resource-detail">No letter penalties</span>
                        }
                    </div>
                </div>
            }
            <div class="resource-block equipment-block">
                <span class="resource-icon">🛠️</span>
                <div class="resource-info">
                    <span class="resource-main">@currentEquipment.Count equipment types</span>
                    <span class="resource-detail">Affects route access</span>
                </div>
            </div>
        </div>
        @if (currentStamina < 3)
        {
            <div class="context-warning">
                ⚠️ Low stamina - consider resting before long journeys
            </div>
        }
    </div>


    <div class="locations-grid">
        @foreach (var destination in GetTravelableLocations())
        {
            <div class="location-card">
                <div class="location-name">
                    @destination.LocationName @(destination.LocationId == CurrentLocation.Id ? "(Current)" : "")
                </div>
                <div class="location-routes">
                    @{
                        var allRoutes = destination.Routes;
                        var lockedRoutes = allRoutes.Where(r => !r.IsDiscovered).ToList();
                        var unlockedRoutes = allRoutes.Where(r => r.IsDiscovered).ToList();
                    }
                    
                    @foreach (var route in unlockedRoutes)
                    {
                        var coinCost = route.CoinCost;
                        var staminaCost = route.TotalStaminaCost;
                        var canAfford = route.CanTravel;
                        var isBlocked = route.IsBlocked;
                        
                        <div class="route-option @(!canAfford ? "disabled" : "") @(isBlocked ? "blocked" : "")">
                            <div class="route-header">
                                <div class="route-name">
                                    @route.RouteName
                                    @if (isBlocked)
                                    {
                                        <span class="blocked-indicator">🔒</span>
                                    }
                                </div>
                                <div class="route-costs">
                                    <span class="cost-item @(!canAfford && route.CannotTravelReason?.Contains("coins") == true ? "insufficient" : "")">💰 @coinCost</span>
                                    <span class="cost-item @(!canAfford && route.CannotTravelReason?.Contains("stamina") == true ? "insufficient" : "")">
                                        ⚡ @staminaCost
                                        @if (route.TotalStaminaCost > route.BaseStaminaCost)
                                        {
                                            <span class="penalty-note">(+@(route.TotalStaminaCost - route.BaseStaminaCost) penalty)</span>
                                        }
                                    </span>
                                </div>
                            </div>
                            
                            @* Display token requirements *@
                            @{
                                var tokenReqs = GetRouteTokenRequirements(route);
                            }
                            @if (tokenReqs.Any())
                            {
                                <div class="route-tokens">
                                    @foreach (var (key, (required, current, displayName)) in tokenReqs)
                                    {
                                        var isTypeReq = key.StartsWith("type_");
                                        var hasEnough = current >= required;
                                        var tokenType = isTypeReq ? Enum.Parse<ConnectionType>(key.Substring(5)) : ConnectionType.Trust;
                                        var icon = isTypeReq ? GetTokenIcon(tokenType) : "🎭";
                                        
                                        <span class="token-requirement @(!hasEnough ? "insufficient" : "")">
                                            @icon @GetTokenRequirementDisplay(required, current) @displayName
                                        </span>
                                    }
                                </div>
                            }
                            
                            @if (route.TerrainCategories.Any())
                            {
                                <div class="route-terrain">
                                    @foreach (var terrain in route.TerrainCategories)
                                    {
                                        <span class="terrain-tag">@GetTerrainIcon(terrain) @terrain.ToString().Replace('_', ' ')</span>
                                    }
                                </div>
                            }
                            
                            @* Display departure time *@
                            @if (route.DepartureTime.HasValue)
                            {
                                <div class="departure-info">
                                    🕐 @route.DepartureTime.Value.ToString().Replace('_', ' ')
                                </div>
                            }
                            
                            @* Show blocking reason and hint *@
                            @if (isBlocked)
                            {
                                @if (!string.IsNullOrEmpty(route.BlockingReason))
                                {
                                    <div class="route-blocked">🚫 @route.BlockingReason</div>
                                }
                                @if (!string.IsNullOrEmpty(route.HintMessage))
                                {
                                    <div class="route-hint">💡 @route.HintMessage</div>
                                }
                            }
                            
                            @* Show only the most critical warning *@
                            @{
                                var criticalWarning = "";
                                if (hasFragileLetters && route.TerrainCategories != null && 
                                    (route.TerrainCategories.Contains(TerrainCategory.Requires_Climbing) || 
                                     route.TerrainCategories.Contains(TerrainCategory.Wilderness_Terrain)))
                                {
                                    criticalWarning = "Fragile letters at risk on this route!";
                                }
                                else if (route.Warnings?.Any() == true)
                                {
                                    criticalWarning = route.Warnings.First();
                                }
                            }
                            @if (!string.IsNullOrEmpty(criticalWarning))
                            {
                                <div class="route-warning">⚠️ @criticalWarning</div>
                            }
                            @if (!string.IsNullOrEmpty(route.Description))
                            {
                                <div class="route-description">@route.Description</div>
                            }
                            @if (canAfford && !isBlocked)
                            {
                                <button class="travel-button"
                                        @onclick="() => HandleTravelRoute(route)">
                                    Travel via @route.TransportMethod
                                </button>
                            }
                            else
                            {
                                <button class="travel-button"
                                        disabled="true">
                                    @(isBlocked ? "Blocked" : "Cannot Afford")
                                </button>
                            }
                        </div>
                    }
                    
                    @* Locked Routes Section *@
                    @if (lockedRoutes.Any())
                    {
                        <div class="route-section">
                            <h4 class="section-header">🔒 Locked Routes</h4>
                            @foreach (var route in lockedRoutes)
                            {
                                var unlockOptions = route.DiscoveryOptions ?? new List<RouteDiscoveryOptionViewModel>();
                                
                                <div class="route-option disabled">
                                    <div class="route-header">
                                        <div class="route-name">
                                            🔒 @route.RouteName
                                        </div>
                                        <div class="route-costs">
                                            <span class="cost-item">⚡ @route.BaseStaminaCost</span>
                                            <span class="cost-item">⏱️ @route.TimeCost hours</span>
                                        </div>
                                    </div>
                                    
                                    @if (!string.IsNullOrEmpty(route.Description))
                                    {
                                        <div class="route-description">@route.Description</div>
                                    }
                                    
                                    @if (unlockOptions.Any())
                                    {
                                        <div class="route-details">
                                            @foreach (var discovery in unlockOptions)
                                            {
                                                <div class="equipment-required">
                                                    Ask @discovery.TeachingNPCName: @discovery.RequiredTokens tokens
                                                    @if (!discovery.CanAfford)
                                                    {
                                                        <span class="insufficient"> (Need @discovery.RequiredTokens tokens, have @discovery.PlayerTokens)</span>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="route-blocked">
                                            🚫 No one here knows this route
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>