@page "/letterboard"
@inherits MainGameplayViewBase

@inject LetterTemplateRepository LetterTemplateRepository
@inject ConnectionTokenManager TokenManager
@inject StandingObligationManager ObligationManager
@inject NoticeBoardService NoticeBoardService

<div class="letter-board-container">
    <h2>Morning Letter Board</h2>
    
    @if (GameWorld.TimeManager.GetCurrentTimeBlock() != TimeBlocks.Dawn)
    {
        <div class="time-restriction">
            <span class="restriction-icon">‚è∞</span>
            <p>The Letter Board is only available during Dawn.</p>
            <small>Rest until morning to see available letters.</small>
        </div>
    }
    else
    {
        @* Queue Status *@
        <div class="queue-status-bar">
            <span class="queue-info">Queue: @LetterQueueManager.GetLetterCount() / 8 letters</span>
            @if (LetterQueueManager.IsQueueFull())
            {
                <span class="queue-warning">‚ö†Ô∏è Queue Full - Cannot accept new letters!</span>
            }
        </div>
        
        @* Available Letters *@
        <div class="available-letters">
            <h3>Available Letters</h3>
            @if (!availableLetters.Any())
            {
                <div class="no-letters">
                    <p>No letters available this morning.</p>
                    <small>Check back tomorrow or visit NPCs directly.</small>
                </div>
            }
            else
            {
                <div class="letter-grid">
                    @foreach (var letter in availableLetters)
                    {
                        <div class="letter-offer @(selectedLetter == letter ? "selected" : "")">
                            <div class="letter-header">
                                <span class="token-icon">@GetTokenIcon(letter.TokenType)</span>
                                <span class="letter-type">@letter.TokenType Letter</span>
                            </div>
                            
                            <div class="letter-route">
                                <div class="route-line">
                                    <span class="label">From:</span>
                                    <span class="sender">@letter.SenderName</span>
                                </div>
                                <div class="route-line">
                                    <span class="label">To:</span>
                                    <span class="recipient">@letter.RecipientName</span>
                                </div>
                            </div>
                            
                            <div class="letter-details">
                                <div class="detail-item">
                                    <span class="icon">üí∞</span>
                                    <span class="value">@letter.Payment coins</span>
                                </div>
                                <div class="detail-item">
                                    <span class="icon">‚è≥</span>
                                    <span class="value">@letter.Deadline days</span>
                                </div>
                                <div class="detail-item">
                                    <span class="icon">üìç</span>
                                    <span class="value">@GetDestinationHint(letter)</span>
                                </div>
                            </div>
                            
                            @if (!LetterQueueManager.IsQueueFull())
                            {
                                <button class="btn btn-primary accept-btn" @onclick="() => SelectLetter(letter)">
                                    @(selectedLetter == letter ? "Selected ‚úì" : "Select")
                                </button>
                            }
                        </div>
                    }
                </div>
                
                @* Action Buttons *@
                @if (selectedLetter != null && !LetterQueueManager.IsQueueFull())
                {
                    <div class="action-panel">
                        <h4>Selected: @selectedLetter.SenderName ‚Üí @selectedLetter.RecipientName</h4>
                        <div class="action-buttons">
                            <button class="btn btn-success" @onclick="AcceptSelectedLetter">
                                Accept Letter
                            </button>
                            <button class="btn btn-secondary" @onclick="() => selectedLetter = null">
                                Cancel Selection
                            </button>
                        </div>
                        
                        @* Show obligation warnings *@
                        @if (WouldViolateRefusalObligation(selectedLetter))
                        {
                            <div class="obligation-warning">
                                <span class="warning-icon">‚ö†Ô∏è</span>
                                <span>You have an obligation that prevents refusing @selectedLetter.TokenType letters!</span>
                            </div>
                        }
                    </div>
                }
            }
        </div>
        
        @* Notice Board Section - Active Letter Seeking *@
        <div class="notice-board-section">
            <h3>üìã Spend Tokens to Seek Letters</h3>
            <div class="notice-board-options">
                @* Anything Heading Direction Option *@
                <div class="board-option @(NoticeBoardService.CanAffordOption(NoticeBoardService.NoticeBoardOption.AnythingHeading) ? "" : "disabled")">
                    <div class="option-header">
                        <h4>"Anything heading..."</h4>
                        <span class="token-cost">2 tokens</span>
                    </div>
                    <div class="option-description">
                        Ask about letters going to specific locations
                    </div>
                    @if (ShowDirectionSelection)
                    {
                        <div class="direction-selection">
                            @foreach (var direction in NoticeBoardService.GetAvailableDirections())
                            {
                                <button class="direction-btn" @onclick="() => SelectDirection(direction)">
                                    @direction
                                </button>
                            }
                        </div>
                    }
                    else
                    {
                        <button class="option-button" 
                                @onclick="() => ShowDirectionSelection = true" 
                                disabled="@(!NoticeBoardService.CanAffordOption(NoticeBoardService.NoticeBoardOption.AnythingHeading))">
                            Ask Board Keeper
                        </button>
                    }
                </div>
                
                @* Looking for Specific Work Option *@
                <div class="board-option @(NoticeBoardService.CanAffordOption(NoticeBoardService.NoticeBoardOption.LookingForWork) ? "" : "disabled")">
                    <div class="option-header">
                        <h4>"Looking for work..."</h4>
                        <span class="token-cost">3 tokens</span>
                    </div>
                    <div class="option-description">
                        Request letters of a specific type
                    </div>
                    @if (ShowTypeSelection)
                    {
                        <div class="type-selection">
                            @foreach (ConnectionType tokenType in Enum.GetValues<ConnectionType>())
                            {
                                <button class="type-btn @GetTokenTypeClass(tokenType)" 
                                        @onclick="() => SelectType(tokenType)">
                                    @GetTokenIcon(tokenType) @tokenType
                                </button>
                            }
                        </div>
                    }
                    else
                    {
                        <button class="option-button" 
                                @onclick="() => ShowTypeSelection = true"
                                disabled="@(!NoticeBoardService.CanAffordOption(NoticeBoardService.NoticeBoardOption.LookingForWork))">
                            Specify Work Type
                        </button>
                    }
                </div>
                
                @* Urgent Deliveries Option *@
                <div class="board-option @(NoticeBoardService.CanAffordOption(NoticeBoardService.NoticeBoardOption.UrgentDeliveries) ? "" : "disabled")">
                    <div class="option-header">
                        <h4>"Urgent deliveries?"</h4>
                        <span class="token-cost">5 tokens</span>
                    </div>
                    <div class="option-description">
                        High-paying letters with tight deadlines
                    </div>
                    <button class="option-button urgent" 
                            @onclick="RequestUrgentDelivery"
                            disabled="@(!NoticeBoardService.CanAffordOption(NoticeBoardService.NoticeBoardOption.UrgentDeliveries))">
                        Check for Urgent Work
                    </button>
                </div>
            </div>
            
            <div class="token-summary">
                <div class="summary-header">Your Tokens:</div>
                <div class="token-list">
                    @foreach (var tokenCount in TokenManager.GetPlayerTokens())
                    {
                        @if (tokenCount.Value > 0)
                        {
                            <span class="token-display @GetTokenTypeClass(tokenCount.Key)">
                                @GetTokenIcon(tokenCount.Key) @tokenCount.Value
                            </span>
                        }
                    }
                </div>
                <div class="total-tokens">Total: @TokenManager.GetPlayerTokens().Values.Sum() tokens</div>
            </div>
        </div>
        
        @* Refresh Info *@
        <div class="refresh-info">
            <p>New letters appear each morning. Visit NPCs with strong connections (3+ tokens) for exclusive offers.</p>
        </div>
    }
    
    @* Back Button *@
    <div class="navigation-buttons">
        <button class="btn btn-secondary" @onclick="() => NavigationService.NavigateTo(CurrentViews.LocationScreen)">Back to Location</button>
    </div>
</div>

@code {

@namespace Wayfarer.Pages
    private List<Letter> availableLetters = new List<Letter>();
    private Letter? selectedLetter = null;
    private bool ShowDirectionSelection = false;
    private bool ShowTypeSelection = false;
    
    protected override void OnInitialized()
    {
        base.OnInitialized();
        CheckAndGenerateLetters();
    }
    
    private void CheckAndGenerateLetters()
    {
        var player = GameWorld.GetPlayer();
        var currentDay = GameWorld.CurrentDay;
        
        // Only generate if we haven't generated for today
        if (player.LastLetterBoardDay < currentDay && GameWorld.TimeManager.GetCurrentTimeBlock() == TimeBlocks.Dawn)
        {
            GenerateAvailableLetters();
            player.LastLetterBoardDay = currentDay;
        }
        // Otherwise, letters remain empty (already accepted or it's not dawn)
    }
    
    private void GenerateAvailableLetters()
    {
        availableLetters.Clear();
        
        // Generate 3-5 letters
        var random = new Random();
        int letterCount = random.Next(3, 6);
        
        for (int i = 0; i < letterCount; i++)
        {
            var template = LetterTemplateRepository.GetRandomTemplate();
            if (template == null) continue;
            
            // Get random NPCs for sender/recipient
            var allNpcs = NPCRepository.GetAllNPCs();
            if (allNpcs.Count < 2) continue;
            
            var sender = allNpcs[random.Next(allNpcs.Count)];
            var recipient = allNpcs[random.Next(allNpcs.Count)];
            
            // Ensure different sender and recipient
            if (sender.ID == recipient.ID && allNpcs.Count > 1)
            {
                recipient = allNpcs.Where(n => n.ID != sender.ID).First();
            }
            
            var letter = LetterTemplateRepository.GenerateLetterFromTemplate(template, sender.Name, recipient.Name);
            if (letter != null)
            {
                // Mark as board letter
                letter.GenerationReason = "Morning Letter Board";
                availableLetters.Add(letter);
            }
        }
    }
    
    private void SelectLetter(Letter letter)
    {
        selectedLetter = letter;
    }
    
    private void AcceptSelectedLetter()
    {
        if (selectedLetter == null || LetterQueueManager.IsQueueFull())
        {
            return;
        }
        
        // Check for refusal obligations
        if (WouldViolateRefusalObligation(selectedLetter))
        {
            var obligation = GetRefusalObligation(selectedLetter);
            if (obligation != null)
            {
                MessageSystem.AddSystemMessage(
                    $"Cannot refuse {selectedLetter.TokenType} letter due to {obligation.Name}",
                    SystemMessageTypes.Warning
                );
                return;
            }
        }
        
        // Add to queue
        int position = LetterQueueManager.AddLetterWithObligationEffects(selectedLetter);
        
        if (position > 0)
        {
            MessageSystem.AddSystemMessage(
                $"Accepted letter from {selectedLetter.SenderName}! Added to queue position {position}.",
                SystemMessageTypes.Success
            );
            
            // Remove from available letters
            availableLetters.Remove(selectedLetter);
            selectedLetter = null;
            
            StateHasChanged();
        }
        else
        {
            MessageSystem.AddSystemMessage(
                "Failed to add letter to queue.",
                SystemMessageTypes.Danger
            );
        }
    }
    
    private bool WouldViolateRefusalObligation(Letter letter)
    {
        return ObligationManager.IsActionForbidden("refuse", letter, out _);
    }
    
    private StandingObligation? GetRefusalObligation(Letter letter)
    {
        var obligations = ObligationManager.GetActiveObligations();
        
        if (letter.TokenType == ConnectionType.Noble)
        {
            return obligations.FirstOrDefault(o => o.HasEffect(ObligationEffect.NoNobleRefusal));
        }
        
        if (letter.TokenType == ConnectionType.Common)
        {
            return obligations.FirstOrDefault(o => o.HasEffect(ObligationEffect.NoCommonRefusal));
        }
        
        return null;
    }
    
    private string GetTokenIcon(ConnectionType type)
    {
        return type switch
        {
            ConnectionType.Trust => "‚ù§Ô∏è",
            ConnectionType.Trade => "ü™ô",
            ConnectionType.Noble => "üëë",
            ConnectionType.Common => "üç∫",
            ConnectionType.Shadow => "üåë",
            _ => "‚ùì"
        };
    }
    
    private string GetDestinationHint(Letter letter)
    {
        // In a full implementation, this would show the general region
        // For now, just show that it's somewhere
        return "Local area";
    }
    
    // Notice Board Methods
    private async Task SelectDirection(string direction)
    {
        ShowDirectionSelection = false;
        
        var letter = NoticeBoardService.UseNoticeBoard(
            NoticeBoardService.NoticeBoardOption.AnythingHeading, 
            direction
        );
        
        if (letter != null)
        {
            var position = LetterQueueManager.AddLetterToFirstEmpty(letter);
            if (position > 0)
            {
                MessageSystem.AddSystemMessage(
                    $"üì¨ Letter added to your queue at position {position}!",
                    SystemMessageTypes.Success
                );
                StateHasChanged();
            }
        }
    }
    
    private async Task SelectType(ConnectionType tokenType)
    {
        ShowTypeSelection = false;
        
        var letter = NoticeBoardService.UseNoticeBoard(
            NoticeBoardService.NoticeBoardOption.LookingForWork,
            null,
            tokenType
        );
        
        if (letter != null)
        {
            var position = LetterQueueManager.AddLetterToFirstEmpty(letter);
            if (position > 0)
            {
                MessageSystem.AddSystemMessage(
                    $"üì¨ {tokenType} letter added to your queue at position {position}!",
                    SystemMessageTypes.Success
                );
                StateHasChanged();
            }
        }
    }
    
    private async Task RequestUrgentDelivery()
    {
        var letter = NoticeBoardService.UseNoticeBoard(
            NoticeBoardService.NoticeBoardOption.UrgentDeliveries
        );
        
        if (letter != null)
        {
            var position = LetterQueueManager.AddLetterToFirstEmpty(letter);
            if (position > 0)
            {
                MessageSystem.AddSystemMessage(
                    $"üì¨ URGENT letter added to your queue at position {position}!",
                    SystemMessageTypes.Warning
                );
                StateHasChanged();
            }
        }
    }
    
    private string GetTokenTypeClass(ConnectionType type)
    {
        return type switch
        {
            ConnectionType.Trust => "trust-token",
            ConnectionType.Trade => "trade-token",
            ConnectionType.Noble => "noble-token",
            ConnectionType.Common => "common-token",
            ConnectionType.Shadow => "shadow-token",
            _ => ""
        };
    }
}