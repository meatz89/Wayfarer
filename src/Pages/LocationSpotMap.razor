@inherits LocationSpotMapBase

@* LocationSpotMap.razor *@

<div class="locations-grid">
    @foreach (LocationSpot spot in GetKnownSpots())
    {
        <div class="@(!spot.IsClosed ? "enabled" : "disabled")">

            <div class="location-card @(spot.SpotID == CurrentSpot.SpotID ? "current" : "reachable")">
                <div class="location-spot-properties">
                    @foreach (var prop in StyleHelper.GetSpotProperties(GetLocation(), spot))
                    {
                        <div class="property-tag @prop.CssClass">
                            <span class="property-icon">@prop.Icon</span>
                            <span class="property-text">@prop.Text</span>
                        </div>
                    }
                </div>
                <div class="location-name">
                    @spot.Name @(spot.IsClosed ? "(Closed)" : "")
                </div>
                <div class="location-type">@spot.Description</div>

                @* Show compact NPC information for this spot *@
                @{
                    var allSpotNPCs = GetAllNPCsForSpot(spot);
                    var availableNPCs = GetAvailableNPCsForSpot(spot);
                    var currentTime = GameWorld.TimeManager.GetCurrentTimeBlock();
                }
                @if (allSpotNPCs.Any())
                {
                    <div class="npcs-section">
                        <div class="npcs-header">People:</div>
                        @foreach (var npc in allSpotNPCs)
                        {
                            bool isCurrentlyAvailable = IsNPCCurrentlyAvailable(npc);
                            string npcId = $"npc-{spot.SpotID}-{npc.Name}";
                            bool isExpanded = GetNPCExpandedState(npcId);
                            <div class="npc-card @(isCurrentlyAvailable ? "npc-available" : "npc-unavailable")">
                                <div class="npc-compact-info" @onclick="() => ToggleNPCExpansion(npcId)">
                                    <div class="npc-status-line">
                                        <span class="status-indicator">@(isCurrentlyAvailable ? "🟢" : "🔴")</span>
                                        <span class="npc-name">@npc.Name</span>
                                        <span class="npc-profession">(@npc.Profession.ToString().Replace("_", " "))</span>
                                        <span class="expand-toggle">@(isExpanded ? "▼" : "►")</span>
                                    </div>
                                    @if (isCurrentlyAvailable && npc.ProvidedServices.Any())
                                    {
                                        <div class="npc-services-compact">
                                            @foreach (var service in npc.ProvidedServices.Take(3))
                                            {
                                                <span class="service-icon">@GetServiceIcon(service)</span>
                                            }
                                            @if (npc.ProvidedServices.Count > 3)
                                            {
                                                <span class="service-more">+@(npc.ProvidedServices.Count - 3)</span>
                                            }
                                        </div>
                                    }
                                </div>
                                
                                @if (isExpanded)
                                {
                                    <div class="npc-expanded-info">
                                        <div class="npc-schedule-info">
                                            <div class="npc-availability">
                                                <strong>Schedule:</strong> @GetNPCScheduleDescription(npc.AvailabilitySchedule)
                                            </div>
                                            <div class="npc-current-status @(isCurrentlyAvailable ? "status-available" : "status-unavailable")">
                                                @if (!isCurrentlyAvailable)
                                                {
                                                    <span>@GetNextAvailableTime(npc)</span>
                                                }
                                            </div>
                                        </div>
                                        
                                        @if (npc.ProvidedServices.Any())
                                        {
                                            <div class="npc-services">
                                                <strong>Services:</strong> @string.Join(", ", npc.ProvidedServices.Select(s => s.ToString().Replace("_", " ")))
                                            </div>
                                        }
                                        
                                        @* Show what the player can do with this NPC *@
                                        @if (isCurrentlyAvailable)
                                        {
                                            <div class="npc-actions">
                                                @if (npc.ProvidedServices.Contains(ServiceTypes.Trade))
                                                {
                                                    <span class="service-action">💰 Can trade items</span>
                                                }
                                                @if (npc.ProvidedServices.Contains(ServiceTypes.Rest))
                                                {
                                                    <span class="service-action">🛏️ Can rest here</span>
                                                }
                                                @if (npc.ProvidedServices.Contains(ServiceTypes.EquipmentRepair))
                                                {
                                                    <span class="service-action">🔧 Can repair equipment</span>
                                                }
                                                @if (npc.ProvidedServices.Contains(ServiceTypes.Information))
                                                {
                                                    <span class="service-action">💬 Can provide information</span>
                                                }
                                                @if (npc.ProvidedServices.Contains(ServiceTypes.Training))
                                                {
                                                    <span class="service-action">📚 Can provide training</span>
                                                }
                                            </div>
                                        }
                                        
                                        @* Show letter offers if NPC has sufficient relationship *@
                                        @if (isCurrentlyAvailable && HasLetterOffers(npc))
                                        {
                                            <div class="npc-letter-offers">
                                                <h4>@npc.Name approaches you:</h4>
                                                @foreach (var offer in GetLetterOffers(npc))
                                                {
                                                    <div class="letter-offer">
                                                        <div class="offer-message">
                                                            <span class="offer-icon">💬</span>
                                                            <span class="offer-text">@offer.Message</span>
                                                        </div>
                                                        <div class="offer-details">
                                                            <span class="letter-type">@GetTokenIcon(offer.LetterType) @offer.LetterType</span>
                                                            <span class="payment">💰 @offer.Payment coins</span>
                                                            <span class="deadline">⏰ @offer.Deadline days</span>
                                                        </div>
                                                        <button class="accept-offer-button" @onclick="() => AcceptLetterOffer(npc.ID, offer.Id)">
                                                            Accept
                                                        </button>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        
                                        @* Show network referral option if NPC can provide referrals *@
                                        @if (isCurrentlyAvailable && CanRequestReferral(npc))
                                        {
                                            <div class="npc-referral-option">
                                                <h4>Network Referrals:</h4>
                                                <p class="referral-description">
                                                    @npc.Name can introduce you to their contacts (1 token)
                                                </p>
                                                <button class="referral-button" @onclick="() => RequestReferral(npc.ID)">
                                                    Ask for Introduction
                                                </button>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="npcs-section">
                        <div class="no-npcs">No people at this location</div>
                    </div>
                }

        @if (spot.SpotID == CurrentSpot.SpotID)
        {
            @* Actions removed - using LocationActionManager and letter queue system *@
                }
                else
                {
                    @* Add travel option if not current spot *@
                    <button class="action-button" disabled="@(!GameWorldManager.CanMoveToSpot(spot.SpotID))"
                            @onclick="() => OnSpotSelected.InvokeAsync(spot)">
                        MOVE HERE
                    </button>
                }
            </div>
        </div>
    }
</div>

@namespace Wayfarer.Pages

@* Action preview removed - location actions handled by LocationActionManager *@
