@inherits LocationSpotMapBase

@* LocationSpotMap.razor *@

<div class="locations-grid">
    @foreach (LocationSpot spot in GetKnownSpots())
    {
        <div class="@(!spot.IsClosed ? "enabled" : "disabled")">

            <div class="location-card @(spot.SpotID == CurrentSpot.SpotID ? "current" : "reachable")">
                <div class="location-spot-properties">
                    @foreach (var prop in StyleHelper.GetSpotProperties(GetLocation(), spot))
                    {
                        <div class="property-tag @prop.CssClass">
                            <span class="property-icon">@prop.Icon</span>
                            <span class="property-text">@prop.Text</span>
                        </div>
                    }
                </div>
                <div class="location-name">
                    @spot.Name @(spot.IsClosed ? "(Closed)" : "")
                </div>
                <div class="location-type">@spot.Description</div>

                @* Show compact NPC information for this spot *@
                @{
                    var allSpotNPCs = GetAllNPCsForSpot(spot);
                    var availableNPCs = GetAvailableNPCsForSpot(spot);
                    var currentTime = GameWorld.TimeManager.GetCurrentTimeBlock();
                }
                @if (allSpotNPCs.Any())
                {
                    <div class="npcs-section">
                        <div class="npcs-header">People:</div>
                        @foreach (var npc in allSpotNPCs)
                        {
                            bool isCurrentlyAvailable = IsNPCCurrentlyAvailable(npc);
                            string npcId = $"npc-{spot.SpotID}-{npc.Name}";
                            bool isExpanded = GetNPCExpandedState(npcId);
                            <div class="npc-card @(isCurrentlyAvailable ? "npc-available" : "npc-unavailable")">
                                <div class="npc-compact-info" @onclick="() => ToggleNPCExpansion(npcId)">
                                    <div class="npc-status-line">
                                        <span class="status-indicator">@(isCurrentlyAvailable ? "🟢" : "🔴")</span>
                                        <span class="npc-name">@npc.Name</span>
                                        <span class="npc-profession">(@npc.Profession.ToString().Replace("_", " "))</span>
                                        <span class="expand-toggle">@(isExpanded ? "▼" : "►")</span>
                                    </div>
                                    @if (isCurrentlyAvailable && npc.ProvidedServices.Any())
                                    {
                                        <div class="npc-services-compact">
                                            @foreach (var service in npc.ProvidedServices.Take(3))
                                            {
                                                <span class="service-icon">@GetServiceIcon(service)</span>
                                            }
                                            @if (npc.ProvidedServices.Count > 3)
                                            {
                                                <span class="service-more">+@(npc.ProvidedServices.Count - 3)</span>
                                            }
                                        </div>
                                    }
                                </div>
                                
                                @if (isExpanded)
                                {
                                    <div class="npc-expanded-info">
                                        <div class="npc-schedule-info">
                                            <div class="npc-availability">
                                                <strong>Schedule:</strong> @GetNPCScheduleDescription(npc.AvailabilitySchedule)
                                            </div>
                                            <div class="npc-current-status @(isCurrentlyAvailable ? "status-available" : "status-unavailable")">
                                                @if (!isCurrentlyAvailable)
                                                {
                                                    <span>@GetNextAvailableTime(npc)</span>
                                                }
                                            </div>
                                        </div>
                                        
                                        @if (npc.ProvidedServices.Any())
                                        {
                                            <div class="npc-services">
                                                <strong>Services:</strong> @string.Join(", ", npc.ProvidedServices.Select(s => s.ToString().Replace("_", " ")))
                                            </div>
                                        }
                                        
                                        @* Show what the player can do with this NPC *@
                                        @if (isCurrentlyAvailable)
                                        {
                                            <div class="npc-actions">
                                                @if (npc.ProvidedServices.Contains(ServiceTypes.Trade))
                                                {
                                                    <span class="service-action">💰 Can trade items</span>
                                                }
                                                @if (npc.ProvidedServices.Contains(ServiceTypes.Rest))
                                                {
                                                    <span class="service-action">🛏️ Can rest here</span>
                                                }
                                                @if (npc.ProvidedServices.Contains(ServiceTypes.EquipmentRepair))
                                                {
                                                    <span class="service-action">🔧 Can repair equipment</span>
                                                }
                                                @if (npc.ProvidedServices.Contains(ServiceTypes.Information))
                                                {
                                                    <span class="service-action">💬 Can provide information</span>
                                                }
                                                @if (npc.ProvidedServices.Contains(ServiceTypes.Training))
                                                {
                                                    <span class="service-action">📚 Can provide training</span>
                                                }
                                            </div>
                                        }
                                        
                                        @* Show letter offers if NPC has sufficient relationship *@
                                        @if (isCurrentlyAvailable && HasLetterOffers(npc))
                                        {
                                            <div class="npc-letter-offers">
                                                <h4>@npc.Name approaches you:</h4>
                                                @foreach (var offer in GetLetterOffers(npc))
                                                {
                                                    <div class="letter-offer">
                                                        <div class="offer-message">
                                                            <span class="offer-icon">💬</span>
                                                            <span class="offer-text">@offer.Message</span>
                                                        </div>
                                                        <div class="offer-details">
                                                            <span class="letter-type">@GetTokenIcon(offer.LetterType) @offer.LetterType</span>
                                                            <span class="payment">💰 @offer.Payment coins</span>
                                                            <span class="deadline">⏰ @offer.Deadline days</span>
                                                        </div>
                                                        <button class="accept-offer-button" @onclick="() => AcceptLetterOffer(npc.ID, offer.Id)">
                                                            Accept
                                                        </button>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="npcs-section">
                        <div class="no-npcs">No people at this location</div>
                    </div>
                }

        @if (spot.SpotID == CurrentSpot.SpotID)
        {
            <div class="action-list">
                @foreach (UserActionOption action in GameWorld.ActionStateTracker.LocationSpotActions)
                {
                    if(action.locationAction.ActionExecutionType == ActionExecutionTypes.Instant)
                    {
                        <button class="approach-button" @onclick="() => HandleActionSelection(action)">
                                @action.locationAction.Name
                        </button >
                    }
                    else
                    {
                        <div class="action-header @(selectedAction?.locationAction.ActionId == action.locationAction.ActionId ? "expanded" : "")"
                                @onclick="() => ToggleActionApproaches(action)">
                            <div class="action-header-content">
                                <span class="action-title">@action.locationAction.Name</span>
                                <span class="action-type">@action.locationAction.RequiredCardType</span>
                            </div>
                            <span class="action-toggle-icon">@(selectedAction?.locationAction.ActionId == action.locationAction.ActionId ? "▼" : "►")</span>
                        </div>
                        @if (selectedAction?.locationAction.ActionId == action.locationAction.ActionId)
                        {
                            <div class="approaches-container">
                                <div class="approaches-description">
                                    @action.locationAction.ObjectiveDescription
                                </div>

                                <div class="approaches-list">
                                    @foreach (var approach in action.locationAction.Approaches)
                                    {
                                        bool isCompatible = IsValidCardForApproach(approach.RequiredCardType);
                                        <div class="approach-option @(isCompatible ? "compatible-approach" : "incompatible-approach")"
                                                @onclick="() => ActivateHighlightMode(approach.RequiredCardType)">
                                            <div class="approach-content">
                                                <div class="approach-header">
                                                    <h4>@approach.Name</h4>
                                                    <div class="card-requirement">
                                                        <div class="card-preview @GetCardTypeClass(approach.RequiredCardType)"></div>
                                                        <span>@approach.RequiredCardType</span>
                                                    </div>
                                                </div>

                                                <p class="approach-description">@approach.Description</p>
                                            </div>

                                            <button class="approach-button @(isCompatible ? "compatible-button" : "incompatible-button")"
                                                @onclick="() => HandleApproachSelection(action, approach)"
                                                @onmouseover="(e) => HandleShowApproachTooltip(action, approach, e)"
                                                @onmouseout="HandleHideTooltip">
                                                @(isCompatible ? "Use Selected Card" : "Select Approach")
                                            </button>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }
                }
            </div>
                }
                else
                {
                    @* Add travel option if not current spot *@
                    <button class="action-button" disabled="@(!GameWorldManager.CanMoveToSpot(spot.SpotID))"
                            @onclick="() => OnSpotSelected.InvokeAsync(spot)">
                        MOVE HERE
                    </button>
                }
            </div>
        </div>
    }
</div>

@if (showTooltip && hoveredApproach != null)

@namespace Wayfarer.Pages
{
    <div class="tooltip" style="left: @(mouseX + 10)px; top: @(mouseY + 10)px">
        <ActionPreview CurrentAction="@selectedAction"
                       CurrentApproach="@hoveredApproach"
                       GameWorld="@GameWorld" />
    </div>
}
