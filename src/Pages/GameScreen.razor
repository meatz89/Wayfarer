@using Wayfarer.Pages.Components
@inherits GameScreenBase

@namespace Wayfarer.Pages

<div class="game-container">
    <!-- Time Segment Header (always visible) -->
    <div class="time-header">
        <div class="day-display">@GetDayDisplay()</div>
        <div class="time-segment-display">
            <div class="period-name">@GetTimePeriodName()</div>
            <div class="segment-dots">
                @foreach (var dot in GetSegmentDots())
                {
                    <div class="segment-dot @dot"></div>
                }
            </div>
            <div class="segment-counter">[@GetCurrentSegmentInPeriod()/@GetTotalSegmentsInPeriod()]</div>
        </div>
    </div>

    <!-- Player Resources Bar (enhanced from mockup) -->
    <div class="resources-bar">
        <div class="resource-group">
            <div class="resource @(Health < 30 ? "low" : "") @(Health < 15 ? "critical" : "")">
                <div class="resource-icon"><span class="icon-health"></span></div>
                <div class="resource-info">
                    <div class="resource-label">Health</div>
                    <div class="resource-value">@Health</div>
                </div>
            </div>
            <div class="resource @(Hunger > 60 ? "low" : "") @(Hunger > 80 ? "critical" : "")">
                <div class="resource-icon"><span class="icon-hunger"></span></div>
                <div class="resource-info">
                    <div class="resource-label">Hunger</div>
                    <div class="resource-value">@Hunger</div>
                </div>
            </div>
            <div class="resource @(Focus < 3 ? "low" : "") @(Focus < 2 ? "critical" : "")">
                <div class="resource-icon"><span class="icon-focus"></span></div>
                <div class="resource-info">
                    <div class="resource-label">Focus</div>
                    <div class="resource-value">@Focus/@MaxFocus</div>
                </div>
            </div>
            <div class="resource">
                <div class="resource-icon"><span class="icon-attention"></span></div>
                <div class="resource-info">
                    <div class="resource-label">Stamina</div>
                    <div class="resource-value">@GetStaminaDisplay()</div>
                </div>
            </div>
            <div class="resource @(Coins < 5 ? "low" : "") @(Coins < 2 ? "critical" : "")">
                <div class="resource-icon"><span class="icon-coin"></span></div>
                <div class="resource-info">
                    <div class="resource-label">Coins</div>
                    <div class="resource-value">@Coins</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed Buttons Container (Journal + Map) -->
    <div class="fixed-buttons-container">
        <button class="journal-btn" @onclick="ToggleJournal">üìñ Journal</button>
        <button class="map-btn" @onclick="ToggleMap">üó∫Ô∏è Map</button>
    </div>

    <!-- Journal Modal -->
    @if (_showJournal)
    {
        <div class="modal-overlay" @onclick="ToggleJournal">
            <div class="modal-content" @onclick:stopPropagation>
                <DiscoveryJournal OnClose="ToggleJournal" />
            </div>
        </div>
    }

    <!-- Obligation Discovery Modal -->
    @if (_showObligationDiscoveryModal && _obligationDiscoveryResult != null)
    {
        <div class="modal-overlay" @onclick="DismissObligationDiscovery">
            <div class="modal-content" @onclick:stopPropagation>
                <ObligationDiscoveryModal Data="@_obligationDiscoveryResult"
                                           OnBeginIntro="BeginObligationIntro"
                                           OnDismiss="DismissObligationDiscovery" />
            </div>
        </div>
    }

    <!-- Obligation Intro Modal -->
    @if (_showObligationIntroModal && _obligationIntroResult != null)
    {
        <div class="modal-overlay" @onclick="CloseObligationIntroModal">
            <div class="modal-content" @onclick:stopPropagation>
                <ObligationIntroModal Data="@_obligationIntroResult"
                                        OnBegin="CompleteObligationIntroAction"
                                        OnDismiss="CloseObligationIntroModal" />
            </div>
        </div>
    }

    <!-- Obligation Activation Modal -->
    @if (_showObligationActivationModal && _obligationActivationResult != null)
    {
        <div class="modal-overlay" @onclick="CloseObligationActivationModal">
            <div class="modal-content" @onclick:stopPropagation>
                <ObligationActivationModal Data="@_obligationActivationResult" OnClose="CloseObligationActivationModal" />
            </div>
        </div>
    }

    <!-- Obligation Progress Modal -->
    @if (_showObligationProgressModal && _obligationProgressResult != null)
    {
        <div class="modal-overlay" @onclick="CloseObligationProgressModal">
            <div class="modal-content" @onclick:stopPropagation>
                <ObligationProgressModal Data="@_obligationProgressResult" OnClose="CloseObligationProgressModal" />
            </div>
        </div>
    }

    <!-- Obligation Complete Modal -->
    @if (_showObligationCompleteModal && _obligationCompleteResult != null)
    {
        <div class="modal-overlay" @onclick="CloseObligationCompleteModal">
            <div class="modal-content" @onclick:stopPropagation>
                <ObligationCompleteModal Data="@_obligationCompleteResult" OnClose="CloseObligationCompleteModal" />
            </div>
        </div>
    }

    <!-- Dynamic Content Area -->
    <CascadingValue Value="@this">
        <div @key="@($"{CurrentScreen}_{ContentVersion}")">
            @{
                Console.WriteLine($"[GameScreen.razor] Rendering with CurrentScreen={CurrentScreen}, ContentVersion={ContentVersion}");
            }
            @switch (CurrentScreen)
            {
                case ScreenMode.Location:
                    <LocationContent OnActionExecuted="RefreshUI" />
                    break;
                    
                case ScreenMode.Exchange:
                    <ExchangeContent Context="@CurrentExchangeContext" OnExchangeEnd="HandleExchangeEnd" />
                    break;
                    
                case ScreenMode.Travel:
                    <TravelContent
                        CurrentLocation="@GetCurrentLocation()"
                        OnNavigate="() => NavigateToScreen(ScreenMode.Location)" />
                    break;
                    
                case ScreenMode.SocialChallenge:
                    <ConversationContent Context="@CurrentSocialContext" OnConversationEnd="HandleConversationEnd" />
                    break;

                case ScreenMode.MentalChallenge:
                    <MentalContent Context="@CurrentMentalContext" OnChallengeEnd="HandleMentalEnd" />
                    break;

                case ScreenMode.PhysicalChallenge:
                    <PhysicalContent Context="@CurrentPhysicalContext" OnChallengeEnd="HandlePhysicalEnd" />
                    break;

                case ScreenMode.ConversationTree:
                    <ConversationTreeContent Context="@CurrentConversationTreeContext" OnConversationEnd="HandleConversationTreeEnd" />
                    break;

                case ScreenMode.Observation:
                    <ObservationContent Context="@CurrentObservationContext" OnObservationEnd="HandleObservationEnd" />
                    break;

                case ScreenMode.Emergency:
                    <EmergencyContent Context="@CurrentEmergencyContext" OnEmergencyEnd="HandleEmergencyEnd" />
                    break;

                case ScreenMode.HexMap:
                    <HexMapContent />
                    break;

                default:
                    <LocationContent OnActionExecuted="RefreshUI" />
                    break;
            }
        </div>
    </CascadingValue>
    
    <!-- Debug Panel (Development Only) -->
    @if (IsDevelopmentMode())
    {
        <DebugPanel />
    }

    <!-- Toast Notifications -->
    <MessageDisplay />
</div>