@using Wayfarer.Pages.Components
@inherits GameScreenBase

@namespace Wayfarer.Pages

<div class="game-container">
    <!-- Time Segment Header (always visible) -->
    <div class="time-header">
        <div class="day-display">@GetDayDisplay()</div>
        <div class="time-segment-display">
            <div class="period-name">@GetTimePeriodName()</div>
            <div class="segment-dots">
                @foreach (var dot in GetSegmentDots())
                {
                    <div class="segment-dot @dot"></div>
                }
            </div>
            <div class="segment-counter">[@GetCurrentSegmentInPeriod()/@GetTotalSegmentsInPeriod()]</div>
        </div>
    </div>

    <!-- Player Resources Bar (enhanced from mockup) -->
    <div class="resources-bar">
        <div class="resource-group">
            <div class="resource @(Health < 30 ? "low" : "") @(Health < 15 ? "critical" : "")">
                <div class="resource-icon"><span class="icon-health"></span></div>
                <div class="resource-info">
                    <div class="resource-label">Health</div>
                    <div class="resource-value">@Health</div>
                </div>
            </div>
            <div class="resource @(Hunger > 60 ? "low" : "") @(Hunger > 80 ? "critical" : "")">
                <div class="resource-icon"><span class="icon-hunger"></span></div>
                <div class="resource-info">
                    <div class="resource-label">Hunger</div>
                    <div class="resource-value">@Hunger</div>
                </div>
            </div>
            <div class="resource">
                <div class="resource-icon"><span class="icon-attention"></span></div>
                <div class="resource-info">
                    <div class="resource-label">Stamina</div>
                    <div class="resource-value">@GetStaminaDisplay()</div>
                </div>
            </div>
            <div class="resource @(Coins < 5 ? "low" : "") @(Coins < 2 ? "critical" : "")">
                <div class="resource-icon"><span class="icon-coin"></span></div>
                <div class="resource-info">
                    <div class="resource-label">Coins</div>
                    <div class="resource-value">@Coins</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Journal Button -->
    <div class="journal-button-container">
        <button class="journal-btn" @onclick="ToggleJournal">ðŸ“– Journal</button>
    </div>

    <!-- Journal Modal -->
    @if (_showJournal)
    {
        <div class="modal-overlay" @onclick="ToggleJournal">
            <div class="modal-content" @onclick:stopPropagation>
                <DiscoveryJournal OnClose="ToggleJournal" />
            </div>
        </div>
    }

    <!-- Investigation Discovery Modal -->
    @if (_showInvestigationDiscoveryModal && _investigationDiscoveryResult != null)
    {
        <div class="modal-overlay" @onclick="DismissInvestigationDiscovery">
            <div class="modal-content" @onclick:stopPropagation>
                <InvestigationDiscoveryModal Data="@_investigationDiscoveryResult"
                                           OnBeginIntro="BeginInvestigationIntro"
                                           OnDismiss="DismissInvestigationDiscovery" />
            </div>
        </div>
    }

    <!-- Investigation Activation Modal -->
    @if (_showInvestigationActivationModal && _investigationActivationResult != null)
    {
        <div class="modal-overlay" @onclick="CloseInvestigationActivationModal">
            <div class="modal-content" @onclick:stopPropagation>
                <InvestigationActivationModal Data="@_investigationActivationResult" OnClose="CloseInvestigationActivationModal" />
            </div>
        </div>
    }

    <!-- Investigation Progress Modal -->
    @if (_showInvestigationProgressModal && _investigationProgressResult != null)
    {
        <div class="modal-overlay" @onclick="CloseInvestigationProgressModal">
            <div class="modal-content" @onclick:stopPropagation>
                <InvestigationProgressModal Data="@_investigationProgressResult" OnClose="CloseInvestigationProgressModal" />
            </div>
        </div>
    }

    <!-- Investigation Complete Modal -->
    @if (_showInvestigationCompleteModal && _investigationCompleteResult != null)
    {
        <div class="modal-overlay" @onclick="CloseInvestigationCompleteModal">
            <div class="modal-content" @onclick:stopPropagation>
                <InvestigationCompleteModal Data="@_investigationCompleteResult" OnClose="CloseInvestigationCompleteModal" />
            </div>
        </div>
    }

    <!-- Dynamic Content Area -->
    <CascadingValue Value="@this">
        <div @key="@($"{CurrentScreen}_{ContentVersion}")">
            @{
                Console.WriteLine($"[GameScreen.razor] Rendering with CurrentScreen={CurrentScreen}, ContentVersion={ContentVersion}");
            }
            @switch (CurrentScreen)
            {
                case ScreenMode.Location:
                    <LocationContent OnActionExecuted="RefreshUI" />
                    break;
                    
                case ScreenMode.Exchange:
                    <ExchangeContent Context="@CurrentExchangeContext" OnExchangeEnd="HandleExchangeEnd" />
                    break;
                    
                case ScreenMode.Travel:
                    <TravelContent 
                        CurrentLocation="@GetCurrentLocation()"
                        OnTravelRoute="HandleTravelRoute"
                        OnNavigate="HandleNavigation" />
                    break;
                    
                case ScreenMode.SocialChallenge:
                    <ConversationContent Context="@CurrentSocialContext" OnConversationEnd="HandleConversationEnd" />
                    break;

                case ScreenMode.MentalChallenge:
                    <MentalContent Context="@CurrentMentalContext" OnChallengeEnd="HandleMentalEnd" />
                    break;

                case ScreenMode.PhysicalChallenge:
                    <PhysicalContent Context="@CurrentPhysicalContext" OnChallengeEnd="HandlePhysicalEnd" />
                    break;

                default:
                    <LocationContent OnActionExecuted="RefreshUI" />
                    break;
            }
        </div>
    </CascadingValue>
    
    <!-- Debug Panel (Development Only) -->
    @if (IsDevelopmentMode())
    {
        <DebugPanel />
    }

    <!-- Toast Notifications -->
    <MessageDisplay />
</div>