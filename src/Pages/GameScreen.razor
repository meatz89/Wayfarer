@using Wayfarer.Pages.Components
@inherits GameScreenBase

@namespace Wayfarer.Pages

<div class="game-screen">
    <!-- Fixed Header with Resources -->
    <div class="game-header">
        <div class="resources-bar">
            <div class="resource-group">
                <div class="resource @(Coins < 5 ? "low" : "")">
                    <div class="resource-icon coins">üí∞</div>
                    <div class="resource-value">@Coins</div>
                    <span>Coins</span>
                </div>
                <div class="resource @(Health < 30 ? "critical" : Health < 50 ? "low" : "")">
                    <div class="resource-icon health">‚ù§Ô∏è</div>
                    <div class="resource-value">@Health</div>
                    <span>Health</span>
                </div>
                <div class="resource @(Food > 80 ? "critical" : Food > 60 ? "low" : "")">
                    <div class="resource-icon hunger">üçû</div>
                    <div class="resource-value">@Food</div>
                    <span>Hunger</span>
                </div>
                <div class="resource">
                    <div class="resource-icon attention">üëÅÔ∏è</div>
                    <div class="resource-value">@Attention/@MaxAttention</div>
                    <span>Attention</span>
                </div>
            </div>
            <div class="time-group">
                <span class="time-display">@CurrentTime</span>
                <span class="time-period">@TimePeriod</span>
                @if (!string.IsNullOrEmpty(MostUrgentDeadline))
                {
                    <span class="deadline">@MostUrgentDeadline</span>
                }
            </div>
        </div>
        
        <!-- Location/Context Bar -->
        <div class="context-bar">
            <div class="location-path">
                @if (!string.IsNullOrEmpty(CurrentLocationPath))
                {
                    @foreach (var segment in CurrentLocationPath.Split(" ‚Üí "))
                    {
                        <span>@segment</span>
                    }
                }
            </div>
            @if (!string.IsNullOrEmpty(CurrentSpot))
            {
                <div class="spot-info">@CurrentSpot</div>
            }
        </div>
    </div>

    <!-- Dynamic Content Area -->
    <CascadingValue Value="@this">
        <div class="game-content" @key="@($"{CurrentScreen}_{ContentVersion}")">
            @switch (CurrentScreen)
            {
                case ScreenMode.Location:
                    <LocationContent OnActionExecuted="RefreshUI" />
                    break;
                    
                case ScreenMode.Conversation:
                    <ConversationContent Context="@CurrentConversationContext" OnConversationEnd="HandleConversationEnd" />
                    break;
                    
                case ScreenMode.ObligationQueue:
                    <ObligationQueueContent OnNavigate="HandleNavigation" ReturnView="@PreviousScreen" />
                    break;
                    
                case ScreenMode.Travel:
                    <TravelContent 
                        CurrentLocation="@GetCurrentLocation()"
                        OnTravelRoute="HandleTravelRoute"
                        OnNavigate="HandleNavigation" />
                    break;
                    
                case ScreenMode.DeckViewer:
                    <NPCDeckViewer />
                    break;
                    
                default:
                    <LocationContent OnActionExecuted="RefreshUI" />
                    break;
            }
        </div>
    </CascadingValue>
    
    <!-- Toast Notifications -->
    <MessageDisplay />

    <!-- Fixed Navigation Footer -->
    <div class="game-footer">
        <div class="navigation-bar">
            <button class="nav-button @(CurrentScreen == ScreenMode.Location ? "active" : "")" 
                    @onclick="() => NavigateToScreen(ScreenMode.Location)">
                <span class="nav-icon location">üè†</span>
                <span>Location</span>
            </button>
            <button class="nav-button @(CurrentScreen == ScreenMode.ObligationQueue ? "active" : "")" 
                    @onclick="() => NavigateToScreen(ScreenMode.ObligationQueue)">
                <span class="nav-icon obligations">üìú</span>
                <span>Obligations</span>
                @if (PendingLetterCount > 0)
                {
                    <span class="badge">@PendingLetterCount</span>
                }
            </button>
        </div>
    </div>
    
    @if (LoadingStateService != null)
    {
        <LoadingIndicator IsVisible="@LoadingStateService.IsLoading"
                          Message="@LoadingStateService.Message"
                          ShowProgress="true"
                          Progress="@LoadingStateService.Progress" />
    }
</div>