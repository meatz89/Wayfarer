@using Wayfarer.GameState
@using Wayfarer.Game.MainSystem
@using Wayfarer.Content

@inject GameWorld GameWorld
@inject NPCRepository NPCRepository
@inject ConnectionTokenManager TokenManager
@inject LocationRepository LocationRepository

<div class="relationship-screen">
    <h2>Character Relationships</h2>
    
    <div class="relationship-list">
        @foreach (var npc in GetAllKnownNPCs())
        {
            <div class="npc-relationship-card">
                <div class="npc-header">
                    <span class="npc-icon">@GetTokenIcon(npc.LetterTokenType)</span>
                    <span class="npc-name">@npc.Name</span>
                    <span class="npc-location">@GetLocationName(npc.Location)</span>
                </div>
                
                <div class="npc-tokens">
                    <span class="token-label">Your @npc.LetterTokenType tokens:</span>
                    <span class="token-count">@(npc.LetterTokenType.HasValue ? TokenManager.GetTokenCount(npc.LetterTokenType.Value) : 0)</span>
                </div>
                
                @if (IsAtNPCLocation(npc))
                {
                    <div class="interaction-available">
                        <span class="available-icon">üü¢</span>
                        <span>Available for interaction</span>
                    </div>
                }
                else
                {
                    <div class="interaction-unavailable">
                        <span class="unavailable-icon">üî¥</span>
                        <span>Visit @GetLocationName(npc.Location) to interact</span>
                    </div>
                }
            </div>
        }
    </div>
    
    @if (!GetAllKnownNPCs().Any())
    {
        <div class="no-relationships">
            <p>You haven't built any relationships yet. Deliver letters to earn connection tokens!</p>
        </div>
    }
    
    <div class="screen-actions">
        <button class="btn btn-secondary" @onclick="OnClose">Close</button>
    </div>
</div>

@code {
    [Parameter] public EventCallback OnClose { get; set; }
    
    private List<NPC> GetAllKnownNPCs()
    {
        // For minimal POC, return all NPCs
        // In full implementation, track which NPCs player has interacted with
        return NPCRepository.GetAllNPCs()
            .Where(npc => npc.LetterTokenType != null)
            .OrderBy(npc => npc.Name)
            .ToList();
    }
    
    private string GetLocationName(string locationId)
    {
        var location = LocationRepository.GetLocation(locationId);
        return location?.Name ?? locationId;
    }
    
    private bool IsAtNPCLocation(NPC npc)
    {
        var currentLocation = GameWorld.WorldState.CurrentLocation;
        return currentLocation != null && currentLocation.Id == npc.Location;
    }
    
    private string GetTokenIcon(ConnectionType? type)
    {
        if (type == null) return "‚ùì";
        
        return type switch
        {
            ConnectionType.Trust => "‚ù§Ô∏è",
            ConnectionType.Trade => "ü™ô",
            ConnectionType.Noble => "üëë",
            ConnectionType.Common => "üç∫",
            ConnectionType.Shadow => "üåë",
            _ => "‚ùì"
        };
    }
}

<style>
    .relationship-screen {
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
    }
    
    .relationship-screen h2 {
        margin-bottom: 20px;
        color: #333;
    }
    
    .relationship-list {
        display: grid;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .npc-relationship-card {
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        transition: background-color 0.2s;
    }
    
    .npc-relationship-card:hover {
        background: #efefef;
    }
    
    .npc-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        font-weight: bold;
    }
    
    .npc-icon {
        font-size: 1.2em;
    }
    
    .npc-name {
        flex: 1;
        color: #333;
    }
    
    .npc-location {
        color: #666;
        font-size: 0.9em;
        font-weight: normal;
    }
    
    .npc-tokens {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        color: #555;
    }
    
    .token-label {
        font-size: 0.9em;
    }
    
    .token-count {
        font-weight: bold;
        font-size: 1.1em;
        color: #2c5aa0;
    }
    
    .interaction-available,
    .interaction-unavailable {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.85em;
    }
    
    .interaction-available {
        color: #2d7e2d;
    }
    
    .interaction-unavailable {
        color: #666;
        font-style: italic;
    }
    
    .available-icon,
    .unavailable-icon {
        font-size: 0.8em;
    }
    
    .no-relationships {
        text-align: center;
        padding: 40px 20px;
        color: #666;
        font-style: italic;
    }
    
    .screen-actions {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }
    
    .btn {
        padding: 8px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1em;
    }
    
    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background-color: #5a6268;
    }
</style>