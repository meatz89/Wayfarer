@page "/missing-references"
@using Microsoft.AspNetCore.Components
@inject ContentValidator Validator
@inject ActionGenerator ActionGenerator
@inject LocationCreationSystem LocationCreationSystem
@inject NavigationManager NavigationManager

<div class="missing-references-container">
    <h2 class="content-warning-title">Content Issues Detected</h2>
    <p class="content-warning-description">
        The following issues were found in the game content. You can choose to generate the missing content automatically
        or continue with missing references (which may cause errors).
    </p>

    @if (validationResult.MissingActions.Count > 0)
    {
        <div class="missing-section">
            <h3>Missing Actions</h3>
            <div class="missing-list">
                @foreach (var missing in validationResult.MissingActions)
                {
                    <div class="missing-item">
                        <span class="missing-id">@missing.ActionId</span>
                        <span class="reference-detail">Referenced by: @missing.ReferencingSpot.LocationId / @missing.ReferencingSpot.Name</span>
                    </div>
                }
            </div>
        </div>
    }

    @if (validationResult.MissingLocations.Count > 0)
    {
        <div class="missing-section">
            <h3>Missing Locations</h3>
            <div class="missing-list">
                @foreach (var missing in validationResult.MissingLocations)
                {
                    <div class="missing-item">
                        <span class="missing-id">@missing.LocationId</span>
                        <span class="reference-detail">Referenced by spot: @missing.ReferencingSpot.Name</span>
                    </div>
                }
            </div>
        </div>
    }

    @if (validationResult.MissingConnectedLocations.Count > 0)
    {
        <div class="missing-section">
            <h3>Missing Connected Locations</h3>
            <div class="missing-list">
                @foreach (var missing in validationResult.MissingConnectedLocations)
                {
                    <div class="missing-item">
                        <span class="missing-id">@missing.LocationId</span>
                        <span class="reference-detail">Referenced by location: @missing.ReferencingLocation.Name</span>
                    </div>
                }
            </div>
        </div>
    }

    <div class="action-buttons">
        <button class="generate-button" @onclick="GenerateMissingContent">Generate Missing Content</button>
        <button class="continue-button" @onclick="ContinueWithoutGenerating">Continue Anyway</button>
    </div>

    @if (isGenerating)
    {
        <div class="generation-progress">
            <p>Generating missing content... (@generatedCount/@totalToGenerate)</p>
            <div class="progress-bar">
                <div class="progress-inner" style="width: @((generatedCount * 100 / Math.Max(1, totalToGenerate)))%"></div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public EventCallback OnMissingReferencesResolved { get; set; }

    private ContentValidationResult validationResult;
    private bool isGenerating = false;
    private int generatedCount = 0;
    private int totalToGenerate = 0;

    protected override void OnInitialized()
    {
        validationResult = Validator.ValidateContent();
    }

    private async Task GenerateMissingContent()
    {
        isGenerating = true;
        generatedCount = 0;
        totalToGenerate = validationResult.MissingActions.Count +
                         validationResult.MissingLocations.Count +
                         validationResult.MissingConnectedLocations.Count;

        // First generate missing locations as actions may depend on them
        foreach (var missingLocation in validationResult.MissingLocations)
        {
            await LocationCreationSystem.CreateLocation(missingLocation.LocationId);
            generatedCount++;
            StateHasChanged();
        }

        // Then generate missing connected locations
        foreach (var missingConnected in validationResult.MissingConnectedLocations)
        {
            await LocationCreationSystem.CreateLocation(missingConnected.LocationId);
            generatedCount++;
            StateHasChanged();
        }

        // Finally generate missing actions
        foreach (var missingAction in validationResult.MissingActions)
        {
            await ActionGenerator.GenerateAction(
                missingAction.ActionId,
                missingAction.ReferencingSpot.Name,
                missingAction.ReferencingSpot.LocationId);

            generatedCount++;
            StateHasChanged();
        }

        isGenerating = false;
        OnMissingReferencesResolved.InvokeAsync();
    }

    private void ContinueWithoutGenerating()
    {
        OnMissingReferencesResolved.InvokeAsync();
    }
}