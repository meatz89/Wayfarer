@page "/"
@inherits ComponentBase

<div class="top-bar">
    <div class="time-display">
        @CurrentHour:00
        @CurrentTime @GetIconForTimeWindow(@GameState.World.WorldTime)
    </div>

    <div class="energy-meters">
        <div class="energy-meter">
            <div class="meter-bar">
                <div class="meter-fill physical" style="width: @(physicalEnergyCurrent * 100 / physicalEnergyMax)%"></div>
            </div>
            <span>Energy (@physicalEnergyCurrent/@physicalEnergyMax)</span>
        </div>
        <div class="energy-meter">
            <div class="meter-bar">
                <div class="meter-fill focus" style="width: @(concentrationCurrent * 100 / concentrationMax)%"></div>
            </div>
            <span>Focus (@concentrationCurrent/@concentrationMax)</span>
        </div>
    </div>

    <div class="resources">
        <div class="resource coins">
            <span class="resource-icon">🪙</span>
            <span class="resource-value">@coins</span>
            <span class="resource-label">Coins</span>
        </div>
        <div class="resource food">
            <span class="resource-icon">🍖</span>
            <span class="resource-value">@food</span>
            <span class="resource-label">Food</span>
        </div>
        <div class="resource health">
            <span class="resource-icon">❤️</span>
            <span class="resource-value">@health/@maxHealth</span>
            <span class="resource-label">Health</span>
        </div>
        <div class="resource reputation">
            <span class="resource-icon">🏆</span>
            <span class="resource-value">@reputation/@maxConfidence</span>
            <span class="resource-label">Confidence</span>
        </div>
    </div>
</div>

<div class="game-container">
    <div class="map-container">
        <div class="map-toggle">
            <button class="toggle-button @(showAreaMap ? "active" : "")" @onclick="() => showAreaMap = true">
                Travel 🗺️
            </button>
        </div>
        @if (OngoingEncounter)
        {
            <EncounterView OnEncounterCompleted="(result) => HandleEncounterCompleted(result)" />
        }
        else
        {
            @if (showAreaMap)
            {
                @if (showNarrative)
                {
                    <NarrativeView LocationName="@selectedLocation"
                    OnNarrativeCompleted="OnNarrativeCompleted"
                    Result="@EncounterResult"
                    ShowResult="false" />
                }
                else if (ShowEncounterResult)
                {
                    <NarrativeView LocationName="@selectedLocation"
                                   OnNarrativeCompleted="FinishEncounter"
                    Result="@EncounterResult"
                    ShowResult="true" />
                }
                else
                {
                    <AreaMap CurrentLocation="@CurrentLocation"
                    Locations="@Locations"
                    OnTravel="@HandleLocationSelection" />
                }
            }
            else
            {
                if (ShowEncounterResult)
                {
                    <NarrativeView LocationName="@selectedLocation"
                                   OnNarrativeCompleted="FinishEncounter"
                                   Result="@EncounterResult"
                                   ShowResult="true" />
                }
                else
                {
                    <LocationSpotMap CurrentLocation="@CurrentLocation"
                                 CurrentSpot="@CurrentSpot"
                                 OnSpotSelected="@HandleSpotSelection"
                                 OnActionSelected="@HandleActionSelection" />
                }
            }
        }
    </div>

    <div class="sidebar">
        <div class="sidebar-panel location-panel">
        <div class="location-name">
            @CurrentLocation.LocationName
        </div>

            <div class="location-properties">
                <div class="properties-header">Properties</div>
                <div class="properties-grid">
                    @foreach (var prop in GetLocationProperties(CurrentLocation))
                    {
                        <div class="property-tag @prop.CssClass">
                            <span class="property-icon">@prop.Icon</span>
                            <span class="property-text">@prop.Text</span>
                        </div>
                    }
                </div>
            </div>

            <div class="sidebar-panel">
                <div class="panel-title">Daily Requirements</div>
                <div class="panel-content">
                    @*                 <div class="requirement">
                        <span style="color: var(--resource-food)">
                            • @baseRequirements.DailyFood Food by Night
                            @if (modifiedRequirements.DailyFood > baseRequirements.DailyFood)
                            {
                                <span class="modifier">
                                    (+@(modifiedRequirements.DailyFood - baseRequirements.DailyFood)
                                    from @GetModifierSource())
                                </span>
                            }
                        </span>
                    </div> *@
                    <div class="requirement">
                        <span style="color: var(--resource-food)">• 1 Food by Night</span>
                    </div>
                    <div class="requirement">
                        <span style="color: var(--resource-shelter)">• Shelter during Night</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-panel">
                <div class="panel-title">Time Management</div>
                <div class="panel-content">
                    <div>• Travel takes time</div>
                    <div>• Actions advance time</div>
                    <div>• Plan your day carefully</div>
                </div>
            </div>

            <div class="sidebar-panel quest-effects">
                <div class="panel-title">Quest Effects</div>
                <div class="panel-content">
                    @foreach (Quest activeQuest in GetActiveQuests())
                    {
                        QuestStep questStep = activeQuest.GetCurrentStep();
                        @if(questStep != null)
                        {
                            @foreach (IGameStateModifier modifier in questStep.StateModifiers)
                            {
                                <div class="quest-effect">
                                    <div class="effect-source">@activeQuest.Title:</div>
                                    <div class="effect-description">
                                        @GetModifierDescription(modifier)
                                    </div>
                                </div>
                            }
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@if (showTooltip && hoveredAction != null)
{
    <div class="tooltip" style="left: @(mouseX + 10)px; top: @(mouseY + 10)px">
        <ActionPreview CurrentAction="@hoveredAction"
                       Player="@Player" />
    </div>
}