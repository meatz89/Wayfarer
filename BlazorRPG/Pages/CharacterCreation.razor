<div class="character-container">
    <h2>Create Your Character</h2>
    <p class="secondary-text">Choose your name and profession to begin your journey</p>

    <div class="tooltip-section">
        <h4>Choose Your Profession</h4>
        <div class="archetype-grid">
            @foreach (ArchetypeTypes archetype in Enum.GetValues(typeof(ArchetypeTypes)))
            {
                <div class="archetype-card @(selectedArchetype == archetype ? "selected" : "")"
                     @onclick="() => SelectArchetype(archetype)">
                    <div class="archetype-icon">@GetArchetypeIcon(archetype)</div>
                    <div class="archetype-name-bold">@FormatArchetypeName(archetype)</div>
                    <div class="archetype-description">@GetArchetypeDescription(archetype)</div>
                    <div>
                        <strong>Advantages:</strong>
                        <div class="archetype-approaches">@GetNaturalTags(archetype)</div>
                        <strong>Disadvantages:</strong>
                        <div class="archetype-approaches">@GetIncompatibleTags(archetype)</div>
                    </div>
                    <div class="starting-items">
                        <strong>Starting Items:</strong>
                        <div class="items-list">
                            @foreach (string item in GetStartingItems(archetype))
                            {
                                <div class="item">@item</div>
                            }
                        </div>
                    </div>
                    @if (selectedArchetype == archetype)
                    {
                        <div class="selected-indicator">✓</div>
                    }
                </div>
            }
        </div>
    </div>

    <div class="tooltip-section">
        <h4>Choose Your Name</h4>
        <div class="player-stat">
            <span class="stat-label">Your Name</span>
            <input id="playerName" @bind="playerName" class="character-input" placeholder="Enter your name..." />
        </div>
    </div>

    <div class="action-button-container">
        <button class="narrative-button" @onclick="CreateCharacter" disabled="@(!IsValid())">
            Begin Your Journey
        </button>
    </div>
</div>

@code {
    [Parameter] public EventCallback<PlayerState> OnCharacterCreated { get; set; }
    [Inject] protected GameState GameState { get; set; }

    private string playerName = "";
    private ArchetypeTypes selectedArchetype = ArchetypeTypes.Sage;

    private void SelectArchetype(ArchetypeTypes archetype)
    {
        selectedArchetype = archetype;
    }

    private bool IsValid()
    {
        return !string.IsNullOrWhiteSpace(playerName);
    }

    private async Task CreateCharacter()
    {
        // Set player name and archetype
        GameState.PlayerState.Initialize(playerName, selectedArchetype);

        // Notify parent component that character creation is complete
        await OnCharacterCreated.InvokeAsync(GameState.PlayerState);
    }

    private string GetArchetypeIcon(ArchetypeTypes archetype)
    {
        return archetype switch
        {
            ArchetypeTypes.Knight => "⚔️",
            ArchetypeTypes.Sage => "📚",
            ArchetypeTypes.Forester => "🏹",
            ArchetypeTypes.Courtier => "🎭",
            ArchetypeTypes.Shadow => "🗝️",
            _ => "❓"
        };
    }

    private string FormatArchetypeName(ArchetypeTypes archetype)
    {
        // Convert enum name to a formatted string (e.g., "WarriorType" to "Warrior Type")
        return System.Text.RegularExpressions.Regex.Replace(
            archetype.ToString(),
            "([A-Z])",
            " $1",
            System.Text.RegularExpressions.RegexOptions.Compiled).Trim();
    }

    private string GetArchetypeDescription(ArchetypeTypes archetype)
    {
        return archetype switch
        {
            ArchetypeTypes.Knight => "Masters of warfare who rely on dominance and physical prowess. Trained in combat techniques and inspiring fear in opponents.",
            ArchetypeTypes.Sage => "Scholars who excel at analysis and information gathering. Their methodical approach reveals hidden knowledge and solves complex problems.",
            ArchetypeTypes.Forester => "Masters of wilderness survival who rely on precision and careful observation. Expert trackers and hunters with deep knowledge of nature.",
            ArchetypeTypes.Courtier => "Skilled diplomats who excel at social interactions and building relationships. Their charm and persuasive abilities open doors closed to others.",
            ArchetypeTypes.Shadow => "Masters of subterfuge who rely on concealment and misdirection. They navigate unseen through dangerous situations and access restricted areas.",
            _ => "Unknown archetype"
        };
    }

    private string GetNaturalTags(ArchetypeTypes archetype)
    {
        return archetype switch
        {
            ArchetypeTypes.Knight => "Dominance, Physical",
            ArchetypeTypes.Sage => "Analysis, Information",
            ArchetypeTypes.Forester => "Precision, Environment",
            ArchetypeTypes.Courtier => "Rapport, Relationship",
            ArchetypeTypes.Shadow => "Concealment, Resource",
            _ => "None"
        };
    }

    private string GetIncompatibleTags(ArchetypeTypes archetype)
    {
        return archetype switch
        {
            ArchetypeTypes.Knight => "Concealment, Information",
            ArchetypeTypes.Sage => "Dominance, Physical",
            ArchetypeTypes.Forester => "Rapport, Relationship",
            ArchetypeTypes.Courtier => "Analysis, Concealment",
            ArchetypeTypes.Shadow => "Dominance, Analysis",
            _ => "None"
        };
    }

    private List<string> GetStartingItems(ArchetypeTypes archetype)
    {
        return archetype switch
        {
            ArchetypeTypes.Knight => new List<string> { "Sword", "Shield", "Chain Mail", "Whetstone", "Rations" },
            ArchetypeTypes.Sage => new List<string> { "Journal", "Quill & Ink", "Spectacles", "Puzzle Box", "Ancient Text" },
            ArchetypeTypes.Forester => new List<string> { "Bow", "Skinning Knife", "Snares", "Flint & Steel", "Herb Pouch" },
            ArchetypeTypes.Courtier => new List<string> { "Fine Clothes", "Wax Seal Kit", "Perfume", "Silver Coins", "Wine Flask" },
            ArchetypeTypes.Shadow => new List<string> { "Lockpicks", "Dark Cloak", "Grappling Hook", "Poison Vial", "Disguise Kit" },
            _ => new List<string> { "Rations" }
        };
    }
}