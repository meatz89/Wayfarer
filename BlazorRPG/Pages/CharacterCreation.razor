<div class="character-container">
    <h2>Choose Your Character</h2>
    <div class="tooltip-section">
        <h4>Choose Your Gender</h4>
        <div class="gender-toggle">
            <button class="gender-option @(selectedGender == Genders.Male ? "selected" : "")"
            @onclick="() => SelectGender(Genders.Male)">
                <span><i class="fas fa-mars icon-spacing"></i> Male</span>
            </button>
            <button class="gender-option @(selectedGender == Genders.Female ? "selected" : "")"
            @onclick="() => SelectGender(Genders.Female)">
                <span><i class="fas fa-venus icon-spacing"></i> Female</span>
            </button>
        </div>
    </div>

    <div class="tooltip-section">
        <h4>Choose Your Profession</h4>
        <div class="archetype-selection">
            <div class="archetype-options">
                @foreach (ArchetypeTypes archetype in Enum.GetValues(typeof(ArchetypeTypes)))
                {
                    <div class="archetype-option @(selectedArchetype == archetype ? "selected" : "")"
                    @onclick="() => SelectArchetype(archetype)">
                        <span class="archetype-name">@FormatArchetypeName(archetype)</span>
                        <span class="archetype-brief">@GetShortDescription(archetype)</span>
                    </div>
                }
            </div>

            <div class="archetype-details">
                @if (selectedArchetype != null)
                {
                    <div class="archetype-portrait portrait-high">
                        <img class="@(changingImage ? "changing" : "")"
                        src="@GetArchetypeImage(selectedArchetype)"
                        alt="@FormatArchetypeName(selectedArchetype)" />
                    </div>
                    <div class="archetype-content @(changingContent ? "changing" : "")">
                        <h3 class="archetype-title">@FormatArchetypeName(selectedArchetype)</h3>
                        <p class="archetype-description">@GetArchetypeDescription(selectedArchetype)</p>

                        <div class="archetype-advantages">
                            <strong>Advantages:</strong>
                            <div class="archetype-approaches">@GetNaturalTags(selectedArchetype)</div>
                        </div>

                        <div class="starting-items">
                            <strong>Starting Items:</strong>
                            <div class="items-list">
                                @foreach (string item in GetStartingItems(selectedArchetype))
                                {
                                    <div class="item">@item</div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="tooltip-section">
        <h4>Choose Your Name</h4>
        <div class="player-stat">
            <span class="stat-label">Your Name</span>
            <div class="name-input-container">
                <input id="playerName" @bind="playerName" class="character-input" placeholder="Enter your name..." />
                <button class="name-generator" @onclick="GenerateRandomName" title="Generate random name">
                    <i class="fas fa-dice"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="action-button-container">
        <button class="narrative-button" @onclick="CreateCharacter" disabled="@(!IsValid())">
            Begin Your Journey
        </button>
    </div>
</div>

@code {
    [Parameter] public EventCallback<PlayerState> OnCharacterCreated { get; set; }
    [Inject] protected GameState GameState { get; set; }

    private string playerName;
    private ArchetypeTypes selectedArchetype = ArchetypeTypes.Guard;
    private Genders selectedGender = Genders.Male;
    private bool changingImage = false;
    private bool changingContent = false;
    private System.Threading.Timer transitionTimer;

    // Name pools
    private static readonly List<string> MaleNames = new List<string> {
        "Alistair", "Bram", "Cedric", "Duncan", "Edmund", "Farley", "Gareth",
        "Hadrian", "Irving", "Jasper", "Leofric", "Nathaniel", "Oswald", 
        "Percival", "Silas", "Tristan", "Wesley"
    };

    private static readonly List<string> FemaleNames = new List<string> {
        "Adeline", "Beatrice", "Cecily", "Eloise", "Fiona", "Gwendolyn",
        "Imogen", "Josephine", "Katerina", "Lenore", "Matilda", "Nora",
        "Ophelia", "Sophia", "Tabitha", "Victoria"
    };

    protected override void OnInitialized()
    {
        // Set initial random name based on default gender
        GenerateRandomName();
    }

    private void SelectGender(Genders gender)
    {
        if (selectedGender == gender) return;

        // Start transition
        StartTransition();

        // Update gender
        selectedGender = gender;

        // Generate a new name appropriate for the gender
        GenerateRandomName();
    }

    private void SelectArchetype(ArchetypeTypes archetype)
    {
        if (selectedArchetype == archetype) return;

        // Start transition
        StartTransition();

        // Update archetype
        selectedArchetype = archetype;
    }

    private void StartTransition()
    {
        // Start image fade out
        changingImage = true;
        changingContent = true;
        StateHasChanged();

        // Schedule transition to end
        transitionTimer?.Dispose();
        transitionTimer = new System.Threading.Timer(_ =>
        {
            // This callback runs on a different thread, so we need InvokeAsync
            InvokeAsync(() =>
            {
                changingImage = false;
                changingContent = false;
                StateHasChanged();
            });
        }, null, 300, Timeout.Infinite);
    }

    public void GenerateRandomName()
    {
        Random random = new Random();
        playerName = selectedGender == Genders.Male
            ? MaleNames[random.Next(MaleNames.Count)]
            : FemaleNames[random.Next(FemaleNames.Count)];
    }

    private string GetShortDescription(ArchetypeTypes archetype)
    {
        // Return a shortened version of the description (just first sentence or two)
        string fullDesc = GetArchetypeDescription(archetype);
        int endPos = fullDesc.IndexOf('.');

        if (endPos > 0 && endPos < fullDesc.Length - 1)
            return fullDesc.Substring(0, endPos + 1);
        else
            return fullDesc;
    }

    private bool IsValid()
    {
        return !string.IsNullOrWhiteSpace(playerName);
    }

    private async Task CreateCharacter()
    {
        // Set player name, archetype, and gender
        GameState.PlayerState.Initialize(playerName, selectedArchetype, selectedGender);

        // Notify parent component that character creation is complete
        await OnCharacterCreated.InvokeAsync(GameState.PlayerState);
    }

    private string FormatArchetypeName(ArchetypeTypes archetype)
    {
        // Convert enum name to a formatted string (e.g., "WarriorType" to "Warrior Type")
        return System.Text.RegularExpressions.Regex.Replace(
            archetype.ToString(),
            "([A-Z])",
            " $1",
            System.Text.RegularExpressions.RegexOptions.Compiled).Trim();
    }

    private string GetArchetypeImage(ArchetypeTypes archetype)
    {
        string selectedGenderString = selectedGender.ToString().ToLower();
        string imagePath = $"/images/characters/{selectedGenderString}_{selectedArchetype.ToString().ToLower()}.png";
        return imagePath;
    }

    private string GetArchetypeDescription(ArchetypeTypes archetype)
    {
        return archetype switch
        {
            ArchetypeTypes.Guard => "Strong of arm and steady of purpose, Guards ensure the village thrives—mending roofs, reinforcing walls, and crafting essential tools for daily life.",
            ArchetypeTypes.Rogue => "Lightfooted wanderers of alley and backroad, Rogues excel at discreet tasks—liberating keys from locked chests, gathering secrets, and slipping unnoticed through crowds.",
            ArchetypeTypes.Diplomat => "Eloquent voices at court and council, Diplomats soothe disputes, broker alliances, and settle rival ambitions with words rather than blades.",
            ArchetypeTypes.Merchant => "Shrewd traders versed in supply and demand, Merchants move goods along trade routes, bargain for profit, and keep markets bustling.",
            ArchetypeTypes.Explorer => "Adventurous travelers into forests and hills, Explorers chart unseen paths, gather medicinal herbs, and return with tales to enrich community life.",
            ArchetypeTypes.Scholar => "Quiet seekers of knowledge in dusty halls, Scholars pore over ancient scrolls, record the town’s story, and guide others with learned counsel.",
            _ => "An undefined soul wandering uncertain roads"
        };
    }

    private string GetNaturalTags(ArchetypeTypes archetype)
    {
        return archetype switch
        {
            ArchetypeTypes.Guard => "+Force, -Contemplation",
            ArchetypeTypes.Rogue => "+Precision, -Rapport",
            ArchetypeTypes.Diplomat => "+Rapport, -Precision",
            ArchetypeTypes.Merchant => "+Persuasion, -Observation",
            ArchetypeTypes.Explorer => "+Observation, -Persuasion",
            ArchetypeTypes.Scholar => "+Contemplation, -Force",
            _ => "None"
        };
    }

    private List<string> GetStartingItems(ArchetypeTypes archetype)
    {
        return archetype switch
        {
            ArchetypeTypes.Guard => new List<string> { "Toolkit", "Work Gloves", "Sturdy Garment", "Backpack", "Rations" },
            ArchetypeTypes.Rogue => new List<string> { "Basic Cloak", "Lockpick Set", "Small Blade", "Backpack", "Rations" },
            ArchetypeTypes.Diplomat => new List<string> { "Fine Garment", "Sealing Wax", "Letter Set", "Journal", "Coin Pouch" },
            ArchetypeTypes.Merchant => new List<string> { "Ledger", "Scales", "Sample Pouch", "Trade Papers", "Coin Pouch" },
            ArchetypeTypes.Explorer => new List<string> { "Field Journal", "Herb Pouch", "Map", "Waterskin", "Rations" },
            ArchetypeTypes.Scholar => new List<string> { "Quill & Ink", "Notebook", "Spectacles", "Scroll", "Reference Text" },
            _ => new List<string> { "Rations" }
        };
    }
}