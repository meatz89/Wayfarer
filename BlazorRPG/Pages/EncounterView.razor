@inherits EncounterViewBase

<div class="encounter-container" @onmousemove="OnMouseMove">
    @if (GameState.Actions.CurrentEncounter != null)
    {
        <div class="encounter-header">
            <h2>@GameState.Actions.CurrentEncounter.Situation</h2>
        </div>

        <div class="encounter-stats">
            <div class="stat">
                <span class="stat-label">Outcome:</span>
                <span class="stat-value">@GameState.Actions.CurrentEncounter.EncounterContext.CurrentValues.Outcome</span>
            </div>
            <div class="stat">
                <span class="stat-label">Insight:</span>
                <span class="stat-value">@GameState.Actions.CurrentEncounter.EncounterContext.CurrentValues.Insight</span>
            </div>
            <div class="stat">
                <span class="stat-label">Resonance:</span>
                <span class="stat-value">@GameState.Actions.CurrentEncounter.EncounterContext.CurrentValues.Resonance</span>
            </div>
            <div class="stat">
                <span class="stat-label">Pressure:</span>
                <span class="stat-value">@GameState.Actions.CurrentEncounter.EncounterContext.CurrentValues.Pressure</span>
            </div>
        </div>

        <div class="encounter-stage">
            <div class="stage-description">
                @GameManager.EncounterSystem.GetCurrentStage(GameState.Actions.CurrentEncounter).Situation
            </div>
        </div>

        <div class="encounter-choices">
            @foreach (var choice in GameState.Actions.EncounterChoiceOptions)
            {
                <div class="choice-option @(hoveredChoice == choice ? "hovered" : "") @(IsChoiceDisabled(choice) ? "disabled" : "")"
                     @onmouseover="() => ShowTooltip(choice)"
                     @onmouseout="HideTooltip"
                     @onclick="() => HandleChoiceSelection(choice)">
                    <span class="choice-index">@choice.Index.</span>
                    <span class="choice-description">@choice.Description</span>
                </div>
            }
        </div>

        @if (showTooltip && hoveredChoice != null)
        {
            <div class="tooltip" style="left: @mouseX; top: @mouseY">
                <div class="preview-container">
                    <h4>Choice Preview</h4>

                    @* Value Changes *@
                    <div class="value-changes">
                        <h5>Encounter Value Changes</h5>
                        @foreach (var baseChange in hoveredChoice.EncounterChoice.Consequences.BaseValueChanges)
                        {
                            var detail = hoveredChoice.EncounterChoice.Consequences.ValueChangeDetails
                            .FirstOrDefault(d => d.ValueType == baseChange.ValueType);
                            if (detail != null)
                            {
                                <div class="value-change">
                                    <div class="value-type">@baseChange.ValueType</div>
                                    @foreach (var source in detail.ValueChanges)
                                    {
                                        <div class="value-modifier @(source.Amount > 0 ? "positive" : "negative")">
                                            @source.Source: @(source.Amount > 0 ? "+" : "")@source.Amount
                                        </div>
                                    }
                                    <div class="value-total">
                                        Total: @(detail.ValueChanges.Sum(s => s.Amount) > 0 ? "+" : "")@detail.ValueChanges.Sum(s => s.Amount)
                                    </div>
                                </div>
                            }
                        }
                    </div>

                    @* Cost Modifications *@
                    @if (hoveredChoice.EncounterChoice.Consequences.CostModifications.Any())
                    {
                        <div class="cost-modifications">
                            <h5>Costs</h5>
                            @foreach (var mod in hoveredChoice.EncounterChoice.Consequences.CostModifications)
                            {
                                <div class="cost-modification">
                                    <div class="cost-type">@mod.OutcomeType</div>
                                    <div class="base-cost">
                                        Base: @hoveredChoice.EncounterChoice.Consequences.BaseCosts
                                        .First(c => c.GetDescription().Contains(mod.OutcomeType)).GetDescription()
                                    </div>
                                    <div class="modifier @(mod.Amount > 0 ? "positive" : "negative")">
                                        @mod.Source: @(mod.Amount > 0 ? "+" : "")@mod.Amount
                                    </div>
                                    <div class="final-cost">
                                        Final: @hoveredChoice.EncounterChoice.Consequences.ModifiedCosts
                                        .First(c => c.GetDescription().Contains(mod.OutcomeType)).GetDescription()
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    @* Reward Modifications *@
                    @if (hoveredChoice.EncounterChoice.Consequences.RewardModifications.Any())
                    {
                        <div class="reward-modifications">
                            <h5>Rewards</h5>
                            @foreach (var mod in hoveredChoice.EncounterChoice.Consequences.RewardModifications)
                            {
                                var baseReward = hoveredChoice.EncounterChoice.Consequences.BaseRewards
                                .First(r => r.GetDescription().Contains(mod.OutcomeType));
                                var modifiedReward = hoveredChoice.EncounterChoice.Consequences.ModifiedRewards
                                .First(r => r.GetDescription().Contains(mod.OutcomeType));

                                <div class="reward-modification">
                                    <div class="reward-type">@mod.OutcomeType</div>
                                    <div class="base-reward">Base: @baseReward.GetDescription()</div>
                                    <div class="modifier @(mod.Amount > 0 ? "positive" : "negative")">
                                        @mod.Source: @(mod.Amount > 0 ? "+" : "")@mod.Amount
                                    </div>
                                    <div class="final-reward">
                                        Final: @modifiedReward.GetDescription()
                                        <span class="preview">@modifiedReward.GetPreview(GameState.Player)</span>
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    @* Energy Costs *@
                    <div class="energy-costs">
                        <h5>Energy Requirements</h5>
                        @foreach (var requirement in hoveredChoice.EncounterChoice.Consequences.ModifiedRequirements
                       .Where(r => r is EnergyRequirement))
                        {
                            var energyReq = (EnergyRequirement)requirement;
                            <div class="energy-cost">
                                <div class="energy-type">@energyReq.EnergyType Energy</div>
                                @{
                                    var currentEnergy = GetCurrentEnergy(GameState.Player, energyReq.EnergyType);
                                    var maxEnergy = GetMaxEnergy(GameState.Player, energyReq.EnergyType);
                                    var newEnergy = Math.Max(0, currentEnergy - energyReq.Amount);
                                }
                                <div class="energy-preview @(newEnergy < currentEnergy ? "negative" : "positive")">
                                    @currentEnergy → @newEnergy / @maxEnergy
                                </div>
                                @if (newEnergy == 0 && currentEnergy < energyReq.Amount)
                                {
                                    <div class="energy-warning">
                                        Warning: Insufficient energy will cause:
                                        @switch (energyReq.EnergyType)
                                        {
                                            case EnergyTypes.Physical:
                                                <span class="health-loss">Health Loss</span>
                                                break;
                                            case EnergyTypes.Focus:
                                                <span class="pressure-gain">Pressure Gain</span>
                                                break;
                                            case EnergyTypes.Social:
                                                <span class="reputation-loss">Reputation Loss</span>
                                                break;
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>

                    @* Requirements *@
                    @if (hoveredChoice.EncounterChoice.Consequences.ModifiedRequirements
                   .Any(r => !(r is EnergyRequirement)))
                    {
                        <div class="other-requirements">
                            <h5>Other Requirements</h5>
                            @foreach (var requirement in hoveredChoice.EncounterChoice.Consequences.ModifiedRequirements
                           .Where(r => !(r is EnergyRequirement)))
                            {
                                <div class="requirement @(requirement.IsSatisfied(GameState.Player) ? "met" : "unmet")">
                                    @requirement.GetDescription()
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>