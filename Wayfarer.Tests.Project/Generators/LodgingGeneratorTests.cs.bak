using Wayfarer.Content.Generators;
using Wayfarer.GameState;
using Wayfarer.GameState.Enums;
using Xunit;

namespace Wayfarer.Tests.Project.Generators;

public class LodgingGeneratorTests
{
    [Fact]
    public void GenerateMultiSituationArc_MercantilePersonality_Creates4Situations()
    {
        var context = new GenerationContext
        {
            Tier = 1,
            NpcPersonality = PersonalityType.MERCANTILE,
            NpcLocationId = "test_inn",
            NpcId = "test_npc",
            PlayerCoins = 50
        };

        SceneArchetypeDefinition result = LodgingGenerator.GenerateMultiSituationArc(context);

        Assert.NotNull(result);
        Assert.NotNull(result.SituationTemplates);
        Assert.Equal(4, result.SituationTemplates.Count);
    }

    [Fact]
    public void GenerateMultiSituationArc_MercantilePersonality_UsesServiceTransactionArchetype()
    {
        var context = new GenerationContext
        {
            Tier = 1,
            NpcPersonality = PersonalityType.MERCANTILE,
            PlayerCoins = 50
        };

        SceneArchetypeDefinition result = LodgingGenerator.GenerateMultiSituationArc(context);

        var negotiateSituation = result.SituationTemplates[0];
        var choices = negotiateSituation.ChoiceTemplates;

        // service_transaction archetype has NO stat gates
        Assert.All(choices, choice =>
            Assert.Equal(0, choice.CompoundRequirement.StatThreshold));
    }

    [Fact]
    public void GenerateMultiSituationArc_DevotedPersonality_UsesSocialManeuveringArchetype()
    {
        var context = new GenerationContext
        {
            Tier = 1,
            NpcPersonality = PersonalityType.DEVOTED,
            PlayerCoins = 50
        };

        SceneArchetypeDefinition result = LodgingGenerator.GenerateMultiSituationArc(context);

        var negotiateSituation = result.SituationTemplates[0];
        var choices = negotiateSituation.ChoiceTemplates;

        // social_maneuvering archetype HAS stat gates
        bool hasStatGate = choices.Any(c => c.CompoundRequirement.StatThreshold > 0);
        Assert.True(hasStatGate);
    }

    [Fact]
    public void GenerateMultiSituationArc_SameInputTwice_ProducesIdenticalOutput()
    {
        var context = new GenerationContext
        {
            Tier = 2,
            NpcPersonality = PersonalityType.MERCANTILE,
            PlayerCoins = 25
        };

        var result1 = LodgingGenerator.GenerateMultiSituationArc(context);
        var result2 = LodgingGenerator.GenerateMultiSituationArc(context);

        // Verify determinism
        Assert.Equal(result1.SituationTemplates.Count, result2.SituationTemplates.Count);
        Assert.Equal(result1.SituationTemplates[0].Id, result2.SituationTemplates[0].Id);
        Assert.Equal(result1.SituationTemplates[0].ChoiceTemplates.Count, result2.SituationTemplates[0].ChoiceTemplates.Count);
    }

    [Theory]
    [InlineData(0)]
    [InlineData(1)]
    [InlineData(2)]
    [InlineData(3)]
    [InlineData(4)]
    public void GenerateMultiSituationArc_AllTiers_ProducesValidStructure(int tier)
    {
        var context = new GenerationContext
        {
            Tier = tier,
            NpcPersonality = PersonalityType.MERCANTILE,
            PlayerCoins = 50
        };

        SceneArchetypeDefinition result = LodgingGenerator.GenerateMultiSituationArc(context);

        Assert.Equal(4, result.SituationTemplates.Count);
        Assert.NotNull(result.SpawnRules);
        Assert.Equal(SpawnPattern.Linear, result.SpawnRules.Pattern);
        Assert.Equal(3, result.SpawnRules.Transitions.Count);
    }

    [Fact]
    public void GenerateMultiSituationArc_ValidatesSpawnRulesReferenceValidSituations()
    {
        var context = new GenerationContext
        {
            Tier = 1,
            NpcPersonality = PersonalityType.MERCANTILE,
            PlayerCoins = 50
        };

        SceneArchetypeDefinition result = LodgingGenerator.GenerateMultiSituationArc(context);

        var situationIds = result.SituationTemplates.Select(s => s.Id).ToHashSet();

        foreach (var transition in result.SpawnRules.Transitions)
        {
            Assert.Contains(transition.SourceSituationId, situationIds);
            Assert.Contains(transition.DestinationSituationId, situationIds);
        }
    }

    [Fact]
    public void GenerateMultiSituationArc_CreatesDependentResources()
    {
        var context = new GenerationContext
        {
            Tier = 1,
            NpcPersonality = PersonalityType.MERCANTILE,
            PlayerCoins = 50
        };

        SceneArchetypeDefinition result = LodgingGenerator.GenerateMultiSituationArc(context);

        Assert.Single(result.DependentLocations);
        Assert.Equal("private_room", result.DependentLocations[0].TemplateId);

        Assert.Single(result.DependentItems);
        Assert.Equal("room_key", result.DependentItems[0].TemplateId);
    }

    [Fact]
    public void GenerateMultiSituationArc_LowCoins_GeneratesDesperateNarrativeHint()
    {
        var context = new GenerationContext
        {
            Tier = 1,
            NpcPersonality = PersonalityType.MERCANTILE,
            PlayerCoins = 5  // Less than 10
        };

        SceneArchetypeDefinition result = LodgingGenerator.GenerateMultiSituationArc(context);

        var negotiateSituation = result.SituationTemplates[0];
        Assert.Equal("desperate", negotiateSituation.NarrativeHints.Style);
    }

    [Fact]
    public void GenerateMultiSituationArc_HighCoins_GeneratesStandardNarrativeHint()
    {
        var context = new GenerationContext
        {
            Tier = 1,
            NpcPersonality = PersonalityType.MERCANTILE,
            PlayerCoins = 100
        };

        SceneArchetypeDefinition result = LodgingGenerator.GenerateMultiSituationArc(context);

        var negotiateSituation = result.SituationTemplates[0];
        Assert.Equal("standard", negotiateSituation.NarrativeHints.Style);
    }
}
