using Wayfarer.GameState;
using Wayfarer.GameState.Enums;
using Wayfarer.Subsystems.ProceduralContent;
using Xunit;

namespace Wayfarer.Tests.Project.Spawning;

public class SceneSpawnerTests
{
    private class TestGameState : IGameStateQuery
    {
        public HashSet<string> Scenes { get; } = new();
        public HashSet<string> Locations { get; } = new();
        public HashSet<string> NPCs { get; } = new();

        public bool HasScene(string templateId) => Scenes.Contains(templateId);
        public bool HasLocation(string locationId) => Locations.Contains(locationId);
        public bool HasNPC(string npcId) => NPCs.Contains(npcId);
    }

    private SceneTemplate CreateTestTemplate()
    {
        return new SceneTemplate
        {
            Id = "test_lodging_scene",
            SituationTemplates = new List<SituationTemplate>
            {
                new() { Id = "negotiate" },
                new() { Id = "access" },
                new() { Id = "service" },
                new() { Id = "depart" }
            },
            DependentLocations = new List<DependentLocationSpec>
            {
                new() { TemplateId = "private_room" }
            },
            DependentItems = new List<DependentItemSpec>
            {
                new() { TemplateId = "room_key" }
            }
        };
    }

    [Fact]
    public void CalculateSpawn_ValidRequest_ReturnsSuccess()
    {
        var template = CreateTestTemplate();
        var request = new SpawnRequest
        {
            Template = template,
            LocationId = "inn",
            NpcId = "elena",
            PlayerId = "player1"
        };

        var gameState = new TestGameState();
        gameState.Locations.Add("inn");
        gameState.NPCs.Add("elena");

        SpawnResult result = SceneSpawner.CalculateSpawn(request, gameState);

        Assert.True(result.Success);
        Assert.NotNull(result.SceneId);
        Assert.Equal(4, result.CreatedSituationIds.Count);
        Assert.Single(result.CreatedLocationIds);
        Assert.Single(result.CreatedItemIds);
    }

    [Fact]
    public void CalculateSpawn_AlreadySpawned_ReturnsFailure()
    {
        var template = CreateTestTemplate();
        var request = new SpawnRequest
        {
            Template = template,
            LocationId = "inn",
            NpcId = "elena"
        };

        var gameState = new TestGameState();
        gameState.Scenes.Add(template.Id); // Already spawned
        gameState.Locations.Add("inn");
        gameState.NPCs.Add("elena");

        SpawnResult result = SceneSpawner.CalculateSpawn(request, gameState);

        Assert.False(result.Success);
        Assert.Contains("already spawned", result.FailureReason);
    }

    [Fact]
    public void CalculateSpawn_MissingLocation_ReturnsFailure()
    {
        var template = CreateTestTemplate();
        var request = new SpawnRequest
        {
            Template = template,
            LocationId = "missing_location",
            NpcId = "elena"
        };

        var gameState = new TestGameState();
        gameState.NPCs.Add("elena");

        SpawnResult result = SceneSpawner.CalculateSpawn(request, gameState);

        Assert.False(result.Success);
        Assert.Contains("not found", result.FailureReason);
    }

    [Fact]
    public void CalculateSpawn_MissingNPC_ReturnsFailure()
    {
        var template = CreateTestTemplate();
        var request = new SpawnRequest
        {
            Template = template,
            LocationId = "inn",
            NpcId = "missing_npc"
        };

        var gameState = new TestGameState();
        gameState.Locations.Add("inn");

        SpawnResult result = SceneSpawner.CalculateSpawn(request, gameState);

        Assert.False(result.Success);
        Assert.Contains("not found", result.FailureReason);
    }

    [Fact]
    public void CalculateSpawn_CreatesMarkerResolutionMap()
    {
        var template = CreateTestTemplate();
        var request = new SpawnRequest
        {
            Template = template,
            LocationId = "inn",
            NpcId = "elena"
        };

        var gameState = new TestGameState();
        gameState.Locations.Add("inn");
        gameState.NPCs.Add("elena");

        SpawnResult result = SceneSpawner.CalculateSpawn(request, gameState);

        Assert.True(result.Success);
        Assert.Contains("generated:private_room", result.MarkerResolutionMap.Keys);
        Assert.Contains("generated:room_key", result.MarkerResolutionMap.Keys);

        string privateRoomId = result.MarkerResolutionMap["generated:private_room"];
        Assert.StartsWith(result.SceneId, privateRoomId);
    }

    [Fact]
    public void CalculateSpawn_SituationIdsMatchSceneId()
    {
        var template = CreateTestTemplate();
        var request = new SpawnRequest
        {
            Template = template,
            LocationId = "inn",
            NpcId = "elena"
        };

        var gameState = new TestGameState();
        gameState.Locations.Add("inn");
        gameState.NPCs.Add("elena");

        SpawnResult result = SceneSpawner.CalculateSpawn(request, gameState);

        Assert.All(result.CreatedSituationIds, sitId =>
            Assert.StartsWith(result.SceneId, sitId));
    }

    [Fact]
    public void CalculateSpawn_NoNPC_StillSucceeds()
    {
        var template = CreateTestTemplate();
        var request = new SpawnRequest
        {
            Template = template,
            LocationId = "inn",
            NpcId = null  // No NPC requirement
        };

        var gameState = new TestGameState();
        gameState.Locations.Add("inn");

        SpawnResult result = SceneSpawner.CalculateSpawn(request, gameState);

        Assert.True(result.Success);
    }
}
