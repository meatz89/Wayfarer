#!/bin/bash
# Comprehensive Architecture Compliance Pre-Commit Hook
# Enforces: DDR-007, HIGHLANDER, Type Restrictions, Code Quality, and more
#
# Install: ./scripts/hooks/install.sh
# Bypass:  git commit --no-verify (NOT RECOMMENDED)
#
# Reference: arc42/08_crosscutting_concepts.md, gdd/06_design_discipline.md, CLAUDE.md

set -e

echo "=== Architecture Compliance Check ==="
echo ""

# Get staged .cs files (excluding UI rendering files and tests)
STAGED_CS=$(git diff --cached --name-only --diff-filter=ACM | grep '\.cs$' | grep -v '\.razor\.cs$' | grep -v 'Tests\.' || true)
STAGED_CS_ALL=$(git diff --cached --name-only --diff-filter=ACM | grep '\.cs$' || true)

# Get staged documentation files (arc42, gdd, CLAUDE.md)
STAGED_ARC42=$(git diff --cached --name-only --diff-filter=ACM | grep 'arc42/.*\.md$' || true)
STAGED_GDD=$(git diff --cached --name-only --diff-filter=ACM | grep 'gdd/.*\.md$' | grep -v 'BASELINE_ECONOMY' || true)
STAGED_CLAUDE=$(git diff --cached --name-only --diff-filter=ACM | grep '^CLAUDE\.md$' || true)
STAGED_PRINCIPLES_DOCS="$STAGED_ARC42 $STAGED_GDD"

if [ -z "$STAGED_CS_ALL" ] && [ -z "$STAGED_ARC42" ] && [ -z "$STAGED_GDD" ] && [ -z "$STAGED_CLAUDE" ]; then
    echo "No relevant files staged, skipping checks"
    exit 0
fi

VIOLATIONS=0
WARNINGS=0

# ============================================================
# SECTION 1: DDR-007 - INTENTIONAL NUMERIC DESIGN
# ============================================================
echo "[DDR-007] Intentional Numeric Design..."

# 1.1 Decimal multipliers (* 0.X or * 1.X)
if [ -n "$STAGED_CS" ]; then
    for file in $STAGED_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n '\* [01]\.[0-9]' | grep -iv 'milliseconds\|timeout\|delay\|animation\|opacity\|alpha\|scale\|zoom\|hex.*spacing' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [DDR-007]: Decimal multiplier in $file:"
                echo "$MATCHES" | head -5
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# 1.2 Basis points patterns
if [ -n "$STAGED_CS" ]; then
    for file in $STAGED_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'BasisPoint\|[^a-zA-Z]BP[A-Z]\|/ *10000\|bp *=' | grep -v '^\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [DDR-007]: Basis point pattern in $file:"
                echo "$MATCHES" | head -5
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# 1.3 float/double in domain code
if [ -n "$STAGED_CS" ]; then
    for file in $STAGED_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n '\bfloat\b\|\bdouble\b' | grep -v '^\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [DDR-007]: float/double type in $file:"
                echo "$MATCHES" | head -5
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 2: TYPE RESTRICTIONS (CLAUDE.md)
# ============================================================
echo "[TYPE] Type Restrictions..."

# 2.1 Dictionary in domain code (excluding DTOs, external)
DOMAIN_CS=$(echo "$STAGED_CS" | grep -v 'DTO\|External\|Framework\|Config' || true)
if [ -n "$DOMAIN_CS" ]; then
    for file in $DOMAIN_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'Dictionary<' | grep -v '^\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [TYPE]: Dictionary in domain code $file (use List<T>):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# 2.2 HashSet in domain code
if [ -n "$DOMAIN_CS" ]; then
    for file in $DOMAIN_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'HashSet<' | grep -v '^\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [TYPE]: HashSet in domain code $file (use List<T>):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# 2.3 var keyword (warning - high false positives with LINQ)
if [ -n "$STAGED_CS" ]; then
    for file in $STAGED_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n '^\s*var\s' | grep -v 'anonymous\|new {' || true)
            if [ -n "$MATCHES" ]; then
                echo "  WARNING [TYPE]: 'var' keyword in $file (prefer explicit types):"
                echo "$MATCHES" | head -3
                WARNINGS=$((WARNINGS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 3: HIGHLANDER - NO ENTITY INSTANCE IDs
# ============================================================
echo "[HIGHLANDER] Entity Identity Model..."

# 3.1 Instance ID properties on domain entities
ENTITY_FILES=$(echo "$STAGED_CS" | grep -E 'GameState|Content|Services' | grep -v 'Template\|DTO' || true)
if [ -n "$ENTITY_FILES" ]; then
    for file in $ENTITY_FILES; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'public.*\(string\|int\|Guid\).*Id\s*{' | grep -v 'TemplateId\|PackageId' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [HIGHLANDER]: Instance ID property in $file:"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 4: FAIL-FAST PHILOSOPHY
# ============================================================
echo "[FAIL-FAST] Fail-Fast Philosophy..."

# 4.1 Null coalescing operators hiding missing data
if [ -n "$DOMAIN_CS" ]; then
    for file in $DOMAIN_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n '\?\?' | grep -v '^\s*//' | grep -v 'parameter\|argument' || true)
            if [ -n "$MATCHES" ]; then
                echo "  WARNING [FAIL-FAST]: Null coalescing (??) in $file (may hide errors):"
                echo "$MATCHES" | head -3
                WARNINGS=$((WARNINGS+1))
            fi
        fi
    done
fi

# 4.2 TryGetValue patterns
if [ -n "$DOMAIN_CS" ]; then
    for file in $DOMAIN_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'TryGetValue\|TryParse' | grep -v '^\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  WARNING [FAIL-FAST]: TryGetValue/TryParse in $file (prefer fail-fast):"
                echo "$MATCHES" | head -3
                WARNINGS=$((WARNINGS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 5: BACKEND/FRONTEND SEPARATION
# ============================================================
echo "[SEPARATION] Backend/Frontend Separation..."

# 5.1 CssClass in backend
SERVICE_FILES=$(echo "$STAGED_CS" | grep -E 'Service|Manager|Facade|Engine' || true)
if [ -n "$SERVICE_FILES" ]; then
    for file in $SERVICE_FILES; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'CssClass\|ClassName.*string' | grep -v '^\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [SEPARATION]: CssClass/ClassName in backend $file:"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# 5.2 IconName in backend
if [ -n "$SERVICE_FILES" ]; then
    for file in $SERVICE_FILES; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'IconName\|public.*Icon.*{' | grep -v '^\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [SEPARATION]: IconName/Icon in backend $file:"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 6: CODE QUALITY
# ============================================================
echo "[QUALITY] Code Quality..."

# 6.1 TODO/FIXME/HACK comments
if [ -n "$STAGED_CS" ]; then
    for file in $STAGED_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'TODO\|FIXME\|HACK\|XXX' | grep -v 'completed\|done\|removed' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [QUALITY]: TODO/FIXME comment in $file (finish before commit):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# 6.2 .Wait() or .Result (async violations)
if [ -n "$STAGED_CS" ]; then
    for file in $STAGED_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n '\.Wait()\|\.Result[;,)]\|GetAwaiter.*GetResult' | grep -v '^\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [QUALITY]: Blocking async call in $file:"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# 6.3 Extension methods
if [ -n "$DOMAIN_CS" ]; then
    for file in $DOMAIN_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'public static.*this ' | grep -v '^\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [QUALITY]: Extension method in domain code $file:"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 7: NAMESPACE RULES
# ============================================================
echo "[NAMESPACE] Namespace Rules..."

# 7.1 Domain code with namespace (should be global)
DOMAIN_CORE=$(echo "$STAGED_CS" | grep -E 'GameState|Content|Services|Subsystems' | grep -v 'Pages\|Components' || true)
if [ -n "$DOMAIN_CORE" ]; then
    for file in $DOMAIN_CORE; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n '^namespace' | grep -v 'Wayfarer\.Tests\|Wayfarer\.Pages' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [NAMESPACE]: Namespace in domain code $file (use global):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 8: RANDOM IN STRATEGIC SYSTEMS
# ============================================================
echo "[DETERMINISM] Strategic Determinism..."

# 8.1 Random usage (only allowed in Pile.cs)
STRATEGIC_CS=$(echo "$STAGED_CS" | grep -v 'Pile\.cs\|Test' || true)
if [ -n "$STRATEGIC_CS" ]; then
    for file in $STRATEGIC_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'new Random\|Random()\|\.Next(' | grep -v '^\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [DETERMINISM]: Random in strategic code $file (only Pile.cs allowed):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 9: CATALOGUE PATTERN (PARSE-TIME ONLY)
# ============================================================
echo "[CATALOGUE] Parse-Time Translation..."

# 9.1 Catalogue calls in Services/Subsystems (must be in Parsers only)
RUNTIME_CS=$(echo "$STAGED_CS" | grep -E 'Services|Subsystems' | grep -v 'Parser' || true)
if [ -n "$RUNTIME_CS" ]; then
    for file in $RUNTIME_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'Catalog\.\|Catalogue\.' | grep -v '^\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [CATALOGUE]: Runtime catalogue call in $file (use Parser pipeline):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 10: DOCUMENTATION PURITY (arc42, gdd, CLAUDE.md)
# ============================================================
# Principles documentation describes WHAT and WHY, not HOW.
# No code examples, JSON structures, or concrete implementation details.

# 10.1 Code blocks in arc42/gdd (ERROR - blocks commit)
if [ -n "$STAGED_PRINCIPLES_DOCS" ]; then
    echo "[DOC-PURITY] Principles Documentation Rules..."

    for file in $STAGED_PRINCIPLES_DOCS; do
        if [ -f "$file" ]; then
            # Check for code blocks (C#, JSON, etc.)
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n '```csharp\|```c#\|```json\|```cs\|```typescript\|```javascript' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [DOC-PURITY]: Code block in $file (describe concepts, not implementation):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done

    # 10.2 JSON structure patterns in arc42/gdd (ERROR - blocks commit)
    for file in $STAGED_PRINCIPLES_DOCS; do
        if [ -f "$file" ]; then
            # Check for JSON object patterns: lines with "key": value format
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n '"[a-zA-Z]*":\s*["{0-9\[]' | grep -v 'Example:\|example:\|e\.g\.' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [DOC-PURITY]: JSON structure in $file (use conceptual tables instead):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done

    # 10.3 Enum value lists in arc42/gdd (ERROR - blocks commit)
    for file in $STAGED_PRINCIPLES_DOCS; do
        if [ -f "$file" ]; then
            # Check for "Values: Foo, Bar, Baz" or "Valid values: A, B, C" patterns
            MATCHES=$(git show ":$file" 2>/dev/null | grep -in 'values:\s*[A-Z][a-zA-Z]*,\s*[A-Z]' | grep -v 'Categorical' || true)
            if [ -n "$MATCHES" ]; then
                echo "  WARNING [DOC-PURITY]: Enum value list in $file (describe categories, not values):"
                echo "$MATCHES" | head -3
                WARNINGS=$((WARNINGS+1))
            fi
        fi
    done

    # 10.4 File paths with line numbers (ERROR - blocks commit)
    for file in $STAGED_PRINCIPLES_DOCS; do
        if [ -f "$file" ]; then
            # Check for file.cs:123 or /path/to/file.cs patterns
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n '[a-zA-Z]*\.cs:[0-9]\|src/.*\.cs' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [DOC-PURITY]: File path/line number in $file (describe patterns, not locations):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done

    # 10.5 Specific game values in arc42/gdd (WARNING - allows commit)
    for file in $STAGED_PRINCIPLES_DOCS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n '[0-9]\+ coins\|[0-9]\+ stamina\|[0-9]\+ health\|[0-9]\+x\s' | grep -v 'range\|threshold\|conceptual' || true)
            if [ -n "$MATCHES" ]; then
                echo "  WARNING [DOC-PURITY]: Specific game value in $file (use ranges or conceptual language):"
                echo "$MATCHES" | head -3
                WARNINGS=$((WARNINGS+1))
            fi
        fi
    done
fi

# 10.6 CLAUDE.md specific checks (lighter rules - can have process instructions)
if [ -n "$STAGED_CLAUDE" ]; then
    echo "[DOC-PURITY] CLAUDE.md Rules..."

    for file in $STAGED_CLAUDE; do
        if [ -f "$file" ]; then
            # Check for game logic code (but allow process commands like ./scripts, dotnet build)
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n '```csharp\|```c#\|```json' | grep -v 'razor' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [DOC-PURITY]: Game logic code block in CLAUDE.md (only process instructions allowed):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 11: ICON SYSTEM (NO EMOJIS)
# ============================================================
# Emojis forbidden in game content - use SVG icons from game-icons.net

STAGED_RAZOR=$(git diff --cached --name-only --diff-filter=ACM | grep '\.razor$' || true)
if [ -n "$STAGED_RAZOR" ]; then
    echo "[ICONS] No Emojis in UI..."

    for file in $STAGED_RAZOR; do
        if [ -f "$file" ]; then
            # Check for common emoji patterns (checkmarks, crosses, arrows, etc.)
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n '[九九덕랭九떡롋九丘뫡셿游댠游丘멆잺游꿢游늸游멇릠벓눯游디勇游띠勇仇벒잺游눜游눛游릭游댮游리]' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [ICONS]: Emoji in $file (use <Icon> component):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 12: EXPLICIT PROPERTY PRINCIPLE
# ============================================================
# No string-based generic property modification patterns

if [ -n "$STAGED_CS" ]; then
    echo "[EXPLICIT] Explicit Property Principle..."

    for file in $STAGED_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'ModifyProperty\|SetProperty\|GetProperty' | grep 'string' | grep -v '^\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [EXPLICIT]: String-based property pattern in $file (use explicit properties):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 13: FILE SIZE LIMIT (1000 LINES MAX)
# ============================================================
# Large files indicate too many responsibilities, insufficient abstraction,
# and cognitive overload. They require holistic refactoring, not tactical fixes.

if [ -n "$STAGED_CS_ALL" ]; then
    echo "[FILE-SIZE] File Size Limit (1000 lines)..."

    for file in $STAGED_CS_ALL; do
        if [ -f "$file" ]; then
            LINE_COUNT=$(git show ":$file" 2>/dev/null | wc -l)
            if [ "$LINE_COUNT" -gt 1000 ]; then
                echo "  ERROR [FILE-SIZE]: $file has $LINE_COUNT lines (max 1000)"
                echo "    This file requires HOLISTIC REFACTORING before commit."
                echo "    See CLAUDE.md 'FILE SIZE LIMIT' section for requirements."
                echo ""
                echo "    FORBIDDEN: Tactical splits, quick fixes, bypassing without plan"
                echo "    REQUIRED:  Use agents to analyze, debate alternatives, implement completely"
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SUMMARY
# ============================================================
echo ""
echo "=== Summary ==="

if [ $VIOLATIONS -gt 0 ]; then
    echo ""
    echo "COMMIT BLOCKED: $VIOLATIONS violation(s) found"
    echo ""
    echo "Reference Documentation:"
    echo "  - DDR-007: gdd/06_design_discipline.md, arc42/08_crosscutting_concepts.md #8.22"
    echo "  - HIGHLANDER: arc42/08_crosscutting_concepts.md #8.1, #8.3"
    echo "  - Type Rules: CLAUDE.md (USER CODE PREFERENCES)"
    echo "  - Fail-Fast: arc42/08_crosscutting_concepts.md #8.5"
    echo "  - Separation: arc42/08_crosscutting_concepts.md #8.6"
    echo "  - File-Size: CLAUDE.md (FILE SIZE LIMIT - requires holistic refactoring)"
    echo ""
    echo "To bypass (NOT RECOMMENDED): git commit --no-verify"
    exit 1
fi

if [ $WARNINGS -gt 0 ]; then
    echo "$WARNINGS warning(s) found (commit allowed)"
fi

echo "All checks passed!"
exit 0
