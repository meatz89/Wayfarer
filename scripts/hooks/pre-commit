#!/bin/bash
# Comprehensive Architecture Compliance Pre-Commit Hook
# Enforces: DDR-007, HIGHLANDER, Type Restrictions, Code Quality, and more
#
# Install: ./scripts/hooks/install.sh
# Bypass:  git commit --no-verify (NOT RECOMMENDED)
#
# Reference: arc42/08_crosscutting_concepts.md, gdd/06_design_discipline.md, CLAUDE.md

set -e

echo "=== Architecture Compliance Check ==="
echo ""

# Get staged .cs files (excluding UI rendering files and tests)
STAGED_CS=$(git diff --cached --name-only --diff-filter=ACM | grep '\.cs$' | grep -v '\.razor\.cs$' | grep -v 'Tests\.' || true)
STAGED_CS_ALL=$(git diff --cached --name-only --diff-filter=ACM | grep '\.cs$' || true)

# Get staged documentation files (arc42, gdd, CLAUDE.md)
STAGED_ARC42=$(git diff --cached --name-only --diff-filter=ACM | grep 'arc42/.*\.md$' || true)
STAGED_GDD=$(git diff --cached --name-only --diff-filter=ACM | grep 'gdd/.*\.md$' | grep -v 'BASELINE_ECONOMY' || true)
STAGED_CLAUDE=$(git diff --cached --name-only --diff-filter=ACM | grep '^CLAUDE\.md$' || true)
STAGED_PRINCIPLES_DOCS="$STAGED_ARC42 $STAGED_GDD"

if [ -z "$STAGED_CS_ALL" ] && [ -z "$STAGED_ARC42" ] && [ -z "$STAGED_GDD" ] && [ -z "$STAGED_CLAUDE" ]; then
    echo "No relevant files staged, skipping checks"
    exit 0
fi

VIOLATIONS=0
WARNINGS=0

# ============================================================
# SECTION 1: DDR-007 - INTENTIONAL NUMERIC DESIGN
# ============================================================
echo "[DDR-007] Intentional Numeric Design..."

# 1.1 Decimal multipliers (* 0.X or * 1.X)
if [ -n "$STAGED_CS" ]; then
    for file in $STAGED_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n '\* [01]\.[0-9]' | grep -iv 'milliseconds\|timeout\|delay\|animation\|opacity\|alpha\|scale\|zoom\|hex.*spacing' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [DDR-007]: Decimal multiplier in $file:"
                echo "$MATCHES" | head -5
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# 1.2 Basis points patterns
if [ -n "$STAGED_CS" ]; then
    for file in $STAGED_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'BasisPoint\|[^a-zA-Z]BP[A-Z]\|/ *10000\|bp *=' | grep -v '^\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [DDR-007]: Basis point pattern in $file:"
                echo "$MATCHES" | head -5
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# 1.3 float/double TYPE DECLARATIONS in domain code
# Pattern must match actual type usage: variable declarations, method parameters, return types
# Excludes: comments, string literals, words like "Double" (capitalized names)
if [ -n "$STAGED_CS" ]; then
    for file in $STAGED_CS; do
        if [ -f "$file" ]; then
            # Match type declarations: "float x", "double y", "(float)", ": float", "< float >"
            MATCHES=$(git show ":$file" 2>/dev/null | grep -nE '(^|[^a-zA-Z])(float|double)\s+[a-z_]|<\s*(float|double)\s*>|\(\s*(float|double)\s*\)|:\s*(float|double)\b' | grep -v '^\s*//' | grep -v '".*double.*"' | grep -v '".*float.*"' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [DDR-007]: float/double type in $file:"
                echo "$MATCHES" | head -5
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 2: TYPE RESTRICTIONS (CLAUDE.md)
# ============================================================
echo "[TYPE] Type Restrictions..."

# 2.1 Dictionary in domain code (excluding DTOs, external)
# NO EXCEPTIONS - no caching allowed in the game
DOMAIN_CS=$(echo "$STAGED_CS" | grep -v 'DTO\|External\|Framework\|Config' || true)
if [ -n "$DOMAIN_CS" ]; then
    for file in $DOMAIN_CS; do
        if [ -f "$file" ]; then
            # Match Dictionary< but exclude comments mentioning Dictionary (documentation)
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'Dictionary<\|ConcurrentDictionary<' | grep -v '^\s*//' | grep -v 'REFACTORED\|instead of Dictionary\|Replaces Dictionary' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [TYPE]: Dictionary in domain code $file (use List<T>):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# 2.2 HashSet in domain code
if [ -n "$DOMAIN_CS" ]; then
    for file in $DOMAIN_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'HashSet<' | grep -v '^\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [TYPE]: HashSet in domain code $file (use List<T>):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# 2.3 KeyValuePair in domain code (Dictionary iteration pattern in disguise)
# Only matches explicit KeyValuePair usage, not nullable .Value access
if [ -n "$DOMAIN_CS" ]; then
    for file in $DOMAIN_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'KeyValuePair<\|kvp\.Key\|kvp\.Value' | grep -v '^\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [TYPE]: KeyValuePair pattern in $file (use List with typed entries):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# 2.4-2.6 REMOVED - warnings for wrapper patterns and var keyword
# These caused noise without blocking commits

# ============================================================
# SECTION 3: HIGHLANDER - NO ENTITY INSTANCE IDs
# ============================================================
echo "[HIGHLANDER] Entity Identity Model..."

# 3.1 Instance ID properties on domain entities
# Exclude: Template files, DTOs, Cards (templates), CollectionEntries (entry classes), Sessions (ephemeral tracking)
# Exclude: Parsers (may have parse-time helper classes with IDs for cross-reference)
ENTITY_FILES=$(echo "$STAGED_CS" | grep -E 'GameState|Content|Services' | grep -v 'Template\|DTO\|/Cards/\|CollectionEntries\|Session\|Parser' || true)
if [ -n "$ENTITY_FILES" ]; then
    for file in $ENTITY_FILES; do
        if [ -f "$file" ]; then
            # Exclude: Template IDs, Package IDs, Game Instance IDs (session tracking, not entity identity)
            # Exclude: Parse-time helper classes (IdPair, etc.)
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'public.*\(string\|int\|Guid\).*Id\s*{' | grep -v 'TemplateId\|PackageId\|GameInstanceId\|IdPair' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [HIGHLANDER]: Instance ID property in $file:"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 4: FAIL-FAST PHILOSOPHY
# ============================================================
echo "[FAIL-FAST] Fail-Fast Philosophy..."

# 4.1 Null coalescing operators hiding missing data
if [ -n "$DOMAIN_CS" ]; then
    for file in $DOMAIN_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n '\?\?' | grep -v '^\s*//' | grep -v 'parameter\|argument' || true)
            if [ -n "$MATCHES" ]; then
                echo "  WARNING [FAIL-FAST]: Null coalescing (??) in $file (may hide errors):"
                echo "$MATCHES" | head -3
                WARNINGS=$((WARNINGS+1))
            fi
        fi
    done
fi

# 4.2 REMOVED - TryGetValue/TryParse warning
# Caused noise without blocking commits

# ============================================================
# SECTION 5: REMOVED - BACKEND/FRONTEND SEPARATION
# ============================================================
# CssClass/IconName checks removed per user request
# These checks were too noisy and not blocking meaningful violations

# ============================================================
# SECTION 6: CODE QUALITY
# ============================================================
echo "[QUALITY] Code Quality..."

# 6.1 TODO/FIXME/HACK comments
if [ -n "$STAGED_CS" ]; then
    for file in $STAGED_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'TODO\|FIXME\|HACK\|XXX' | grep -v 'completed\|done\|removed' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [QUALITY]: TODO/FIXME comment in $file (finish before commit):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# 6.2 .Wait() or .Result (async violations)
if [ -n "$STAGED_CS" ]; then
    for file in $STAGED_CS; do
        if [ -f "$file" ]; then
            # Exclude all comment lines (// and ///) - match actual code only
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n '\.Wait()\|\.Result[;,)]\|GetAwaiter.*GetResult' | grep -v '^\s*[0-9]*:\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [QUALITY]: Blocking async call in $file:"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# 6.3 Extension methods
if [ -n "$DOMAIN_CS" ]; then
    for file in $DOMAIN_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'public static.*this ' | grep -v '^\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [QUALITY]: Extension method in domain code $file:"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 7: NAMESPACE RULES
# ============================================================
echo "[NAMESPACE] Namespace Rules..."

# 7.1 Domain code with namespace (should be global)
DOMAIN_CORE=$(echo "$STAGED_CS" | grep -E 'GameState|Content|Services|Subsystems' | grep -v 'Pages\|Components' || true)
if [ -n "$DOMAIN_CORE" ]; then
    for file in $DOMAIN_CORE; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n '^namespace' | grep -v 'Wayfarer\.Tests\|Wayfarer\.Pages' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [NAMESPACE]: Namespace in domain code $file (use global):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 8: RANDOM IN STRATEGIC SYSTEMS
# ============================================================
echo "[DETERMINISM] Strategic Determinism..."

# 8.1 Random usage (only allowed in Pile.cs)
STRATEGIC_CS=$(echo "$STAGED_CS" | grep -v 'Pile\.cs\|Test' || true)
if [ -n "$STRATEGIC_CS" ]; then
    for file in $STRATEGIC_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'new Random\|Random()\|\.Next(' | grep -v '^\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [DETERMINISM]: Random in strategic code $file (only Pile.cs allowed):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 9: CATALOGUE PATTERN (PARSE-TIME ONLY)
# ============================================================
echo "[CATALOGUE] Parse-Time Translation..."

# 9.1 Catalogue calls in Services/Subsystems (must be in Parsers only)
# Exception: SceneGenerationFacade wraps catalogue for parse-time generation (called from Parser)
RUNTIME_CS=$(echo "$STAGED_CS" | grep -E 'Services|Subsystems' | grep -v 'Parser\|SceneGenerationFacade' || true)
if [ -n "$RUNTIME_CS" ]; then
    for file in $RUNTIME_CS; do
        if [ -f "$file" ]; then
            # Exclude comment lines (// and ///) - match actual method calls only
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'Catalog\.\|Catalogue\.' | grep -v '^\s*[0-9]*:\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [CATALOGUE]: Runtime catalogue call in $file (use Parser pipeline):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 10: DOCUMENTATION PURITY (arc42, gdd, CLAUDE.md)
# ============================================================
# Principles documentation describes WHAT and WHY, not HOW.
# No code examples, JSON structures, or concrete implementation details.

# 10.1 Code blocks in arc42/gdd (ERROR - blocks commit)
if [ -n "$STAGED_PRINCIPLES_DOCS" ]; then
    echo "[DOC-PURITY] Principles Documentation Rules..."

    for file in $STAGED_PRINCIPLES_DOCS; do
        if [ -f "$file" ]; then
            # Check for code blocks (C#, JSON, etc.)
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n '```csharp\|```c#\|```json\|```cs\|```typescript\|```javascript' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [DOC-PURITY]: Code block in $file (describe concepts, not implementation):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done

    # 10.2 JSON structure patterns in arc42/gdd (ERROR - blocks commit)
    for file in $STAGED_PRINCIPLES_DOCS; do
        if [ -f "$file" ]; then
            # Check for JSON object patterns: lines with "key": value format
            # Exclude: Examples, Before/After transformation examples, inline code
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n '"[a-zA-Z]*":\s*["{0-9\[]' | grep -v 'Example:\|example:\|e\.g\.\|Before\|After\|Transformation\|JSON:' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [DOC-PURITY]: JSON structure in $file (use conceptual tables instead):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done

    # 10.3 REMOVED - enum value lists warning
    # Caused noise without blocking commits

    # 10.4 File paths with line numbers (ERROR - blocks commit)
    for file in $STAGED_PRINCIPLES_DOCS; do
        if [ -f "$file" ]; then
            # Check for file.cs:123 or /path/to/file.cs patterns
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n '[a-zA-Z]*\.cs:[0-9]\|src/.*\.cs' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [DOC-PURITY]: File path/line number in $file (describe patterns, not locations):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done

    # 10.5 REMOVED - specific game values warning
    # Caused noise without blocking commits
fi

# 10.6 CLAUDE.md specific checks (lighter rules - can have process instructions)
if [ -n "$STAGED_CLAUDE" ]; then
    echo "[DOC-PURITY] CLAUDE.md Rules..."

    for file in $STAGED_CLAUDE; do
        if [ -f "$file" ]; then
            # Check for game logic code (but allow process commands like ./scripts, dotnet build)
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n '```csharp\|```c#\|```json' | grep -v 'razor' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [DOC-PURITY]: Game logic code block in CLAUDE.md (only process instructions allowed):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 11: REMOVED - ICON SYSTEM (NO EMOJIS)
# ============================================================
# Emoji checks removed - not finding violations in practice

# ============================================================
# SECTION 12: EXPLICIT PROPERTY PRINCIPLE
# ============================================================
# No string-based generic property modification patterns

if [ -n "$STAGED_CS" ]; then
    echo "[EXPLICIT] Explicit Property Principle..."

    for file in $STAGED_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'ModifyProperty\|SetProperty\|GetProperty' | grep 'string' | grep -v '^\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [EXPLICIT]: String-based property pattern in $file (use explicit properties):"
                echo "$MATCHES" | head -3
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 13: NO PARTIAL CLASSES
# ============================================================
# Partial classes split files, not responsibilities.
# Exception: Blazor code-behind (.razor.cs) requires partial (framework requirement)
# See CLAUDE.md "NO PARTIAL CLASSES"

# Exclude .razor.cs files (Blazor code-behind requires partial)
NON_BLAZOR_CS=$(echo "$STAGED_CS_ALL" | grep -v '\.razor\.cs$' || true)
if [ -n "$NON_BLAZOR_CS" ]; then
    echo "[PARTIAL] No Partial Classes..."

    for file in $NON_BLAZOR_CS; do
        if [ -f "$file" ]; then
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'partial class\|partial struct\|partial interface' | grep -v '^\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [PARTIAL]: Partial class in $file:"
                echo "$MATCHES" | head -3
                echo ""
                echo "    FORBIDDEN: partial class keyword (except Blazor .razor.cs)"
                echo "    REQUIRED:  Use composition - extract to separate service, inject via DI"
                echo "    EXCEPTION: .razor.cs files (Blazor framework requirement)"
                echo "    Reference: CLAUDE.md 'NO PARTIAL CLASSES'"
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 14: FILE SIZE LIMIT (1000 LINES MAX)
# ============================================================
# Large files indicate too many responsibilities, insufficient abstraction,
# and cognitive overload. They require holistic refactoring, not tactical fixes.
# Exceptions:
# - GameOrchestrator.cs (coordinates ALL facades per FACADE ISOLATION)
# - GameWorld.cs (single source of truth for ALL game state, inherently central)

if [ -n "$STAGED_CS_ALL" ]; then
    echo "[FILE-SIZE] File Size Limit (1000 lines)..."

    for file in $STAGED_CS_ALL; do
        # Skip GameOrchestrator.cs - exempt per FACADE ISOLATION (coordinates all facades)
        if echo "$file" | grep -q "GameOrchestrator.cs$"; then
            continue
        fi
        # Skip GameWorld.cs - exempt as single source of truth for all game state
        if echo "$file" | grep -q "GameWorld.cs$"; then
            continue
        fi
        if [ -f "$file" ]; then
            LINE_COUNT=$(git show ":$file" 2>/dev/null | wc -l)
            if [ "$LINE_COUNT" -gt 1000 ]; then
                echo "  ERROR [FILE-SIZE]: $file has $LINE_COUNT lines (max 1000)"
                echo "    This file requires HOLISTIC REFACTORING before commit."
                echo "    See CLAUDE.md 'FILE SIZE LIMIT' section for requirements."
                echo ""
                echo "    FORBIDDEN: Tactical splits, quick fixes, bypassing without plan"
                echo "    REQUIRED:  Use agents to analyze, debate alternatives, implement completely"
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 15: ARCHETYPE REUSABILITY (NO TUTORIAL HARDCODING)
# ============================================================
# Archetypes must be context-agnostic - no story sequence checks
# See arc42/08_crosscutting_concepts.md #8.23

CATALOG_CS=$(echo "$STAGED_CS" | grep -E 'Catalog|Catalogue|Archetype' || true)
if [ -n "$CATALOG_CS" ]; then
    echo "[ARCHETYPE] Archetype Reusability..."

    for file in $CATALOG_CS; do
        if [ -f "$file" ]; then
            # Check for AStorySequence checks (tutorial hardcoding)
            MATCHES=$(git show ":$file" 2>/dev/null | grep -n 'AStorySequence\|\.IsTutorial\|== 1\).*tutorial\|== 2\).*tutorial\|== 3\).*tutorial' | grep -v '^\s*//' || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [ARCHETYPE]: Tutorial hardcoding in $file (use categorical properties):"
                echo "$MATCHES" | head -5
                echo "  Reference: arc42/08_crosscutting_concepts.md #8.23"
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SECTION 16: FACADE ISOLATION (NO LATERAL DEPENDENCIES)
# ============================================================
# Facades may never reference other facades - only GameOrchestrator can orchestrate
# See CLAUDE.md "FACADE ISOLATION (NO LATERAL DEPENDENCIES)"

FACADE_FILES=$(echo "$STAGED_CS" | grep -E 'Facade\.cs$' | grep -v 'GameOrchestrator\|GameOrchestrator' || true)
if [ -n "$FACADE_FILES" ]; then
    echo "[FACADE] Facade Isolation..."

    for file in $FACADE_FILES; do
        if [ -f "$file" ]; then
            # Check for references to other facades (field declarations, constructor params, method calls)
            # Pattern: XyzFacade (any word ending in Facade that's not the file's own facade)
            BASENAME=$(basename "$file" .cs)
            MATCHES=$(git show ":$file" 2>/dev/null | grep -nE '(private|readonly|public).*[A-Z][a-zA-Z]*Facade[^;]*;|[A-Z][a-zA-Z]*Facade [a-z]' | grep -v "^\s*//" | grep -v "$BASENAME" || true)
            if [ -n "$MATCHES" ]; then
                echo "  ERROR [FACADE]: Lateral facade dependency in $file:"
                echo "$MATCHES" | head -5
                echo ""
                echo "    FORBIDDEN: Facades calling other facades directly"
                echo "    REQUIRED:  GameOrchestrator coordinates between facades"
                echo "    Reference: CLAUDE.md 'FACADE ISOLATION'"
                VIOLATIONS=$((VIOLATIONS+1))
            fi
        fi
    done
fi

# ============================================================
# SUMMARY
# ============================================================
echo ""
echo "=== Summary ==="

if [ $VIOLATIONS -gt 0 ]; then
    echo ""
    echo "COMMIT BLOCKED: $VIOLATIONS violation(s) found"
    echo ""
    echo "Reference Documentation:"
    echo "  - DDR-007: gdd/06_design_discipline.md, arc42/08_crosscutting_concepts.md #8.24"
    echo "  - HIGHLANDER: arc42/08_crosscutting_concepts.md #8.1, #8.3"
    echo "  - Type Rules: CLAUDE.md (USER CODE PREFERENCES)"
    echo "  - Fail-Fast: arc42/08_crosscutting_concepts.md #8.5"
    echo "  - Separation: arc42/08_crosscutting_concepts.md #8.6"
    echo "  - File-Size: CLAUDE.md (FILE SIZE LIMIT - requires holistic refactoring)"
    echo "  - Archetype Reusability: arc42/08_crosscutting_concepts.md #8.23"
    echo ""
    echo "To bypass (NOT RECOMMENDED): git commit --no-verify"
    exit 1
fi

if [ $WARNINGS -gt 0 ]; then
    echo "$WARNINGS warning(s) found (commit allowed)"
fi

echo "All checks passed!"
exit 0
